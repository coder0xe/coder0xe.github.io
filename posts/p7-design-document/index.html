<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>P7-design-document | coder0xe's blog</title><meta name=keywords content="计组"><meta name=description content="P7设计文档"><meta name=author content="sudo"><link rel=canonical href=https://coder0xe.github.io/posts/p7-design-document/><link crossorigin=anonymous href=/assets/css/stylesheet.e4a36188e2c44563c1cc5ed1a2d0b8451a4f68c685114d738b97609f82dae050.css integrity="sha256-5KNhiOLERWPBzF7RotC4RRpPaMaFEU1zi5dgn4La4FA=" rel="preload stylesheet" as=style><link rel=icon href=https://coder0xe.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://coder0xe.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://coder0xe.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://coder0xe.github.io/apple-touch-icon.png><link rel=mask-icon href=https://coder0xe.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://coder0xe.github.io/posts/p7-design-document/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://coder0xe.github.io/posts/p7-design-document/"><meta property="og:site_name" content="coder0xe's blog"><meta property="og:title" content="P7-design-document"><meta property="og:description" content="P7设计文档"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-03T15:34:11+08:00"><meta property="article:modified_time" content="2023-12-03T15:34:11+08:00"><meta property="article:tag" content="Dec"><meta name=twitter:card content="summary"><meta name=twitter:title content="P7-design-document"><meta name=twitter:description content="P7设计文档"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://coder0xe.github.io/posts/"},{"@type":"ListItem","position":2,"name":"P7-design-document","item":"https://coder0xe.github.io/posts/p7-design-document/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"P7-design-document","name":"P7-design-document","description":"P7设计文档","keywords":["计组"],"articleBody":"P7-Design-Document 0.顶层设计概述 ​\tP7要求为实现MIPS微系统，需要为P6实现的流水线CPU添加异常中断功能，并封装为CPU模块、实现系统桥Bridge、计时器Timer1,Timer2等模块，最终形成MIPS微系统，如下图所示。\n绿色虚线表示已经实现 紫色虚线表示新增部分 红色虚线为改变后的DM接口 P7需要实现的任务如下列表\n任务 解释 计时器 课程组提供代码 系统桥 为CPU提供统一的访问外设的接口，自行实现 协处理器CP0 设置CPU的异常处理功能，反馈CPU的异常信息，自行实现 内部检测异常与流水 CPU检测内部指令执行错误 外部中断响应 CPU需要具有响应外部中断信号的能力 异常处理指令 异常处理程序中，会有一些特殊的指令需要实现 单周期CPU的封装 让CPU从外部看上去是单周期CPU 异常处理程序 利用MARS编写简单的异常处理程序进行测试 施工步骤：\n更改流水线各级使之可以产生异常\n添加CP0处理异常\n添加Bridge与两个外设\n异常与中断\n异常：内部异常 如F级取指异常、D级计算溢出等 中断：来自外部设备，Timer0,Timer1,Interrupt 来自外部设备的中断比内部异常优先级更高 一.功能部件设计 0.新增指令的实现思路 P7中增加四条指令 mtc0 mfc0 eret syscall mtc0 ：写入CP0中寄存器(12/14) 对于mtc0和mfc0指令 ： 读取的CP0寄存器地址均为rd域，由于本实现中采用了集中式译码，故增加数据通路，将原指令的rd域流水下去，作为CP0寄存器地址, CP0_addr\n指令格式 ：\n010000 || 00100 || rt || rd || 00000000000\nmtc0 rt,rd\nMCU ：\nCP0_WE_D T_rs_use = T_rt_use = 3（这里rt的真实使用时间是3，但是并不会对暂停/转发造成影响，Tuse \u003e= Tnew成立，可以通过转发解决） T_new = 0 写入时应当注意 ：Cause寄存器(13)不允许写入，EPC允许写入，SR寄存器部分字段允许写入，其他不允许写入的字段要保持为0\n1 2 3 4 5 6 7 if(A2 == 12) begin `IM \u003c= D_in[15:10]; `EXL \u003c= D_in[1]; `IE \u003c= D_in[0]; end else if (A2 == 14) EPC \u003c= D_in; mfc0 : 读取CP0中寄存器的值(12/13/14) ​\t在M级CP0输出结果与DE输出结果之间加MUX\n指令格式 ： 010000 || 00000 || rt || rd || 00000000000\nmfc0 rt,rd\nMCU :\nRegWrite T_rs_use = T_rt_use = 3 T_new = 3 eret : 从中断/异常处理中返回 MCU中判断后进行流水，D_eret，在M级进行使用跳出异常处理\neret是错误最易发生的一个指令，对于eret的要求有:\n跳转到CP0中EPC寄存器存储的受害PC\n不执行eret后延迟槽中的指令\n不执行延迟槽中的指令我的实现方式(比较优雅 较为推荐)为 ：在D级识别到eret指令后，在F级直接插入nop，同时npc中选择EPC端口\n1 2 3 4 5 6 \\\\ D_MCU_eret : D_eret assign D_eret = op_eret; \\\\ F-D reg 当F级出现取指异常或D级识别到eret指令时 传递指令nop assign F_instr_new = (F_AdEL) ? 32'b0 : (D_eret) : F_instr; \\\\ D_npc assign npc = (D_eret) ? EPC : ... 同时还有两种可能的实现方式 ：\n在D级识别到eret指令后，清D级延迟槽，但是此时应当注意清空延迟槽的条件为(clr \u0026\u0026 !stall)，即判断当前非暂停，举一个简单的例子就可以知道，例如D:eret E:mtc0\n**一定要注意信号之间的优先级！**下面给出D级流水线寄存器的代码(我采用集中式译码，好臃肿，更加推荐分布式译码(bushi))\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 always@(posedge clk)begin if(reset )begin instr \u003c= 32'b0; pc \u003c= 32'b0; pc8 \u003c= 32'b0; ExcCode \u003c= 5'b0; BD \u003c= 1'b0; end else if (req) begin instr \u003c= 32'b0; pc \u003c= 32'h0000_4180; pc8 \u003c= 32'h0000_4188; ExcCode \u003c= 5'b0; BD \u003c= 1'b0; end else if (clr \u0026\u0026 en) begin instr \u003c= 32'b0; pc \u003c= 32'b0; pc8 \u003c= 32'b0; ExcCode \u003c= 5'b0; BD \u003c= 1'b0; end else if (en) begin instr \u003c= F_instr; pc \u003c= F_pc; pc8 \u003c= F_pc8; ExcCode \u003c= F_ExcCode; BD \u003c= F_BD; end else begin //stall instr \u003c= instr; pc \u003c= pc; pc8 \u003c= pc8; ExcCode \u003c= ExcCode; BD \u003c= BD; end end 在F级输入pc取指时进行特判(这种写法我没有通过，报错处理延迟槽中断后没有跳回跳转指令)，不过多叙述\nsyscall : 系统调用异常 在D级MCU中识别出来并判断为异常即可 0.5关于流水线寄存器/PC选择中的信号优先级问题 2023秋计算机组成教程中课程组对于信号的优先级规定如下\nreset \u003e req \u003e stall\n​\t在流水线寄存器和IFU中pc选择时需要对信号优先级进行判断，推荐使用if_else_if_else语句实现对优先级的判断，非常重要！\n流水线寄存器，以信号最复杂的E级为例\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 lways@(posedge clk) begin if(reset) begin ... end else if(req) begin ... end else if(clr)begin pc \u003c= D_pc ; // 注意E级暂停时也要对pc,BD信号进行流水 pc8 \u003c= D_pc8 ; BD \u003c= D_BD; ... end else begin ... end end IFU中PC的选择\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 always@(posedge clk)begin if(reset)begin PC \u003c= 32'h0000_3000; PC8 \u003c= 32'h0000_3008; tmp \u003c= 32'b0; end else if (req) begin PC \u003c= npc; PC8 \u003c= npc + 4'b1000; tmp \u003c= npc - 32'h0000_3000; end else if (en)begin PC \u003c= npc; PC8 \u003c= npc + 4'b1000; tmp \u003c= npc - 32'h0000_3000; end else begin PC \u003c= PC; PC8 \u003c=PC8; tmp \u003c= tmp; end 1.CP0 0.数据通路 **宏观PC：**为了将我们的流水线CPU封装为单周期CPU（至少在外界看来是这个样子），提出宏观PC的概念，在宏观PC之前的地址对应的指令均已经完成，在宏观PC之后的地址对应的指令还未完成，依据这一特点我们知道应当将CP0(Coprocessor0)放置在M级流水线。 1.需要处理的异常 0.异常优先级 一条指令发生多个异常，考虑最先发生的异常(F\u003eD\u003eE\u003eM) 多条指令发生异常，也有限考虑最先发生的异常(M\u003eE\u003eD\u003eF)，即将M级异常传入CP0 1.F级异常： PC地址没有字对齐（AdEL） PC地址超过0x3000 ~ 0x6ffc（AdEL） 还需要判断D级不是eret指令，因为eret后“延迟槽”中指令不被执行，即使在F级发生异常也不应被处理/进入异常处理程序。 1 assign F_ExcCode = (!D_eret) \u0026\u0026 (F_pc[1:0] != 2'b00) || (F_pc \u003c 32'h0000_3000) || (F_pc \u003e 32'h0000_3fffc) ? ADEL : NONE; 注意F级发生取指错误后要流水空指令nop递交到CP0\n1 F_instr_new = (F_AdEL) ? 32'b0 : (D_eret) ? 32'b0 : F_instr; 1.D级异常： 未知的指令码（RI）\n从MCU中添加输出信号invalid_D，标记当前指令是否为无效指令，注意在MCU中识别nop指令\n1 assign invalid_D = !(cal_R | cal_I | store | load | branch | md | mt | mf | op_jal | op_jr | op_mfc0 | op_mtc0 | op_syscall | op_eret | op_nop | op_syscall); syccall 系统调用异常\n1 2 3 4 assign D_ExcCode_fixed = (D_ExcCode) ? D_ExcCode : (invalid_D) ? RI : (D_syscall) ? SYSCALL : NONE; 2.E级异常： addi、add、sub计算溢出（Ov）: 在MCU中添加输出信号isAriOv_D表示是不是需要判断溢出的运算指令\n1 assign isAriOv_D = op_add | op_addi | op_sub; load类指令计算地址时加法溢出（AdEL）\nstore类指令计算地址时加法溢出（AdES）\n1 2 3 4 assign E_ExcCode_fixed = (E_ExcCode) ? E_ExcCode : (overflow_E \u0026\u0026 (DMOp_E == sw || DMOp_E == sh || DMOp_E == sb)) ? ADES : (overflow_E \u0026\u0026 (DMOp_E == lw || DMOp_E == lh || DMOp_E == lb)) ? ADEL : (overflow_E \u0026\u0026 isAriOv_E) ? OV : NONE; 补位法溢出判断 ​\t依据add,addi,sub原始的指令RTL中对溢出的判断编写.\ntemp = (GPR[rs]31 || GPR[rs]) + (GPR[rt]31 || GPR[rt]) if temp32 ≠ temp31 then SignalException(IntegerOverflow) else GPR[rd] ← temp31..0 endif ​\t以add为例翻译为对应的verilog代码如下\n1 2 3 4 5 6 7 8 9 ext_A = {src_A[31],src_A}; ext_B = {src_B[31],src_B}; ext_AO = ext_A + ext_B; if(ext_AO[32] != ext_AO[31]) begin overflow = 1'b1; end else begin E_AO = ext_AO[31:0]; end 3.M级异常： lw取数地址未 4 字节对齐（AdEL）\nlh取数地址未与 2 字节对齐（AdEL）\nlh、lb取 Timer 寄存器的值（AdEL）\nload型指令取数地址超出 DM、Timer0、Timer1、中断发生器的范围（AdEL）\nsw存数地址未 4 字节对齐（AdES）\nsh存数地址未 2 字节对齐（AdES）\nsh、sb存 Timer 寄存器的值（AdES）\nstore型指令向计时器的 Count 寄存器存值（AdES）\nstore型指令存数地址超出 DM、Timer0、Timer1、中断发生器的范围（AdES）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 wire lhlb_tag = (DMOp_M == lh || DMOp_M == lb); wire load_tag = (DMOp_M == lw || DMOp_M == lh || DMOp_M == lb); wire shsb_tag = (DMOp_M == sh || DMOp_M == sb); wire store_tag = (DMOp_M == sw || DMOp_M == sh || DMOp_M == sb); wire timer_addr = (M_AO \u003e= 32'h7f00 \u0026\u0026 M_AO \u003c= 32'h7f0b) || (M_AO \u003e= 32'h7f10 \u0026\u0026 M_AO \u003c= 32'h7f1b); wire dm_addr = (M_AO \u003e= 32'h0000 \u0026\u0026 M_AO \u003c= 32'h2fff); wire interrupt_addr = (M_AO \u003e= 32'h7f20 \u0026\u0026 M_AO \u003c= 32'h7f23); assign M_ExcCode_fixed = (M_ExcCode) ? M_ExcCode : (DMOp_M == lw \u0026\u0026 (M_AO[1:0] != 2'b00)) ? ADEL : (DMOp_M == lh \u0026\u0026 (M_AO[0] != 1'b0)) ? ADEL : (lhlb_tag \u0026\u0026 timer_addr) ? ADEL : (load_tag \u0026\u0026 !dm_addr \u0026\u0026 !timer_addr \u0026\u0026 !interrupt_addr) ? ADEL : (DMOp_M == sw \u0026\u0026 (M_AO[1:0] != 2'b00)) ? ADES : (DMOp_M == sh \u0026\u0026 (M_AO[0] != 1'b0)) ? ADES : (shsb_tag \u0026\u0026 timer_addr) ? ADES : (store_tag \u0026\u0026 timer_addr \u0026\u0026 M_AO[3:0] == 4'h8) ? ADES : (store_tag \u0026\u0026 !dm_addr \u0026\u0026 !timer_addr \u0026\u0026 !interrupt_addr) ? ADES : NONE; 2.端口定义列表 名称 方向 位宽 描述 产生来源和机制 clk I 1 时钟信号 reset I 1 同步复位信号 A1 I 5 读CP0寄存器编号 指令mfc0 A2 I 5 写CP0寄存器编号 指令mtc0 D_in I 32 写入CP0寄存器的数据 指令mtc0 M_pc I 32 M级PC:发生中断/异常时的PC M_ExcCode I 5 中断/异常的类型 异常功能部件 BD_in I 1 分支延迟槽指令标志 HWInt I 6 6个外部设备的中断 外部设备 WE I 1 CP0寄存器写使能 指令mtc0 EXTClr I 1 SR的EXL位置零 eret_M控制信号输入 req O 1 异常/中断请求 CP0模块确认响应异常/中断 EPC_out O 32 EPC寄存器输出 D_out O 32 CP0寄存器输出数据 指令mfc0 3.内部寄存器列表 ​\t将SR,Cause,EPC都实现为32位！\n寄存器 编号 功能 SR 12 配置异常的功能。 Cause 13 记录异常发生的原因和情况。 EPC 14 记录异常处理结束后需要返回的 PC。 寄存器 功能域 位域 解释 SR（State Register） IM（Interrupt Mask） 15:10 分别对应六个外部中断，相应位置 1 表示允许中断，置 0 表示禁止中断。这是一个被动的功能，只能通过 mtc0 这个指令修改，通过修改这个功能域，我们可以屏蔽一些中断。 SR（State Register） EXL（Exception Level） 1 任何异常发生时置位，这会强制进入核心态（也就是进入异常处理程序）并禁止中断。 SR（State Register） IE（Interrupt Enable） 0 全局中断使能，该位置 1 表示允许中断，置 0 表示禁止中断。 Cause BD（Branch Delay） 31 当该位置 1 的时候，EPC 指向当前指令的前一条指令（一定为跳转），否则指向当前指令。 Cause IP（Interrupt Pending） 15:10 为 6 位待决的中断位，分别对应 6 个外部中断，相应位置 1 表示有中断，置 0 表示无中断，将会每个周期被修改一次，修改的内容来自计时器和外部中断。 Cause ExcCode 6:2 异常编码，记录当前发生的是什么异常。 EPC - - 记录异常处理结束后需要返回的 PC。 4.设计思路 ​\t在CP0中进行处理的指令有mfc0,mtc0\nmfc0 (读) SR Cause EPC mtc0 (写/Cause only read) SR EPC ​\t在CP0中定义三个32位寄存器，并使用宏定义定义寄存器的功能字段\n1.产生异常/中断请求 使用位缩减运算符 | : result = a[0] | a[1] | ….\n注：外部中断比内部异常优先级更高，即有有中断先处理中断，后处理异常\n1 2 3 wire int_req = (|(HWInt \u0026 `IM)) \u0026 (!`EXL) \u0026 (`IE); // (某一个外设上有中断且允许中断) \u0026 (当前不在中断处理中) \u0026 (允许中断) wire exc_req = (| M_ExcCode) \u0026 (!`EXL); // （有异常）\u0026 （当前不在中断处理中） assign req = int_req | exc_req; // request 2.EPC处理 ​\t对于EPC要考虑延迟槽的问题\n若产生异常的为延迟槽中的指令，则跳回到跳转指令，即M_pc - 4\nwire [31:2] tmpEPC = (req) ? ((M_BD) ? M_pc[31:2] -1 : M_pc[31:2]) : EPC; assign EPC_out = {tmpEPC,2'b00}; // 4 byte align 注：对PC进行字对齐处理，后补2’b00\n需要注意的是EPC保存当前指令PC的条件是req，即发生了异常时才会对EPC进行更新，这样就保证了EPC中的值在进入异常处理程序之后不会发生改变，识别到eret指令之后跳回到异常指令。\n3.对于延迟槽指令的判断 ​\t延迟槽即跳转指令的下一条指令，所以标记延迟槽指令只需要识别出他的上一条指令是跳转指令(NPCOp_D != 3’b000)，并在F级跟随该指令进行流水到M级进行判断即可(无论跳转指令是否跳转)。\n1 F_BD = (NPCOp_D != 3'b000) 2.nop和req在流水线寄存器中的问题 nop ​\t如果沿用P6/P5中暂停时在E级插入nop的写法，这个nop指令的pc和bd信号都为0。此时M级宏观PC会显示错误的值，并且如果此时发生了中断，CP0中存入错误的EPC值。正确的做法是在暂停时让pc和bd继续流水\nreq ​\t发生异常时，需要跳转到异常响应代码并清空流水线内还没有执行完的指令。直接将pc清为0会导致第一条处理异常的代码到达M级之前，宏观PC都是0，故req信号来时需要将pc置为异常代码地址32'h0000_4180\n1 2 3 4 5 6 7 8 9 10 11 12 //以E级为例 always@(posedge clk) begin if(reset | stall | req) begin pc \u003c= (stall) ? D_pc : (req ? 32'h0000_4180 : 32'h0); pc8 \u003c= (stall) ? D_pc8 : (req ? 32'h0000_4188 : 32'h0); BD \u003c= (stall) ? D_BD : 1'b0; ... end else begin ... end end 3.NPC 1.端口定义列表 名称 方向 位宽 描述 req I 1 中断请求 D_eret I 1 D级是否为eret指令 b_result I 1 B类跳转指令是否满足跳转条件 NPCOp I 3 地址选择 F_pc I 32 F级PC输入 D_pc I 32 D级PC输入 b_offset I 32 B类跳转指令偏移 j_address I 26 J类跳转指令偏移 reg_address I 32 寄存器中保存的地址 npc O 32 输出下一PC 2.PC选择逻辑 若发生req中断，跳转到异常处理程序地址 : 32’h0000_4180 若执行eret指令，eret将保存在CP0的地址写入PC，从而实现从处理异常程序中跳回到主程序 (同时保证了不会指令eret延迟槽中的指令) 在D级识别到eret，NPC选择EPC输入到F级 1 2 3 4 5 6 7 8 //NPC assign npc = (req) ? 32'h0000_4180 : (D_eret) ? EPC: (NPCOp == 3'b000) ? F_pc + 4'd4 : (NPCOp == 3'b001 \u0026\u0026 b_result) ? D_pc + 4'd4 + (b_offset \u003c\u003c 2'b10) : (NPCOp == 3'b010) ? {ADD4[31:28],j_address,2'b00} : (NPCOp == 3'b011) ? reg_address : (F_pc + 4'd4); 4.Bridge 1.端口定义列表 名称 方向 位宽 描述 Addr_in I 32 写入/读取外设的地址 WD_in I 32 写入外设单元的数据 byteen I 4 写入外设单元的使能 DM_RD I 32 DM读取值的输入 T1_RD I 32 Timer1读取值的输入 T0_RD I 32 Timer0读取值的输入 Addr_out O 32 写入/读取外设的地址 WD_out O 32 写入外设单元的数据 RD_out O 32 外设单元的读取值输出 DM_WE O 4 DM写入使能 T1_WE O 1 Timer1写入使能 T0_WE O 1 Timer0写入使能 2.实现代码（对地址的判断） ​\t需要注意的是我们写入的外设中，DM支持按字节访问，即byteen写入使能信号4位表示，写入Timer是按字写入的，一位写入使能信号。\n观察官方Timer端口定义：\ninput [31:2] Addr input [31:0] Din 说明Timer中寄存器为按字写入\n**Timer按字写入：byteen = 4’b1111(sw指令) 使用位缩减运算符变为一位 : \u0026byteen = 1’b1 **\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 assign Addr_out = Addr_in; assign WD_out = WD_in; wire DM_addr = (Addr_in \u003e= 32'h0000 \u0026\u0026 Addr_in \u003c= 32'h2fff); wire T0_addr = (Addr_in \u003e= 32'h7f00 \u0026\u0026 Addr_in \u003c= 32'h7f0b); wire T1_addr = (Addr_in \u003e= 32'h7f10 \u0026\u0026 Addr_in \u003c= 32'h7f1b); assign DM_WE = (DM_addr) ? byteen : 4'b0; assign T0_WE = (T0_addr) ? \u0026byteen : 1'b0; assign T1_WE = (T1_addr) ? \u0026byteen : 1'b0; assign RD_out = (DM_addr) ? DM_RD : (T0_addr) ? T0_RD : (T1_addr) ? T1_RD : 32'b0; 5.Timer ​\t课程组已经提供实现好的代码，两种模式的有限状态机，具体分析见思考题\n端口定义列表 名称 方向 位宽 描述 clk I 1 时钟信号 reset I 1 同步复位信号 Addr I 30 写入寄存器地址 Din I 32 写入数据 Dout O 32 读取数据 IRQ O 1 定时/定周期产生的中断信号 6.乘除槽处理 2023秋季计算机组成课程对于乘除槽的规定： mult 在 E 级启动了乘法运算，流水到 M 级时产生了中断，此时无需停止乘法计算，其它乘除法指令同理。 mthi 在 E 级修改了 HI 寄存器，流水到 M 级时产生了中断，此时无需恢复 HI 寄存器的值，mtlo 同理。 mult 在 E 级，受害指令在 M 级，此时还未改变 MDU 状态，不应开始乘法计算，其它乘除法指令同理。 mthi 在 E 级，受害指令在 M 级，此时还未改变 MDU 状态，不应修改 HI 寄存器的值，mtlo 同理。 ​\t即发生异常时若已经启动了乘除槽就不管他，如果还没启动，就不允许启动，只需要在启动乘除槽的条件中加入!req\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 always@(posedge clk)begin if(reset)begin cnt \u003c= 32'b0; busy \u003c= 1'b0; end else if(start \u0026\u0026 !req)begin //start claculate busy \u003c= 1'b1; end else if(busy) begin // continue to calculate is not influnced by req if(cnt == delay - 1)begin //next T : busy = 0 cnt \u003c= 32'b0; busy \u003c= 1'b0; end else begin cnt \u003c= cnt + 1'b1; end end end always@(posedge clk)begin if(reset)begin tmpHI \u003c= 32'b0; tmpLO \u003c= 32'b0; HI \u003c= 32'b0; LO \u003c= 32'b0; end else begin if (!busy \u0026\u0026 !req) begin //start calcualte case(MDUOp) mult : begin delay \u003c= 4'b0101; //5 {tmpHI,tmpLO} \u003c= $signed(A) * $signed(B); end multu : begin delay \u003c= 4'b0101; {tmpHI,tmpLO} \u003c= $unsigned(A) * $unsigned(B); end div : begin delay \u003c= 4'b1010; //10 tmpLO \u003c= $signed(A) / $signed(B); tmpHI \u003c= $signed(A) % $signed(B); end divu : begin delay \u003c= 4'b1010; tmpLO \u003c= $unsigned(A) / $unsigned(B); tmpHI \u003c= $unsigned(A) % $unsigned(B); end mthi : HI \u003c= A; mtlo : LO \u003c= A; endcase end else begin // // continue to calculate is not influnced by req if(cnt == delay - 1'b1)begin // next T : busy = 0; HI \u003c= tmpHI; LO \u003c= tmpLO; end else begin HI \u003c= HI; LO \u003c= LO; end end end end 二.测试方案 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 text la\t$ra, pos_1 addi\t$ra, $ra, 1 jr\t$ra ori\t$s0, $0, 100 ori\t$s0, $0, 200 #invalid pos_1: addi\t$s1, $s0, 20 #invalid addi\t$s1, $s0, 50 #F_exc_AdEL nop #you can change it 0xf000000f li\t$t0, 13 mfc0\t$t0, $t1 #D_exc_RI lui\t$s2, 0x7fff lui\t$s3, 0x7fff add\t$s4, $s2, $s3 #E_exc_Ov_add and\t$5, $s2, $s3 lui\t$s2, 0x7fff addi\t$s3, $s2, 0x7fffffff #E_exc_Ov_addi and\t$5, $s2, $s3 lui\t$s2, 0x7fff lui\t$s3, 0x8fff sub\t$s4, $s3, $s2 #E_exc_Ov_sub and\t$5, $s2, $s3 li\t$s0, 0x12345678 sw\t$s0, 0($0) lw\t$s1, 3($0) lw\t$s2, 0($0) #D_exc_AdEL and\t$5, $s2, $s3 li\t$s0, 0x8fffffff sw\t$s0, 0($0) lh\t$s1, 1($0) lh\t$s2, 2($0) #D_exc_AdEL and\t$5, $s2, $s3 li\t$s0, 0x80000000 sw\t$s0, 0($0) lhu\t$s1, 1($0) lhu\t$s2, 2($0) #D_exc_AdEL and\t$5, $s1, $s2 li\t$s0, 0x7f00 li\t$s1, 10 sw\t$s1, 0($s0) lh\t$s2, 0($s0) lw\t$s3, 0($s0) #D_exc_AdEL and\t$5, $s1, $s2 li\t$s0, 0x7010 li\t$s1, 10 sw\t$s1, 0($s0) li\t$s0, 0x2800 sw\t$s1, 0($s0) #D_exc_AdEL and\t$5, $s1, $s2 li\t$s0, 0x12ab34cd sw\t$s0, 3($0) sw\t$s0, 4($0) #D_exc_AdEL and\t$5, $s1, $s2 li\t$s0, 0xabcd sh\t$s0, 1($0) sh\t$s0, 2($0) #D_exc_AdEL and\t$5, $s1, $s2 li\t$s0, 0x7f10 li\t$s1, 10 sh\t$s1, 0($s0) sw\t$s1, 0($s0) #D_exc_AdEL and\t$5, $s1, $s2 li\t$s0, 0x7f10 li\t$s1, 10 sw\t$s1, 8($s0) #D_exc_AdEL and\t$5, $s1, $s2 li\t$s0, 0x8ff0 li\t$s1, 100 sh\t$s1, 0($s0) sh\t$s1, 0($s0) #D_exc_AdEL and\t$5, $s1, $s2 三.思考题 请查阅相关资料，说明鼠标和键盘的输入信号是如何被 CPU 知晓的？ 鼠标和键盘产生中断信号，进入中断处理程序，在中断处理程序中，鼠标和键盘输入信号 请思考为什么我们的 CPU 处理中断异常必须是已经指定好的地址？如果你的 CPU 支持用户自定义入口地址，即处理中断异常的程序由用户提供，其还能提供我们所希望的功能吗？如果可以，请说明这样可能会出现什么问题？否则举例说明。（假设用户提供的中断处理程序合法） 若自定义入口地址，则很多软件将会不兼容，在程序员视角设计软件的时候，中断处理的入口地址是不重要的，也就是说这是软件和硬件之间的协议。 为何与外设通信需要 Bridge？ 外设的种类繁多，我们通过bridge并且约定某段内存地址对应于某个外设，这样我们就只需要通过访存去实现与外设的联系，指令集会比较的简洁。添加外设时，外设也只需要体现在入口地址的不同而不需要改变CPU的内部结构，让CPU访问外设只需通过地址，这样体现了”高内聚，低耦合”的原则 请阅读官方提供的定时器源代码，阐述两种中断模式的异同，并分别针对每一种模式绘制状态移图 模式0 ： 定时中断\n模式1 ： 周期性中断\n画图如下\n倘若中断信号流入的时候，在检测宏观 PC 的一级如果是一条空泡（你的 CPU 该级所有信息均为空）指令，此时会发生什么问题？在此例基础上请思考：在 P7 中，清空流水线产生的空泡指令应该保留原指令的哪些信息？ 写入EPC会出错，延迟槽标记信号BD也会出错。 如果是中断或者异常而清空流水线，应该保持原有的PC值，以保证宏观PC的正确。 如果是阻塞而清空流水线，应该要保持原有的PC并且保持原有的BD标志信号。 为什么 jalr 指令为什么不能写成 jalr $31, $31？ 这种操作具有二义性，不知道先跳转还是先链接\n指令集要求 rs 和 rd 不得相等，因为此类指令在重新执行时不具有相同的效果。执行此类指令的结果是不可预测的。此限制允许异常处理程序在分支延迟槽中发生异常时通过重新执行分支来恢复执行。\n","wordCount":"2262","inLanguage":"en","datePublished":"2023-12-03T15:34:11+08:00","dateModified":"2023-12-03T15:34:11+08:00","author":{"@type":"Person","name":"sudo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://coder0xe.github.io/posts/p7-design-document/"},"publisher":{"@type":"Organization","name":"coder0xe's blog","logo":{"@type":"ImageObject","url":"https://coder0xe.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://coder0xe.github.io/ accesskey=h title="coder0xe's blog (Alt + H)">coder0xe's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://coder0xe.github.io/ title=首页><span>首页</span></a></li><li><a href=https://coder0xe.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://coder0xe.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://coder0xe.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://coder0xe.github.io/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://coder0xe.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://coder0xe.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">P7-design-document</h1><div class=post-description>P7设计文档</div><div class=post-meta><span title='2023-12-03 15:34:11 +0800 +0800'>December 3, 2023</span>&nbsp;·&nbsp;<span>11 min</span>&nbsp;·&nbsp;<span>sudo</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#p7-design-document aria-label=P7-Design-Document>P7-Design-Document</a><ul><li><a href=#0%e9%a1%b6%e5%b1%82%e8%ae%be%e8%ae%a1%e6%a6%82%e8%bf%b0 aria-label=0.顶层设计概述>0.顶层设计概述</a></li><li><a href=#%e4%b8%80%e5%8a%9f%e8%83%bd%e9%83%a8%e4%bb%b6%e8%ae%be%e8%ae%a1 aria-label=一.功能部件设计>一.功能部件设计</a><ul><li><a href=#0%e6%96%b0%e5%a2%9e%e6%8c%87%e4%bb%a4%e7%9a%84%e5%ae%9e%e7%8e%b0%e6%80%9d%e8%b7%af aria-label=0.新增指令的实现思路>0.新增指令的实现思路</a><ul><li><a href=#p7%e4%b8%ad%e5%a2%9e%e5%8a%a0%e5%9b%9b%e6%9d%a1%e6%8c%87%e4%bb%a4 aria-label=P7中增加四条指令>P7中增加四条指令</a></li><li><a href=#mtc0-%e5%86%99%e5%85%a5cp0%e4%b8%ad%e5%af%84%e5%ad%98%e5%99%a81214 aria-label="mtc0 ：写入CP0中寄存器(12/14)">mtc0 ：写入CP0中寄存器(12/14)</a></li><li><a href=#mfc0--%e8%af%bb%e5%8f%96cp0%e4%b8%ad%e5%af%84%e5%ad%98%e5%99%a8%e7%9a%84%e5%80%bc121314 aria-label="mfc0 : 读取CP0中寄存器的值(12/13/14)">mfc0 : 读取CP0中寄存器的值(12/13/14)</a></li><li><a href=#eret--%e4%bb%8e%e4%b8%ad%e6%96%ad%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86%e4%b8%ad%e8%bf%94%e5%9b%9e aria-label="eret : 从中断/异常处理中返回">eret : 从中断/异常处理中返回</a></li><li><a href=#syscall--%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e5%bc%82%e5%b8%b8 aria-label="syscall : 系统调用异常">syscall : 系统调用异常</a></li></ul></li><li><a href=#05%e5%85%b3%e4%ba%8e%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%af%84%e5%ad%98%e5%99%a8pc%e9%80%89%e6%8b%a9%e4%b8%ad%e7%9a%84%e4%bf%a1%e5%8f%b7%e4%bc%98%e5%85%88%e7%ba%a7%e9%97%ae%e9%a2%98 aria-label=0.5关于流水线寄存器/PC选择中的信号优先级问题>0.5关于流水线寄存器/PC选择中的信号优先级问题</a></li><li><a href=#1cp0 aria-label=1.CP0>1.CP0</a><ul><li><a href=#0%e6%95%b0%e6%8d%ae%e9%80%9a%e8%b7%af aria-label=0.数据通路>0.数据通路</a></li><li><a href=#1%e9%9c%80%e8%a6%81%e5%a4%84%e7%90%86%e7%9a%84%e5%bc%82%e5%b8%b8 aria-label=1.需要处理的异常>1.需要处理的异常</a><ul><li><a href=#0%e5%bc%82%e5%b8%b8%e4%bc%98%e5%85%88%e7%ba%a7 aria-label=0.异常优先级>0.异常优先级</a></li><li><a href=#1f%e7%ba%a7%e5%bc%82%e5%b8%b8 aria-label=1.F级异常：>1.F级异常：</a></li><li><a href=#1d%e7%ba%a7%e5%bc%82%e5%b8%b8 aria-label=1.D级异常：>1.D级异常：</a></li><li><a href=#2e%e7%ba%a7%e5%bc%82%e5%b8%b8 aria-label=2.E级异常：>2.E级异常：</a><ul><li><a href=#%e8%a1%a5%e4%bd%8d%e6%b3%95%e6%ba%a2%e5%87%ba%e5%88%a4%e6%96%ad aria-label=补位法溢出判断>补位法溢出判断</a></li></ul></li><li><a href=#3m%e7%ba%a7%e5%bc%82%e5%b8%b8 aria-label=3.M级异常：>3.M级异常：</a></li></ul></li><li><a href=#2%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8 aria-label=2.端口定义列表>2.端口定义列表</a></li><li><a href=#3%e5%86%85%e9%83%a8%e5%af%84%e5%ad%98%e5%99%a8%e5%88%97%e8%a1%a8 aria-label=3.内部寄存器列表>3.内部寄存器列表</a></li><li><a href=#4%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af aria-label=4.设计思路>4.设计思路</a><ul><li><a href=#1%e4%ba%a7%e7%94%9f%e5%bc%82%e5%b8%b8%e4%b8%ad%e6%96%ad%e8%af%b7%e6%b1%82 aria-label=1.产生异常/中断请求>1.产生异常/中断请求</a></li><li><a href=#2epc%e5%a4%84%e7%90%86 aria-label=2.EPC处理>2.EPC处理</a></li><li><a href=#3%e5%af%b9%e4%ba%8e%e5%bb%b6%e8%bf%9f%e6%a7%bd%e6%8c%87%e4%bb%a4%e7%9a%84%e5%88%a4%e6%96%ad aria-label=3.对于延迟槽指令的判断>3.对于延迟槽指令的判断</a></li></ul></li></ul></li><li><a href=#2nop%e5%92%8creq%e5%9c%a8%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%af%84%e5%ad%98%e5%99%a8%e4%b8%ad%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=2.nop和req在流水线寄存器中的问题>2.nop和req在流水线寄存器中的问题</a><ul><ul><li><a href=#nop aria-label=nop>nop</a></li><li><a href=#req aria-label=req>req</a></li></ul></ul></li><li><a href=#3npc aria-label=3.NPC>3.NPC</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2pc%e9%80%89%e6%8b%a9%e9%80%bb%e8%be%91 aria-label=2.PC选择逻辑>2.PC选择逻辑</a></li></ul></li><li><a href=#4bridge aria-label=4.Bridge>4.Bridge</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-1 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2%e5%ae%9e%e7%8e%b0%e4%bb%a3%e7%a0%81%e5%af%b9%e5%9c%b0%e5%9d%80%e7%9a%84%e5%88%a4%e6%96%ad aria-label=2.实现代码（对地址的判断）>2.实现代码（对地址的判断）</a></li></ul></li><li><a href=#5timer aria-label=5.Timer>5.Timer</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8 aria-label=端口定义列表>端口定义列表</a></li></ul></li><li><a href=#6%e4%b9%98%e9%99%a4%e6%a7%bd%e5%a4%84%e7%90%86 aria-label=6.乘除槽处理>6.乘除槽处理</a></li></ul></li><li><a href=#%e4%ba%8c%e6%b5%8b%e8%af%95%e6%96%b9%e6%a1%88 aria-label=二.测试方案>二.测试方案</a></li><li><a href=#%e4%b8%89%e6%80%9d%e8%80%83%e9%a2%98 aria-label=三.思考题>三.思考题</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=p7-design-document><center>P7-Design-Document</center><a hidden class=anchor aria-hidden=true href=#p7-design-document>#</a></h1><h2 id=0顶层设计概述>0.顶层设计概述<a hidden class=anchor aria-hidden=true href=#0顶层设计概述>#</a></h2><p>​ P7要求为实现MIPS微系统，需要为P6实现的流水线CPU添加异常中断功能，并封装为CPU模块、实现系统桥Bridge、计时器Timer1,Timer2等模块，最终形成MIPS微系统，如下图所示。</p><ul><li>绿色虚线表示已经实现</li><li>紫色虚线表示新增部分</li><li>红色虚线为改变后的DM接口</li></ul><p><img alt=image-20231203155826233 loading=lazy src=/img/image-20231203155826233.png></p><p><strong>P7需要实现的任务如下列表</strong></p><table><thead><tr><th>任务</th><th>解释</th></tr></thead><tbody><tr><td>计时器</td><td>课程组提供代码</td></tr><tr><td>系统桥</td><td>为CPU提供统一的访问外设的接口，自行实现</td></tr><tr><td>协处理器CP0</td><td>设置CPU的异常处理功能，反馈CPU的异常信息，自行实现</td></tr><tr><td>内部检测异常与流水</td><td>CPU检测内部指令执行错误</td></tr><tr><td>外部中断响应</td><td>CPU需要具有响应外部中断信号的能力</td></tr><tr><td>异常处理指令</td><td>异常处理程序中，会有一些特殊的指令需要实现</td></tr><tr><td>单周期CPU的封装</td><td>让CPU从外部看上去是单周期CPU</td></tr><tr><td>异常处理程序</td><td>利用MARS编写简单的异常处理程序进行测试</td></tr></tbody></table><p><strong>施工步骤</strong>：</p><ol><li><p>更改流水线各级使之可以产生异常</p></li><li><p>添加CP0处理异常</p></li><li><p>添加Bridge与两个外设</p></li></ol><p><strong>异常与中断</strong></p><ul><li>异常：内部异常 如F级取指异常、D级计算溢出等</li><li>中断：来自外部设备，Timer0,Timer1,Interrupt</li><li>来自外部设备的中断比内部异常优先级更高</li></ul><h2 id=一功能部件设计>一.功能部件设计<a hidden class=anchor aria-hidden=true href=#一功能部件设计>#</a></h2><h3 id=0新增指令的实现思路>0.新增指令的实现思路<a hidden class=anchor aria-hidden=true href=#0新增指令的实现思路>#</a></h3><h4 id=p7中增加四条指令><strong>P7中增加四条指令</strong><a hidden class=anchor aria-hidden=true href=#p7中增加四条指令>#</a></h4><ul><li>mtc0</li><li>mfc0</li><li>eret</li><li>syscall</li></ul><h4 id=mtc0-写入cp0中寄存器1214>mtc0 ：写入CP0中寄存器(12/14)<a hidden class=anchor aria-hidden=true href=#mtc0-写入cp0中寄存器1214>#</a></h4><ul><li><p><strong>对于mtc0和mfc0指令 ： 读取的CP0寄存器地址均为rd域，由于本实现中采用了集中式译码，故增加数据通路，将原指令的rd域流水下去，作为CP0寄存器地址, CP0_addr</strong></p></li><li><p>指令格式 ：</p><p>010000 || 00100 || rt || rd || 00000000000</p><p>mtc0 rt,rd</p></li><li><p>MCU ：</p><ul><li>CP0_WE_D</li><li>T_rs_use = T_rt_use = 3（这里rt的真实使用时间是3，但是并不会对暂停/转发造成影响，T<sub>use</sub> >= T<sub>new</sub>成立，可以通过转发解决）</li><li>T_new = 0</li></ul></li><li><p>写入时应当注意 ：Cause寄存器(13)不允许写入，EPC允许写入，<strong>SR寄存器部分字段允许写入，其他不允许写入的字段要保持为0</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>if</span>(A2 <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>12</span>) 
</span></span><span style=display:flex><span><span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	`IM <span style=color:#ff79c6>&lt;=</span> D_in[<span style=color:#bd93f9>15</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>10</span>];
</span></span><span style=display:flex><span>	`EXL <span style=color:#ff79c6>&lt;=</span> D_in[<span style=color:#bd93f9>1</span>];
</span></span><span style=display:flex><span>	`IE <span style=color:#ff79c6>&lt;=</span> D_in[<span style=color:#bd93f9>0</span>];
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (A2 <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>14</span>) EPC <span style=color:#ff79c6>&lt;=</span> D_in;
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=mfc0--读取cp0中寄存器的值121314>mfc0 : 读取CP0中寄存器的值(12/13/14)<a hidden class=anchor aria-hidden=true href=#mfc0--读取cp0中寄存器的值121314>#</a></h4><p>​ <strong>在M级CP0输出结果与DE输出结果之间加MUX</strong></p><ul><li><p>指令格式 ：
010000 || 00000 || rt || rd || 00000000000</p><p>mfc0 rt,rd</p></li><li><p>MCU :</p><ul><li>RegWrite</li><li>T_rs_use = T_rt_use = 3</li><li>T_new = 3</li></ul></li></ul><h4 id=eret--从中断异常处理中返回>eret : 从中断/异常处理中返回<a hidden class=anchor aria-hidden=true href=#eret--从中断异常处理中返回>#</a></h4><ul><li><p>MCU中判断后进行流水，D_eret，在M级进行使用跳出异常处理</p><p><strong>eret是错误最易发生的一个指令，对于eret的要求有:</strong></p><ul><li><p>跳转到CP0中EPC寄存器存储的受害PC</p></li><li><p>不执行eret后延迟槽中的指令</p><p>不执行延迟槽中的指令我的实现方式(比较优雅 较为推荐)为 ：在D级识别到eret指令后，在F级直接插入nop，同时npc中选择EPC端口</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span>\\ D_MCU_eret <span style=color:#ff79c6>:</span> D_eret
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> D_eret  <span style=color:#ff79c6>=</span> op_eret;
</span></span><span style=display:flex><span>\\ F<span style=color:#ff79c6>-</span>D <span style=color:#8be9fd>reg</span> 当F级出现取指异常或D级识别到eret指令时 传递指令nop
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> F_instr_new <span style=color:#ff79c6>=</span> (F_AdEL) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span> <span style=color:#ff79c6>:</span> (D_eret) <span style=color:#ff79c6>:</span> F_instr;
</span></span><span style=display:flex><span>\\ D_npc 
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> npc <span style=color:#ff79c6>=</span> (D_eret) <span style=color:#ff79c6>?</span> EPC <span style=color:#ff79c6>:</span> ...
</span></span></code></pre></td></tr></table></div></div><p>同时还有两种可能的实现方式 ：</p><ol><li><p>在D级识别到eret指令后，清D级延迟槽，但是此时应当注意清空延迟槽的条件为(clr && !stall)，即判断当前非暂停，举一个简单的例子就可以知道，例如D:eret E:mtc0</p><p>**一定要注意信号之间的优先级！**下面给出D级流水线寄存器的代码(我采用集中式译码，好臃肿，更加推荐分布式译码(bushi))</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>always</span>@(<span style=color:#ff79c6>posedge</span> clk)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span>(reset )<span style=color:#ff79c6>begin</span> 
</span></span><span style=display:flex><span>	instr <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	pc <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	pc8 <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	ExcCode <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>5</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	BD <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span>  (req) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	instr <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	pc <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h0000</span>_4180;
</span></span><span style=display:flex><span>	pc8 <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h0000</span>_4188;
</span></span><span style=display:flex><span>	ExcCode <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>5</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	BD <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (clr <span style=color:#ff79c6>&amp;&amp;</span> en) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>    instr <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	pc <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	pc8 <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	ExcCode <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>5</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	BD <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (en) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	instr <span style=color:#ff79c6>&lt;=</span> F_instr;
</span></span><span style=display:flex><span>	pc <span style=color:#ff79c6>&lt;=</span> F_pc;
</span></span><span style=display:flex><span>	pc8 <span style=color:#ff79c6>&lt;=</span> F_pc8;
</span></span><span style=display:flex><span>	ExcCode <span style=color:#ff79c6>&lt;=</span> F_ExcCode;
</span></span><span style=display:flex><span>	BD <span style=color:#ff79c6>&lt;=</span> F_BD;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>   <span style=color:#6272a4>//stall
</span></span></span><span style=display:flex><span>	instr <span style=color:#ff79c6>&lt;=</span> instr;
</span></span><span style=display:flex><span>	pc <span style=color:#ff79c6>&lt;=</span> pc;
</span></span><span style=display:flex><span>	pc8 <span style=color:#ff79c6>&lt;=</span> pc8;
</span></span><span style=display:flex><span>	ExcCode <span style=color:#ff79c6>&lt;=</span> ExcCode;
</span></span><span style=display:flex><span>	BD <span style=color:#ff79c6>&lt;=</span> BD;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>在F级输入pc取指时进行特判(这种写法我没有通过，报错处理延迟槽中断后没有跳回跳转指令)，不过多叙述</p></li></ol></li></ul></li></ul><h4 id=syscall--系统调用异常>syscall : 系统调用异常<a hidden class=anchor aria-hidden=true href=#syscall--系统调用异常>#</a></h4><ul><li>在D级MCU中识别出来并判断为异常即可</li></ul><h3 id=05关于流水线寄存器pc选择中的信号优先级问题>0.5关于流水线寄存器/PC选择中的信号优先级问题<a hidden class=anchor aria-hidden=true href=#05关于流水线寄存器pc选择中的信号优先级问题>#</a></h3><ul><li><p><strong>2023秋计算机组成教程中课程组对于信号的优先级规定如下</strong></p></li><li><p><strong>reset > req > stall</strong></p></li></ul><p>​ 在流水线寄存器和IFU中pc选择时需要对信号优先级进行判断，<strong>推荐使用if_else_if_else语句实现对优先级的判断</strong>，非常重要！</p><p><strong>流水线寄存器，以信号最复杂的E级为例</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span>lways@(<span style=color:#ff79c6>posedge</span> clk) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span>(reset) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span>(req) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span>(clr)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	pc <span style=color:#ff79c6>&lt;=</span>  D_pc ;   <span style=color:#6272a4>// 注意E级暂停时也要对pc,BD信号进行流水
</span></span></span><span style=display:flex><span>	pc8 <span style=color:#ff79c6>&lt;=</span>  D_pc8 ;
</span></span><span style=display:flex><span>	BD <span style=color:#ff79c6>&lt;=</span>  D_BD;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>IFU中PC的选择</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>always</span>@(<span style=color:#ff79c6>posedge</span> clk)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span>(reset)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	PC <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h0000</span>_3000;
</span></span><span style=display:flex><span>	PC8 <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h0000</span>_3008;
</span></span><span style=display:flex><span>	tmp <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (req) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	PC <span style=color:#ff79c6>&lt;=</span> npc;
</span></span><span style=display:flex><span>	PC8 <span style=color:#ff79c6>&lt;=</span> npc <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b1000</span>;
</span></span><span style=display:flex><span>	tmp <span style=color:#ff79c6>&lt;=</span> npc <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>32&#39;h0000</span>_3000;
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (en)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	PC <span style=color:#ff79c6>&lt;=</span> npc;
</span></span><span style=display:flex><span>	PC8 <span style=color:#ff79c6>&lt;=</span> npc <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b1000</span>;
</span></span><span style=display:flex><span>	tmp <span style=color:#ff79c6>&lt;=</span> npc <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>32&#39;h0000</span>_3000;
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	PC <span style=color:#ff79c6>&lt;=</span> PC;
</span></span><span style=display:flex><span>	PC8 <span style=color:#ff79c6>&lt;=</span>PC8;
</span></span><span style=display:flex><span>	tmp <span style=color:#ff79c6>&lt;=</span> tmp;
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=1cp0>1.CP0<a hidden class=anchor aria-hidden=true href=#1cp0>#</a></h3><h4 id=0数据通路>0.数据通路<a hidden class=anchor aria-hidden=true href=#0数据通路>#</a></h4><ul><li>**宏观PC：**为了将我们的流水线CPU封装为单周期CPU（至少在外界看来是这个样子），提出宏观PC的概念，<strong>在宏观PC之前的地址对应的指令均已经完成，在宏观PC之后的地址对应的指令还未完成</strong>，依据这一特点我们知道应当将CP0(Coprocessor0)放置在M级流水线。</li></ul><p><img alt=image-20231205180537987 loading=lazy src=/img/image-20231205180537987.png></p><h4 id=1需要处理的异常>1.需要处理的异常<a hidden class=anchor aria-hidden=true href=#1需要处理的异常>#</a></h4><h5 id=0异常优先级>0.异常优先级<a hidden class=anchor aria-hidden=true href=#0异常优先级>#</a></h5><ul><li>一条指令发生多个异常，考虑最先发生的异常(F>D>E>M)</li><li>多条指令发生异常，也有限考虑最先发生的异常(M>E>D>F)，即将M级异常传入CP0</li></ul><h5 id=1f级异常>1.F级异常：<a hidden class=anchor aria-hidden=true href=#1f级异常>#</a></h5><ul><li>PC地址没有字对齐（AdEL）</li><li>PC地址超过0x3000 ~ 0x6ffc（AdEL）</li><li>还需要判断D级不是eret指令，因为eret后“延迟槽”中指令不被执行，即使在F级发生异常也不应被处理/进入异常处理程序。</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>assign</span> F_ExcCode <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>!</span>D_eret) <span style=color:#ff79c6>&amp;&amp;</span> (F_pc[<span style=color:#bd93f9>1</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b00</span>) <span style=color:#ff79c6>||</span> (F_pc <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>32&#39;h0000</span>_3000) <span style=color:#ff79c6>||</span> (F_pc <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>32&#39;h0000</span>_3fffc) <span style=color:#ff79c6>?</span> ADEL <span style=color:#ff79c6>:</span> NONE;
</span></span></code></pre></td></tr></table></div></div><p><strong>注意F级发生取指错误后要流水空指令nop递交到CP0</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span>F_instr_new <span style=color:#ff79c6>=</span> (F_AdEL) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span> <span style=color:#ff79c6>:</span> (D_eret) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span> <span style=color:#ff79c6>:</span> F_instr;
</span></span></code></pre></td></tr></table></div></div><h5 id=1d级异常>1.D级异常：<a hidden class=anchor aria-hidden=true href=#1d级异常>#</a></h5><ul><li><p>未知的指令码（RI）</p><p>从MCU中添加输出信号<code>invalid_D</code>，标记当前指令是否为无效指令，<strong>注意在MCU中识别nop指令</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>assign</span> invalid_D <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>!</span>(cal_R <span style=color:#ff79c6>|</span> cal_I <span style=color:#ff79c6>|</span> store <span style=color:#ff79c6>|</span> load <span style=color:#ff79c6>|</span> branch <span style=color:#ff79c6>|</span> md <span style=color:#ff79c6>|</span> mt <span style=color:#ff79c6>|</span> mf <span style=color:#ff79c6>|</span> op_jal <span style=color:#ff79c6>|</span> op_jr <span style=color:#ff79c6>|</span> op_mfc0 <span style=color:#ff79c6>|</span> op_mtc0 <span style=color:#ff79c6>|</span> op_syscall <span style=color:#ff79c6>|</span> op_eret <span style=color:#ff79c6>|</span> op_nop <span style=color:#ff79c6>|</span> op_syscall);
</span></span></code></pre></td></tr></table></div></div></li></ul><ul><li><p>syccall 系统调用异常</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>assign</span> D_ExcCode_fixed <span style=color:#ff79c6>=</span> (D_ExcCode) <span style=color:#ff79c6>?</span> D_ExcCode <span style=color:#ff79c6>:</span> 
</span></span><span style=display:flex><span>								 (invalid_D) <span style=color:#ff79c6>?</span> RI <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (D_syscall) <span style=color:#ff79c6>?</span> SYSCALL <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 NONE;
</span></span></code></pre></td></tr></table></div></div></li></ul><h5 id=2e级异常>2.E级异常：<a hidden class=anchor aria-hidden=true href=#2e级异常>#</a></h5><ul><li><p>addi、add、sub计算溢出（Ov）: 在MCU中添加输出信号<code>isAriOv_D</code>表示是不是需要判断溢出的运算指令</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>assign</span> isAriOv_D <span style=color:#ff79c6>=</span> op_add <span style=color:#ff79c6>|</span> op_addi <span style=color:#ff79c6>|</span> op_sub;
</span></span></code></pre></td></tr></table></div></div></li><li><p>load类指令计算地址时加法溢出（AdEL）</p></li><li><p>store类指令计算地址时加法溢出（AdES）</p></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>assign</span> E_ExcCode_fixed <span style=color:#ff79c6>=</span> (E_ExcCode) <span style=color:#ff79c6>?</span> E_ExcCode <span style=color:#ff79c6>:</span> 
</span></span><span style=display:flex><span>								 (overflow_E <span style=color:#ff79c6>&amp;&amp;</span> (DMOp_E <span style=color:#ff79c6>==</span> sw <span style=color:#ff79c6>||</span> DMOp_E <span style=color:#ff79c6>==</span> sh <span style=color:#ff79c6>||</span> DMOp_E <span style=color:#ff79c6>==</span> sb)) <span style=color:#ff79c6>?</span> ADES <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (overflow_E <span style=color:#ff79c6>&amp;&amp;</span> (DMOp_E <span style=color:#ff79c6>==</span> lw <span style=color:#ff79c6>||</span> DMOp_E <span style=color:#ff79c6>==</span> lh <span style=color:#ff79c6>||</span> DMOp_E <span style=color:#ff79c6>==</span> lb)) <span style=color:#ff79c6>?</span> ADEL <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (overflow_E <span style=color:#ff79c6>&amp;&amp;</span> isAriOv_E) <span style=color:#ff79c6>?</span> OV <span style=color:#ff79c6>:</span> NONE;
</span></span></code></pre></td></tr></table></div></div><h6 id=补位法溢出判断>补位法溢出判断<a hidden class=anchor aria-hidden=true href=#补位法溢出判断>#</a></h6><p>​ 依据add,addi,sub原始的指令RTL中对溢出的判断编写.</p><pre tabindex=0><code class=language-RTL data-lang=RTL>temp = (GPR[rs]31 || GPR[rs]) + (GPR[rt]31 || GPR[rt]) 
if temp32 ≠ temp31 then 
	SignalException(IntegerOverflow) 
else 
	GPR[rd] ← temp31..0 
endif 
</code></pre><p>​ 以add为例翻译为对应的verilog代码如下</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span>	ext_A <span style=color:#ff79c6>=</span> {src_A[<span style=color:#bd93f9>31</span>],src_A};
</span></span><span style=display:flex><span>	ext_B <span style=color:#ff79c6>=</span> {src_B[<span style=color:#bd93f9>31</span>],src_B};
</span></span><span style=display:flex><span>	ext_AO <span style=color:#ff79c6>=</span> ext_A <span style=color:#ff79c6>+</span> ext_B;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span>(ext_AO[<span style=color:#bd93f9>32</span>] <span style=color:#ff79c6>!=</span> ext_AO[<span style=color:#bd93f9>31</span>]) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>		overflow <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b1</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>		E_AO <span style=color:#ff79c6>=</span> ext_AO[<span style=color:#bd93f9>31</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>0</span>];
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=3m级异常>3.M级异常：<a hidden class=anchor aria-hidden=true href=#3m级异常>#</a></h5><ul><li><p>lw取数地址未 4 字节对齐（AdEL）</p></li><li><p>lh取数地址未与 2 字节对齐（AdEL）</p></li><li><p>lh、lb取 Timer 寄存器的值（AdEL）</p></li><li><p>load型指令取数地址超出 DM、Timer0、Timer1、中断发生器的范围（AdEL）</p></li><li><p>sw存数地址未 4 字节对齐（AdES）</p></li><li><p>sh存数地址未 2 字节对齐（AdES）</p></li><li><p>sh、sb存 Timer 寄存器的值（AdES）</p></li><li><p>store型指令向计时器的 Count 寄存器存值（AdES）</p><p><img alt=image-20231205211833450 loading=lazy src=/img/image-20231205211833450.png></p></li><li><p>store型指令存数地址超出 DM、Timer0、Timer1、中断发生器的范围（AdES）</p></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#8be9fd>wire</span> lhlb_tag <span style=color:#ff79c6>=</span> (DMOp_M <span style=color:#ff79c6>==</span> lh <span style=color:#ff79c6>||</span> DMOp_M <span style=color:#ff79c6>==</span> lb);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> load_tag <span style=color:#ff79c6>=</span> (DMOp_M <span style=color:#ff79c6>==</span> lw <span style=color:#ff79c6>||</span> DMOp_M <span style=color:#ff79c6>==</span> lh <span style=color:#ff79c6>||</span> DMOp_M <span style=color:#ff79c6>==</span> lb);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> shsb_tag <span style=color:#ff79c6>=</span> (DMOp_M <span style=color:#ff79c6>==</span> sh <span style=color:#ff79c6>||</span> DMOp_M <span style=color:#ff79c6>==</span> sb);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> store_tag <span style=color:#ff79c6>=</span> (DMOp_M <span style=color:#ff79c6>==</span> sw <span style=color:#ff79c6>||</span> DMOp_M <span style=color:#ff79c6>==</span> sh <span style=color:#ff79c6>||</span> DMOp_M <span style=color:#ff79c6>==</span> sb);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> timer_addr <span style=color:#ff79c6>=</span> (M_AO <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>32&#39;h7f00</span> <span style=color:#ff79c6>&amp;&amp;</span> M_AO <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h7f0b</span>) <span style=color:#ff79c6>||</span> (M_AO <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>32&#39;h7f10</span> <span style=color:#ff79c6>&amp;&amp;</span> M_AO <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h7f1b</span>);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> dm_addr <span style=color:#ff79c6>=</span> (M_AO <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>32&#39;h0000</span> <span style=color:#ff79c6>&amp;&amp;</span> M_AO <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h2fff</span>);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> interrupt_addr <span style=color:#ff79c6>=</span> (M_AO <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>32&#39;h7f20</span> <span style=color:#ff79c6>&amp;&amp;</span> M_AO <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h7f23</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> M_ExcCode_fixed <span style=color:#ff79c6>=</span> (M_ExcCode) <span style=color:#ff79c6>?</span> M_ExcCode <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (DMOp_M <span style=color:#ff79c6>==</span> lw <span style=color:#ff79c6>&amp;&amp;</span> (M_AO[<span style=color:#bd93f9>1</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b00</span>)) <span style=color:#ff79c6>?</span> ADEL <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (DMOp_M <span style=color:#ff79c6>==</span> lh <span style=color:#ff79c6>&amp;&amp;</span> (M_AO[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>)) <span style=color:#ff79c6>?</span> ADEL <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (lhlb_tag <span style=color:#ff79c6>&amp;&amp;</span> timer_addr) <span style=color:#ff79c6>?</span> ADEL <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (load_tag <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>dm_addr <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>timer_addr <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>interrupt_addr) <span style=color:#ff79c6>?</span> ADEL <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (DMOp_M <span style=color:#ff79c6>==</span> sw <span style=color:#ff79c6>&amp;&amp;</span> (M_AO[<span style=color:#bd93f9>1</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b00</span>)) <span style=color:#ff79c6>?</span> ADES <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (DMOp_M <span style=color:#ff79c6>==</span> sh <span style=color:#ff79c6>&amp;&amp;</span> (M_AO[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>)) <span style=color:#ff79c6>?</span> ADES <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (shsb_tag <span style=color:#ff79c6>&amp;&amp;</span> timer_addr) <span style=color:#ff79c6>?</span> ADES <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>								 (store_tag <span style=color:#ff79c6>&amp;&amp;</span> timer_addr <span style=color:#ff79c6>&amp;&amp;</span> M_AO[<span style=color:#bd93f9>3</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>4&#39;h8</span>) <span style=color:#ff79c6>?</span> ADES <span style=color:#ff79c6>:</span> 
</span></span><span style=display:flex><span>								 (store_tag <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>dm_addr <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>timer_addr <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>interrupt_addr) <span style=color:#ff79c6>?</span> ADES <span style=color:#ff79c6>:</span> NONE;
</span></span></code></pre></td></tr></table></div></div><h4 id=2端口定义列表>2.端口定义列表<a hidden class=anchor aria-hidden=true href=#2端口定义列表>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th><th>产生来源和机制</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td>时钟信号</td><td></td></tr><tr><td>reset</td><td>I</td><td>1</td><td>同步复位信号</td><td></td></tr><tr><td>A1</td><td>I</td><td>5</td><td>读CP0寄存器编号</td><td>指令mfc0</td></tr><tr><td>A2</td><td>I</td><td>5</td><td>写CP0寄存器编号</td><td>指令mtc0</td></tr><tr><td>D_in</td><td>I</td><td>32</td><td>写入CP0寄存器的数据</td><td>指令mtc0</td></tr><tr><td>M_pc</td><td>I</td><td>32</td><td>M级PC:发生中断/异常时的PC</td><td></td></tr><tr><td>M_ExcCode</td><td>I</td><td>5</td><td>中断/异常的类型</td><td>异常功能部件</td></tr><tr><td>BD_in</td><td>I</td><td>1</td><td>分支延迟槽指令标志</td><td></td></tr><tr><td>HWInt</td><td>I</td><td>6</td><td>6个外部设备的中断</td><td>外部设备</td></tr><tr><td>WE</td><td>I</td><td>1</td><td>CP0寄存器写使能</td><td>指令mtc0</td></tr><tr><td>EXTClr</td><td>I</td><td>1</td><td>SR的EXL位置零</td><td>eret_M控制信号输入</td></tr><tr><td>req</td><td>O</td><td>1</td><td>异常/中断请求</td><td>CP0模块确认响应异常/中断</td></tr><tr><td>EPC_out</td><td>O</td><td>32</td><td>EPC寄存器输出</td><td></td></tr><tr><td>D_out</td><td>O</td><td>32</td><td>CP0寄存器输出数据</td><td>指令mfc0</td></tr></tbody></table><h4 id=3内部寄存器列表>3.内部寄存器列表<a hidden class=anchor aria-hidden=true href=#3内部寄存器列表>#</a></h4><p>​ <strong>将SR,Cause,EPC都实现为32位！</strong></p><table><thead><tr><th style=text-align:left>寄存器</th><th style=text-align:left>编号</th><th style=text-align:left>功能</th></tr></thead><tbody><tr><td style=text-align:left>SR</td><td style=text-align:left>12</td><td style=text-align:left>配置异常的功能。</td></tr><tr><td style=text-align:left>Cause</td><td style=text-align:left>13</td><td style=text-align:left>记录异常发生的原因和情况。</td></tr><tr><td style=text-align:left>EPC</td><td style=text-align:left>14</td><td style=text-align:left>记录异常处理结束后需要返回的 PC。</td></tr></tbody></table><table><thead><tr><th style=text-align:left>寄存器</th><th style=text-align:left>功能域</th><th style=text-align:left>位域</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>SR（State Register）</td><td style=text-align:left>IM（Interrupt Mask）</td><td style=text-align:left>15:10</td><td style=text-align:left>分别对应六个外部中断，相应位置 1 表示允许中断，置 0 表示禁止中断。这是一个被动的功能，只能通过 <code>mtc0</code> 这个指令修改，通过修改这个功能域，我们可以屏蔽一些中断。</td></tr><tr><td style=text-align:left>SR（State Register）</td><td style=text-align:left>EXL（Exception Level）</td><td style=text-align:left>1</td><td style=text-align:left>任何异常发生时置位，这会强制进入核心态（也就是进入异常处理程序）并禁止中断。</td></tr><tr><td style=text-align:left>SR（State Register）</td><td style=text-align:left>IE（Interrupt Enable）</td><td style=text-align:left>0</td><td style=text-align:left>全局中断使能，该位置 1 表示允许中断，置 0 表示禁止中断。</td></tr><tr><td style=text-align:left>Cause</td><td style=text-align:left>BD（Branch Delay）</td><td style=text-align:left>31</td><td style=text-align:left>当该位置 1 的时候，EPC 指向当前指令的前一条指令（一定为跳转），否则指向当前指令。</td></tr><tr><td style=text-align:left>Cause</td><td style=text-align:left>IP（Interrupt Pending）</td><td style=text-align:left>15:10</td><td style=text-align:left>为 6 位待决的中断位，分别对应 6 个外部中断，相应位置 1 表示有中断，置 0 表示无中断，将会每个周期被修改一次，修改的内容来自计时器和外部中断。</td></tr><tr><td style=text-align:left>Cause</td><td style=text-align:left>ExcCode</td><td style=text-align:left>6:2</td><td style=text-align:left>异常编码，记录当前发生的是什么异常。</td></tr><tr><td style=text-align:left>EPC</td><td style=text-align:left>-</td><td style=text-align:left>-</td><td style=text-align:left>记录异常处理结束后需要返回的 PC。</td></tr></tbody></table><h4 id=4设计思路>4.设计思路<a hidden class=anchor aria-hidden=true href=#4设计思路>#</a></h4><p>​ 在CP0中进行处理的指令有mfc0,mtc0</p><ul><li>mfc0 (读)<ul><li>SR</li><li>Cause</li><li>EPC</li></ul></li><li>mtc0 (写/Cause only read)<ul><li>SR</li><li>EPC</li></ul></li></ul><p>​ 在CP0中定义三个32位寄存器，并使用宏定义定义寄存器的功能字段</p><h5 id=1产生异常中断请求>1.产生异常/中断请求<a hidden class=anchor aria-hidden=true href=#1产生异常中断请求>#</a></h5><p><strong>使用位缩减运算符 | : result = a[0] | a[1] | &mldr;.</strong></p><p><strong>注：外部中断比内部异常优先级更高，即有有中断先处理中断，后处理异常</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#8be9fd>wire</span> int_req <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>|</span>(HWInt <span style=color:#ff79c6>&amp;</span> `IM)) <span style=color:#ff79c6>&amp;</span> (<span style=color:#ff79c6>!</span>`EXL) <span style=color:#ff79c6>&amp;</span> (`IE);  <span style=color:#6272a4>// (某一个外设上有中断且允许中断) &amp; (当前不在中断处理中) &amp; (允许中断)
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> exc_req <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>|</span> M_ExcCode) <span style=color:#ff79c6>&amp;</span> (<span style=color:#ff79c6>!</span>`EXL); <span style=color:#6272a4>// （有异常）&amp; （当前不在中断处理中）
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> req <span style=color:#ff79c6>=</span> int_req <span style=color:#ff79c6>|</span> exc_req; <span style=color:#6272a4>// request
</span></span></span></code></pre></td></tr></table></div></div><h5 id=2epc处理>2.EPC处理<a hidden class=anchor aria-hidden=true href=#2epc处理>#</a></h5><p>​ 对于EPC要考虑延迟槽的问题</p><ul><li><p>若产生异常的为延迟槽中的指令，则跳回到跳转指令，即M_pc - 4</p><pre tabindex=0><code class=language-verilog] data-lang=verilog]>wire [31:2] tmpEPC = (req) ? ((M_BD) ? M_pc[31:2] -1 : M_pc[31:2]) : EPC;
assign EPC_out = {tmpEPC,2&#39;b00}; // 4 byte align
</code></pre><p><strong>注：对PC进行字对齐处理，后补2&rsquo;b00</strong></p></li><li><p>需要注意的是EPC保存当前指令PC的条件是req，即发生了异常时才会对EPC进行更新，这样就保证了EPC中的值在进入异常处理程序之后不会发生改变，识别到eret指令之后跳回到异常指令。</p></li></ul><h5 id=3对于延迟槽指令的判断>3.对于延迟槽指令的判断<a hidden class=anchor aria-hidden=true href=#3对于延迟槽指令的判断>#</a></h5><p>​ 延迟槽即跳转指令的下一条指令，所以标记延迟槽指令只需要识别出他的上一条指令是跳转指令(NPCOp_D != 3&rsquo;b000)，并在F级跟随该指令进行流水到M级进行判断即可(无论跳转指令是否跳转)。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span>F_BD <span style=color:#ff79c6>=</span> (NPCOp_D <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>3</span><span style=color:#bd93f9>&#39;b000</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=2nop和req在流水线寄存器中的问题>2.nop和req在流水线寄存器中的问题<a hidden class=anchor aria-hidden=true href=#2nop和req在流水线寄存器中的问题>#</a></h3><h5 id=nop>nop<a hidden class=anchor aria-hidden=true href=#nop>#</a></h5><p>​ 如果沿用P6/P5中暂停时在E级插入nop的写法，这个nop指令的pc和bd信号都为0。此时M级宏观PC会显示错误的值，并且如果此时发生了中断，CP0中存入错误的EPC值。<strong>正确的做法是在暂停时让pc和bd继续流水</strong></p><h5 id=req>req<a hidden class=anchor aria-hidden=true href=#req>#</a></h5><p>​ 发生异常时，需要跳转到异常响应代码并清空流水线内还没有执行完的指令。直接将pc清为0会导致第一条处理异常的代码到达M级之前，宏观PC都是0，故req信号来时需要将pc置为异常代码地址<code>32'h0000_4180</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#6272a4>//以E级为例
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>always</span>@(<span style=color:#ff79c6>posedge</span> clk) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span>(reset <span style=color:#ff79c6>|</span> stall <span style=color:#ff79c6>|</span> req) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>        pc <span style=color:#ff79c6>&lt;=</span> (stall) <span style=color:#ff79c6>?</span> D_pc <span style=color:#ff79c6>:</span> (req <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>32&#39;h0000</span>_4180 <span style=color:#ff79c6>:</span> <span style=color:#bd93f9>32&#39;h0</span>);
</span></span><span style=display:flex><span>        pc8 <span style=color:#ff79c6>&lt;=</span> (stall) <span style=color:#ff79c6>?</span> D_pc8 <span style=color:#ff79c6>:</span> (req <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>32&#39;h0000</span>_4188 <span style=color:#ff79c6>:</span> <span style=color:#bd93f9>32&#39;h0</span>);
</span></span><span style=display:flex><span>        BD <span style=color:#ff79c6>&lt;=</span> (stall) <span style=color:#ff79c6>?</span> D_BD <span style=color:#ff79c6>:</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3npc>3.NPC<a hidden class=anchor aria-hidden=true href=#3npc>#</a></h3><h4 id=1端口定义列表>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>req</td><td>I</td><td>1</td><td>中断请求</td></tr><tr><td>D_eret</td><td>I</td><td>1</td><td>D级是否为eret指令</td></tr><tr><td>b_result</td><td>I</td><td>1</td><td>B类跳转指令是否满足跳转条件</td></tr><tr><td>NPCOp</td><td>I</td><td>3</td><td>地址选择</td></tr><tr><td>F_pc</td><td>I</td><td>32</td><td>F级PC输入</td></tr><tr><td>D_pc</td><td>I</td><td>32</td><td>D级PC输入</td></tr><tr><td>b_offset</td><td>I</td><td>32</td><td>B类跳转指令偏移</td></tr><tr><td>j_address</td><td>I</td><td>26</td><td>J类跳转指令偏移</td></tr><tr><td>reg_address</td><td>I</td><td>32</td><td>寄存器中保存的地址</td></tr><tr><td>npc</td><td>O</td><td>32</td><td>输出下一PC</td></tr></tbody></table><h4 id=2pc选择逻辑>2.PC选择逻辑<a hidden class=anchor aria-hidden=true href=#2pc选择逻辑>#</a></h4><ul><li>若发生req中断，跳转到异常处理程序地址 : 32&rsquo;h0000_4180</li><li>若执行eret指令，eret将保存在CP0的地址写入PC，从而实现从处理异常程序中跳回到主程序 (同时保证了不会指令eret延迟槽中的指令)</li><li>在D级识别到eret，NPC选择EPC输入到F级</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#6272a4>//NPC
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> npc <span style=color:#ff79c6>=</span> (req) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>32&#39;h0000</span>_4180 <span style=color:#ff79c6>:</span> 
</span></span><span style=display:flex><span>    			 (D_eret) <span style=color:#ff79c6>?</span> <span style=color:#8be9fd;font-style:italic>EPC:</span>
</span></span><span style=display:flex><span>				 (NPCOp <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>3</span><span style=color:#bd93f9>&#39;b000</span>) <span style=color:#ff79c6>?</span> F_pc <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;d4</span> <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>				 (NPCOp <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>3</span><span style=color:#bd93f9>&#39;b001</span> <span style=color:#ff79c6>&amp;&amp;</span> b_result) <span style=color:#ff79c6>?</span> D_pc <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;d4</span> <span style=color:#ff79c6>+</span> (b_offset <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b10</span>) <span style=color:#ff79c6>:</span> 
</span></span><span style=display:flex><span>				 (NPCOp <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>3</span><span style=color:#bd93f9>&#39;b010</span>) <span style=color:#ff79c6>?</span> {ADD4[<span style=color:#bd93f9>31</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>28</span>],j_address,<span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b00</span>} <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>				 (NPCOp <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>3</span><span style=color:#bd93f9>&#39;b011</span>) <span style=color:#ff79c6>?</span> reg_address <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>				 (F_pc <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;d4</span>); 
</span></span></code></pre></td></tr></table></div></div><h3 id=4bridge>4.Bridge<a hidden class=anchor aria-hidden=true href=#4bridge>#</a></h3><h4 id=1端口定义列表-1>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-1>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>Addr_in</td><td>I</td><td>32</td><td>写入/读取外设的地址</td></tr><tr><td>WD_in</td><td>I</td><td>32</td><td>写入外设单元的数据</td></tr><tr><td>byteen</td><td>I</td><td>4</td><td>写入外设单元的使能</td></tr><tr><td>DM_RD</td><td>I</td><td>32</td><td>DM读取值的输入</td></tr><tr><td>T1_RD</td><td>I</td><td>32</td><td>Timer1读取值的输入</td></tr><tr><td>T0_RD</td><td>I</td><td>32</td><td>Timer0读取值的输入</td></tr><tr><td>Addr_out</td><td>O</td><td>32</td><td>写入/读取外设的地址</td></tr><tr><td>WD_out</td><td>O</td><td>32</td><td>写入外设单元的数据</td></tr><tr><td>RD_out</td><td>O</td><td>32</td><td>外设单元的读取值输出</td></tr><tr><td>DM_WE</td><td>O</td><td>4</td><td>DM写入使能</td></tr><tr><td>T1_WE</td><td>O</td><td>1</td><td>Timer1写入使能</td></tr><tr><td>T0_WE</td><td>O</td><td>1</td><td>Timer0写入使能</td></tr></tbody></table><h4 id=2实现代码对地址的判断>2.实现代码（对地址的判断）<a hidden class=anchor aria-hidden=true href=#2实现代码对地址的判断>#</a></h4><p>​ 需要注意的是我们写入的外设中，DM支持按字节访问，即byteen写入使能信号4位表示，写入Timer是按字写入的，一位写入使能信号。</p><p>观察官方Timer端口定义：</p><ul><li>input [31:2] Addr</li><li>input [31:0] Din</li></ul><p>说明Timer中寄存器为按字写入</p><p>**Timer按字写入：byteen = 4&rsquo;b1111(sw指令) 使用位缩减运算符变为一位 : &amp;byteen = 1&rsquo;b1 **</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>assign</span> Addr_out <span style=color:#ff79c6>=</span> Addr_in;
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> WD_out <span style=color:#ff79c6>=</span> WD_in;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> DM_addr <span style=color:#ff79c6>=</span> (Addr_in <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>32&#39;h0000</span> <span style=color:#ff79c6>&amp;&amp;</span> Addr_in <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h2fff</span>);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> T0_addr <span style=color:#ff79c6>=</span> (Addr_in <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>32&#39;h7f00</span> <span style=color:#ff79c6>&amp;&amp;</span> Addr_in <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h7f0b</span>);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> T1_addr <span style=color:#ff79c6>=</span> (Addr_in <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>32&#39;h7f10</span> <span style=color:#ff79c6>&amp;&amp;</span> Addr_in <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32&#39;h7f1b</span>); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> DM_WE <span style=color:#ff79c6>=</span> (DM_addr) <span style=color:#ff79c6>?</span> byteen <span style=color:#ff79c6>:</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> T0_WE <span style=color:#ff79c6>=</span> (T0_addr) <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>&amp;</span>byteen <span style=color:#ff79c6>:</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> T1_WE <span style=color:#ff79c6>=</span> (T1_addr) <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>&amp;</span>byteen <span style=color:#ff79c6>:</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> RD_out <span style=color:#ff79c6>=</span> (DM_addr) <span style=color:#ff79c6>?</span> DM_RD <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>					 (T0_addr) <span style=color:#ff79c6>?</span> T0_RD <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>					 (T1_addr) <span style=color:#ff79c6>?</span> T1_RD <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>					 <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span></code></pre></td></tr></table></div></div><h3 id=5timer>5.Timer<a hidden class=anchor aria-hidden=true href=#5timer>#</a></h3><p>​ 课程组已经提供实现好的代码，两种模式的有限状态机，具体分析见思考题</p><h4 id=端口定义列表>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td>时钟信号</td></tr><tr><td>reset</td><td>I</td><td>1</td><td>同步复位信号</td></tr><tr><td>Addr</td><td>I</td><td>30</td><td>写入寄存器地址</td></tr><tr><td>Din</td><td>I</td><td>32</td><td>写入数据</td></tr><tr><td>Dout</td><td>O</td><td>32</td><td>读取数据</td></tr><tr><td>IRQ</td><td>O</td><td>1</td><td>定时/定周期产生的中断信号</td></tr></tbody></table><h3 id=6乘除槽处理>6.乘除槽处理<a hidden class=anchor aria-hidden=true href=#6乘除槽处理>#</a></h3><ul><li><strong>2023秋季计算机组成课程对于乘除槽的规定：</strong></li></ul><ul><li><code>mult</code> 在 E 级启动了乘法运算，流水到 M 级时产生了中断，此时无需停止乘法计算，其它乘除法指令同理。</li><li><code>mthi</code> 在 E 级修改了 HI 寄存器，流水到 M 级时产生了中断，此时无需恢复 HI 寄存器的值，<code>mtlo</code> 同理。</li><li><code>mult</code> 在 E 级，受害指令在 M 级，此时还未改变 MDU 状态，不应开始乘法计算，其它乘除法指令同理。</li><li><code>mthi</code> 在 E 级，受害指令在 M 级，此时还未改变 MDU 状态，不应修改 HI 寄存器的值，<code>mtlo</code> 同理。</li></ul><p>​ <strong>即发生异常时若已经启动了乘除槽就不管他，如果还没启动，就不允许启动，只需要在启动乘除槽的条件中加入!req</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>always</span>@(<span style=color:#ff79c6>posedge</span> clk)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span>(reset)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>		cnt <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		busy <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span>(start <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>req)<span style=color:#ff79c6>begin</span>   <span style=color:#6272a4>//start claculate
</span></span></span><span style=display:flex><span>		busy <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b1</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span>(busy) <span style=color:#ff79c6>begin</span> <span style=color:#6272a4>// continue to calculate is not influnced by req
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(cnt <span style=color:#ff79c6>==</span> delay <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>)<span style=color:#ff79c6>begin</span>  <span style=color:#6272a4>//next T : busy = 0
</span></span></span><span style=display:flex><span>			cnt <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>			busy <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			cnt <span style=color:#ff79c6>&lt;=</span> cnt <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b1</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>always</span>@(<span style=color:#ff79c6>posedge</span> clk)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span>(reset)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>		tmpHI <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		tmpLO <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		HI <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		LO <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span>  <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>busy <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>req) <span style=color:#ff79c6>begin</span> <span style=color:#6272a4>//start calcualte 
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span>(MDUOp)
</span></span><span style=display:flex><span>		mult <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			delay <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b0101</span>; <span style=color:#6272a4>//5
</span></span></span><span style=display:flex><span>			{tmpHI,tmpLO} <span style=color:#ff79c6>&lt;=</span> $signed(A) <span style=color:#ff79c6>*</span> $signed(B); 
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		multu <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			delay <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b0101</span>;
</span></span><span style=display:flex><span>			{tmpHI,tmpLO} <span style=color:#ff79c6>&lt;=</span> $unsigned(A) <span style=color:#ff79c6>*</span> $unsigned(B);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		div <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			delay <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b1010</span>; <span style=color:#6272a4>//10
</span></span></span><span style=display:flex><span>			tmpLO <span style=color:#ff79c6>&lt;=</span> $signed(A) <span style=color:#ff79c6>/</span> $signed(B);
</span></span><span style=display:flex><span>			tmpHI <span style=color:#ff79c6>&lt;=</span> $signed(A) <span style=color:#ff79c6>%</span> $signed(B);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		divu <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			delay <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b1010</span>;
</span></span><span style=display:flex><span>			tmpLO <span style=color:#ff79c6>&lt;=</span> $unsigned(A) <span style=color:#ff79c6>/</span> $unsigned(B);
</span></span><span style=display:flex><span>			tmpHI <span style=color:#ff79c6>&lt;=</span> $unsigned(A) <span style=color:#ff79c6>%</span> $unsigned(B);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		mthi <span style=color:#ff79c6>:</span> HI <span style=color:#ff79c6>&lt;=</span> A;
</span></span><span style=display:flex><span>		mtlo <span style=color:#ff79c6>:</span> LO <span style=color:#ff79c6>&lt;=</span> A;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>endcase</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>  <span style=color:#6272a4>// // continue to calculate is not influnced by req
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(cnt <span style=color:#ff79c6>==</span> delay <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b1</span>)<span style=color:#ff79c6>begin</span>  <span style=color:#6272a4>// next T : busy = 0;
</span></span></span><span style=display:flex><span>			HI <span style=color:#ff79c6>&lt;=</span> tmpHI;
</span></span><span style=display:flex><span>			LO <span style=color:#ff79c6>&lt;=</span> tmpLO;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			HI <span style=color:#ff79c6>&lt;=</span> HI;
</span></span><span style=display:flex><span>			LO <span style=color:#ff79c6>&lt;=</span> LO;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=二测试方案>二.测试方案<a hidden class=anchor aria-hidden=true href=#二测试方案>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span>text
</span></span><span style=display:flex><span>la	$ra, pos_1
</span></span><span style=display:flex><span>addi	$ra, $ra, <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>jr	$ra
</span></span><span style=display:flex><span>ori	$s0, $<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>ori	$s0, $<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>200</span> #invalid
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>pos_1:</span> 
</span></span><span style=display:flex><span>addi	$s1, $s0, <span style=color:#bd93f9>20</span> #invalid
</span></span><span style=display:flex><span>addi	$s1, $s0, <span style=color:#bd93f9>50</span> 
</span></span><span style=display:flex><span>     	             #F_exc_AdEL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nop                  #you can change it <span style=color:#bd93f9>0</span>xf000000f
</span></span><span style=display:flex><span>li	$t0, <span style=color:#bd93f9>13</span>
</span></span><span style=display:flex><span>mfc0	$t0, $t1     #D_exc_RI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lui	$s2, <span style=color:#bd93f9>0</span>x7fff
</span></span><span style=display:flex><span>lui	$s3, <span style=color:#bd93f9>0</span>x7fff
</span></span><span style=display:flex><span>add	$s4, $s2, $s3
</span></span><span style=display:flex><span>    #E_exc_Ov_add
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s2, $s3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lui	$s2, <span style=color:#bd93f9>0</span>x7fff
</span></span><span style=display:flex><span>addi	$s3, $s2, <span style=color:#bd93f9>0</span>x7fffffff  
</span></span><span style=display:flex><span>    #E_exc_Ov_addi
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s2, $s3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lui	$s2, <span style=color:#bd93f9>0</span>x7fff
</span></span><span style=display:flex><span>lui	$s3, <span style=color:#bd93f9>0</span>x8fff
</span></span><span style=display:flex><span>sub	$s4, $s3, $s2
</span></span><span style=display:flex><span>    #E_exc_Ov_sub
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s2, $s3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x12345678
</span></span><span style=display:flex><span>sw	$s0, <span style=color:#bd93f9>0</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>lw	$s1, <span style=color:#bd93f9>3</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>lw	$s2, <span style=color:#bd93f9>0</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s2, $s3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x8fffffff
</span></span><span style=display:flex><span>sw	$s0, <span style=color:#bd93f9>0</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>lh	$s1, <span style=color:#bd93f9>1</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>lh	$s2, <span style=color:#bd93f9>2</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s2, $s3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x80000000
</span></span><span style=display:flex><span>sw	$s0, <span style=color:#bd93f9>0</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>lhu	$s1, <span style=color:#bd93f9>1</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>lhu	$s2, <span style=color:#bd93f9>2</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s1, $s2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x7f00
</span></span><span style=display:flex><span>li	$s1, <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>sw	$s1, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>lh	$s2, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>lw	$s3, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s1, $s2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x7010
</span></span><span style=display:flex><span>li	$s1, <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>sw	$s1, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x2800
</span></span><span style=display:flex><span>sw	$s1, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s1, $s2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x12ab34cd
</span></span><span style=display:flex><span>sw	$s0, <span style=color:#bd93f9>3</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>sw	$s0, <span style=color:#bd93f9>4</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s1, $s2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>xabcd
</span></span><span style=display:flex><span>sh	$s0, <span style=color:#bd93f9>1</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>sh	$s0, <span style=color:#bd93f9>2</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s1, $s2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x7f10
</span></span><span style=display:flex><span>li	$s1, <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>sh	$s1, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>sw	$s1, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s1, $s2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x7f10
</span></span><span style=display:flex><span>li	$s1, <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>sw	$s1, <span style=color:#bd93f9>8</span>($s0)
</span></span><span style=display:flex><span>    #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s1, $s2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>li	$s0, <span style=color:#bd93f9>0</span>x8ff0
</span></span><span style=display:flex><span>li	$s1, <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>sh	$s1, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>sh	$s1, <span style=color:#bd93f9>0</span>($s0)
</span></span><span style=display:flex><span>   #D_exc_AdEL
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span>	$<span style=color:#bd93f9>5</span>, $s1, $s2
</span></span></code></pre></td></tr></table></div></div><h2 id=三思考题>三.思考题<a hidden class=anchor aria-hidden=true href=#三思考题>#</a></h2><ol><li>请查阅相关资料，说明鼠标和键盘的输入信号是如何被 CPU 知晓的？</li></ol><ul><li>鼠标和键盘产生中断信号，进入中断处理程序，在中断处理程序中，鼠标和键盘输入信号</li></ul><ol start=2><li>请思考为什么我们的 CPU 处理中断异常必须是已经指定好的地址？如果你的 CPU 支持用户自定义入口地址，即处理中断异常的程序由用户提供，其还能提供我们所希望的功能吗？如果可以，请说明这样可能会出现什么问题？否则举例说明。（假设用户提供的中断处理程序合法）</li></ol><ul><li>若自定义入口地址，则很多软件将会不兼容，在程序员视角设计软件的时候，中断处理的入口地址是不重要的，也就是说这是软件和硬件之间的协议。</li></ul><ol start=3><li>为何与外设通信需要 Bridge？</li></ol><ul><li>外设的种类繁多，我们通过bridge并且约定某段内存地址对应于某个外设，这样我们就只需要通过访存去实现与外设的联系，指令集会比较的简洁。添加外设时，外设也只需要体现在入口地址的不同而不需要改变CPU的内部结构，让CPU访问外设只需通过地址，这样体现了”高内聚，低耦合”的原则</li></ul><ol start=4><li>请阅读官方提供的定时器源代码，阐述两种中断模式的异同，并分别针对每一种模式绘制状态移图</li></ol><ul><li><p>模式0 ： 定时中断</p></li><li><p>模式1 ： 周期性中断</p></li><li><p>画图如下</p><p><img alt=image-20231206012815889 loading=lazy src=/img/image-20231206012815889.png></p></li></ul><ol start=5><li>倘若中断信号流入的时候，在检测宏观 PC 的一级如果是一条空泡（你的 CPU 该级所有信息均为空）指令，此时会发生什么问题？在此例基础上请思考：在 P7 中，清空流水线产生的空泡指令应该保留原指令的哪些信息？</li></ol><ul><li>写入EPC会出错，延迟槽标记信号BD也会出错。</li><li>如果是中断或者异常而清空流水线，应该保持原有的PC值，以保证宏观PC的正确。</li><li>如果是阻塞而清空流水线，应该要保持原有的PC并且保持原有的BD标志信号。</li></ul><ol start=6><li>为什么 jalr 指令为什么不能写成 jalr $31, $31？</li></ol><ul><li><p>这种操作具有二义性，不知道先跳转还是先链接</p></li><li><p>指令集要求 rs 和 rd 不得相等，因为此类指令在重新执行时不具有相同的效果。执行此类指令的结果是不可预测的。此限制允许异常处理程序在分支延迟槽中发生异常时通过重新执行分支来恢复执行。</p><p><img alt=image-20231206002456836 loading=lazy src=/img/image-20231206002456836.png></p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://coder0xe.github.io/tags/dec/>Dec</a></li></ul><nav class=paginav><a class=prev href=https://coder0xe.github.io/posts/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E9%85%8D%E4%B8%80%E4%B8%AA%E9%BE%99%E8%8A%AF%E6%9D%AF%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%8E%AF%E5%A2%83/><span class=title>« Prev</span><br><span>从0开始配龙芯杯vivado+vcs虚拟机环境(Ubuntu22.04)</span>
</a><a class=next href=https://coder0xe.github.io/posts/p6%E8%AF%BE%E4%B8%8A%E6%B5%8B%E8%AF%95/><span class=title>Next »</span><br><span>P6课上测试</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share P7-design-document on x" href="https://x.com/intent/tweet/?text=P7-design-document&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp7-design-document%2f&amp;hashtags=Dec"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P7-design-document on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp7-design-document%2f&amp;title=P7-design-document&amp;summary=P7-design-document&amp;source=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp7-design-document%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P7-design-document on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp7-design-document%2f&title=P7-design-document"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P7-design-document on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp7-design-document%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P7-design-document on whatsapp" href="https://api.whatsapp.com/send?text=P7-design-document%20-%20https%3a%2f%2fcoder0xe.github.io%2fposts%2fp7-design-document%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P7-design-document on telegram" href="https://telegram.me/share/url?text=P7-design-document&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp7-design-document%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P7-design-document on ycombinator" href="https://news.ycombinator.com/submitlink?t=P7-design-document&u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp7-design-document%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://coder0xe.github.io/>coder0xe's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>