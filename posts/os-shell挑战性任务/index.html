<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OS:Shell挑战性任务 | coder0xe's blog</title><meta name=keywords content="OS:挑战性任务"><meta name=description content="OS:Shell挑战性任务"><meta name=author content="sudo"><link rel=canonical href=https://coder0xe.github.io/posts/os-shell%E6%8C%91%E6%88%98%E6%80%A7%E4%BB%BB%E5%8A%A1/><link crossorigin=anonymous href=/assets/css/stylesheet.e4a36188e2c44563c1cc5ed1a2d0b8451a4f68c685114d738b97609f82dae050.css integrity="sha256-5KNhiOLERWPBzF7RotC4RRpPaMaFEU1zi5dgn4La4FA=" rel="preload stylesheet" as=style><link rel=icon href=https://coder0xe.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://coder0xe.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://coder0xe.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://coder0xe.github.io/apple-touch-icon.png><link rel=mask-icon href=https://coder0xe.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://coder0xe.github.io/posts/os-shell%E6%8C%91%E6%88%98%E6%80%A7%E4%BB%BB%E5%8A%A1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://coder0xe.github.io/posts/os-shell%E6%8C%91%E6%88%98%E6%80%A7%E4%BB%BB%E5%8A%A1/"><meta property="og:site_name" content="coder0xe's blog"><meta property="og:title" content="OS:Shell挑战性任务"><meta property="og:description" content="OS:Shell挑战性任务"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-08T18:31:34+08:00"><meta property="article:modified_time" content="2024-06-08T18:31:34+08:00"><meta property="article:tag" content="June"><meta name=twitter:card content="summary"><meta name=twitter:title content="OS:Shell挑战性任务"><meta name=twitter:description content="OS:Shell挑战性任务"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://coder0xe.github.io/posts/"},{"@type":"ListItem","position":2,"name":"OS:Shell挑战性任务","item":"https://coder0xe.github.io/posts/os-shell%E6%8C%91%E6%88%98%E6%80%A7%E4%BB%BB%E5%8A%A1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OS:Shell挑战性任务","name":"OS:Shell挑战性任务","description":"OS:Shell挑战性任务","keywords":["OS:挑战性任务"],"articleBody":"Shell挑战性任务设计文档:MOS_SUDO_SHELL 一.实现不带.b的后缀指令 ​\t实现不带.b的后缀指令同时兼容带有.b后缀的指令，这一点可以通过**首先尝试打开不带后缀的指令名，例如ls，失败后再尝试打开带后缀的指令名ls.b实现。**修改spawn.c/spawn函数中的打开文件逻辑即可。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 int spawn(char *prog, char **argv) { // Step 1: Open the file 'prog' (the path of the program). // Return the error if 'open' fails. int fd; if ((fd = open(prog, O_RDONLY)) \u003c 0) { /*Shell Challenge: *.b*/ char *ext = \".b\"; char prog_b[1024]; strcpy(prog_b, prog); // strcat for (int i = strlen(prog_b), j = 0; j \u003c strlen(ext); i++, j++) { prog_b[i] = ext[j]; } if ((fd = open(prog_b, O_RDONLY)) \u003c 0) { return fd; } } //... } 二.实现指令条件执行 ​\t需要实现Linux Shell中的\u0026\u0026与||，需要满足短路原则。\n对于command1 \u0026\u0026 command2，commmand2被执行当且仅当command1返回0 对于command1 | command2，command2被执行当且仅当command1返回1 并且\u0026\u0026和||的优先级相同，从左向右执行 ​\t课程组已经给出了测试程序true.c和false.c，其中true.c返回0,false.c返回1,可以增加适当的输出信息用于测试。\n​\t首先应当想到在解析命令时新增两种token：\u0026\u0026和||，分别用首字母a和o表示。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 int _gettoken(char *s, char **p1, char **p2) { //... if (strchr(SYMBOLS, *s)) { // 修改此处逻辑 识别 \u0026\u0026 || ; int t = *s; *p1 = s; /*Shell Challenge*/ char *s1 = s + 1; if (*s1 == *s \u0026\u0026 *s1 == '\u0026') { s++; t = 'a'; } else if (*s1 == *s \u0026\u0026 *s1 == '|') { s++; t = 'o'; } *s++ = 0; *p2 = s; return t; } //... } ​\t当我们在parsecmd中解析到\u0026\u0026或||时，我们的思路是先fork一下，首先运行左侧的指令，是否运行右边的指令由左边指令的返回值确定，返回值需要通过进程间通信实现。大致梳理一下这个过程：\nparent child spawn : grandson ​\t我们可以看出这个通信过程是一个由底向上的过程，我们知道指令的具体执行是由子shell进行spawn后的“孙子”进程完成的，那么就要由“晚辈的”一层层向“长辈”靠拢，这其间的通信我们使用ipc实现。\n​\tgrandson的返回值在libos.c/libmain中接收，并返回给child，需要注意的是除了这里debugf.c/user_panic中也要进行通信，我选择返回-1表示指令错误执行。\n​\t这里需要注意的是，需要新建用于传递返回值的系统调用和新的返回值字段，否则会与文件系统的ipc发生冲突。\n为env结构体添加用于接受返回值的成员return_value和是否处于接受返回值的状态量waiting_return_value\n1 2 3 4 5 6 7 struct Env { //... // Shell Challenge u_int waiting_return_value; u_int return_value; }; 仿照ipc完成进行返回值传递和接受的系统调用\nsys_send_return_value：发送返回值 sys_recv_return_value：接受返回值 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 int sys_send_return_value(u_int envid, u_int value, u_int srcva, u_int perm) { struct Env *e; struct Page *p; if (srcva != 0 \u0026\u0026 is_illegal_va(srcva)) { return -E_INVAL; } try(envid2env(envid,\u0026e,0)); if (e-\u003ewaiting_return_value != 1) { return -E_IPC_NOT_RECV; } e-\u003eenv_ipc_value = value; e-\u003eenv_ipc_from = curenv-\u003eenv_id; e-\u003eenv_ipc_perm = PTE_V | perm; e-\u003eenv_ipc_recving = 0; e-\u003ewaiting_return_value = 0; e-\u003ereturn_value = value; e-\u003eenv_status = ENV_RUNNABLE; TAILQ_INSERT_TAIL(\u0026env_sched_list,e,env_sched_link); if (srcva != 0) { p = page_lookup(curenv-\u003eenv_pgdir,srcva,NULL); if (!p) { return -E_INVAL; } try(page_insert(e-\u003eenv_pgdir,e-\u003eenv_asid,p,e-\u003eenv_ipc_dstva,perm)); } return 0; } int sys_recv_return_value() { curenv-\u003ewaiting_return_value = 1; curenv-\u003eenv_status = ENV_NOT_RUNNABLE; TAILQ_REMOVE(\u0026env_sched_list,curenv,env_sched_link); ((struct Trapframe *)KSTACKTOP - 1)-\u003eregs[2] = 0; schedule(1); } 传递返回值\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // libos.c void libmain(int argc, char **argv) { // set env to point at our env structure in envs[]. env = \u0026envs[ENVX(syscall_getenvid())]; // call user main routine u_int r = main(argc, argv); //syscall_ipc_try_send(env-\u003eenv_parent_id, r, 0, 0); syscall_send_return_value(env-\u003eenv_parent_id, r, 0, 0); syscall_set_job_done(env-\u003eenv_id); // exit gracefully exit(); } // debugf.c void _user_panic(const char *file, int line, const char *fmt, ...) { debugf(\"panic at %s:%d: \", file, line); va_list ap; va_start(ap, fmt); vdebugf(fmt, ap); va_end(ap); syscall_send_return_value(env-\u003eenv_parent_id, -1, 0, 0); debugf(\"\\n\"); exit(); } child进程使用ipc_recv接收返回值，这里需要注意的是，使用syscall_recv_return_value后，并不需要再进行wait，因为接收到返回值已经说明子进程执行完毕。\n另外需要注意的是，当我们遇到\u0026\u0026 ||时child需要向parent进行通信，其他时候不需要，我们可以设置一个标志flag进行区分。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 void runcmd(char *s) { // ... int child = spawn(argv[0], argv); // spawn a new process to run the command // if succeeds, child is the envid of the new process. // if fails, child is the error code. if (child \u003e= 0) { if (flag == 1) { syscall_recv_return_value(); syscall_send_return_value(env-\u003eenv_parent_id, env-\u003ereturn_value, 0, 0); } else if (job_flag == 1) { // 需要创建后台任务 syscall_create_job(child, cmd); syscall_recv_return_value(); } else { syscall_recv_return_value(); } } //... } ​\t考虑到一种比较复杂的情况是cmd1 || cmd2 || cmd3 等可能省略中间部分指令的情况，我选择给parsecmd增加一个参数mark来表示这条指令是否需要执行，经过梳理运行逻辑，一种可行的解决办法是：当我们遇到短路原则时，下一条指令是一定不需要执行的，我们将mark标记为0，当return时，若mark标记为0,则return 0，否则return argc。在runcmd原有的逻辑中，return 0 说明后面没有命令，会退出命令运行，但在此时，我们不能够退出，我们的目标是跳过一条指令，还需要判断后边的指令是否需要执行。我们可以对return 0的情况进行分析\n命令末尾：return 0 \u0026\u0026 argv[0] = \"\" 若是省略命令：return 0 \u0026\u0026 argv[0] != \"\" ​\t因此我们可以利用argv[0]是否为空串来对这两种情况进行区分，当是第一种情况时，直接退出；当是第二种情况时，我们需要与代表着cmd3的父进程进行通信，这时我们将前两个已经短路的指令看作一个整体，返回0。\nparsecmd中注意细节，每一个return都要对mark进行判断。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 int parsecmd(char **argv, int *rightpipe, int mark) { int argc = 0; while (1) { //... case 'a':; // \u0026\u0026 flag = 1; int child2 = fork(); if (child2 == 0) { // child shell return mark ? argc : 0; } else { // parent shell syscall_recv_return_value(); if (env-\u003ereturn_value == 0) { return parsecmd(argv, rightpipe, 1); } else { return parsecmd(argv, rightpipe, 0); } } break; case 'o':; // || flag = 1; int child3 = fork(); if (child3 == 0) { return mark ? argc : 0; } else { syscall_recv_return_value(); if (env-\u003ereturn_value != 0) { return parsecmd(argv, rightpipe, 1); } else { return parsecmd(argv, rightpipe, 0); } } break; } } return argc; } void runcmd(char *s) { //... if (argc == 0) { if (argv[0]) { // 后边还有指令 syscall_send_return_value(env-\u003eenv_parent_id, 0, 0, 0); } return; } argv[argc] = 0; //... } 这里有一个很奇怪的点，可能和我的设计有关，我必须将close_all移动到后面，否则不能即使recv返回值，导致返回值丢失进入死锁\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 int child = spawn(argv[0], argv); // spawn a new process to run the command if (child \u003e= 0) { if (flag == 1) { syscall_recv_return_value(); syscall_send_return_value(env-\u003eenv_parent_id, env-\u003ereturn_value, 0, 0); } else if (job_flag == 1) { // 需要创建后台任务 syscall_create_job(child, cmd); syscall_recv_return_value(); } else { syscall_recv_return_value(); } } else { debugf(\"spawn %s: %d\\n\", argv[0], child); } if (rightpipe) { wait(rightpipe); } close_all(); // close all file descriptors !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! 三.实现更多指令 3.1 touch touch ：不会出现创建多个文件的情况 ​\t新建touch.c并在include.mk中加入touch.b，检查文件是否存在的方式为先尝试打开，若不能成功打开则进行创建。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // touch.c #include void touch(char *path) { int fd = open(path, O_RDONLY); // 首先检查文件是否存在 if (fd \u003e 0) { close(fd); return; } else { // 文件不存在，创建文件 fd = open(path, O_CREAT); if (fd \u003c 0) { printf(\"touch: cannot touch '%s': No such file or directory\\n\", path); return; } close(fd); } } int main(int argc, char **argv) { int i; if (argc \u003c 2) { printf(\"touch: missing file operand\\n\"); return 0; } touch(argv[1]); } 3.2 mkdir mkdir mkdir -p ​\tmkdir的实现方式与touch类似，在open时传入O_MKDIR，需要注意的是要在文件系统服务函数serv.c中打开函数时相应加入对于O_MKDIR的判断。\n1 2 3 4 5 6 7 8 9 10 11 12 13 void serve_open(u_int envid, struct Fsreq_open *rq) { //... if ((rq-\u003ereq_omode \u0026 O_CREAT) \u0026\u0026 (r = file_create(rq-\u003ereq_omode, rq-\u003ereq_path, \u0026f)) \u003c 0 \u0026\u0026 r != -E_FILE_EXISTS) { ipc_send(envid, r, 0, 0); return; } else if ((rq-\u003ereq_omode \u0026 O_MKDIR) \u0026\u0026 (r = file_create(rq-\u003ereq_omode, rq-\u003ereq_path, \u0026f)) \u003c 0 \u0026\u0026 r != -E_FILE_EXISTS) { ipc_send(envid, r, 0, 0); return; } //... } ​\t同时应当修改file_create函数，增加传入参数rq-\u003ereq_mode，区分创建文件还是目录，为结构体的type字段赋值。\n1 2 3 4 5 6 7 8 9 10 int file_create(u_int req_mode, char *path, struct File **file) { //... /*Shell Challenge*/ if (req_mode == O_MKDIR) { f-\u003ef_type = FTYPE_DIR; } else { f-\u003ef_type = FTYPE_REG; } //... } ​\t具体的mkdir逻辑\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 #include void mkdir(char *path, int flag) { int fd = open(path, O_RDONLY); // 首先检查文件是否存在 if (fd \u003e 0) { close(fd); if (!flag) { printf(\"mkdir: cannot create directory '%s': File exists\\n\", path); } return; } else { // 文件不存在，创建文件 fd = open(path, O_MKDIR); if (fd \u003c 0) { if (!flag) { printf(\"mkdir: cannot create directory '%s': No such file or directory\\n\", path); return; } else { // 递归创建目录,例如 \"/nonexist/dqr/123\" char *p = path; if (*p == '/') { // 跳过开头的'/' p++; } while (1) { if (*p == '/') { *p = '\\0'; mkdir(path, 1); *p = '/'; } else if (*p == '\\0') { mkdir(path, 1); break; } p++; } } } close(fd); } } int main(int argc, char **argvs) { if (argc \u003c 2) { printf(\"mkdir: missing operand\\n\"); return 0; } // 需要考虑参数p忽略错误 if (strcmp(argvs[1], \"-p\") == 0) { mkdir(argvs[2], 1); } else { mkdir(argvs[1], 0); } return 0; } 3.3 rm rm rm rm -r | rm -rf | ​\t对于rm指令处理的关键在于对于参数的处理，我们知道删除目录时需要-r/-rf参数，所以需要特殊判断无参数删除目录文件的情况。我采用的方法是在文件系统删除请求结构体中加入一个模式字段，用来表示参数情况(无参数为0，-r为1，-rf为2)。\n1 2 3 4 struct Fsreq_remove { char req_path[MAXPATHLEN]; u_int remove_type; }; ​\t对于这个参数的传递，我选择了一种不太“优雅“的方式，由于不能修改remove函数的传参(remove函数在test中有引用，评测时替换为标准文件，若修改会导致编译不过)，我选择将模式数字拼接在路径字符串的\\0之后，这样我们既可以读取模式数字，又可以保证读取路径的正确性。\n​\t在remove函数中将这个数字取出，沿着调用链进行传递。\n1 2 3 4 5 6 7 8 int remove(const char *path) { // Call fsipc_remove. // 最后一位为模式 int len = strlen(path); int type = path[++len] - '0'; /* Exercise 5.13: Your code here. */ return fsipc_remove(path, type); } ​\t在fsipc_remove中构建请求结构体时对新增字段赋值，达到通过结构体传参的目的。\n1 2 3 4 5 int fsipc_remove(const char *path, u_int type) { //... req-\u003eremove_type = type; //... } ​\t在文件系统服务函数中，为file_remove新增模式参数\n1 2 3 4 void serve_remove(u_int envid, struct Fsreq_remove *rq) { r = file_remove(rq-\u003ereq_path, rq-\u003eremove_type); ipc_send(envid, r, 0, 0); } ​\t修改具体的文件删除逻辑，当要删除的文件为目录但传递的参数为N(0)时，返回一种新的错误码(E_IS_DIR=14,新增定义在error.h中)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 int file_remove(char *path, u_int type) { int r; struct File *f; // Step 1: find the file on the disk. if ((r = walk_path(path, 0, \u0026f, 0)) \u003c 0) { return r; } /*Shell Challenge*/ if (f-\u003ef_type == FTYPE_DIR \u0026\u0026 type == 0) { return -E_IS_DIR; } //... } ​\t具体的remove逻辑：这里返回小于0值说明一定是N模式下删除了目录。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #include #define N 0 #define R 1 #define RF 2 void rm(char *path, int flag) { int fd = open(path, O_RDONLY); if (fd \u003c 0) { if (flag != RF) { printf(\"rm: cannot remove '%s': No such file or directory\\n\", path); } } else { close(fd); /*为了避免传参问题 将模式拼接在路径末尾\\0之后*/ char path1[MAXPATHLEN+1]; strcpy(path1, path); int len = strlen(path1); path1[++len] = flag + '0'; /********************/ fd = remove(path1); if (fd \u003c 0) { printf(\"rm: cannot remove '%s': Is a directory\\n\", path); } } } int main(int argc, char **argv) { if (argc \u003c 2) { printf(\"rm: missing operand\\n\"); } if (strcmp(argv[1], \"-r\") == 0) { rm(argv[2], R); } else if (strcmp(argv[1], \"-rf\") == 0) { rm(argv[2], RF); } else { rm(argv[1], N); } return 0; } 四.实现反引号 ​\t使用反引号实现指令替换，只需要考虑echo进行的输出，需要将反引号内指令执行的所有标准输出替换为echo的参数。\n换句话说，执行一下反引号里边的内容 ​\t首先增加反引号token\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 int _gettoken(char *s, char **p1, char **p2) { //... if(*s == '`') { // 识别反引号 *s = 0; s++; *p1 = s; while(*s \u0026\u0026 (*s != '`')){ s++; } *s++ = 0; *p2 = s; return 'f'; } //... } ​\t在parsecmd中增加对应逻辑，这时反引号中间的指令已经被保存在字符串指针t中。\n1 2 3 4 5 6 7 8 9 10 11 int parsecmd(char **argv, int *rightpipe, int mark) { int argc = 0; while (1) { //... case 'f':; // 反引号 runcmd(t); break; } //... } } 五.实现注释功能 ​\t使用#实现注释功能也就是对#后面的内容进行忽略，可以在进行执行指令时对字符串#后面的部分进行截断。\n1 2 3 4 5 6 7 8 9 10 11 //sh.c void runcmd(char *s) { /*Shell Challenge: #*/ char *p = s; while (*p \u0026\u0026 *p != '#') { p++; } *p = 0; gettoken(s, 0); //... } 六.实现历史指令 启动shell时创建.mosh_history文件 运行命令时将命令保存到.mosh_history history命令输出文件内容 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 void create_history() { int fd; if ((fd = open(\".mosh_history\", O_CREAT)) \u003c 0) { printf(\"create history file failed\\n\"); } return; } void save_history_cmd(char * cmd) { int fd; if ((fd = open(\".mosh_history\", O_WRONLY)) \u003c 0) { printf(\"open history file failed\\n\"); } struct Stat st; stat(\".mosh_history\", \u0026st); seek(fd, st.st_size); write(fd, cmd, strlen(cmd)); write(fd, \"\\n\", 1); close(fd); return; } void print_history() { int fd; if ((fd = open(\".mosh_history\", O_RDONLY)) \u003c 0) { printf(\"open history file failed\\n\"); } char ch; while (read(fd, \u0026ch, 1)) { printf(\"%c\", ch); } close(fd); return; } 七.实现一行多指令 ​\t实现使用;将多条指令隔开从而从左至右依顺序执行每条指令的功能，通过修改parsecmd()函数使其增添对;的处理能力。在parsecmd的字符串解析过程中，若读到一个;，则进行一次fork，产生一个子shell，让子shell执行左边的命令，父shell等待子shell执行完成后执行右边的命令。\n1 2 3 4 5 6 7 8 9 case ';':; int child = fork(); if (child == 0) { // child shell return argc; } else { // parent shell wait(child); return parsecmd(argv, rightpipe); } break; 八.实现追加重定向 实现\u003e\u003e的追加重定向的功能 ​\t首先增加一种token为\u003e\u003e，在_gettoken中实现，标记为z。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 int _gettoken(char *s, char **p1, char **p2) { //... if (strchr(SYMBOLS, *s)) { // 修改此处逻辑 识别 \u0026\u0026 || ; int t = *s; *p1 = s; /*Shell Challenge*/ char *s1 = s + 1; if (*s1 == *s \u0026\u0026 *s1 == '\u0026') { s++; t = 'a'; } else if (*s1 == *s \u0026\u0026 *s1 == '|') { s++; t = 'o'; } else if (*s1 == *s \u0026\u0026 *s1 == '\u003e') { s++; t = 'z'; } *s++ = 0; *p2 = s; return t; } //... } ​\t在parsecmd中进行修改，为文件设置好偏移量后进行dup\nstat获取文件信息 seek设置文件偏移量 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 int parsecmd(char **argv, int *rightpipe, int mark) { int argc = 0; while (1) { //... case 'z':; // 实现追加重定向 if (gettoken(0, \u0026t) != 'w') { debugf(\"syntax error: \u003e not followed by word\\n\"); exit(); } if ((fd = open(t, O_RDONLY | O_WRONLY | O_CREAT)) \u003c 0) { debugf(\"failed to open %s\\n\", t); exit(); } struct Stat st; if (fstat(fd, \u0026st) \u003c 0) { debugf(\"failed to fstat %s\\n\", t); exit(); } seek(fd, st.st_size); if ((r = dup(fd, 1)) \u003c 0) { debugf(\"failed to duplicate file to \\n\"); exit(); } close(fd); break;\t} } return argc; } 九.实现引号支持 ​\tshell在解析时需要将双引号内的内容看作是单个字符串，在解析字符串时加了一种token为字符串，修改_gettoken中的逻辑。\n1 2 3 4 5 6 7 8 9 10 11 /*Shell Challenge : \"content\"*/ if (*s == '\"') { // read until the next '\"' *s++; *p1 = s; while (*s \u0026\u0026 *s != '\"') { s++; } *(s++) = 0; // *s = '\"' *p2 = s; return 'w'; } 十.实现前后台任务管理 10.1 实现后台任务并行 ​\t此功能的实现与实现一行多指令类似，后台运行任务即在fork之后父进程不会等待子进程运行完成。\n1 2 3 4 5 6 7 8 9 case '\u0026':; job_flag = 1; int child = fork(); if (child == 0) { // child shell return argc; } else { // parent shell return parsecmd(argv, rightpipe); }\tbreak;\t10.2 实现jobs指令 关于后台任务的三个指令我们需要实现为内置指令，shell中分为内置指令和外部指令，外部指令需要fork一个子进程进行执行，而内置指令不会，效率更高。\n基本的实现思路为我们在runcmd时检查指令，如果为内置指令不再进行spawn而是直接调用sh.c中写好的函数执行。 为了实现进程间的共享，我选择在内核态对后台进程进行管理，通过系统调用syscall_*进行更新 加系统调用的流程上机考试早已熟悉 ​\t首先：如何实现内置指令，区别于外部指令，内部指令执行时不会进行fork，效率更高，当我们在runcmd时应当特判遇到的内置指令，调用sh.c中写好的处理函数执行。\n1 2 3 4 5 6 7 8 9 10 11 12 if (strcmp(argv[0], \"jobs\") == 0) { execute_jobs(); exit(); } else if (strcmp(argv[0], \"fg\") == 0) { int jobId = parseJobId(argv[1]); execute_fg(jobId); exit(); } else if (strcmp(argv[0], \"kill\") == 0) { int jobId = parseJobId(argv[1]); execute_kill(jobId); exit(); } ​\t为了更好的管理工作的信息，我选择新建一个Job结构体，定义在env.h中\n1 2 3 4 5 6 struct Job { int job_id; int job_status; // 0 for Done; 1 for Running int envid; char cmd[1024]; }; ​\t在内核态对struct Job数组进行管理，将数组定义在env.c中便于操作。\n1 2 struct Job jobs[32]; int jobCnt = 0; ​\t**重点在于何时将进程放入后台：**我们设置一个全局变量job_flag读到\u0026时置为1,在runcmd时，对这个标记进行特判，从而将进程放到后台，这里需要注意的是，recv应当在syscall_create_job之后，否则会一直阻塞，不能加入到后台，直到进程运行完毕才能加入到后台。\n1 2 3 4 5 6 7 8 9 10 11 if (child \u003e= 0) { if (flag == 1) { syscall_recv_return_value(); syscall_send_return_value(env-\u003eenv_parent_id, env-\u003ereturn_value, 0, 0); } else if (job_flag == 1) { // 需要创建后台任务 syscall_create_job(child, cmd); syscall_recv_return_value(); } else { syscall_recv_return_value(); } } ​\t这里创建后台任务也是通过系统调用实现，实际上是对内核态jobs数组赋值的操作，这样就实现了加入后台任务。\n1 2 3 4 5 6 7 8 //env.c void env_create_job(u_int envid, char * cmd) { jobs[jobCnt].envid = envid; jobs[jobCnt].job_status = 1; // Running strcpy(jobs[jobCnt].cmd, cmd); jobs[jobCnt].job_id = jobCnt + 1; jobCnt++; } ​\t加入后台时，将运行状态status设置为1(Running)，0(Done).\n​\tjobs操作实际上是一个“输出”操作，我们通过系统调用实现。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 //sh.c void execute_jobs() { // 约等于无用封装 syscall_print_jobs(); } //env.c void env_print_jobs() { for (int i = 0; i \u003c jobCnt; i++) { if (jobs[i].job_status == 1) { printk(\"[%d] %-10s 0x%08x %s\\n\\r\", jobs[i].job_id, \"Running\", jobs[i].envid, jobs[i].cmd); } else { printk(\"[%d] %-10s 0x%08x %s\\n\\r\", jobs[i].job_id, \"Done\", jobs[i].envid, jobs[i].cmd); } } } ​\t这里还有很重要的一点是：后台进程状态的变化，当后台进程结束时，应当设置状态为Done，而我们知道后台进程结束点是在libmain，在libmain中通过系统调用更改job_status = 0(Done)。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // libos.c void libmain(int argc, char **argv) { //... syscall_set_job_done(env-\u003eenv_id); // exit gracefully exit(); } //env.c void env_set_job_done(u_int envid) { for (int i = 0; i \u003c jobCnt; i++) { if (jobs[i].envid == envid) { jobs[i].job_status = 0; break; } } } 10.3 实现fg指令 首先构建一个简单的辅助函数，用来将argv[1]转换为\n1 2 3 4 5 6 7 8 int parseJobId(char *s) { int jobId = 0; while (*s) { jobId = jobId * 10 + (*s - '0'); s++; } return jobId; } fg命令同样通过系统调用实现，并不需要从后台jobs中删除jobid的目录项，只需到前台运行该进程，或者说当前运行进程wait这个后台进程。\n说个题外话，我是没想到不用从jobs列表中删除该项的，因为linux中的行为是进行删除，而课程组的建议是仿照linux行为实现，并且挑战性任务说明书一坨，MOS居然有了这么离谱的举动，居然也不在挑战性任务中说明或给出样例，等大家猜吗… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 //sh.c void execute_fg(int jobId) { int envid = syscall_fg_job(jobId); if (envid == -1) { printf(\"fg: job (%d) do not exist\\n\", jobId); } else if (envs[ENVX(envid)].env_status != ENV_RUNNABLE) { printf(\"fg: (0x%08x) not running\\n\", envid); } else { wait(envid); } } //env.c int env_fg_job(int jobId) { for (int i = 0; i \u003c jobCnt; i++) { if (jobs[i].job_id == jobId) { return jobs[i].envid; } } return -1; } 10.4 实现kill指令 kill命令同样通过系统调用实现，杀死后台进程\n同样不需要从Jobs列表中删除…\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // sh.c void execute_kill(int jobId) { syscall_kill_job(jobId); } // env.c void env_kill_job(int jobId) { for (int i = 0; i \u003c jobCnt; i++) { if (jobs[i].job_id == jobId) { if (envs[ENVX(jobs[i].envid)].env_status != ENV_RUNNABLE) { printk(\"fg: (0x%08x) not running\\n\", jobs[i].envid); return; } else { env_destroy(\u0026envs[ENVX(jobs[i].envid)]); jobs[i].job_status = 0; return; } } } printk(\"fg: job (%d) do not exist\\n\", jobId); return; } ","wordCount":"2831","inLanguage":"en","datePublished":"2024-06-08T18:31:34+08:00","dateModified":"2024-06-08T18:31:34+08:00","author":{"@type":"Person","name":"sudo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://coder0xe.github.io/posts/os-shell%E6%8C%91%E6%88%98%E6%80%A7%E4%BB%BB%E5%8A%A1/"},"publisher":{"@type":"Organization","name":"coder0xe's blog","logo":{"@type":"ImageObject","url":"https://coder0xe.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://coder0xe.github.io/ accesskey=h title="coder0xe's blog (Alt + H)">coder0xe's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://coder0xe.github.io/ title=首页><span>首页</span></a></li><li><a href=https://coder0xe.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://coder0xe.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://coder0xe.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://coder0xe.github.io/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://coder0xe.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://coder0xe.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">OS:Shell挑战性任务</h1><div class=post-description>OS:Shell挑战性任务</div><div class=post-meta><span title='2024-06-08 18:31:34 +0800 +0800'>June 8, 2024</span>&nbsp;·&nbsp;<span>14 min</span>&nbsp;·&nbsp;<span>sudo</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#shell%e6%8c%91%e6%88%98%e6%80%a7%e4%bb%bb%e5%8a%a1%e8%ae%be%e8%ae%a1%e6%96%87%e6%a1%a3mos_sudo_shell aria-label=Shell挑战性任务设计文档:MOS_SUDO_SHELL>Shell挑战性任务设计文档:MOS_SUDO_SHELL</a><ul><li><a href=#%e4%b8%80%e5%ae%9e%e7%8e%b0%e4%b8%8d%e5%b8%a6b%e7%9a%84%e5%90%8e%e7%bc%80%e6%8c%87%e4%bb%a4 aria-label=一.实现不带.b的后缀指令>一.实现不带.b的后缀指令</a></li><li><a href=#%e4%ba%8c%e5%ae%9e%e7%8e%b0%e6%8c%87%e4%bb%a4%e6%9d%a1%e4%bb%b6%e6%89%a7%e8%a1%8c aria-label=二.实现指令条件执行>二.实现指令条件执行</a></li><li><a href=#%e4%b8%89%e5%ae%9e%e7%8e%b0%e6%9b%b4%e5%a4%9a%e6%8c%87%e4%bb%a4 aria-label=三.实现更多指令>三.实现更多指令</a><ul><li><a href=#31-touch aria-label="3.1 touch">3.1 touch</a></li><li><a href=#32-mkdir aria-label="3.2 mkdir">3.2 mkdir</a></li><li><a href=#33-rm aria-label="3.3 rm">3.3 rm</a></li></ul></li><li><a href=#%e5%9b%9b%e5%ae%9e%e7%8e%b0%e5%8f%8d%e5%bc%95%e5%8f%b7 aria-label=四.实现反引号>四.实现反引号</a></li><li><a href=#%e4%ba%94%e5%ae%9e%e7%8e%b0%e6%b3%a8%e9%87%8a%e5%8a%9f%e8%83%bd aria-label=五.实现注释功能>五.实现注释功能</a></li><li><a href=#%e5%85%ad%e5%ae%9e%e7%8e%b0%e5%8e%86%e5%8f%b2%e6%8c%87%e4%bb%a4 aria-label=六.实现历史指令>六.实现历史指令</a></li><li><a href=#%e4%b8%83%e5%ae%9e%e7%8e%b0%e4%b8%80%e8%a1%8c%e5%a4%9a%e6%8c%87%e4%bb%a4 aria-label=七.实现一行多指令>七.实现一行多指令</a></li><li><a href=#%e5%85%ab%e5%ae%9e%e7%8e%b0%e8%bf%bd%e5%8a%a0%e9%87%8d%e5%ae%9a%e5%90%91 aria-label=八.实现追加重定向>八.实现追加重定向</a></li><li><a href=#%e4%b9%9d%e5%ae%9e%e7%8e%b0%e5%bc%95%e5%8f%b7%e6%94%af%e6%8c%81 aria-label=九.实现引号支持>九.实现引号支持</a></li><li><a href=#%e5%8d%81%e5%ae%9e%e7%8e%b0%e5%89%8d%e5%90%8e%e5%8f%b0%e4%bb%bb%e5%8a%a1%e7%ae%a1%e7%90%86 aria-label=十.实现前后台任务管理>十.实现前后台任务管理</a><ul><li><a href=#101-%e5%ae%9e%e7%8e%b0%e5%90%8e%e5%8f%b0%e4%bb%bb%e5%8a%a1%e5%b9%b6%e8%a1%8c aria-label="10.1 实现后台任务并行">10.1 实现后台任务并行</a></li><li><a href=#102-%e5%ae%9e%e7%8e%b0jobs%e6%8c%87%e4%bb%a4 aria-label="10.2 实现jobs指令">10.2 实现jobs指令</a></li><li><a href=#103-%e5%ae%9e%e7%8e%b0fg%e6%8c%87%e4%bb%a4 aria-label="10.3 实现fg指令">10.3 实现fg指令</a></li><li><a href=#104-%e5%ae%9e%e7%8e%b0kill%e6%8c%87%e4%bb%a4 aria-label="10.4 实现kill指令">10.4 实现kill指令</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h1 id=shell挑战性任务设计文档mos_sudo_shell>Shell挑战性任务设计文档:MOS_SUDO_SHELL<a hidden class=anchor aria-hidden=true href=#shell挑战性任务设计文档mos_sudo_shell>#</a></h1><h2 id=一实现不带b的后缀指令>一.实现不带<code>.b</code>的后缀指令<a hidden class=anchor aria-hidden=true href=#一实现不带b的后缀指令>#</a></h2><p>​ 实现不带<code>.b</code>的后缀指令同时兼容带有<code>.b</code>后缀的指令，这一点可以通过**首先尝试打开不带后缀的指令名，例如<code>ls</code>，失败后再尝试打开带后缀的指令名<code>ls.b</code>实现。**修改<code>spawn.c/spawn</code>函数中的打开文件逻辑即可。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>spawn</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>prog, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Open the file &#39;prog&#39; (the path of the program).
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Return the error if &#39;open&#39; fails.
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> fd;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(prog, O_RDONLY)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#6272a4>/*Shell Challenge: *.b*/</span>
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>ext <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;.b&#34;</span>;
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>char</span> prog_b[<span style=color:#bd93f9>1024</span>];
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>strcpy</span>(prog_b, prog);
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// strcat
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>strlen</span>(prog_b), j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> <span style=color:#50fa7b>strlen</span>(ext); i<span style=color:#ff79c6>++</span>, j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>			prog_b[i] <span style=color:#ff79c6>=</span> ext[j];
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> ((fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(prog_b, O_RDONLY)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> fd;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=二实现指令条件执行>二.实现指令条件执行<a hidden class=anchor aria-hidden=true href=#二实现指令条件执行>#</a></h2><p>​ 需要实现<code>Linux Shell</code>中的<code>&&</code>与<code>||</code>，需要满足短路原则。</p><ul><li>对于<code>command1 && command2</code>，<code>commmand2</code>被执行当且仅当<code>command1</code>返回0</li><li>对于<code>command1 | command2</code>，<code>command2</code>被执行当且仅当<code>command1</code>返回1</li><li><strong>并且<code>&&</code>和<code>||</code>的优先级相同，从左向右执行</strong></li></ul><p>​ 课程组已经给出了测试程序<code>true.c</code>和<code>false.c</code>，其中<code>true.c</code>返回0,<code>false.c</code>返回1,可以增加适当的输出信息用于测试。</p><p>​ 首先应当想到在解析命令时新增两种<code>token</code>：<code>&&</code>和<code>||</code>，分别用首字母<code>a</code>和<code>o</code>表示。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>_gettoken</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>p1, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>p2) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strchr</span>(SYMBOLS, <span style=color:#ff79c6>*</span>s)) { <span style=color:#6272a4>// 修改此处逻辑 识别 &amp;&amp; || ;
</span></span></span><span style=display:flex><span>		<span style=color:#8be9fd>int</span> t <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>p1 <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>		<span style=color:#6272a4>/*Shell Challenge*/</span>
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>=</span> s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;&amp;&#39;</span>) {
</span></span><span style=display:flex><span>			s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>			t <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;a&#39;</span>;
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;|&#39;</span>) {
</span></span><span style=display:flex><span>			s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>			t <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;o&#39;</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>s<span style=color:#ff79c6>++</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>p2 <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> t;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 当我们在<code>parsecmd</code>中解析到<code>&&</code>或<code>||</code>时，我们的思路是先<code>fork</code>一下，首先运行左侧的指令，是否运行右边的指令由左边指令的返回值确定，返回值需要通过进程间通信实现。大致梳理一下这个过程：</p><ul><li>parent<ul><li>child<ul><li>spawn : grandson</li></ul></li></ul></li></ul><p>​ 我们可以看出这个<strong>通信过程是一个由底向上的过程</strong>，我们知道指令的具体执行是由子shell进行spawn后的“孙子”进程完成的，那么就要由“晚辈的”一层层向“长辈”靠拢，这其间的通信我们使用<code>ipc</code>实现。</p><p>​ <code>grandson</code>的返回值在<code>libos.c/libmain</code>中接收，并返回给<code>child</code>，需要注意的是除了这里<code>debugf.c/user_panic</code>中也要进行通信，我选择返回-1表示指令错误执行。</p><p>​ <strong>这里需要注意的是，需要新建用于传递返回值的系统调用和新的返回值字段，否则会与文件系统的ipc发生冲突。</strong></p><ul><li><p>为<code>env</code>结构体添加用于接受返回值的成员<code>return_value</code>和是否处于接受返回值的状态量<code>waiting_return_value</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Env {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Shell Challenge
</span></span></span><span style=display:flex><span>	u_int waiting_return_value;
</span></span><span style=display:flex><span>	u_int return_value;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div></li><li><p>仿照<code>ipc</code>完成进行返回值传递和接受的系统调用</p><ul><li><code>sys_send_return_value</code>：发送返回值</li><li><code>sys_recv_return_value</code>：接受返回值</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_send_return_value</span>(u_int envid, u_int value, u_int srcva, u_int perm) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>e;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Page <span style=color:#ff79c6>*</span>p;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (srcva <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>is_illegal_va</span>(srcva)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>envid2env</span>(envid,<span style=color:#ff79c6>&amp;</span>e,<span style=color:#bd93f9>0</span>));
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (e<span style=color:#ff79c6>-&gt;</span>waiting_return_value <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_IPC_NOT_RECV;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_ipc_value <span style=color:#ff79c6>=</span> value;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_ipc_from <span style=color:#ff79c6>=</span> curenv<span style=color:#ff79c6>-&gt;</span>env_id;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_ipc_perm <span style=color:#ff79c6>=</span> PTE_V <span style=color:#ff79c6>|</span> perm;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_ipc_recving <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>waiting_return_value <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>return_value <span style=color:#ff79c6>=</span> value;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_status <span style=color:#ff79c6>=</span> ENV_RUNNABLE;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>TAILQ_INSERT_TAIL</span>(<span style=color:#ff79c6>&amp;</span>env_sched_list,e,env_sched_link);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (srcva <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		p <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>page_lookup</span>(curenv<span style=color:#ff79c6>-&gt;</span>env_pgdir,srcva,<span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>p) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>page_insert</span>(e<span style=color:#ff79c6>-&gt;</span>env_pgdir,e<span style=color:#ff79c6>-&gt;</span>env_asid,p,e<span style=color:#ff79c6>-&gt;</span>env_ipc_dstva,perm));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_recv_return_value</span>() {
</span></span><span style=display:flex><span>	curenv<span style=color:#ff79c6>-&gt;</span>waiting_return_value <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>	curenv<span style=color:#ff79c6>-&gt;</span>env_status <span style=color:#ff79c6>=</span> ENV_NOT_RUNNABLE;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>TAILQ_REMOVE</span>(<span style=color:#ff79c6>&amp;</span>env_sched_list,curenv,env_sched_link);
</span></span><span style=display:flex><span>	((<span style=color:#ff79c6>struct</span> Trapframe <span style=color:#ff79c6>*</span>)KSTACKTOP <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>)<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>2</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>schedule</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>传递返回值</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>// libos.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>libmain</span>(<span style=color:#8be9fd>int</span> argc, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// set env to point at our env structure in envs[].
</span></span></span><span style=display:flex><span>	env <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>envs[<span style=color:#50fa7b>ENVX</span>(<span style=color:#50fa7b>syscall_getenvid</span>())];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// call user main routine
</span></span></span><span style=display:flex><span>	u_int r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>main</span>(argc, argv);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//syscall_ipc_try_send(env-&gt;env_parent_id, r, 0, 0);
</span></span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_send_return_value</span>(env<span style=color:#ff79c6>-&gt;</span>env_parent_id, r, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_set_job_done</span>(env<span style=color:#ff79c6>-&gt;</span>env_id);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// exit gracefully
</span></span></span><span style=display:flex><span>	<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// debugf.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>_user_panic</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>file, <span style=color:#8be9fd>int</span> line, <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>fmt, ...) {
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>debugf</span>(<span style=color:#f1fa8c>&#34;panic at %s:%d: &#34;</span>, file, line);
</span></span><span style=display:flex><span>	va_list ap;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>va_start</span>(ap, fmt);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>vdebugf</span>(fmt, ap);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>va_end</span>(ap);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_send_return_value</span>(env<span style=color:#ff79c6>-&gt;</span>env_parent_id, <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>debugf</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p><code>child</code>进程使用<code>ipc_recv</code>接收返回值，<strong>这里需要注意的是，使用syscall_recv_return_value后，并不需要再进行wait，因为接收到返回值已经说明子进程执行完毕。</strong></p></li><li><p>另外需要注意的是，当我们遇到<code>&& ||</code>时<code>child</code>需要向<code>parent</code>进行通信，其他时候不需要，我们可以设置一个标志<code>flag</code>进行区分。</p></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>runcmd</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// ...
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> child <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>spawn</span>(argv[<span style=color:#bd93f9>0</span>], argv); <span style=color:#6272a4>// spawn a new process to run the command
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// if succeeds, child is the envid of the new process.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// if fails, child is the error code. 
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (child <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (flag <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_send_return_value</span>(env<span style=color:#ff79c6>-&gt;</span>env_parent_id, env<span style=color:#ff79c6>-&gt;</span>return_value, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (job_flag <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) { <span style=color:#6272a4>// 需要创建后台任务 
</span></span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_create_job</span>(child, cmd);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} 
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 考虑到一种比较复杂的情况是<code>cmd1 || cmd2 || cmd3 </code>等可能省略中间部分指令的情况，我选择给<code>parsecmd</code>增加一个参数<code>mark</code>来表示这条指令是否需要执行，经过梳理运行逻辑，一种可行的解决办法是：当我们遇到<strong>短路原则</strong>时，下一条指令是一定不需要执行的，我们将<code>mark</code>标记为0，当<code>return</code>时，若<code>mark</code>标记为0,则<code>return 0</code>，否则<code>return argc</code>。在<code>runcmd</code>原有的逻辑中，<code>return 0 </code>说明后面没有命令，会退出命令运行，<strong>但在此时，我们不能够退出，我们的目标是跳过一条指令，还需要判断后边的指令是否需要执行</strong>。<strong>我们可以对return 0的情况进行分析</strong></p><ol><li>命令末尾：<code>return 0 && argv[0] = ""</code></li><li>若是省略命令：<code>return 0 && argv[0] != ""</code></li></ol><p>​ <strong>因此我们可以利用<code>argv[0]</code>是否为空串来对这两种情况进行区分</strong>，当是第一种情况时，直接退出；当是第二种情况时，我们需要与代表着<code>cmd3</code>的父进程进行通信，<strong>这时我们将前两个已经短路的指令看作一个整体，返回0</strong>。</p><ul><li><code>parsecmd</code>中注意细节，每一个<code>return</code>都要对<code>mark</code>进行判断。</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>parsecmd</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv, <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>rightpipe, <span style=color:#8be9fd>int</span> mark) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> argc <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#39;a&#39;</span><span style=color:#ff79c6>:</span>; <span style=color:#6272a4>// &amp;&amp;
</span></span></span><span style=display:flex><span>			flag <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>			<span style=color:#8be9fd>int</span> child2 <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>fork</span>();
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (child2 <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>// child shell
</span></span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> mark <span style=color:#ff79c6>?</span> <span style=color:#8be9fd;font-style:italic>argc</span> : <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>			} <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// parent shell
</span></span></span><span style=display:flex><span>				<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> (env<span style=color:#ff79c6>-&gt;</span>return_value <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>					<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>parsecmd</span>(argv, rightpipe, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>				} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>					<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>parsecmd</span>(argv, rightpipe, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#39;o&#39;</span><span style=color:#ff79c6>:</span>; <span style=color:#6272a4>// ||
</span></span></span><span style=display:flex><span>			flag <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>			<span style=color:#8be9fd>int</span> child3 <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>fork</span>();
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (child3 <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> mark <span style=color:#ff79c6>?</span> <span style=color:#8be9fd;font-style:italic>argc</span> : <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>			} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> (env<span style=color:#ff79c6>-&gt;</span>return_value <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>					<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>parsecmd</span>(argv, rightpipe, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>				} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>					<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>parsecmd</span>(argv, rightpipe, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> argc;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>runcmd</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (argc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (argv[<span style=color:#bd93f9>0</span>]) { <span style=color:#6272a4>// 后边还有指令
</span></span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_send_return_value</span>(env<span style=color:#ff79c6>-&gt;</span>env_parent_id, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	argv[argc] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>这里有一个很奇怪的点，可能和我的设计有关，我必须将close_all移动到后面，否则不能即使recv返回值，导致返回值丢失进入死锁</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#8be9fd>int</span> child <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>spawn</span>(argv[<span style=color:#bd93f9>0</span>], argv); <span style=color:#6272a4>// spawn a new process to run the command
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (child <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (flag <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_send_return_value</span>(env<span style=color:#ff79c6>-&gt;</span>env_parent_id, env<span style=color:#ff79c6>-&gt;</span>return_value, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (job_flag <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) { <span style=color:#6272a4>// 需要创建后台任务 
</span></span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_create_job</span>(child, cmd);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>debugf</span>(<span style=color:#f1fa8c>&#34;spawn %s: %d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, argv[<span style=color:#bd93f9>0</span>], child);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (rightpipe) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>wait</span>(rightpipe);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>close_all</span>(); <span style=color:#6272a4>// close all file descriptors !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=三实现更多指令>三.实现更多指令<a hidden class=anchor aria-hidden=true href=#三实现更多指令>#</a></h2><h3 id=31-touch>3.1 <code>touch</code><a hidden class=anchor aria-hidden=true href=#31-touch>#</a></h3><ul><li><code>touch &lt;file></code>：不会出现创建多个文件的情况</li></ul><p>​ 新建<code>touch.c</code>并在<code>include.mk</code>中加入<code>touch.b</code>，<strong>检查文件是否存在的方式为先尝试打开，若不能成功打开则进行创建。</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>// touch.c
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span><span style=color:#ff79c6>&lt;lib.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>touch</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(path, O_RDONLY);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 首先检查文件是否存在
</span></span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>close</span>(fd);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 文件不存在，创建文件
</span></span></span><span style=display:flex><span>        fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(path, O_CREAT);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;touch: cannot touch &#39;%s&#39;: No such file or directory</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, path);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>close</span>(fd);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>(<span style=color:#8be9fd>int</span> argc, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> i;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (argc <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;touch: missing file operand</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>touch</span>(argv[<span style=color:#bd93f9>1</span>]);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=32-mkdir>3.2 <code>mkdir</code><a hidden class=anchor aria-hidden=true href=#32-mkdir>#</a></h3><ul><li><code>mkdir &lt;dir></code></li><li><code>mkdir -p &lt;dir></code></li></ul><p>​ <code>mkdir</code>的实现方式与<code>touch</code>类似，在<code>open</code>时传入<code>O_MKDIR</code>，需要注意的是要在文件系统服务函数<code>serv.c</code>中打开函数时相应加入对于<code>O_MKDIR</code>的判断。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>serve_open</span>(u_int envid, <span style=color:#ff79c6>struct</span> Fsreq_open <span style=color:#ff79c6>*</span>rq) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((rq<span style=color:#ff79c6>-&gt;</span>req_omode <span style=color:#ff79c6>&amp;</span> O_CREAT) <span style=color:#ff79c6>&amp;&amp;</span> (r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>file_create</span>(rq<span style=color:#ff79c6>-&gt;</span>req_omode, rq<span style=color:#ff79c6>-&gt;</span>req_path, <span style=color:#ff79c6>&amp;</span>f)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>	    r <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span>E_FILE_EXISTS) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>ipc_send</span>(envid, r, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((rq<span style=color:#ff79c6>-&gt;</span>req_omode <span style=color:#ff79c6>&amp;</span> O_MKDIR) <span style=color:#ff79c6>&amp;&amp;</span> (r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>file_create</span>(rq<span style=color:#ff79c6>-&gt;</span>req_omode, rq<span style=color:#ff79c6>-&gt;</span>req_path, <span style=color:#ff79c6>&amp;</span>f)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>	    r <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span>E_FILE_EXISTS) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>ipc_send</span>(envid, r, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>     <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 同时应当修改<code>file_create</code>函数，增加传入参数<code>rq->req_mode</code>，区分创建文件还是目录，为结构体的<code>type</code>字段赋值。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>file_create</span>(u_int req_mode, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path, <span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>**</span>file) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/*Shell Challenge*/</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (req_mode <span style=color:#ff79c6>==</span> O_MKDIR) {
</span></span><span style=display:flex><span>		f<span style=color:#ff79c6>-&gt;</span>f_type <span style=color:#ff79c6>=</span> FTYPE_DIR;
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		f<span style=color:#ff79c6>-&gt;</span>f_type <span style=color:#ff79c6>=</span> FTYPE_REG;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 具体的<code>mkdir</code>逻辑</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>#include</span><span style=color:#ff79c6>&lt;lib.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>mkdir</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path, <span style=color:#8be9fd>int</span> flag) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(path, O_RDONLY); <span style=color:#6272a4>// 首先检查文件是否存在
</span></span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>close</span>(fd);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>flag) { 
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;mkdir: cannot create directory &#39;%s&#39;: File exists</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, path);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// 文件不存在，创建文件
</span></span></span><span style=display:flex><span>        fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(path, O_MKDIR);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>flag) {
</span></span><span style=display:flex><span>                <span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;mkdir: cannot create directory &#39;%s&#39;: No such file or directory</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, path);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// 递归创建目录,例如 &#34;/nonexist/dqr/123&#34;
</span></span></span><span style=display:flex><span>                <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> path;
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;/&#39;</span>) { <span style=color:#6272a4>// 跳过开头的&#39;/&#39;
</span></span></span><span style=display:flex><span>                    p<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>while</span> (<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;/&#39;</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>                        <span style=color:#50fa7b>mkdir</span>(path, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;/&#39;</span>;
</span></span><span style=display:flex><span>                    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#50fa7b>mkdir</span>(path, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    p<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>close</span>(fd);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>(<span style=color:#8be9fd>int</span> argc, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argvs) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (argc <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;mkdir: missing operand</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 需要考虑参数p忽略错误
</span></span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strcmp</span>(argvs[<span style=color:#bd93f9>1</span>], <span style=color:#f1fa8c>&#34;-p&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>mkdir</span>(argvs[<span style=color:#bd93f9>2</span>], <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>mkdir</span>(argvs[<span style=color:#bd93f9>1</span>], <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=33-rm>3.3 <code>rm</code><a hidden class=anchor aria-hidden=true href=#33-rm>#</a></h3><ul><li><code>rm &lt;file></code></li><li><code>rm &lt;dir></code></li><li><code>rm -r &lt;dir>|&lt;file></code></li><li><code>rm -rf &lt;dir>|&lt;file></code></li></ul><p>​ 对于<code>rm</code>指令处理的关键在于对于参数的处理，我们知道删除目录时需要<code>-r/-rf</code>参数，所以需要特殊判断无参数删除目录文件的情况。我采用的方法是在文件系统删除请求结构体中加入一个模式字段，用来表示参数情况(<code>无参数为0，-r为1，-rf为2</code>)。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Fsreq_remove {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>char</span> req_path[MAXPATHLEN];
</span></span><span style=display:flex><span>	u_int remove_type;
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>​ 对于这个参数的传递，我选择了一种不太“优雅“的方式，由于不能修改<code>remove</code>函数的传参(remove函数在test中有引用，评测时替换为标准文件，若修改会导致编译不过)，<strong>我选择将模式数字拼接在路径字符串的\0之后，这样我们既可以读取模式数字，又可以保证读取路径的正确性。</strong></p><p>​ 在<code>remove</code>函数中将这个数字取出，沿着调用链进行传递。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>remove</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Call fsipc_remove.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// 最后一位为模式
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> len <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>strlen</span>(path);
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> type <span style=color:#ff79c6>=</span> path[<span style=color:#ff79c6>++</span>len] <span style=color:#ff79c6>-</span> <span style=color:#f1fa8c>&#39;0&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.13: Your code here. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>fsipc_remove</span>(path, type);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在<code>fsipc_remove</code>中构建请求结构体时对新增字段赋值，达到通过结构体传参的目的。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>fsipc_remove</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path, u_int type) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	req<span style=color:#ff79c6>-&gt;</span>remove_type <span style=color:#ff79c6>=</span> type;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在文件系统服务函数中，为<code>file_remove</code>新增模式参数</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>serve_remove</span>(u_int envid, <span style=color:#ff79c6>struct</span> Fsreq_remove <span style=color:#ff79c6>*</span>rq) {
</span></span><span style=display:flex><span>	r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>file_remove</span>(rq<span style=color:#ff79c6>-&gt;</span>req_path, rq<span style=color:#ff79c6>-&gt;</span>remove_type);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>ipc_send</span>(envid, r, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 修改具体的文件删除逻辑，当要删除的文件为目录但传递的参数为N(0)时，返回一种新的错误码(<code>E_IS_DIR=14,新增定义在error.h中</code>)</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>file_remove</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path, u_int type) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> r;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>f;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: find the file on the disk.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>walk_path</span>(path, <span style=color:#bd93f9>0</span>, <span style=color:#ff79c6>&amp;</span>f, <span style=color:#bd93f9>0</span>)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> r;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/*Shell Challenge*/</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (f<span style=color:#ff79c6>-&gt;</span>f_type <span style=color:#ff79c6>==</span> FTYPE_DIR <span style=color:#ff79c6>&amp;&amp;</span> type <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_IS_DIR;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 具体的<code>remove</code>逻辑：这里返回小于0值说明一定是N模式下删除了目录。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;lib.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>#define N 0
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define R 1
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define RF 2
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>rm</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path, <span style=color:#8be9fd>int</span> flag) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(path, O_RDONLY);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (flag <span style=color:#ff79c6>!=</span> RF) {
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;rm: cannot remove &#39;%s&#39;: No such file or directory</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, path);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>close</span>(fd);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>/*为了避免传参问题 将模式拼接在路径末尾\0之后*/</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>char</span> path1[MAXPATHLEN<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>];
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>strcpy</span>(path1, path);
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> len <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>strlen</span>(path1);
</span></span><span style=display:flex><span>        path1[<span style=color:#ff79c6>++</span>len] <span style=color:#ff79c6>=</span> flag <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#39;0&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>/********************/</span>
</span></span><span style=display:flex><span>        fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>remove</span>(path1);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (fd <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;rm: cannot remove &#39;%s&#39;: Is a directory</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, path);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>(<span style=color:#8be9fd>int</span> argc, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (argc <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;rm: missing operand</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strcmp</span>(argv[<span style=color:#bd93f9>1</span>], <span style=color:#f1fa8c>&#34;-r&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>rm</span>(argv[<span style=color:#bd93f9>2</span>], R);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strcmp</span>(argv[<span style=color:#bd93f9>1</span>], <span style=color:#f1fa8c>&#34;-rf&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>rm</span>(argv[<span style=color:#bd93f9>2</span>], RF);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#50fa7b>rm</span>(argv[<span style=color:#bd93f9>1</span>], N);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=四实现反引号>四.实现反引号<a hidden class=anchor aria-hidden=true href=#四实现反引号>#</a></h2><p>​ 使用反引号实现指令替换，<strong>只需要考虑<code>echo</code>进行的输出</strong>，需要将反引号内指令执行的所有标准输出替换为<code>echo</code>的参数。</p><ul><li>换句话说，执行一下反引号里边的内容</li></ul><p>​ 首先增加反引号<code>token</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>_gettoken</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>p1, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>p2) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span>(<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;`&#39;</span>) { <span style=color:#6272a4>// 识别反引号
</span></span></span><span style=display:flex><span>    	<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    	s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>    	<span style=color:#ff79c6>*</span>p1 <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>   		<span style=color:#ff79c6>while</span>(<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;&amp;</span> (<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#39;`&#39;</span>)){
</span></span><span style=display:flex><span>        	s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>    	}
</span></span><span style=display:flex><span>    	<span style=color:#ff79c6>*</span>s<span style=color:#ff79c6>++</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    	<span style=color:#ff79c6>*</span>p2 <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>    	<span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#39;f&#39;</span>; 
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在parsecmd中增加对应逻辑，这时反引号中间的指令已经被保存在字符串指针<code>t</code>中。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>parsecmd</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv, <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>rightpipe, <span style=color:#8be9fd>int</span> mark) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> argc <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#39;f&#39;</span><span style=color:#ff79c6>:</span>; <span style=color:#6272a4>// 反引号 
</span></span></span><span style=display:flex><span>			<span style=color:#50fa7b>runcmd</span>(t);
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>    	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=五实现注释功能>五.实现注释功能<a hidden class=anchor aria-hidden=true href=#五实现注释功能>#</a></h2><p>​ 使用<code>#</code>实现注释功能也就是对<code>#</code>后面的内容进行忽略，可以在进行执行指令时对字符串<code>#</code>后面的部分进行截断。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>//sh.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>runcmd</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/*Shell Challenge: #*/</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#39;#&#39;</span>) {
</span></span><span style=display:flex><span>		p<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>*</span>p <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>gettoken</span>(s, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=六实现历史指令>六.实现历史指令<a hidden class=anchor aria-hidden=true href=#六实现历史指令>#</a></h2><ul><li>启动<code>shell</code>时创建<code>.mosh_history</code>文件</li><li>运行命令时将命令保存到<code>.mosh_history</code></li><li><code>history</code>命令输出文件内容</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>create_history</span>() {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> fd;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(<span style=color:#f1fa8c>&#34;.mosh_history&#34;</span>, O_CREAT)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;create history file failed</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>save_history_cmd</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span> cmd) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> fd;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(<span style=color:#f1fa8c>&#34;.mosh_history&#34;</span>, O_WRONLY)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;open history file failed</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Stat st;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>stat</span>(<span style=color:#f1fa8c>&#34;.mosh_history&#34;</span>, <span style=color:#ff79c6>&amp;</span>st);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>seek</span>(fd, st.st_size);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>write</span>(fd, cmd, <span style=color:#50fa7b>strlen</span>(cmd));
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>write</span>(fd, <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>close</span>(fd);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>print_history</span>() {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> fd;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(<span style=color:#f1fa8c>&#34;.mosh_history&#34;</span>, O_RDONLY)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;open history file failed</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>char</span> ch;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (<span style=color:#50fa7b>read</span>(fd, <span style=color:#ff79c6>&amp;</span>ch, <span style=color:#bd93f9>1</span>)) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;%c&#34;</span>, ch);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>close</span>(fd);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=七实现一行多指令>七.实现一行多指令<a hidden class=anchor aria-hidden=true href=#七实现一行多指令>#</a></h2><p>​ 实现使用<code>;</code>将多条指令隔开从而从左至右依顺序执行每条指令的功能，通过修改<code>parsecmd()</code>函数使其增添对<code>;</code>的处理能力。在<code>parsecmd</code>的字符串解析过程中，若读到一个<code>;</code>，则进行一次<code>fork</code>，产生一个子<code>shell</code>，让子<code>shell</code>执行左边的命令，父<code>shell</code>等待子<code>shell</code>执行完成后执行右边的命令。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#39;;&#39;</span><span style=color:#ff79c6>:</span>;
</span></span><span style=display:flex><span>			<span style=color:#8be9fd>int</span> child <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>fork</span>();
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (child <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>// child shell
</span></span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> argc;
</span></span><span style=display:flex><span>			} <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// parent shell
</span></span></span><span style=display:flex><span>				<span style=color:#50fa7b>wait</span>(child); 
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>parsecmd</span>(argv, rightpipe);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span></code></pre></td></tr></table></div></div><h2 id=八实现追加重定向>八.实现追加重定向<a hidden class=anchor aria-hidden=true href=#八实现追加重定向>#</a></h2><ul><li>实现<code>>></code>的追加重定向的功能</li></ul><p>​ 首先增加一种<code>token</code>为<code>>></code>，在<code>_gettoken</code>中实现，标记为<code>z</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>_gettoken</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>p1, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>p2) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strchr</span>(SYMBOLS, <span style=color:#ff79c6>*</span>s)) { <span style=color:#6272a4>// 修改此处逻辑 识别 &amp;&amp; || ;
</span></span></span><span style=display:flex><span>		<span style=color:#8be9fd>int</span> t <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>s;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>p1 <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>		<span style=color:#6272a4>/*Shell Challenge*/</span>
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>=</span> s <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;&amp;&#39;</span>) {
</span></span><span style=display:flex><span>			s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>			t <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;a&#39;</span>;
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;|&#39;</span>) {
</span></span><span style=display:flex><span>			s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>			t <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;o&#39;</span>;
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s1 <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;&gt;&#39;</span>) {
</span></span><span style=display:flex><span>			s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>			t <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;z&#39;</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>s<span style=color:#ff79c6>++</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>p2 <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> t;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在<code>parsecmd</code>中进行修改，为文件设置好偏移量后进行<code>dup</code></p><ul><li><code>stat</code>获取文件信息</li><li><code>seek</code>设置文件偏移量</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>parsecmd</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv, <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>rightpipe, <span style=color:#8be9fd>int</span> mark) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> argc <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#39;z&#39;</span><span style=color:#ff79c6>:</span>; <span style=color:#6272a4>// 实现追加重定向
</span></span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>gettoken</span>(<span style=color:#bd93f9>0</span>, <span style=color:#ff79c6>&amp;</span>t) <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#39;w&#39;</span>) {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>debugf</span>(<span style=color:#f1fa8c>&#34;syntax error: &gt; not followed by word</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> ((fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(t, O_RDONLY <span style=color:#ff79c6>|</span> O_WRONLY <span style=color:#ff79c6>|</span> O_CREAT)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>debugf</span>(<span style=color:#f1fa8c>&#34;failed to open %s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, t);
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>struct</span> Stat st;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>fstat</span>(fd, <span style=color:#ff79c6>&amp;</span>st) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>debugf</span>(<span style=color:#f1fa8c>&#34;failed to fstat %s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, t);
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>seek</span>(fd, st.st_size);
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> ((r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>dup</span>(fd, <span style=color:#bd93f9>1</span>)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>debugf</span>(<span style=color:#f1fa8c>&#34;failed to duplicate file to &lt;stdout&gt;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>close</span>(fd);
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;	
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> argc;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=九实现引号支持>九.实现引号支持<a hidden class=anchor aria-hidden=true href=#九实现引号支持>#</a></h2><p>​ <code>shell</code>在解析时需要将双引号内的内容看作是单个字符串，在解析字符串时加了一种<code>token</code>为字符串，修改<code>_gettoken</code>中的逻辑。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#6272a4>/*Shell Challenge : &#34;content&#34;*/</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;&#34;&#39;</span>) { <span style=color:#6272a4>// read until the next &#39;&#34;&#39;
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>p1 <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>!=</span> <span style=color:#f1fa8c>&#39;&#34;&#39;</span>) {
</span></span><span style=display:flex><span>			s<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>(s<span style=color:#ff79c6>++</span>) <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>// *s = &#39;&#34;&#39;
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>p2 <span style=color:#ff79c6>=</span> s;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#39;w&#39;</span>;
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><h2 id=十实现前后台任务管理>十.实现前后台任务管理<a hidden class=anchor aria-hidden=true href=#十实现前后台任务管理>#</a></h2><h3 id=101-实现后台任务并行>10.1 实现后台任务并行<a hidden class=anchor aria-hidden=true href=#101-实现后台任务并行>#</a></h3><p>​ 此功能的实现与实现一行多指令类似，后台运行任务即在<code>fork</code>之后父进程不会等待子进程运行完成。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>		<span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#39;&amp;&#39;</span><span style=color:#ff79c6>:</span>;
</span></span><span style=display:flex><span>			job_flag <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>			<span style=color:#8be9fd>int</span> child <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>fork</span>();
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (child <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>// child shell
</span></span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> argc;
</span></span><span style=display:flex><span>			} <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// parent shell
</span></span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>parsecmd</span>(argv, rightpipe);
</span></span><span style=display:flex><span>			}		
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;	
</span></span></code></pre></td></tr></table></div></div><h3 id=102-实现jobs指令>10.2 实现<code>jobs</code>指令<a hidden class=anchor aria-hidden=true href=#102-实现jobs指令>#</a></h3><blockquote><p>关于后台任务的三个指令我们需要实现为内置指令，shell中分为内置指令和外部指令，外部指令需要fork一个子进程进行执行，而内置指令不会，效率更高。</p><ul><li>基本的实现思路为我们在runcmd时检查指令，如果为内置指令不再进行<code>spawn</code>而是直接调用<code>sh.c</code>中写好的函数执行。</li><li>为了实现进程间的共享，我选择在内核态对后台进程进行管理，通过系统调用<code>syscall_*</code>进行更新</li><li>加系统调用的流程上机考试早已熟悉</li></ul></blockquote><p>​ <strong>首先：如何实现内置指令</strong>，区别于外部指令，内部指令执行时不会进行<code>fork</code>，效率更高，当我们在<code>runcmd</code>时应当特判遇到的内置指令，调用<code>sh.c</code>中写好的处理函数执行。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strcmp</span>(argv[<span style=color:#bd93f9>0</span>], <span style=color:#f1fa8c>&#34;jobs&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>execute_jobs</span>();
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strcmp</span>(argv[<span style=color:#bd93f9>0</span>], <span style=color:#f1fa8c>&#34;fg&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>int</span> jobId <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>parseJobId</span>(argv[<span style=color:#bd93f9>1</span>]);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>execute_fg</span>(jobId);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strcmp</span>(argv[<span style=color:#bd93f9>0</span>], <span style=color:#f1fa8c>&#34;kill&#34;</span>) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>int</span> jobId <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>parseJobId</span>(argv[<span style=color:#bd93f9>1</span>]);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>execute_kill</span>(jobId);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><p>​ 为了更好的管理工作的信息，我选择新建一个<code>Job</code>结构体，定义在<code>env.h</code>中</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Job {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> job_id;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> job_status; <span style=color:#6272a4>// 0 for Done; 1 for Running 
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> envid;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>char</span> cmd[<span style=color:#bd93f9>1024</span>];
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>​ 在内核态对<code>struct Job</code>数组进行管理，将数组定义在<code>env.c</code>中便于操作。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Job jobs[<span style=color:#bd93f9>32</span>];
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> jobCnt <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span></code></pre></td></tr></table></div></div><p>​ **重点在于何时将进程放入后台：**我们设置一个全局变量<code>job_flag</code>读到<code>&</code>时置为1,在<code>runcmd</code>时，对这个标记进行特判，从而将进程放到后台，<strong>这里需要注意的是，<code>recv</code>应当在<code>syscall_create_job</code>之后，否则会一直阻塞，不能加入到后台，直到进程运行完毕才能加入到后台。</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (child <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (flag <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_send_return_value</span>(env<span style=color:#ff79c6>-&gt;</span>env_parent_id, env<span style=color:#ff79c6>-&gt;</span>return_value, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (job_flag <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) { <span style=color:#6272a4>// 需要创建后台任务 
</span></span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_create_job</span>(child, cmd);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>syscall_recv_return_value</span>();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} 
</span></span></code></pre></td></tr></table></div></div><p>​ 这里创建后台任务也是通过系统调用实现，实际上是对内核态<code>jobs</code>数组赋值的操作，这样就实现了加入后台任务。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>//env.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>env_create_job</span>(u_int envid, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span> cmd) {
</span></span><span style=display:flex><span>	jobs[jobCnt].envid <span style=color:#ff79c6>=</span> envid;
</span></span><span style=display:flex><span>	jobs[jobCnt].job_status <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; <span style=color:#6272a4>// Running
</span></span></span><span style=display:flex><span>	<span style=color:#50fa7b>strcpy</span>(jobs[jobCnt].cmd, cmd);
</span></span><span style=display:flex><span>	jobs[jobCnt].job_id <span style=color:#ff79c6>=</span> jobCnt <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>	jobCnt<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 加入后台时，将运行状态<code>status</code>设置为1(<code>Running</code>)，0(<code>Done</code>).</p><p>​ <code>jobs</code>操作实际上是一个“输出”操作，我们通过系统调用实现。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>//sh.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>execute_jobs</span>() { <span style=color:#6272a4>// 约等于无用封装
</span></span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_print_jobs</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>//env.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>env_print_jobs</span>() {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> jobCnt; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (jobs[i].job_status <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>printk</span>(<span style=color:#f1fa8c>&#34;[%d] %-10s 0x%08x %s</span><span style=color:#f1fa8c>\n\r</span><span style=color:#f1fa8c>&#34;</span>, jobs[i].job_id, <span style=color:#f1fa8c>&#34;Running&#34;</span>, jobs[i].envid, jobs[i].cmd);
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>printk</span>(<span style=color:#f1fa8c>&#34;[%d] %-10s 0x%08x %s</span><span style=color:#f1fa8c>\n\r</span><span style=color:#f1fa8c>&#34;</span>, jobs[i].job_id, <span style=color:#f1fa8c>&#34;Done&#34;</span>, jobs[i].envid, jobs[i].cmd);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ <strong>这里还有很重要的一点是：后台进程状态的变化</strong>，当后台进程结束时，应当设置状态为<code>Done</code>，而我们知道后台进程结束点是在<code>libmain</code>，在<code>libmain</code>中通过系统调用更改<code>job_status = 0(Done)</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>// libos.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>libmain</span>(<span style=color:#8be9fd>int</span> argc, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_set_job_done</span>(env<span style=color:#ff79c6>-&gt;</span>env_id);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// exit gracefully
</span></span></span><span style=display:flex><span>	<span style=color:#50fa7b>exit</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>//env.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>env_set_job_done</span>(u_int envid) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> jobCnt; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (jobs[i].envid <span style=color:#ff79c6>==</span> envid) {
</span></span><span style=display:flex><span>			jobs[i].job_status <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=103-实现fg指令>10.3 实现<code>fg</code>指令<a hidden class=anchor aria-hidden=true href=#103-实现fg指令>#</a></h3><ul><li><p>首先构建一个简单的辅助函数，用来将<code>argv[1]</code>转换为<code>&lt;jobid></code></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>parseJobId</span>(<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> jobId <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>*</span>s) {
</span></span><span style=display:flex><span>		jobId <span style=color:#ff79c6>=</span> jobId <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>10</span> <span style=color:#ff79c6>+</span> (<span style=color:#ff79c6>*</span>s <span style=color:#ff79c6>-</span> <span style=color:#f1fa8c>&#39;0&#39;</span>);
</span></span><span style=display:flex><span>		s<span style=color:#ff79c6>++</span>; 
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> jobId;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p><code>fg</code>命令同样通过系统调用实现，<strong>并不需要从后台<code>jobs</code>中删除<code>jobid</code>的目录项</strong>，只需到前台运行该进程，或者说当前运行进程wait这个后台进程。</p><ul><li>说个题外话，我是没想到不用从jobs列表中删除该项的，因为linux中的行为是进行删除，而课程组的建议是仿照linux行为实现，并且挑战性任务说明书一坨，MOS居然有了这么离谱的举动，居然也不在挑战性任务中说明或给出样例，等大家猜吗&mldr;</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>//sh.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>execute_fg</span>(<span style=color:#8be9fd>int</span> jobId) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> envid <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>syscall_fg_job</span>(jobId);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (envid <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;fg: job (%d) do not exist</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, jobId);
</span></span><span style=display:flex><span>	}  <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (envs[<span style=color:#50fa7b>ENVX</span>(envid)].env_status <span style=color:#ff79c6>!=</span> ENV_RUNNABLE) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;fg: (0x%08x) not running</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, envid);
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>wait</span>(envid);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>//env.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>env_fg_job</span>(<span style=color:#8be9fd>int</span> jobId) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> jobCnt; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (jobs[i].job_id <span style=color:#ff79c6>==</span> jobId) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> jobs[i].envid;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=104-实现kill指令>10.4 实现<code>kill</code>指令<a hidden class=anchor aria-hidden=true href=#104-实现kill指令>#</a></h3><ul><li><p><code>kill</code>命令同样通过系统调用实现，杀死后台进程</p></li><li><p>同样不需要从Jobs列表中删除&mldr;</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>// sh.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>execute_kill</span>(<span style=color:#8be9fd>int</span> jobId) {
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_kill_job</span>(jobId);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// env.c
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>env_kill_job</span>(<span style=color:#8be9fd>int</span> jobId) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> jobCnt; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (jobs[i].job_id <span style=color:#ff79c6>==</span> jobId) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (envs[<span style=color:#50fa7b>ENVX</span>(jobs[i].envid)].env_status <span style=color:#ff79c6>!=</span> ENV_RUNNABLE) {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>printk</span>(<span style=color:#f1fa8c>&#34;fg: (0x%08x) not running</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, jobs[i].envid);
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>			} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>env_destroy</span>(<span style=color:#ff79c6>&amp;</span>envs[<span style=color:#50fa7b>ENVX</span>(jobs[i].envid)]);
</span></span><span style=display:flex><span>				jobs[i].job_status <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>printk</span>(<span style=color:#f1fa8c>&#34;fg: job (%d) do not exist</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, jobId);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://coder0xe.github.io/tags/june/>June</a></li></ul><nav class=paginav><a class=prev href=https://coder0xe.github.io/posts/oo-unit4/><span class=title>« Prev</span><br><span>OO-Unit4</span>
</a><a class=next href=https://coder0xe.github.io/posts/os-lab6%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/><span class=title>Next »</span><br><span>OS:lab6实验报告</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:Shell挑战性任务 on x" href="https://x.com/intent/tweet/?text=OS%3aShell%e6%8c%91%e6%88%98%e6%80%a7%e4%bb%bb%e5%8a%a1&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-shell%25E6%258C%2591%25E6%2588%2598%25E6%2580%25A7%25E4%25BB%25BB%25E5%258A%25A1%2f&amp;hashtags=June"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:Shell挑战性任务 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-shell%25E6%258C%2591%25E6%2588%2598%25E6%2580%25A7%25E4%25BB%25BB%25E5%258A%25A1%2f&amp;title=OS%3aShell%e6%8c%91%e6%88%98%e6%80%a7%e4%bb%bb%e5%8a%a1&amp;summary=OS%3aShell%e6%8c%91%e6%88%98%e6%80%a7%e4%bb%bb%e5%8a%a1&amp;source=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-shell%25E6%258C%2591%25E6%2588%2598%25E6%2580%25A7%25E4%25BB%25BB%25E5%258A%25A1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:Shell挑战性任务 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-shell%25E6%258C%2591%25E6%2588%2598%25E6%2580%25A7%25E4%25BB%25BB%25E5%258A%25A1%2f&title=OS%3aShell%e6%8c%91%e6%88%98%e6%80%a7%e4%bb%bb%e5%8a%a1"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:Shell挑战性任务 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-shell%25E6%258C%2591%25E6%2588%2598%25E6%2580%25A7%25E4%25BB%25BB%25E5%258A%25A1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:Shell挑战性任务 on whatsapp" href="https://api.whatsapp.com/send?text=OS%3aShell%e6%8c%91%e6%88%98%e6%80%a7%e4%bb%bb%e5%8a%a1%20-%20https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-shell%25E6%258C%2591%25E6%2588%2598%25E6%2580%25A7%25E4%25BB%25BB%25E5%258A%25A1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:Shell挑战性任务 on telegram" href="https://telegram.me/share/url?text=OS%3aShell%e6%8c%91%e6%88%98%e6%80%a7%e4%bb%bb%e5%8a%a1&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-shell%25E6%258C%2591%25E6%2588%2598%25E6%2580%25A7%25E4%25BB%25BB%25E5%258A%25A1%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:Shell挑战性任务 on ycombinator" href="https://news.ycombinator.com/submitlink?t=OS%3aShell%e6%8c%91%e6%88%98%e6%80%a7%e4%bb%bb%e5%8a%a1&u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-shell%25E6%258C%2591%25E6%2588%2598%25E6%2580%25A7%25E4%25BB%25BB%25E5%258A%25A1%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://coder0xe.github.io/>coder0xe's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>