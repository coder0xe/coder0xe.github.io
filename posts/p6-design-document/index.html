<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>P6-design-document | coder0xe's blog</title><meta name=keywords content="计组"><meta name=description content="P6设计文档"><meta name=author content="sudo"><link rel=canonical href=https://coder0xe.github.io/posts/p6-design-document/><link crossorigin=anonymous href=/assets/css/stylesheet.e4a36188e2c44563c1cc5ed1a2d0b8451a4f68c685114d738b97609f82dae050.css integrity="sha256-5KNhiOLERWPBzF7RotC4RRpPaMaFEU1zi5dgn4La4FA=" rel="preload stylesheet" as=style><link rel=icon href=https://coder0xe.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://coder0xe.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://coder0xe.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://coder0xe.github.io/apple-touch-icon.png><link rel=mask-icon href=https://coder0xe.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://coder0xe.github.io/posts/p6-design-document/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://coder0xe.github.io/posts/p6-design-document/"><meta property="og:site_name" content="coder0xe's blog"><meta property="og:title" content="P6-design-document"><meta property="og:description" content="P6设计文档"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-28T20:56:55+08:00"><meta property="article:modified_time" content="2023-11-28T20:56:55+08:00"><meta property="article:tag" content="Nov"><meta name=twitter:card content="summary"><meta name=twitter:title content="P6-design-document"><meta name=twitter:description content="P6设计文档"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://coder0xe.github.io/posts/"},{"@type":"ListItem","position":2,"name":"P6-design-document","item":"https://coder0xe.github.io/posts/p6-design-document/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"P6-design-document","name":"P6-design-document","description":"P6设计文档","keywords":["计组"],"articleBody":"P6-Design-Document 一.数据通路图示 ​\tP6在P5的基础上新增乘除槽单元、字节使能单元、数据扩展单元，在顶层模块中增加与testbench的接口，将IM与DM外移到testbench中。\n二.功能模块定义 1. MCU 1.端口定义列表 名称 方向 位宽 描述 D_opcode I 6 操作码 D_funct I 6 功能码 SelA3_D O 2 选择写入寄存器地址 RegWrite_D O 1 寄存器堆写入地址 EXTOp_D O 1 立即数扩展信号 SelEMout_D O 1 选择E、M级转发数据 SelWout_D O 2 选择W级转发数据/写入GRF数据 SeLALUB_D O 1 选择ALU_B端口输入数据 SelALUS_D O 1 选择ALU_S端口移位数据 check_D O 1 判定是否为新信号(课上扩展使用) mf_D O 1 mfhi/mflo指令，选择E级输出数据 start_D O 1 乘除类导致延迟的指令信号，只有md类需要 CMPOp_D O 3 B类跳转指令操作码 NPCOp_D O 3 跳转地址选择 ALUOp_D O 4 ALU计算操作 MDUOp_D O 4 乘除类计算操作 DMOp_D O 4 存取指令操作 T_rs_use_D O 2 位于D级用到rs寄存器中值的周期数 T_rt_use_D O 2 位于D级用到rt寄存器中值的周期数 T_new_D O 2 位于D级产生新信号的周期数 注：由于BE模块产生字节使能信号，将原内存写入使能信号MemWrite省去\n2.指令分类与T_use/T_new处理 指令分类如下\n类别 包含的指令 cal_R add,sub,and,or,slt,sltu cal_I andi,ori,addi,lui shift sll shiftv sllv branch beq,bne store sw,sh,sb load lw,lh,lb md（有运算延迟） mult,multu,div,divu mf（读取） mfhi,mflo mt（写入） mthi,mtlo ​\t对指令进行分类的好处是使得控制信号的产生更加简洁，增加指令时可以先考虑它属于哪一类\n1 2 3 4 5 6 7 8 9 assign T_rs_use_D = (branch | op_jr | op_jalr) ? 2'b00 : (cal_R | cal_I | load | store | shiftv | md | mt) ? 2'b01 : 2'b11;//用不到置为3 assign T_rt_use_D = (branch) ? 2'b00 : (cal_R | shift | shiftv | md) ? 2'b01 : 2'b11; assign T_new_D = (load) ? 2'b11 : (cal_R | cal_I | shift | shiftv | mf) ? 2'b10 : 2'b00; 3.HCU 1.端口定义列表 输入信号 方向 位宽 描述 MDUOp_D I 4 D级当前指令是否为乘除指令 D_A1 I 5 D级A1输入 D_A2 I 5 D级A2输入 E_A1 I 5 E级A1输入 E_A2 I 5 E级A2输入 E_A3 I 5 E级A3输入 check_E I 1 课上扩展 start I 1 E级乘除运算启动信号 busy I 1 E级乘除运算进行符号 M_A2 I 5 M级A2输入 M_A3 I 5 M级A3输入 check_M I 1 课上扩展 W_A3 I 5 W级A3输入 RegWrite_E I 1 E级保存的GRF写入使能信号 RegWrite_M I 1 M级保存的GRF写入使能信号 RegWrite_W I 1 W级保存的GRF写入使能信号 T_rs_use I 2 D级中MCU输出的T_rs_use_D信号 T_rt_use I 2 D级中MCU输出的T_rt_use_D信号 T_new_E I 2 E级中T_new_E输入 T_new_M I 2 M级中T_new_M输入 T_new_W I 2 W级中T_new_W输入 输出信号 位宽 作用级 描述 FwdCMPD1 2 D 对HMUX_CMP_D1输出进行选择 FwdCMPD2 2 D 对HMUX_CMP_D2输出进行选择 FwdALUA 2 E 对HMUX_ALU_A输出进行选择 FwdALUB 2 E 对HMUX_ALU_B输出进行选择 FwdDM 1 M 对HMUX_DM的输出进行选择 stall 1 D,F,M 暂停信号 2.暂停与转发 将P5中列举出的8种暂停情况合并为4种，更加简洁且易于扩展\n针对乘除槽增加暂停信号\n当 busy 信号或 start 信号为 1 时，mult, multu, div, divu, mfhi, mflo, mthi, mtlo 等乘除法相关的指令均被阻塞在 D 流水级\n转发与P5相比未作改动\n1 2 3 4 5 6 7 8 wire stall_rs_e = (T_rs_use \u003c T_new_E)\u0026\u0026(D_A1 == E_A3)\u0026\u0026(D_A1 != 5'b0)\u0026\u0026(RegWrite_E); wire stall_rs_m = (T_rs_use \u003c T_new_M)\u0026\u0026(D_A1 == M_A3)\u0026\u0026(D_A1 != 5'b0)\u0026\u0026(RegWrite_M); wire stall_rs = stall_rs_e | stall_rs_m ; wire stall_rt_e = (T_rt_use \u003c T_new_E)\u0026\u0026(D_A2 == E_A3)\u0026\u0026(D_A2 != 5'b0)\u0026\u0026(RegWrite_E); wire stall_rt_m = (T_rt_use \u003c T_new_M)\u0026\u0026(D_A2 == M_A3)\u0026\u0026(D_A2 != 5'b0)\u0026\u0026(RegWrite_M); wire stall_rt = stall_rt_e | stall_rt_m ; wire stall_mdu = (MDUOp_D != 4'b0000)\u0026\u0026(busy | start); assign stall = stall_rs | stall_rt | stall_mdu; 3.ALU 1.端口定义列表 名称 方向 位宽 描述 src_A I 32 操作数1 src_B I 32 操作数2 shamt_f I 5 移位数据 ALUOp I 3 运算类型 AO O 32 运算结果 2.ALUOp编码与运算选择 ALU运算 ALUOp编码 + 0000 - 0001 | 0010 \u0026 0011 load to higher half (lui) 0100 signed compare (slt) 0101 unsigned compare(sltu) 0110 « 0111 4.EXT 端口定义列表 名称 方向 位宽 描述 imm I 16 D级16位立即数 EXTOp I 1 选择进行符号扩展/零扩展 imm_32 I 32 位扩展结果 5.GRF 1.端口定义列表 名称 方向 位宽 描述 clk I 1 时钟信号 reset I 1 同步复位信号 rs I 5 rs寄存器 rt I 5 rt寄存器 rd I 5 rd寄存器 pc I 32 指令执行地址 datawrite I 32 写入数据选择 RegWrite I 1 写入使能 dataread1 O 32 读rs寄存器 dataread2 O 32 读rt寄存器 注意：这里的RegWrite,datawirte,A3(rd),pc信号均来自W级\n2.GRF内部转发 ​\t设计GRF内部转发逻辑：GRF既是D级的一个部件又是W级之后的流水线寄存器。当W级写GRF，D级读GRF时，如果读取寄存器与写入寄存器为同一寄存器时不进行转发，新值虽然被写入GRF但流入E级的值依然为旧值。\n判断条件：当写入信号RegWrite有效且A1==A3或A2==A3时，将写入值作为对应输出值\n判断逻辑如下:\n1 2 //forward assign dataread1 = (RegWrite \u0026\u0026 rs == rd \u0026\u0026 rd != 0) ? datawrite : grf[rs]; 6.IFU 端口定义列表 名称 方向 位宽 描述 clk I 1 时钟信号 reset I 1 同步复位信号 en I 1 使能信号(~stall) npc I 32 下一指令地址 pc O 32 F级当前地址 pc8 O 32 输出PC+8，随流水段传递(jal考虑延迟槽) instr O 32 取出的指令 7.NPC 1.端口定义列表 名称 方向 位宽 描述 D_pc I 32 D级PC F_pc I 32 F级PC b_result I 1 D级CMP模块判断结果 b_offset I 32 B类指令的跳转地址 j_address I 26 J类指令跳转地址 reg_address I 32 跳转到寄存器中的地址(jr) NPCOp I 3 地址选择信号 npc O 32 程序下一条指令地址 2.NPCOp编码与地址选择 NPCOp编码 选择跳转地址 000 F_pc + 4 001(B) \u0026\u0026 b_result D_pc + 4 + (b_offset « 2’b10) 010(jal) {(D_pc + 4)[31:28],j_address,2’b00} 011(jr) reg_address 注：NPC是横跨D级和E级的模块，如果是beq或jal等指令，则需要在D_pc基础上进行操作，否则为F_pc+4\n8.CMP 1.端口定义列表 名称 方向 位宽 描述 D_V1 I 32 GRF中读出的rs寄存器的值 D_V2 I 32 GRF中读出的rt寄存器的值 CMPOp I 3 选择比较类型 b_result O 1 是否满足B类跳转指令的跳转条件 2.CMPOp编码与对应指令 当前只实现beq，该信号的设置更大的意义在于其可扩展性，便于课上添加指令\nCMPOp编码 对应指令 000 beq 001 bne … … 9.MDU 1.端口定义列表 名称 方向 位宽 描述 clk I 1 时钟信号 reset I 1 同步复位信号 start I 1 开始乘除运算信号 MDUOp I 4 乘除操作 A I 32 操作数A B I 32 操作数B out I 32 mfhi/mflo输出结果 busy I 1 正在执行乘除运算指示信号 2.MDUOp编码与对应指令 DMOp编码 对应指令 0000 非乘除指令，记为nop 0001 mult 0010 multu 0011 div 0100 divu 0101 mfhi 0110 mflo 0111 mthi 1000 mtlo 3.代码实现逻辑 乘法mult/multu延迟5周期，除法div/divu延迟10周期，在计算出结果后存储在tmpHI,tmpLO中，等到耗满延迟再转存入HI,LO.mfhi/mflo从HI,LO中读取。 设置计数器 判断是否达到该种运算的延迟(delay)，若达到，则将数值从tmp转存入HI/LO，同时将busy信号置0 实际上得到的结果为64位的结果，使用{tmpHI,tmpLO}位拼接写法进行拆分。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 // counter always@(posedge clk)begin if(reset)begin cnt \u003c= 32'b0; busy \u003c= 1'b0; end else if(start)begin //start claculate busy \u003c= 1'b1; end else if(busy) begin if(cnt == delay - 1)begin //next T : busy = 0 cnt \u003c= 32'b0; busy \u003c= 1'b0; end else begin cnt \u003c= cnt + 1'b1; end end end always@(posedge clk)begin if(reset)begin tmpHI \u003c= 32'b0; tmpLO \u003c= 32'b0; HI \u003c= 32'b0; LO \u003c= 32'b0; end else begin if (!busy) begin //进行新运算 case(MDUOp) mult : begin delay \u003c= 4'b0101; //5 {tmpHI,tmpLO} \u003c= $signed(A) * $signed(B); end multu : begin delay \u003c= 4'b0101; {tmpHI,tmpLO} \u003c= $unsigned(A) * $unsigned(B); end div : begin delay \u003c= 4'b1010; //10 tmpLO \u003c= $signed(A) / $signed(B); tmpHI \u003c= $signed(A) % $signed(B); end divu : begin delay \u003c= 4'b1010; tmpLO \u003c= $unsigned(A) / $unsigned(B); tmpHI \u003c= $unsigned(A) % $unsigned(B); end mthi : HI \u003c= A; mtlo : LO \u003c= A; endcase end else begin //保持老运算 if(cnt == delay - 1'b1)begin // next T : busy = 0; HI \u003c= tmpHI; LO \u003c= tmpLO; end else begin HI \u003c= HI; LO \u003c= LO; end end end end // mfhi/mflo为组合逻辑 assign out = (MDUOp == mfhi)? HI : (MDUOp == mflo)? LO : 32'b0; endmodule 10.BE 1.端口定义列表 名称 方向 位宽 描述 address I 32 存数据地址 DMOp I 4 存数操作 WD_in I 32 未经处理的存入数据 byteen O 4 字节使能信号 WD_out O 32 处理后的存入数据(字/半字/字节) 注：byteen为存入字节使能信号、对应位置的值为1表示允许存入，如sw-\u003ebyteen = 1111 2.DMOp编码与存数操作 DMOp 对应指令 0001 sw 0010 sh 0011 sb 11.DE 1.端口定义列表 名称 方向 位宽 描述 address I 32 取数地址 DMOp I 4 取数操作 RD_in I 32 未经处理的取出数据 RD_out O 32 处理后的取出数据 2.DMOp编码与取数操作 DMOp 对应指令 1000 lw 1001 lh 1010 lb 12.MUX 1.功能多路选择器 1.MUX_A3 D级写入寄存器选择 端口定义列表 名称 方向 位宽 描述 D_instr_rs I 5 instr中rs段 D_instr_rt I 5 instr中rt段 SelA3_D I 2 rd选择信号 D_A3 O 5 写入寄存器A3 选择信号与结果 SelA3_D D_A3 2’b10 31 2’b01 rd 2’b00 rt 2.MUX_ALU_B ALUB端口选择 端口定义列表 名称 方向 位宽 描述 E_V2_f I 32 转发后的V2 E_E32 I 32 32位立即数 SelALUB_E I 1 选择信号 E_ALU_B O 32 输出到ALUB端口的结果 选择信号与结果 SelALUB_E E_ALU_B 1’b1 E_E32 1’b0 E_V2_f 3.MUX_E_out 选择E级转发数据 端口定义列表 名称 方向 位宽 描述 E_E32 I 32 32位立即数 E_pc8 I 32 流水PC8(jal) SelEMout_E I 1 选择信号 E_out O 32 E级转发数据 选择信号与结果 SelEMout_E E_out 1’b1 E_pc8 1’b0 E_E32 4.MUX_M_out 选择M级转发数据 端口定义列表 名称 方向 位宽 描述 M_AO I 32 M级ALU计算结果 M_pc8 I 32 流水PC8(jal) SelEMout_M I 1 选择信号 M_out O 32 M级转发数据 选择信号与结果 SelEMout_M M_out 1’b1 M_pc8 1’b0 M_AO 5.MUX_W_out 选择W级转发数据 端口定义列表 名称 方向 位宽 描述 W_AO I 32 W级ALU计算结果 W_DR I 32 W级DM中读取出的数据 W_pc8 I 32 W级流水PC8(jal) SelWout_W I 2 选择信号 W_out O 32 W级转发数据/GRF写入数据 选择信号与结果 SelWout_W W_out 2’b10 W_pc8 2’b01 W_DR 2’b00 W_AO 6.MUX_MDU_ALU选择E级输出数据 端口定义列表 名称 方向 位宽 描述 E_AO I 32 ALU输出 E_MDU_out I 32 MDU输出 E_mf I 1 是否为mf类指令 E_AO_new O 32 E级输出值 选择信号与结果 E_mf E_AO_new 1 E_MDU_out 0 E_AO 2.转发多路选择器 1.HMUX_CMP_D1 CMP模块rs寄存器值转发 端口定义列表 名称 方向 位宽 描述 GRF_RD1 I 32 GRF中读取出的rs值 M_out I 32 M级转发数据 E_out I 32 E级转发数据 FwdCMPD1 I 2 选择信号 D_V1_f O 32 转发后的rs寄存器值 ​\t注：转发寄存器中有数据优先级的问题，越新产生的数据优先级越高，考虑到GRF中内部转发的逻辑，事实上GRF_RD1也代表着潜在的W级转发数据，但是仍然不破坏优先级关系E\u003eM\u003eW\n选择信号与结果 FwdCMPD1 D_V1_f 2’b10 E_out 2’b01 M_out 2’b00 GRF_RD1 2.HMUX_CMP_D2 CMP模块rt寄存器值转发 端口定义列表 名称 方向 位宽 描述 GRF_RD2 I 32 GRF中读取出的rt值 M_out I 32 M级转发数据 E_out I 32 E级转发数据 FwdCMPD2 I 2 选择信号 D_V2_f O 32 转发后的rt寄存器值 选择信号与结果 FwdCMPD2 D_V1_f 2’b10 E_out 2’b01 M_out 2’b00 GRF_RD2 3.HMUX_ALU_A ALU模块V1值转发/MDU输入V1 端口定义列表 名称 方向 位宽 描述 E_V1 I 32 GRF中读取出的rs值 M_out I 32 M级转发数据 W_out I 32 W级转发数据 FwdALUA I 2 选择信号 E_V1_f O 32 转发后的V1值 选择信号与结果 FwdALUA E_V1_f 2’b10 M_out 2’b01 W_out 2’b00 E_V1 4.HMUX_ALU_B ALU模块V2值转发/MDU输入V2 端口定义列表 名称 方向 位宽 描述 E_V2 I 32 GRF中读取出的rt值 M_out I 32 M级转发数据 W_out I 32 W级转发数据 FwdALUB I 2 选择信号 E_V2_f O 32 转发后的V2值 选择信号与结果 FwdALUB E_V2_f 2’b10 M_out 2’b01 W_out 2’b00 E_V2 5.HMUX_DM DM写入数据转发 端口定义列表 名称 方向 位宽 描述 M_V2 I 32 M级V2 W_out I 32 W级转发数据 FwdDM I 1 选择信号 M_V1_f O 32 DM写入数据 选择信号与结果 FwdDM M_V1_f 1’b1 W_out 1’b0 M_V2 6.HMUX_NPC NPC模块跳转寄存器值转发 端口定义列表 名称 方向 位宽 描述 GRF_RD1 I 32 GRF中读取出的rs值 M_out I 32 M级转发数据 E_out I 32 E级转发数据 FwdCMPD1 I 2 选择信号 D_RA_f O 32 转发后的rs寄存器值 ​\t注：其实可以共用CMPD1的转发数据\n选择信号与结果 FwdCMPD1 D_RA_f 2’b10 E_out 2’b01 M_out 2’b00 GRF_RD1 13.流水线寄存器 1.D_REG 名称 方向 位宽 描述 clk I 1 时钟信号 reset I 1 同步复位信号 en I 1 ~stall（冻结D级） F_instr I 32 F级取指令 F_pc I 32 F级PC F_pc8 I 32 F级PC+8(jal) D_instr O 32 D级执行指令 D_pc O 32 D级PC D_pc8 O 32 D级PC+8 2.E_REG 名称 方向 位宽 描述 clk I 1 时钟信号 reset I 1 同步复位信号 clr I 1 stall(清空E级) D_V1 I 32 D级GRF中读取rs寄存器的值 D_V2 I 32 D级GRF中读取rt寄存器的值 D_A1 I 5 D级A1 D_A2 I 5 D级A2 D_A3 I 5 D级A3 D_E32 I 32 32位立即数 D_pc I 32 D级pc D_pc8 I 32 D级pc+8 T_new_D I 2 D级T_new RegWrite_D I 1 D级GRF写入使能 start_D I 1 D级乘除指令开始信号 SelEMout_D I 1 E、M级转发数据选择信号 SelWout_D I 1 W级转发数据选择信号 SelALUB_D I 1 ALUB端口数据选择 ALUOp_D I 4 ALU操作选择 DMOp_D I 4 DM操作选择 MDUOp_D I 4 乘除指令操作 E_V1 O 32 E_V2 O 32 E_A1 O 5 E_A2 O 5 E_A3 O 5 E_E32 O 32 E_pc O 32 E_pc8 O 32 T_new_E O 2 RegWrite_E O 1 SelEMout_E O 1 SelWout_E O 2 SelALUB_E O 1 ALUOp_E O 3 DMOp_E O 3 3.M_REG 名称 方向 位宽 描述 clk I 1 reset I 1 E_AO I 32 E级ALU/MDU输出 E_V2 I 32 注意：E_V2不是D_V2,而是经过转发后的D_V2_f E_A2 I 5 E_A3 I 5 E_pc I 32 E_pc8 I 32 T_new_E I 2 RegWrite_E I 1 start_E I 1 SelEMout_E I 1 SelWout_E I 1 DMOp_E I 4 M_AO O 32 M_V2 O 5 M_A2 O 5 M_A3 O 5 M_pc O 32 M_pc8 O 32 T_new_M O 2 RegWrite_M O 1 SelEMout_M O 1 SelWout_M O 2 DMOp_M O 3 4.W_REG 名称 方向 位宽 描述 clk I 1 reset I 1 M_AO I 32 M_DR I 32 M级DM中读出的数据 M_A3 M_pc I 32 M_pc8 I 32 SelWout_M I 2 T_new_M I 2 RegWrite_M I 1 W_AO O 32 W_DR O 32 W_A3 O 5 W_pc O 32 W_pc8 O 32 SelWout_W O 2 T_new_W O 2 RegWrite_W O 1 三.测试 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 li $0 -1590414783 li $1 -1387657999 li $2 97336612 li $3 -1971889419 li $4 1148790734 li $5 -289210629 li $6 1026640559 li $7 1852052372 li $8, 7860 sltu $4, $0, $1 srav $4, $1, $6 or $6, $0, $4 xor $0, $6, $6 nor $3, $5, $2 slt $0, $5, $3 ori $5, $1, -31050 or $5, $2, $6 subu $1, $2, $6 sltu $4, $4, $3 lbu $0, 878($0) slt $2, $2, $2 or $6, $2, $4 srav $1, $7, $0 sll $0, $7, 7 srlv $6, $3, $6 nor $3, $3, $7 or $5, $7, $2 div $4, $8 sltu $7, $3, $2 sllv $6, $2, $0 srlv $5, $5, $5 mtlo $0 addu $0, $5, $4 slt $6, $7, $6 addu $5, $1, $1 mfhi $1 nor $4, $5, $5 srav $3, $5, $4 sltiu $3, $4, 7080 and $3, $0, $4 or $7, $5, $5 xor $5, $3, $3 andi $2, $6, 25900 xori $1, $5, 18289 srlv $0, $6, $5 slt $4, $6, $2 ori $7, $3, -32729 lh $7, 1250($0) sllv $7, $4, $4 addu $4, $1, $2 xori $7, $0, 11378 srl $4, $4, 5 addu $6, $5, $6 srav $7, $3, $4 slti $1, $5, -24158 multu $6, $8 sltu $6, $0, $1 四.思考题 1、为什么需要有单独的乘除法部件而不是整合进 ALU？为何需要有独立的 HI、LO 寄存器？\n乘除法都有较高的延迟，若整合进ALU，则进行乘除法的时候，所有的运算类指令都只能阻塞在D级，造成了极大的性能损失。单独设置MDU的话，无关的指令还能正常的在ALU运行，效率较高。 HI，LO寄存器并不是通用寄存器，和其他通用寄存器的用法不一致，不能通过非乘除法指令修改和访问，因此不需要置于GRF中，内置在MDU中即可。 2、真实的流水线 CPU 是如何使用实现乘除法的？请查阅相关资料进行简单说明。\n真实的流水线CPU采用的乘法是有加法器和移位器循环，具体实现过程为：\n首先CPU会初始化三个通用寄存器用来存放被乘数，乘数，部分积。 部分积寄存器初始化为0。 判断乘数寄存器的低位是0|1，如果为0则将乘数寄存器右移一位，同时将部分积寄存器也右移一位。 在位移时遵循计算机位移规则，乘数寄存器低位溢出的一位丢弃，部分积寄存器低位溢出的一位填充到乘数寄存器的高位。 同时部分积寄存器高位补0。如果为1则将部分积寄存器加上被乘数寄存器，再进行移位操作。 当所有乘数位处理完成后部分积寄存器做高位，乘数寄存器做低位就是最终乘法结果。\n还有另一种乘法的方式：\n只需两个寄存器，A[31:0],B[63:0]，A初始化为被乘数，B初始化为乘数。 每一次取B的最低位，为1则将A[31:0]+B[63:32] -\u003e B[63:32]，为0则不操作。 每次将B » 1，然后高位补0。\n除法实现：\n与乘法的操作基本相反，首先CPU会初始化三个寄存器,用来存放被除数，除数，部分商。余数(被除数与除数比较的结果)放到被除数的有效高位上。CPU做除法时和做除法时是相反的，乘法是右移，除法是左移，乘法做的是加法，除法做的是减法。首先CPU会把被除数bit位与除数bit位对齐，然后再让对齐的被除数与除数比较(双符号位判断)。比如01-10=11(前面的1是符号位) 1-2=-1 计算机通过符号位和后一位的bit位来判断大于和小于，那么01-10=11 就说明01小于10，如果得数为01就代表大于，如果得数为00代表等于。如果得数大于或等于则将比较的结果放到被除数的有效高位上然后再商寄存器上商：1 并向后多看一位(上商就是将商的最低位左移1位腾出商寄存器最低位上新的商)如果得数小于则上商：0 并向后多看一位然后循环做以上操作当所有的被除数都处理完后，商做结果被除数里面的值就是余数。\n3、请结合自己的实现分析，你是如何处理 Busy 信号带来的周期阻塞的？\n除cnt和busy置位以外全是组合逻辑的操作（不然可能会多出来一个空周期） 对于乘除指令： 将busy_E，start_E，MDUOp_D传入HCU 然后md暂停信号为(busy_E | start_E) \u0026 (MDUOp_D != 4'b0000) 4、请问采用字节使能信号的方式处理写指令有什么好处？（提示：从清晰性、统一性等角度考虑）\n对于需要写入的位置更加的直观，相当于将DMWE、DMOP写入的A[1:0]用四位字节使能信号表示，十分的统一。 5、请思考，我们在按字节读和按字节写时，实际从 DM 获得的数据和向 DM 写入的数据是否是一字节？在什么情况下我们按字节读和按字节写的效率会高于按字读和按字写呢？\n按字节读写的时候，我们获得的是一字节，但是我们如果要lw或lh的话我们就需要拼接。如果是sw或sh的话我们需要多次存入。 若用lb，sb，lh，sh这种非取字的读写时，按字节读可以省去，取位，拼接的步骤，效率要优于按字读写。 6、为了对抗复杂性你采取了哪些抽象和规范手段？这些手段在译码和处理数据冲突的时候有什么样的特点与帮助？\nNPC统一，NPC统一为一个模块 指令分类，cal_R,cal_I,shift,shiftv,branch,load,store等 每一级设置outMUX，只需在MCU中控制outSel即可决定转发值及写入寄存器的值 7、在本实验中你遇到了哪些不同指令类型组合产生的冲突？你又是如何解决的？相应的测试样例是什么样的？\n在常规测试通过后，我们可以将T_rsUse和T_rtUse相同的指令归类为同一需求指令，把T_new相同的指令归类为同一供给指令。 所以可以在new方面有下列指令：add，lw，jal，mfhi 在rsUse方面有下面情况：add，sll，lw，beq，jr，mult，mthi 然后对着转发的时间表，设计测试数据： 复制# rs0_E1 add $t0, $t1, $t2 beq $t0, $t3, label1 nop # rs0_E2 lw $t0, 0($t1) beq $t0, $t3, label1 nop #rs0_E0 jal label1 nop ori $t0, $0, 0x1234 label1: jr $ra nop .... 8、如果你是手动构造的样例，请说明构造策略，说明你的测试程序如何保证覆盖了所有需要测试的情况；如果你是完全随机生成的测试样例，请思考完全随机的测试程序有何不足之处；如果你在生成测试样例时采用了特殊的策略，比如构造连续数据冒险序列，请你描述一下你使用的策略如何结合了随机性达到强测的效果。\n手动构造策略见上 完全随机生成有几大不足之处，如无法保证内存对齐，无法保证延迟槽中没有跳转分支，无法避免一定几率的死循环等等 但可以加入策略： 比如只用t0-t6寄存器以保证产生足够多的冲突 在检测到生成跳转后禁用跳转指令 检测到内存不对齐可以不生成等等 ","wordCount":"2184","inLanguage":"en","datePublished":"2023-11-28T20:56:55+08:00","dateModified":"2023-11-28T20:56:55+08:00","author":{"@type":"Person","name":"sudo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://coder0xe.github.io/posts/p6-design-document/"},"publisher":{"@type":"Organization","name":"coder0xe's blog","logo":{"@type":"ImageObject","url":"https://coder0xe.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://coder0xe.github.io/ accesskey=h title="coder0xe's blog (Alt + H)">coder0xe's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://coder0xe.github.io/ title=首页><span>首页</span></a></li><li><a href=https://coder0xe.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://coder0xe.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://coder0xe.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://coder0xe.github.io/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://coder0xe.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://coder0xe.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">P6-design-document</h1><div class=post-description>P6设计文档</div><div class=post-meta><span title='2023-11-28 20:56:55 +0800 +0800'>November 28, 2023</span>&nbsp;·&nbsp;<span>11 min</span>&nbsp;·&nbsp;<span>sudo</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#p6-design-document aria-label=P6-Design-Document>P6-Design-Document</a><ul><li><a href=#%e4%b8%80%e6%95%b0%e6%8d%ae%e9%80%9a%e8%b7%af%e5%9b%be%e7%a4%ba aria-label=一.数据通路图示>一.数据通路图示</a></li><li><a href=#%e4%ba%8c%e5%8a%9f%e8%83%bd%e6%a8%a1%e5%9d%97%e5%ae%9a%e4%b9%89 aria-label=二.功能模块定义>二.功能模块定义</a><ul><li><a href=#1-mcu aria-label="1. MCU">1. MCU</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2%e6%8c%87%e4%bb%a4%e5%88%86%e7%b1%bb%e4%b8%8et_uset_new%e5%a4%84%e7%90%86 aria-label=2.指令分类与T_use/T_new处理>2.指令分类与T_use/T_new处理</a></li></ul></li><li><a href=#3hcu aria-label=3.HCU>3.HCU</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-1 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2%e6%9a%82%e5%81%9c%e4%b8%8e%e8%bd%ac%e5%8f%91 aria-label=2.暂停与转发>2.暂停与转发</a></li></ul></li><li><a href=#3alu aria-label=3.ALU>3.ALU</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-2 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2aluop%e7%bc%96%e7%a0%81%e4%b8%8e%e8%bf%90%e7%ae%97%e9%80%89%e6%8b%a9 aria-label=2.ALUOp编码与运算选择>2.ALUOp编码与运算选择</a></li></ul></li><li><a href=#4ext aria-label=4.EXT>4.EXT</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8 aria-label=端口定义列表>端口定义列表</a></li></ul></li><li><a href=#5grf aria-label=5.GRF>5.GRF</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-3 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2grf%e5%86%85%e9%83%a8%e8%bd%ac%e5%8f%91 aria-label=2.GRF内部转发>2.GRF内部转发</a></li></ul></li><li><a href=#6ifu aria-label=6.IFU>6.IFU</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-1 aria-label=端口定义列表>端口定义列表</a></li></ul></li><li><a href=#7npc aria-label=7.NPC>7.NPC</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-4 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2npcop%e7%bc%96%e7%a0%81%e4%b8%8e%e5%9c%b0%e5%9d%80%e9%80%89%e6%8b%a9 aria-label=2.NPCOp编码与地址选择>2.NPCOp编码与地址选择</a></li></ul></li><li><a href=#8cmp aria-label=8.CMP>8.CMP</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-5 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2cmpop%e7%bc%96%e7%a0%81%e4%b8%8e%e5%af%b9%e5%ba%94%e6%8c%87%e4%bb%a4 aria-label=2.CMPOp编码与对应指令>2.CMPOp编码与对应指令</a></li></ul></li><li><a href=#9mdu aria-label=9.MDU>9.MDU</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-6 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2mduop%e7%bc%96%e7%a0%81%e4%b8%8e%e5%af%b9%e5%ba%94%e6%8c%87%e4%bb%a4 aria-label=2.MDUOp编码与对应指令>2.MDUOp编码与对应指令</a></li><li><a href=#3%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0%e9%80%bb%e8%be%91 aria-label=3.代码实现逻辑>3.代码实现逻辑</a></li></ul></li><li><a href=#10be aria-label=10.BE>10.BE</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-7 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2dmop%e7%bc%96%e7%a0%81%e4%b8%8e%e5%ad%98%e6%95%b0%e6%93%8d%e4%bd%9c aria-label=2.DMOp编码与存数操作>2.DMOp编码与存数操作</a></li></ul></li><li><a href=#11de aria-label=11.DE>11.DE</a><ul><li><a href=#1%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-8 aria-label=1.端口定义列表>1.端口定义列表</a></li><li><a href=#2dmop%e7%bc%96%e7%a0%81%e4%b8%8e%e5%8f%96%e6%95%b0%e6%93%8d%e4%bd%9c aria-label=2.DMOp编码与取数操作>2.DMOp编码与取数操作</a></li></ul></li><li><a href=#12mux aria-label=12.MUX>12.MUX</a><ul><li><a href=#1%e5%8a%9f%e8%83%bd%e5%a4%9a%e8%b7%af%e9%80%89%e6%8b%a9%e5%99%a8 aria-label=1.功能多路选择器>1.功能多路选择器</a><ul><li><a href=#1mux_a3-d%e7%ba%a7%e5%86%99%e5%85%a5%e5%af%84%e5%ad%98%e5%99%a8%e9%80%89%e6%8b%a9 aria-label="1.MUX_A3 D级写入寄存器选择">1.MUX_A3 D级写入寄存器选择</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-2 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#2mux_alu_b-alub%e7%ab%af%e5%8f%a3%e9%80%89%e6%8b%a9 aria-label="2.MUX_ALU_B ALUB端口选择">2.MUX_ALU_B ALUB端口选择</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-3 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-1 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#3mux_e_out--%e9%80%89%e6%8b%a9e%e7%ba%a7%e8%bd%ac%e5%8f%91%e6%95%b0%e6%8d%ae aria-label="3.MUX_E_out  选择E级转发数据">3.MUX_E_out 选择E级转发数据</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-4 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-2 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#4mux_m_out-%e9%80%89%e6%8b%a9m%e7%ba%a7%e8%bd%ac%e5%8f%91%e6%95%b0%e6%8d%ae aria-label="4.MUX_M_out 选择M级转发数据">4.MUX_M_out 选择M级转发数据</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-5 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-3 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#5mux_w_out-%e9%80%89%e6%8b%a9w%e7%ba%a7%e8%bd%ac%e5%8f%91%e6%95%b0%e6%8d%ae aria-label="5.MUX_W_out 选择W级转发数据">5.MUX_W_out 选择W级转发数据</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-6 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-4 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#6mux_mdu_alu%e9%80%89%e6%8b%a9e%e7%ba%a7%e8%be%93%e5%87%ba%e6%95%b0%e6%8d%ae aria-label=6.MUX_MDU_ALU选择E级输出数据>6.MUX_MDU_ALU选择E级输出数据</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-7 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-5 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li></ul></li><li><a href=#2%e8%bd%ac%e5%8f%91%e5%a4%9a%e8%b7%af%e9%80%89%e6%8b%a9%e5%99%a8 aria-label=2.转发多路选择器>2.转发多路选择器</a><ul><li><a href=#1hmux_cmp_d1-cmp%e6%a8%a1%e5%9d%97rs%e5%af%84%e5%ad%98%e5%99%a8%e5%80%bc%e8%bd%ac%e5%8f%91 aria-label="1.HMUX_CMP_D1 CMP模块rs寄存器值转发">1.HMUX_CMP_D1 CMP模块rs寄存器值转发</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-8 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-6 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#2hmux_cmp_d2-cmp%e6%a8%a1%e5%9d%97rt%e5%af%84%e5%ad%98%e5%99%a8%e5%80%bc%e8%bd%ac%e5%8f%91 aria-label="2.HMUX_CMP_D2 CMP模块rt寄存器值转发">2.HMUX_CMP_D2 CMP模块rt寄存器值转发</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-9 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-7 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#3hmux_alu_a-alu%e6%a8%a1%e5%9d%97v1%e5%80%bc%e8%bd%ac%e5%8f%91mdu%e8%be%93%e5%85%a5v1 aria-label="3.HMUX_ALU_A ALU模块V1值转发/MDU输入V1">3.HMUX_ALU_A ALU模块V1值转发/MDU输入V1</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-10 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-8 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#4hmux_alu_b-alu%e6%a8%a1%e5%9d%97v2%e5%80%bc%e8%bd%ac%e5%8f%91mdu%e8%be%93%e5%85%a5v2 aria-label="4.HMUX_ALU_B ALU模块V2值转发/MDU输入V2">4.HMUX_ALU_B ALU模块V2值转发/MDU输入V2</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-11 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-9 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#5hmux_dm-dm%e5%86%99%e5%85%a5%e6%95%b0%e6%8d%ae%e8%bd%ac%e5%8f%91 aria-label="5.HMUX_DM DM写入数据转发">5.HMUX_DM DM写入数据转发</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-12 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-10 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li><li><a href=#6hmux_npc-npc%e6%a8%a1%e5%9d%97%e8%b7%b3%e8%bd%ac%e5%af%84%e5%ad%98%e5%99%a8%e5%80%bc%e8%bd%ac%e5%8f%91 aria-label="6.HMUX_NPC NPC模块跳转寄存器值转发">6.HMUX_NPC NPC模块跳转寄存器值转发</a><ul><li><a href=#%e7%ab%af%e5%8f%a3%e5%ae%9a%e4%b9%89%e5%88%97%e8%a1%a8-13 aria-label=端口定义列表>端口定义列表</a></li><li><a href=#%e9%80%89%e6%8b%a9%e4%bf%a1%e5%8f%b7%e4%b8%8e%e7%bb%93%e6%9e%9c-11 aria-label=选择信号与结果>选择信号与结果</a></li></ul></li></ul></li></ul></li><li><a href=#13%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%af%84%e5%ad%98%e5%99%a8 aria-label=13.流水线寄存器>13.流水线寄存器</a><ul><li><a href=#1d_reg aria-label=1.D_REG>1.D_REG</a></li><li><a href=#2e_reg aria-label=2.E_REG>2.E_REG</a></li><li><a href=#3m_reg aria-label=3.M_REG>3.M_REG</a></li><li><a href=#4w_reg aria-label=4.W_REG>4.W_REG</a></li></ul></li></ul></li><li><a href=#%e4%b8%89%e6%b5%8b%e8%af%95 aria-label=三.测试>三.测试</a></li><li><a href=#%e5%9b%9b%e6%80%9d%e8%80%83%e9%a2%98 aria-label=四.思考题>四.思考题</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=p6-design-document><center>P6-Design-Document</center><a hidden class=anchor aria-hidden=true href=#p6-design-document>#</a></h1><h2 id=一数据通路图示>一.数据通路图示<a hidden class=anchor aria-hidden=true href=#一数据通路图示>#</a></h2><p>​ P6在P5的基础上新增乘除槽单元、字节使能单元、数据扩展单元，在顶层模块中增加与testbench的接口，将IM与DM外移到testbench中。</p><p><img alt=image-20231130193453498 loading=lazy src=/img/image-20231130193453498.png></p><h2 id=二功能模块定义>二.功能模块定义<a hidden class=anchor aria-hidden=true href=#二功能模块定义>#</a></h2><h3 id=1-mcu>1. MCU<a hidden class=anchor aria-hidden=true href=#1-mcu>#</a></h3><h4 id=1端口定义列表>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>D_opcode</td><td>I</td><td>6</td><td>操作码</td></tr><tr><td>D_funct</td><td>I</td><td>6</td><td>功能码</td></tr><tr><td>SelA3_D</td><td>O</td><td>2</td><td>选择写入寄存器地址</td></tr><tr><td>RegWrite_D</td><td>O</td><td>1</td><td>寄存器堆写入地址</td></tr><tr><td>EXTOp_D</td><td>O</td><td>1</td><td>立即数扩展信号</td></tr><tr><td>SelEMout_D</td><td>O</td><td>1</td><td>选择E、M级转发数据</td></tr><tr><td>SelWout_D</td><td>O</td><td>2</td><td>选择W级转发数据/写入GRF数据</td></tr><tr><td>SeLALUB_D</td><td>O</td><td>1</td><td>选择ALU_B端口输入数据</td></tr><tr><td>SelALUS_D</td><td>O</td><td>1</td><td>选择ALU_S端口移位数据</td></tr><tr><td>check_D</td><td>O</td><td>1</td><td>判定是否为新信号(课上扩展使用)</td></tr><tr><td>mf_D</td><td>O</td><td>1</td><td>mfhi/mflo指令，选择E级输出数据</td></tr><tr><td>start_D</td><td>O</td><td>1</td><td>乘除类导致延迟的指令信号，只有md类需要</td></tr><tr><td>CMPOp_D</td><td>O</td><td>3</td><td>B类跳转指令操作码</td></tr><tr><td>NPCOp_D</td><td>O</td><td>3</td><td>跳转地址选择</td></tr><tr><td>ALUOp_D</td><td>O</td><td>4</td><td>ALU计算操作</td></tr><tr><td>MDUOp_D</td><td>O</td><td>4</td><td>乘除类计算操作</td></tr><tr><td>DMOp_D</td><td>O</td><td>4</td><td>存取指令操作</td></tr><tr><td>T_rs_use_D</td><td>O</td><td>2</td><td>位于D级用到rs寄存器中值的周期数</td></tr><tr><td>T_rt_use_D</td><td>O</td><td>2</td><td>位于D级用到rt寄存器中值的周期数</td></tr><tr><td>T_new_D</td><td>O</td><td>2</td><td>位于D级产生新信号的周期数</td></tr></tbody></table><p><strong>注：由于BE模块产生字节使能信号，将原内存写入使能信号MemWrite省去</strong></p><h4 id=2指令分类与t_uset_new处理>2.指令分类与T_use/T_new处理<a hidden class=anchor aria-hidden=true href=#2指令分类与t_uset_new处理>#</a></h4><p><strong>指令分类如下</strong></p><table><thead><tr><th>类别</th><th>包含的指令</th></tr></thead><tbody><tr><td>cal_R</td><td>add,sub,and,or,slt,sltu</td></tr><tr><td>cal_I</td><td>andi,ori,addi,lui</td></tr><tr><td>shift</td><td>sll</td></tr><tr><td>shiftv</td><td>sllv</td></tr><tr><td>branch</td><td>beq,bne</td></tr><tr><td>store</td><td>sw,sh,sb</td></tr><tr><td>load</td><td>lw,lh,lb</td></tr><tr><td>md（有运算延迟）</td><td>mult,multu,div,divu</td></tr><tr><td>mf（读取）</td><td>mfhi,mflo</td></tr><tr><td>mt（写入）</td><td>mthi,mtlo</td></tr></tbody></table><p>​ <strong>对指令进行分类的好处是使得控制信号的产生更加简洁，增加指令时可以先考虑它属于哪一类</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#ff79c6>assign</span> T_rs_use_D <span style=color:#ff79c6>=</span> (branch <span style=color:#ff79c6>|</span> op_jr <span style=color:#ff79c6>|</span> op_jalr) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b00</span> <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>						  (cal_R <span style=color:#ff79c6>|</span> cal_I <span style=color:#ff79c6>|</span> load <span style=color:#ff79c6>|</span> store <span style=color:#ff79c6>|</span> shiftv <span style=color:#ff79c6>|</span> md <span style=color:#ff79c6>|</span> mt) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b01</span> <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>						  <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b11</span>;<span style=color:#6272a4>//用不到置为3
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> T_rt_use_D <span style=color:#ff79c6>=</span> (branch) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b00</span> <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>						  (cal_R <span style=color:#ff79c6>|</span> shift <span style=color:#ff79c6>|</span> shiftv <span style=color:#ff79c6>|</span> md) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b01</span> <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>						  <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b11</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> T_new_D <span style=color:#ff79c6>=</span> (load) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b11</span> <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>					  (cal_R <span style=color:#ff79c6>|</span> cal_I <span style=color:#ff79c6>|</span> shift <span style=color:#ff79c6>|</span> shiftv <span style=color:#ff79c6>|</span> mf) <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b10</span> <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>					  <span style=color:#bd93f9>2</span><span style=color:#bd93f9>&#39;b00</span>;
</span></span></code></pre></td></tr></table></div></div><img src=/img/%E6%8C%87%E4%BB%A4%E6%97%B6%E9%97%B4%E8%A1%A8.jpg alt=img><h3 id=3hcu>3.HCU<a hidden class=anchor aria-hidden=true href=#3hcu>#</a></h3><h4 id=1端口定义列表-1>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-1>#</a></h4><table><thead><tr><th>输入信号</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>MDUOp_D</td><td>I</td><td>4</td><td>D级当前指令是否为乘除指令</td></tr><tr><td>D_A1</td><td>I</td><td>5</td><td>D级A1输入</td></tr><tr><td>D_A2</td><td>I</td><td>5</td><td>D级A2输入</td></tr><tr><td>E_A1</td><td>I</td><td>5</td><td>E级A1输入</td></tr><tr><td>E_A2</td><td>I</td><td>5</td><td>E级A2输入</td></tr><tr><td>E_A3</td><td>I</td><td>5</td><td>E级A3输入</td></tr><tr><td>check_E</td><td>I</td><td>1</td><td>课上扩展</td></tr><tr><td>start</td><td>I</td><td>1</td><td>E级乘除运算启动信号</td></tr><tr><td>busy</td><td>I</td><td>1</td><td>E级乘除运算进行符号</td></tr><tr><td>M_A2</td><td>I</td><td>5</td><td>M级A2输入</td></tr><tr><td>M_A3</td><td>I</td><td>5</td><td>M级A3输入</td></tr><tr><td>check_M</td><td>I</td><td>1</td><td>课上扩展</td></tr><tr><td>W_A3</td><td>I</td><td>5</td><td>W级A3输入</td></tr><tr><td>RegWrite_E</td><td>I</td><td>1</td><td>E级保存的GRF写入使能信号</td></tr><tr><td>RegWrite_M</td><td>I</td><td>1</td><td>M级保存的GRF写入使能信号</td></tr><tr><td>RegWrite_W</td><td>I</td><td>1</td><td>W级保存的GRF写入使能信号</td></tr><tr><td>T_rs_use</td><td>I</td><td>2</td><td>D级中MCU输出的T_rs_use_D信号</td></tr><tr><td>T_rt_use</td><td>I</td><td>2</td><td>D级中MCU输出的T_rt_use_D信号</td></tr><tr><td>T_new_E</td><td>I</td><td>2</td><td>E级中T_new_E输入</td></tr><tr><td>T_new_M</td><td>I</td><td>2</td><td>M级中T_new_M输入</td></tr><tr><td>T_new_W</td><td>I</td><td>2</td><td>W级中T_new_W输入</td></tr><tr><td><strong>输出信号</strong></td><td><strong>位宽</strong></td><td><strong>作用级</strong></td><td><strong>描述</strong></td></tr><tr><td>FwdCMPD1</td><td>2</td><td>D</td><td>对HMUX_CMP_D1输出进行选择</td></tr><tr><td>FwdCMPD2</td><td>2</td><td>D</td><td>对HMUX_CMP_D2输出进行选择</td></tr><tr><td>FwdALUA</td><td>2</td><td>E</td><td>对HMUX_ALU_A输出进行选择</td></tr><tr><td>FwdALUB</td><td>2</td><td>E</td><td>对HMUX_ALU_B输出进行选择</td></tr><tr><td>FwdDM</td><td>1</td><td>M</td><td>对HMUX_DM的输出进行选择</td></tr><tr><td>stall</td><td>1</td><td>D,F,M</td><td>暂停信号</td></tr></tbody></table><h4 id=2暂停与转发>2.暂停与转发<a hidden class=anchor aria-hidden=true href=#2暂停与转发>#</a></h4><ul><li><p>将P5中列举出的8种暂停情况合并为4种，更加简洁且易于扩展</p></li><li><p>针对乘除槽增加暂停信号</p></li><li><p>当 busy 信号或 start 信号为 1 时，<code>mult, multu, div, divu, mfhi, mflo, mthi, mtlo</code> 等乘除法相关的指令均被阻塞在 D 流水级</p></li><li><p>转发与P5相比未作改动</p></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#8be9fd>wire</span> stall_rs_e <span style=color:#ff79c6>=</span> (T_rs_use <span style=color:#ff79c6>&lt;</span> T_new_E)<span style=color:#ff79c6>&amp;&amp;</span>(D_A1 <span style=color:#ff79c6>==</span> E_A3)<span style=color:#ff79c6>&amp;&amp;</span>(D_A1 <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>5</span><span style=color:#bd93f9>&#39;b0</span>)<span style=color:#ff79c6>&amp;&amp;</span>(RegWrite_E);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> stall_rs_m <span style=color:#ff79c6>=</span> (T_rs_use <span style=color:#ff79c6>&lt;</span> T_new_M)<span style=color:#ff79c6>&amp;&amp;</span>(D_A1 <span style=color:#ff79c6>==</span> M_A3)<span style=color:#ff79c6>&amp;&amp;</span>(D_A1 <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>5</span><span style=color:#bd93f9>&#39;b0</span>)<span style=color:#ff79c6>&amp;&amp;</span>(RegWrite_M);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> stall_rs <span style=color:#ff79c6>=</span> stall_rs_e <span style=color:#ff79c6>|</span> stall_rs_m ;
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> stall_rt_e <span style=color:#ff79c6>=</span> (T_rt_use <span style=color:#ff79c6>&lt;</span> T_new_E)<span style=color:#ff79c6>&amp;&amp;</span>(D_A2 <span style=color:#ff79c6>==</span> E_A3)<span style=color:#ff79c6>&amp;&amp;</span>(D_A2 <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>5</span><span style=color:#bd93f9>&#39;b0</span>)<span style=color:#ff79c6>&amp;&amp;</span>(RegWrite_E);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> stall_rt_m <span style=color:#ff79c6>=</span> (T_rt_use <span style=color:#ff79c6>&lt;</span> T_new_M)<span style=color:#ff79c6>&amp;&amp;</span>(D_A2 <span style=color:#ff79c6>==</span> M_A3)<span style=color:#ff79c6>&amp;&amp;</span>(D_A2 <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>5</span><span style=color:#bd93f9>&#39;b0</span>)<span style=color:#ff79c6>&amp;&amp;</span>(RegWrite_M);
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> stall_rt <span style=color:#ff79c6>=</span> stall_rt_e <span style=color:#ff79c6>|</span> stall_rt_m ;
</span></span><span style=display:flex><span><span style=color:#8be9fd>wire</span> stall_mdu <span style=color:#ff79c6>=</span> (MDUOp_D <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b0000</span>)<span style=color:#ff79c6>&amp;&amp;</span>(busy <span style=color:#ff79c6>|</span> start);
</span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> stall <span style=color:#ff79c6>=</span> stall_rs <span style=color:#ff79c6>|</span> stall_rt <span style=color:#ff79c6>|</span> stall_mdu;
</span></span></code></pre></td></tr></table></div></div><h3 id=3alu>3.ALU<a hidden class=anchor aria-hidden=true href=#3alu>#</a></h3><h4 id=1端口定义列表-2>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-2>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>src_A</td><td>I</td><td>32</td><td>操作数1</td></tr><tr><td>src_B</td><td>I</td><td>32</td><td>操作数2</td></tr><tr><td>shamt_f</td><td>I</td><td>5</td><td>移位数据</td></tr><tr><td>ALUOp</td><td>I</td><td>3</td><td>运算类型</td></tr><tr><td>AO</td><td>O</td><td>32</td><td>运算结果</td></tr></tbody></table><h4 id=2aluop编码与运算选择>2.ALUOp编码与运算选择<a hidden class=anchor aria-hidden=true href=#2aluop编码与运算选择>#</a></h4><table><thead><tr><th>ALU运算</th><th>ALUOp编码</th></tr></thead><tbody><tr><td>+</td><td>0000</td></tr><tr><td>-</td><td>0001</td></tr><tr><td>|</td><td>0010</td></tr><tr><td>&</td><td>0011</td></tr><tr><td>load to higher half (lui)</td><td>0100</td></tr><tr><td>signed compare (slt)</td><td>0101</td></tr><tr><td>unsigned compare(sltu)</td><td>0110</td></tr><tr><td>&#171;</td><td>0111</td></tr></tbody></table><h3 id=4ext>4.EXT<a hidden class=anchor aria-hidden=true href=#4ext>#</a></h3><h4 id=端口定义列表>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>imm</td><td>I</td><td>16</td><td>D级16位立即数</td></tr><tr><td>EXTOp</td><td>I</td><td>1</td><td>选择进行符号扩展/零扩展</td></tr><tr><td>imm_32</td><td>I</td><td>32</td><td>位扩展结果</td></tr></tbody></table><h3 id=5grf>5.GRF<a hidden class=anchor aria-hidden=true href=#5grf>#</a></h3><h4 id=1端口定义列表-3>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-3>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td>时钟信号</td></tr><tr><td>reset</td><td>I</td><td>1</td><td>同步复位信号</td></tr><tr><td>rs</td><td>I</td><td>5</td><td>rs寄存器</td></tr><tr><td>rt</td><td>I</td><td>5</td><td>rt寄存器</td></tr><tr><td>rd</td><td>I</td><td>5</td><td>rd寄存器</td></tr><tr><td>pc</td><td>I</td><td>32</td><td>指令执行地址</td></tr><tr><td>datawrite</td><td>I</td><td>32</td><td>写入数据选择</td></tr><tr><td>RegWrite</td><td>I</td><td>1</td><td>写入使能</td></tr><tr><td>dataread1</td><td>O</td><td>32</td><td>读rs寄存器</td></tr><tr><td>dataread2</td><td>O</td><td>32</td><td>读rt寄存器</td></tr></tbody></table><p><strong>注意：这里的RegWrite,datawirte,A3(rd),pc信号均来自W级</strong></p><h4 id=2grf内部转发>2.GRF内部转发<a hidden class=anchor aria-hidden=true href=#2grf内部转发>#</a></h4><p>​ 设计GRF内部转发逻辑：GRF既是D级的一个部件又是W级之后的流水线寄存器。当W级写GRF，D级读GRF时，如果读取寄存器与写入寄存器为同一寄存器时不进行转发，新值虽然被写入GRF但流入E级的值依然为旧值。</p><p><strong>判断条件：当写入信号RegWrite有效且A1==A3或A2==A3时，将写入值作为对应输出值</strong></p><p>判断逻辑如下:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#6272a4>//forward
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> dataread1 <span style=color:#ff79c6>=</span> (RegWrite <span style=color:#ff79c6>&amp;&amp;</span> rs <span style=color:#ff79c6>==</span> rd <span style=color:#ff79c6>&amp;&amp;</span> rd <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>?</span> datawrite <span style=color:#ff79c6>:</span> grf[rs];
</span></span></code></pre></td></tr></table></div></div><h3 id=6ifu>6.IFU<a hidden class=anchor aria-hidden=true href=#6ifu>#</a></h3><h4 id=端口定义列表-1>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-1>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td>时钟信号</td></tr><tr><td>reset</td><td>I</td><td>1</td><td>同步复位信号</td></tr><tr><td>en</td><td>I</td><td>1</td><td>使能信号(~stall)</td></tr><tr><td>npc</td><td>I</td><td>32</td><td>下一指令地址</td></tr><tr><td>pc</td><td>O</td><td>32</td><td>F级当前地址</td></tr><tr><td>pc8</td><td>O</td><td>32</td><td>输出PC+8，随流水段传递(jal考虑延迟槽)</td></tr><tr><td>instr</td><td>O</td><td>32</td><td>取出的指令</td></tr></tbody></table><h3 id=7npc>7.NPC<a hidden class=anchor aria-hidden=true href=#7npc>#</a></h3><h4 id=1端口定义列表-4>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-4>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>D_pc</td><td>I</td><td>32</td><td>D级PC</td></tr><tr><td>F_pc</td><td>I</td><td>32</td><td>F级PC</td></tr><tr><td>b_result</td><td>I</td><td>1</td><td>D级CMP模块判断结果</td></tr><tr><td>b_offset</td><td>I</td><td>32</td><td>B类指令的跳转地址</td></tr><tr><td>j_address</td><td>I</td><td>26</td><td>J类指令跳转地址</td></tr><tr><td>reg_address</td><td>I</td><td>32</td><td>跳转到寄存器中的地址(jr)</td></tr><tr><td>NPCOp</td><td>I</td><td>3</td><td>地址选择信号</td></tr><tr><td>npc</td><td>O</td><td>32</td><td>程序下一条指令地址</td></tr></tbody></table><h4 id=2npcop编码与地址选择>2.NPCOp编码与地址选择<a hidden class=anchor aria-hidden=true href=#2npcop编码与地址选择>#</a></h4><table><thead><tr><th>NPCOp编码</th><th>选择跳转地址</th></tr></thead><tbody><tr><td>000</td><td>F_pc + 4</td></tr><tr><td>001(B) && b_result</td><td>D_pc + 4 + (b_offset &#171; 2&rsquo;b10)</td></tr><tr><td>010(jal)</td><td>{(D_pc + 4)[31:28],j_address,2&rsquo;b00}</td></tr><tr><td>011(jr)</td><td>reg_address</td></tr></tbody></table><p><strong>注：NPC是横跨D级和E级的模块，如果是beq或jal等指令，则需要在D_pc基础上进行操作，否则为F_pc+4</strong></p><h3 id=8cmp>8.CMP<a hidden class=anchor aria-hidden=true href=#8cmp>#</a></h3><h4 id=1端口定义列表-5>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-5>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>D_V1</td><td>I</td><td>32</td><td>GRF中读出的rs寄存器的值</td></tr><tr><td>D_V2</td><td>I</td><td>32</td><td>GRF中读出的rt寄存器的值</td></tr><tr><td>CMPOp</td><td>I</td><td>3</td><td>选择比较类型</td></tr><tr><td>b_result</td><td>O</td><td>1</td><td>是否满足B类跳转指令的跳转条件</td></tr></tbody></table><h4 id=2cmpop编码与对应指令>2.CMPOp编码与对应指令<a hidden class=anchor aria-hidden=true href=#2cmpop编码与对应指令>#</a></h4><p>当前只实现beq，该信号的设置更大的意义在于其可扩展性，便于课上添加指令</p><table><thead><tr><th>CMPOp编码</th><th>对应指令</th></tr></thead><tbody><tr><td>000</td><td>beq</td></tr><tr><td>001</td><td>bne</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><h3 id=9mdu>9.MDU<a hidden class=anchor aria-hidden=true href=#9mdu>#</a></h3><h4 id=1端口定义列表-6>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-6>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td>时钟信号</td></tr><tr><td>reset</td><td>I</td><td>1</td><td>同步复位信号</td></tr><tr><td>start</td><td>I</td><td>1</td><td>开始乘除运算信号</td></tr><tr><td>MDUOp</td><td>I</td><td>4</td><td>乘除操作</td></tr><tr><td>A</td><td>I</td><td>32</td><td>操作数A</td></tr><tr><td>B</td><td>I</td><td>32</td><td>操作数B</td></tr><tr><td>out</td><td>I</td><td>32</td><td>mfhi/mflo输出结果</td></tr><tr><td>busy</td><td>I</td><td>1</td><td>正在执行乘除运算指示信号</td></tr></tbody></table><h4 id=2mduop编码与对应指令>2.MDUOp编码与对应指令<a hidden class=anchor aria-hidden=true href=#2mduop编码与对应指令>#</a></h4><table><thead><tr><th>DMOp编码</th><th>对应指令</th></tr></thead><tbody><tr><td>0000</td><td>非乘除指令，记为nop</td></tr><tr><td>0001</td><td>mult</td></tr><tr><td>0010</td><td>multu</td></tr><tr><td>0011</td><td>div</td></tr><tr><td>0100</td><td>divu</td></tr><tr><td>0101</td><td>mfhi</td></tr><tr><td>0110</td><td>mflo</td></tr><tr><td>0111</td><td>mthi</td></tr><tr><td>1000</td><td>mtlo</td></tr></tbody></table><h4 id=3代码实现逻辑>3.代码实现逻辑<a hidden class=anchor aria-hidden=true href=#3代码实现逻辑>#</a></h4><ul><li>乘法mult/multu延迟5周期，除法div/divu延迟10周期，在计算出结果后存储在tmpHI,tmpLO中，等到耗满延迟再转存入HI,LO.mfhi/mflo从HI,LO中读取。</li><li>设置计数器 判断是否达到该种运算的延迟(delay)，若达到，则将数值从tmp转存入HI/LO，同时将busy信号置0</li><li>实际上得到的结果为64位的结果，使用{tmpHI,tmpLO}位拼接写法进行拆分。</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#6272a4>// counter 
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>always</span>@(<span style=color:#ff79c6>posedge</span> clk)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span>(reset)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>		cnt <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		busy <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span>(start)<span style=color:#ff79c6>begin</span>   <span style=color:#6272a4>//start claculate
</span></span></span><span style=display:flex><span>		busy <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b1</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span>(busy) <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(cnt <span style=color:#ff79c6>==</span> delay <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>)<span style=color:#ff79c6>begin</span>  <span style=color:#6272a4>//next T : busy = 0
</span></span></span><span style=display:flex><span>			cnt <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>			busy <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			cnt <span style=color:#ff79c6>&lt;=</span> cnt <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b1</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>always</span>@(<span style=color:#ff79c6>posedge</span> clk)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span>(reset)<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>		tmpHI <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		tmpLO <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		HI <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>		LO <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span>  <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>busy) <span style=color:#ff79c6>begin</span>  <span style=color:#6272a4>//进行新运算
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>case</span>(MDUOp)
</span></span><span style=display:flex><span>		mult <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			delay <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b0101</span>; <span style=color:#6272a4>//5
</span></span></span><span style=display:flex><span>			{tmpHI,tmpLO} <span style=color:#ff79c6>&lt;=</span> $signed(A) <span style=color:#ff79c6>*</span> $signed(B); 
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		multu <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			delay <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b0101</span>;
</span></span><span style=display:flex><span>			{tmpHI,tmpLO} <span style=color:#ff79c6>&lt;=</span> $unsigned(A) <span style=color:#ff79c6>*</span> $unsigned(B);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		div <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			delay <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b1010</span>; <span style=color:#6272a4>//10
</span></span></span><span style=display:flex><span>			tmpLO <span style=color:#ff79c6>&lt;=</span> $signed(A) <span style=color:#ff79c6>/</span> $signed(B);
</span></span><span style=display:flex><span>			tmpHI <span style=color:#ff79c6>&lt;=</span> $signed(A) <span style=color:#ff79c6>%</span> $signed(B);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		divu <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			delay <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>4</span><span style=color:#bd93f9>&#39;b1010</span>;
</span></span><span style=display:flex><span>			tmpLO <span style=color:#ff79c6>&lt;=</span> $unsigned(A) <span style=color:#ff79c6>/</span> $unsigned(B);
</span></span><span style=display:flex><span>			tmpHI <span style=color:#ff79c6>&lt;=</span> $unsigned(A) <span style=color:#ff79c6>%</span> $unsigned(B);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		mthi <span style=color:#ff79c6>:</span> HI <span style=color:#ff79c6>&lt;=</span> A;
</span></span><span style=display:flex><span>		mtlo <span style=color:#ff79c6>:</span> LO <span style=color:#ff79c6>&lt;=</span> A;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>endcase</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>      <span style=color:#6272a4>//保持老运算
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(cnt <span style=color:#ff79c6>==</span> delay <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span><span style=color:#bd93f9>&#39;b1</span>)<span style=color:#ff79c6>begin</span>  <span style=color:#6272a4>// next T : busy = 0;
</span></span></span><span style=display:flex><span>			HI <span style=color:#ff79c6>&lt;=</span> tmpHI;
</span></span><span style=display:flex><span>			LO <span style=color:#ff79c6>&lt;=</span> tmpLO;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>else</span> <span style=color:#ff79c6>begin</span>
</span></span><span style=display:flex><span>			HI <span style=color:#ff79c6>&lt;=</span> HI;
</span></span><span style=display:flex><span>			LO <span style=color:#ff79c6>&lt;=</span> LO;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>end</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// mfhi/mflo为组合逻辑
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>assign</span> out <span style=color:#ff79c6>=</span> (MDUOp <span style=color:#ff79c6>==</span> mfhi)<span style=color:#ff79c6>?</span> HI <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>				 (MDUOp <span style=color:#ff79c6>==</span> mflo)<span style=color:#ff79c6>?</span> LO <span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>				 <span style=color:#bd93f9>32</span><span style=color:#bd93f9>&#39;b0</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>endmodule</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=10be>10.BE<a hidden class=anchor aria-hidden=true href=#10be>#</a></h3><h4 id=1端口定义列表-7>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-7>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>address</td><td>I</td><td>32</td><td>存数据地址</td></tr><tr><td>DMOp</td><td>I</td><td>4</td><td>存数操作</td></tr><tr><td>WD_in</td><td>I</td><td>32</td><td>未经处理的存入数据</td></tr><tr><td>byteen</td><td>O</td><td>4</td><td>字节使能信号</td></tr><tr><td>WD_out</td><td>O</td><td>32</td><td>处理后的存入数据(字/半字/字节)</td></tr></tbody></table><ul><li><strong>注：byteen为存入字节使能信号、对应位置的值为1表示允许存入，如sw->byteen = 1111</strong></li></ul><h4 id=2dmop编码与存数操作>2.DMOp编码与存数操作<a hidden class=anchor aria-hidden=true href=#2dmop编码与存数操作>#</a></h4><table><thead><tr><th>DMOp</th><th>对应指令</th></tr></thead><tbody><tr><td>0001</td><td>sw</td></tr><tr><td>0010</td><td>sh</td></tr><tr><td>0011</td><td>sb</td></tr></tbody></table><h3 id=11de>11.DE<a hidden class=anchor aria-hidden=true href=#11de>#</a></h3><h4 id=1端口定义列表-8>1.端口定义列表<a hidden class=anchor aria-hidden=true href=#1端口定义列表-8>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>address</td><td>I</td><td>32</td><td>取数地址</td></tr><tr><td>DMOp</td><td>I</td><td>4</td><td>取数操作</td></tr><tr><td>RD_in</td><td>I</td><td>32</td><td>未经处理的取出数据</td></tr><tr><td>RD_out</td><td>O</td><td>32</td><td>处理后的取出数据</td></tr></tbody></table><h4 id=2dmop编码与取数操作>2.DMOp编码与取数操作<a hidden class=anchor aria-hidden=true href=#2dmop编码与取数操作>#</a></h4><table><thead><tr><th>DMOp</th><th>对应指令</th></tr></thead><tbody><tr><td>1000</td><td>lw</td></tr><tr><td>1001</td><td>lh</td></tr><tr><td>1010</td><td>lb</td></tr></tbody></table><h3 id=12mux>12.MUX<a hidden class=anchor aria-hidden=true href=#12mux>#</a></h3><h4 id=1功能多路选择器>1.功能多路选择器<a hidden class=anchor aria-hidden=true href=#1功能多路选择器>#</a></h4><h5 id=1mux_a3-d级写入寄存器选择>1.MUX_A3 D级写入寄存器选择<a hidden class=anchor aria-hidden=true href=#1mux_a3-d级写入寄存器选择>#</a></h5><h6 id=端口定义列表-2>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-2>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>D_instr_rs</td><td>I</td><td>5</td><td>instr中rs段</td></tr><tr><td>D_instr_rt</td><td>I</td><td>5</td><td>instr中rt段</td></tr><tr><td>SelA3_D</td><td>I</td><td>2</td><td>rd选择信号</td></tr><tr><td>D_A3</td><td>O</td><td>5</td><td>写入寄存器A3</td></tr></tbody></table><h6 id=选择信号与结果>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果>#</a></h6><table><thead><tr><th>SelA3_D</th><th>D_A3</th></tr></thead><tbody><tr><td>2&rsquo;b10</td><td>31</td></tr><tr><td>2&rsquo;b01</td><td>rd</td></tr><tr><td>2&rsquo;b00</td><td>rt</td></tr></tbody></table><h5 id=2mux_alu_b-alub端口选择>2.MUX_ALU_B ALUB端口选择<a hidden class=anchor aria-hidden=true href=#2mux_alu_b-alub端口选择>#</a></h5><h6 id=端口定义列表-3>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-3>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>E_V2_f</td><td>I</td><td>32</td><td>转发后的V2</td></tr><tr><td>E_E32</td><td>I</td><td>32</td><td>32位立即数</td></tr><tr><td>SelALUB_E</td><td>I</td><td>1</td><td>选择信号</td></tr><tr><td>E_ALU_B</td><td>O</td><td>32</td><td>输出到ALUB端口的结果</td></tr></tbody></table><h6 id=选择信号与结果-1>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-1>#</a></h6><table><thead><tr><th>SelALUB_E</th><th>E_ALU_B</th></tr></thead><tbody><tr><td>1&rsquo;b1</td><td>E_E32</td></tr><tr><td>1&rsquo;b0</td><td>E_V2_f</td></tr></tbody></table><h5 id=3mux_e_out--选择e级转发数据>3.MUX_E_out 选择E级转发数据<a hidden class=anchor aria-hidden=true href=#3mux_e_out--选择e级转发数据>#</a></h5><h6 id=端口定义列表-4>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-4>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>E_E32</td><td>I</td><td>32</td><td>32位立即数</td></tr><tr><td>E_pc8</td><td>I</td><td>32</td><td>流水PC8(jal)</td></tr><tr><td>SelEMout_E</td><td>I</td><td>1</td><td>选择信号</td></tr><tr><td>E_out</td><td>O</td><td>32</td><td>E级转发数据</td></tr></tbody></table><h6 id=选择信号与结果-2>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-2>#</a></h6><table><thead><tr><th>SelEMout_E</th><th>E_out</th></tr></thead><tbody><tr><td>1&rsquo;b1</td><td>E_pc8</td></tr><tr><td>1&rsquo;b0</td><td>E_E32</td></tr></tbody></table><h5 id=4mux_m_out-选择m级转发数据>4.MUX_M_out 选择M级转发数据<a hidden class=anchor aria-hidden=true href=#4mux_m_out-选择m级转发数据>#</a></h5><h6 id=端口定义列表-5>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-5>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>M_AO</td><td>I</td><td>32</td><td>M级ALU计算结果</td></tr><tr><td>M_pc8</td><td>I</td><td>32</td><td>流水PC8(jal)</td></tr><tr><td>SelEMout_M</td><td>I</td><td>1</td><td>选择信号</td></tr><tr><td>M_out</td><td>O</td><td>32</td><td>M级转发数据</td></tr></tbody></table><h6 id=选择信号与结果-3>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-3>#</a></h6><table><thead><tr><th>SelEMout_M</th><th>M_out</th></tr></thead><tbody><tr><td>1&rsquo;b1</td><td>M_pc8</td></tr><tr><td>1&rsquo;b0</td><td>M_AO</td></tr></tbody></table><h5 id=5mux_w_out-选择w级转发数据>5.MUX_W_out 选择W级转发数据<a hidden class=anchor aria-hidden=true href=#5mux_w_out-选择w级转发数据>#</a></h5><h6 id=端口定义列表-6>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-6>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>W_AO</td><td>I</td><td>32</td><td>W级ALU计算结果</td></tr><tr><td>W_DR</td><td>I</td><td>32</td><td>W级DM中读取出的数据</td></tr><tr><td>W_pc8</td><td>I</td><td>32</td><td>W级流水PC8(jal)</td></tr><tr><td>SelWout_W</td><td>I</td><td>2</td><td>选择信号</td></tr><tr><td>W_out</td><td>O</td><td>32</td><td>W级转发数据/GRF写入数据</td></tr></tbody></table><h6 id=选择信号与结果-4>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-4>#</a></h6><table><thead><tr><th>SelWout_W</th><th>W_out</th></tr></thead><tbody><tr><td>2&rsquo;b10</td><td>W_pc8</td></tr><tr><td>2&rsquo;b01</td><td>W_DR</td></tr><tr><td>2&rsquo;b00</td><td>W_AO</td></tr></tbody></table><h5 id=6mux_mdu_alu选择e级输出数据>6.MUX_MDU_ALU选择E级输出数据<a hidden class=anchor aria-hidden=true href=#6mux_mdu_alu选择e级输出数据>#</a></h5><h6 id=端口定义列表-7>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-7>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>E_AO</td><td>I</td><td>32</td><td>ALU输出</td></tr><tr><td>E_MDU_out</td><td>I</td><td>32</td><td>MDU输出</td></tr><tr><td>E_mf</td><td>I</td><td>1</td><td>是否为mf类指令</td></tr><tr><td>E_AO_new</td><td>O</td><td>32</td><td>E级输出值</td></tr></tbody></table><h6 id=选择信号与结果-5>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-5>#</a></h6><table><thead><tr><th>E_mf</th><th>E_AO_new</th></tr></thead><tbody><tr><td>1</td><td>E_MDU_out</td></tr><tr><td>0</td><td>E_AO</td></tr></tbody></table><h4 id=2转发多路选择器>2.转发多路选择器<a hidden class=anchor aria-hidden=true href=#2转发多路选择器>#</a></h4><h5 id=1hmux_cmp_d1-cmp模块rs寄存器值转发>1.HMUX_CMP_D1 CMP模块rs寄存器值转发<a hidden class=anchor aria-hidden=true href=#1hmux_cmp_d1-cmp模块rs寄存器值转发>#</a></h5><h6 id=端口定义列表-8>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-8>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>GRF_RD1</td><td>I</td><td>32</td><td>GRF中读取出的rs值</td></tr><tr><td>M_out</td><td>I</td><td>32</td><td>M级转发数据</td></tr><tr><td>E_out</td><td>I</td><td>32</td><td>E级转发数据</td></tr><tr><td>FwdCMPD1</td><td>I</td><td>2</td><td>选择信号</td></tr><tr><td>D_V1_f</td><td>O</td><td>32</td><td>转发后的rs寄存器值</td></tr></tbody></table><p>​ <strong>注：转发寄存器中有数据优先级的问题，越新产生的数据优先级越高，考虑到GRF中内部转发的逻辑，事实上GRF_RD1也代表着潜在的W级转发数据，但是仍然不破坏优先级关系E>M>W</strong></p><h6 id=选择信号与结果-6>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-6>#</a></h6><table><thead><tr><th>FwdCMPD1</th><th>D_V1_f</th></tr></thead><tbody><tr><td>2&rsquo;b10</td><td>E_out</td></tr><tr><td>2&rsquo;b01</td><td>M_out</td></tr><tr><td>2&rsquo;b00</td><td>GRF_RD1</td></tr></tbody></table><h5 id=2hmux_cmp_d2-cmp模块rt寄存器值转发>2.HMUX_CMP_D2 CMP模块rt寄存器值转发<a hidden class=anchor aria-hidden=true href=#2hmux_cmp_d2-cmp模块rt寄存器值转发>#</a></h5><h6 id=端口定义列表-9>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-9>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>GRF_RD2</td><td>I</td><td>32</td><td>GRF中读取出的rt值</td></tr><tr><td>M_out</td><td>I</td><td>32</td><td>M级转发数据</td></tr><tr><td>E_out</td><td>I</td><td>32</td><td>E级转发数据</td></tr><tr><td>FwdCMPD2</td><td>I</td><td>2</td><td>选择信号</td></tr><tr><td>D_V2_f</td><td>O</td><td>32</td><td>转发后的rt寄存器值</td></tr></tbody></table><h6 id=选择信号与结果-7>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-7>#</a></h6><table><thead><tr><th>FwdCMPD2</th><th>D_V1_f</th></tr></thead><tbody><tr><td>2&rsquo;b10</td><td>E_out</td></tr><tr><td>2&rsquo;b01</td><td>M_out</td></tr><tr><td>2&rsquo;b00</td><td>GRF_RD2</td></tr></tbody></table><h5 id=3hmux_alu_a-alu模块v1值转发mdu输入v1>3.HMUX_ALU_A ALU模块V1值转发/MDU输入V1<a hidden class=anchor aria-hidden=true href=#3hmux_alu_a-alu模块v1值转发mdu输入v1>#</a></h5><h6 id=端口定义列表-10>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-10>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>E_V1</td><td>I</td><td>32</td><td>GRF中读取出的rs值</td></tr><tr><td>M_out</td><td>I</td><td>32</td><td>M级转发数据</td></tr><tr><td>W_out</td><td>I</td><td>32</td><td>W级转发数据</td></tr><tr><td>FwdALUA</td><td>I</td><td>2</td><td>选择信号</td></tr><tr><td>E_V1_f</td><td>O</td><td>32</td><td>转发后的V1值</td></tr></tbody></table><h6 id=选择信号与结果-8>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-8>#</a></h6><table><thead><tr><th>FwdALUA</th><th>E_V1_f</th></tr></thead><tbody><tr><td>2&rsquo;b10</td><td>M_out</td></tr><tr><td>2&rsquo;b01</td><td>W_out</td></tr><tr><td>2&rsquo;b00</td><td>E_V1</td></tr></tbody></table><h5 id=4hmux_alu_b-alu模块v2值转发mdu输入v2>4.HMUX_ALU_B ALU模块V2值转发/MDU输入V2<a hidden class=anchor aria-hidden=true href=#4hmux_alu_b-alu模块v2值转发mdu输入v2>#</a></h5><h6 id=端口定义列表-11>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-11>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>E_V2</td><td>I</td><td>32</td><td>GRF中读取出的rt值</td></tr><tr><td>M_out</td><td>I</td><td>32</td><td>M级转发数据</td></tr><tr><td>W_out</td><td>I</td><td>32</td><td>W级转发数据</td></tr><tr><td>FwdALUB</td><td>I</td><td>2</td><td>选择信号</td></tr><tr><td>E_V2_f</td><td>O</td><td>32</td><td>转发后的V2值</td></tr></tbody></table><h6 id=选择信号与结果-9>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-9>#</a></h6><table><thead><tr><th>FwdALUB</th><th>E_V2_f</th></tr></thead><tbody><tr><td>2&rsquo;b10</td><td>M_out</td></tr><tr><td>2&rsquo;b01</td><td>W_out</td></tr><tr><td>2&rsquo;b00</td><td>E_V2</td></tr></tbody></table><h5 id=5hmux_dm-dm写入数据转发>5.HMUX_DM DM写入数据转发<a hidden class=anchor aria-hidden=true href=#5hmux_dm-dm写入数据转发>#</a></h5><h6 id=端口定义列表-12>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-12>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>M_V2</td><td>I</td><td>32</td><td>M级V2</td></tr><tr><td>W_out</td><td>I</td><td>32</td><td>W级转发数据</td></tr><tr><td>FwdDM</td><td>I</td><td>1</td><td>选择信号</td></tr><tr><td>M_V1_f</td><td>O</td><td>32</td><td>DM写入数据</td></tr></tbody></table><h6 id=选择信号与结果-10>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-10>#</a></h6><table><thead><tr><th>FwdDM</th><th>M_V1_f</th></tr></thead><tbody><tr><td>1&rsquo;b1</td><td>W_out</td></tr><tr><td>1&rsquo;b0</td><td>M_V2</td></tr></tbody></table><h5 id=6hmux_npc-npc模块跳转寄存器值转发>6.HMUX_NPC NPC模块跳转寄存器值转发<a hidden class=anchor aria-hidden=true href=#6hmux_npc-npc模块跳转寄存器值转发>#</a></h5><h6 id=端口定义列表-13>端口定义列表<a hidden class=anchor aria-hidden=true href=#端口定义列表-13>#</a></h6><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>GRF_RD1</td><td>I</td><td>32</td><td>GRF中读取出的rs值</td></tr><tr><td>M_out</td><td>I</td><td>32</td><td>M级转发数据</td></tr><tr><td>E_out</td><td>I</td><td>32</td><td>E级转发数据</td></tr><tr><td>FwdCMPD1</td><td>I</td><td>2</td><td>选择信号</td></tr><tr><td>D_RA_f</td><td>O</td><td>32</td><td>转发后的rs寄存器值</td></tr></tbody></table><p>​ <strong>注：其实可以共用CMPD1的转发数据</strong></p><h6 id=选择信号与结果-11>选择信号与结果<a hidden class=anchor aria-hidden=true href=#选择信号与结果-11>#</a></h6><table><thead><tr><th>FwdCMPD1</th><th>D_RA_f</th></tr></thead><tbody><tr><td>2&rsquo;b10</td><td>E_out</td></tr><tr><td>2&rsquo;b01</td><td>M_out</td></tr><tr><td>2&rsquo;b00</td><td>GRF_RD1</td></tr></tbody></table><h3 id=13流水线寄存器>13.流水线寄存器<a hidden class=anchor aria-hidden=true href=#13流水线寄存器>#</a></h3><h4 id=1d_reg>1.D_REG<a hidden class=anchor aria-hidden=true href=#1d_reg>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td>时钟信号</td></tr><tr><td>reset</td><td>I</td><td>1</td><td>同步复位信号</td></tr><tr><td>en</td><td>I</td><td>1</td><td>~stall（冻结D级）</td></tr><tr><td>F_instr</td><td>I</td><td>32</td><td>F级取指令</td></tr><tr><td>F_pc</td><td>I</td><td>32</td><td>F级PC</td></tr><tr><td>F_pc8</td><td>I</td><td>32</td><td>F级PC+8(jal)</td></tr><tr><td>D_instr</td><td>O</td><td>32</td><td>D级执行指令</td></tr><tr><td>D_pc</td><td>O</td><td>32</td><td>D级PC</td></tr><tr><td>D_pc8</td><td>O</td><td>32</td><td>D级PC+8</td></tr></tbody></table><h4 id=2e_reg>2.E_REG<a hidden class=anchor aria-hidden=true href=#2e_reg>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td>时钟信号</td></tr><tr><td>reset</td><td>I</td><td>1</td><td>同步复位信号</td></tr><tr><td>clr</td><td>I</td><td>1</td><td>stall(清空E级)</td></tr><tr><td>D_V1</td><td>I</td><td>32</td><td>D级GRF中读取rs寄存器的值</td></tr><tr><td>D_V2</td><td>I</td><td>32</td><td>D级GRF中读取rt寄存器的值</td></tr><tr><td>D_A1</td><td>I</td><td>5</td><td>D级A1</td></tr><tr><td>D_A2</td><td>I</td><td>5</td><td>D级A2</td></tr><tr><td>D_A3</td><td>I</td><td>5</td><td>D级A3</td></tr><tr><td>D_E32</td><td>I</td><td>32</td><td>32位立即数</td></tr><tr><td>D_pc</td><td>I</td><td>32</td><td>D级pc</td></tr><tr><td>D_pc8</td><td>I</td><td>32</td><td>D级pc+8</td></tr><tr><td>T_new_D</td><td>I</td><td>2</td><td>D级T_new</td></tr><tr><td>RegWrite_D</td><td>I</td><td>1</td><td>D级GRF写入使能</td></tr><tr><td>start_D</td><td>I</td><td>1</td><td>D级乘除指令开始信号</td></tr><tr><td>SelEMout_D</td><td>I</td><td>1</td><td>E、M级转发数据选择信号</td></tr><tr><td>SelWout_D</td><td>I</td><td>1</td><td>W级转发数据选择信号</td></tr><tr><td>SelALUB_D</td><td>I</td><td>1</td><td>ALUB端口数据选择</td></tr><tr><td>ALUOp_D</td><td>I</td><td>4</td><td>ALU操作选择</td></tr><tr><td>DMOp_D</td><td>I</td><td>4</td><td>DM操作选择</td></tr><tr><td>MDUOp_D</td><td>I</td><td>4</td><td>乘除指令操作</td></tr><tr><td>E_V1</td><td>O</td><td>32</td><td></td></tr><tr><td>E_V2</td><td>O</td><td>32</td><td></td></tr><tr><td>E_A1</td><td>O</td><td>5</td><td></td></tr><tr><td>E_A2</td><td>O</td><td>5</td><td></td></tr><tr><td>E_A3</td><td>O</td><td>5</td><td></td></tr><tr><td>E_E32</td><td>O</td><td>32</td><td></td></tr><tr><td>E_pc</td><td>O</td><td>32</td><td></td></tr><tr><td>E_pc8</td><td>O</td><td>32</td><td></td></tr><tr><td>T_new_E</td><td>O</td><td>2</td><td></td></tr><tr><td>RegWrite_E</td><td>O</td><td>1</td><td></td></tr><tr><td>SelEMout_E</td><td>O</td><td>1</td><td></td></tr><tr><td>SelWout_E</td><td>O</td><td>2</td><td></td></tr><tr><td>SelALUB_E</td><td>O</td><td>1</td><td></td></tr><tr><td>ALUOp_E</td><td>O</td><td>3</td><td></td></tr><tr><td>DMOp_E</td><td>O</td><td>3</td><td></td></tr></tbody></table><h4 id=3m_reg>3.M_REG<a hidden class=anchor aria-hidden=true href=#3m_reg>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td></td></tr><tr><td>reset</td><td>I</td><td>1</td><td></td></tr><tr><td>E_AO</td><td>I</td><td>32</td><td>E级ALU/MDU输出</td></tr><tr><td>E_V2</td><td>I</td><td>32</td><td><strong>注意：E_V2不是D_V2,而是经过转发后的D_V2_f</strong></td></tr><tr><td>E_A2</td><td>I</td><td>5</td><td></td></tr><tr><td>E_A3</td><td>I</td><td>5</td><td></td></tr><tr><td>E_pc</td><td>I</td><td>32</td><td></td></tr><tr><td>E_pc8</td><td>I</td><td>32</td><td></td></tr><tr><td>T_new_E</td><td>I</td><td>2</td><td></td></tr><tr><td>RegWrite_E</td><td>I</td><td>1</td><td></td></tr><tr><td>start_E</td><td>I</td><td>1</td><td></td></tr><tr><td>SelEMout_E</td><td>I</td><td>1</td><td></td></tr><tr><td>SelWout_E</td><td>I</td><td>1</td><td></td></tr><tr><td>DMOp_E</td><td>I</td><td>4</td><td></td></tr><tr><td>M_AO</td><td>O</td><td>32</td><td></td></tr><tr><td>M_V2</td><td>O</td><td>5</td><td></td></tr><tr><td>M_A2</td><td>O</td><td>5</td><td></td></tr><tr><td>M_A3</td><td>O</td><td>5</td><td></td></tr><tr><td>M_pc</td><td>O</td><td>32</td><td></td></tr><tr><td>M_pc8</td><td>O</td><td>32</td><td></td></tr><tr><td>T_new_M</td><td>O</td><td>2</td><td></td></tr><tr><td>RegWrite_M</td><td>O</td><td>1</td><td></td></tr><tr><td>SelEMout_M</td><td>O</td><td>1</td><td></td></tr><tr><td>SelWout_M</td><td>O</td><td>2</td><td></td></tr><tr><td>DMOp_M</td><td>O</td><td>3</td><td></td></tr></tbody></table><h4 id=4w_reg>4.W_REG<a hidden class=anchor aria-hidden=true href=#4w_reg>#</a></h4><table><thead><tr><th>名称</th><th>方向</th><th>位宽</th><th>描述</th></tr></thead><tbody><tr><td>clk</td><td>I</td><td>1</td><td></td></tr><tr><td>reset</td><td>I</td><td>1</td><td></td></tr><tr><td>M_AO</td><td>I</td><td>32</td><td></td></tr><tr><td>M_DR</td><td>I</td><td>32</td><td>M级DM中读出的数据</td></tr><tr><td>M_A3</td><td></td><td></td><td></td></tr><tr><td>M_pc</td><td>I</td><td>32</td><td></td></tr><tr><td>M_pc8</td><td>I</td><td>32</td><td></td></tr><tr><td>SelWout_M</td><td>I</td><td>2</td><td></td></tr><tr><td>T_new_M</td><td>I</td><td>2</td><td></td></tr><tr><td>RegWrite_M</td><td>I</td><td>1</td><td></td></tr><tr><td>W_AO</td><td>O</td><td>32</td><td></td></tr><tr><td>W_DR</td><td>O</td><td>32</td><td></td></tr><tr><td>W_A3</td><td>O</td><td>5</td><td></td></tr><tr><td>W_pc</td><td>O</td><td>32</td><td></td></tr><tr><td>W_pc8</td><td>O</td><td>32</td><td></td></tr><tr><td>SelWout_W</td><td>O</td><td>2</td><td></td></tr><tr><td>T_new_W</td><td>O</td><td>2</td><td></td></tr><tr><td>RegWrite_W</td><td>O</td><td>1</td><td></td></tr></tbody></table><h2 id=三测试>三.测试<a hidden class=anchor aria-hidden=true href=#三测试>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-verilog data-lang=verilog><span style=display:flex><span>li $<span style=color:#bd93f9>0</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1590414783</span>
</span></span><span style=display:flex><span>li $<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1387657999</span>
</span></span><span style=display:flex><span>li $<span style=color:#bd93f9>2</span> <span style=color:#bd93f9>97336612</span>
</span></span><span style=display:flex><span>li $<span style=color:#bd93f9>3</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1971889419</span>
</span></span><span style=display:flex><span>li $<span style=color:#bd93f9>4</span> <span style=color:#bd93f9>1148790734</span>
</span></span><span style=display:flex><span>li $<span style=color:#bd93f9>5</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>289210629</span>
</span></span><span style=display:flex><span>li $<span style=color:#bd93f9>6</span> <span style=color:#bd93f9>1026640559</span>
</span></span><span style=display:flex><span>li $<span style=color:#bd93f9>7</span> <span style=color:#bd93f9>1852052372</span>
</span></span><span style=display:flex><span>li $<span style=color:#bd93f9>8</span>, <span style=color:#bd93f9>7860</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sltu $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>srav $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>1</span>, $<span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>or</span> $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>xor</span> $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>nor</span> $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>slt $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>ori $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>1</span>, <span style=color:#ff79c6>-</span><span style=color:#bd93f9>31050</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>or</span> $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>2</span>, $<span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>subu $<span style=color:#bd93f9>1</span>, $<span style=color:#bd93f9>2</span>, $<span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>sltu $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>lbu $<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>878</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>slt $<span style=color:#bd93f9>2</span>, $<span style=color:#bd93f9>2</span>, $<span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>or</span> $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>2</span>, $<span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>srav $<span style=color:#bd93f9>1</span>, $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>sll $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>7</span>, <span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span>srlv $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>nor</span> $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>7</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>or</span> $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>div $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>sltu $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sllv $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>2</span>, $<span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>srlv $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>mtlo $<span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>addu $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>slt $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>addu $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>1</span>, $<span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>mfhi $<span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>nor</span> $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>srav $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>sltiu $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>4</span>, <span style=color:#bd93f9>7080</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>and</span> $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>or</span> $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>xor</span> $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>andi $<span style=color:#bd93f9>2</span>, $<span style=color:#bd93f9>6</span>, <span style=color:#bd93f9>25900</span>
</span></span><span style=display:flex><span>xori $<span style=color:#bd93f9>1</span>, $<span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>18289</span>
</span></span><span style=display:flex><span>srlv $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>slt $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>ori $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>3</span>, <span style=color:#ff79c6>-</span><span style=color:#bd93f9>32729</span>
</span></span><span style=display:flex><span>lh $<span style=color:#bd93f9>7</span>, <span style=color:#bd93f9>1250</span>($<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>sllv $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>addu $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>1</span>, $<span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>xori $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>11378</span>
</span></span><span style=display:flex><span>srl $<span style=color:#bd93f9>4</span>, $<span style=color:#bd93f9>4</span>, <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>addu $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>5</span>, $<span style=color:#bd93f9>6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>srav $<span style=color:#bd93f9>7</span>, $<span style=color:#bd93f9>3</span>, $<span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>slti $<span style=color:#bd93f9>1</span>, $<span style=color:#bd93f9>5</span>, <span style=color:#ff79c6>-</span><span style=color:#bd93f9>24158</span>
</span></span><span style=display:flex><span>multu $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span>sltu $<span style=color:#bd93f9>6</span>, $<span style=color:#bd93f9>0</span>, $<span style=color:#bd93f9>1</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=四思考题>四.思考题<a hidden class=anchor aria-hidden=true href=#四思考题>#</a></h2><p>1、为什么需要有单独的乘除法部件而不是整合进 ALU？为何需要有独立的 HI、LO 寄存器？</p><ul><li>乘除法都有较高的延迟，若整合进ALU，则进行乘除法的时候，所有的运算类指令都只能阻塞在D级，造成了极大的性能损失。单独设置MDU的话，无关的指令还能正常的在ALU运行，效率较高。</li><li>HI，LO寄存器并不是通用寄存器，和其他通用寄存器的用法不一致，不能通过非乘除法指令修改和访问，因此不需要置于GRF中，内置在MDU中即可。</li></ul><p>2、真实的流水线 CPU 是如何使用实现乘除法的？请查阅相关资料进行简单说明。</p><ul><li><p>真实的流水线CPU采用的乘法是有加法器和移位器循环，具体实现过程为：</p><blockquote><p>首先CPU会初始化三个通用寄存器用来存放被乘数，乘数，部分积。
部分积寄存器初始化为0。
判断乘数寄存器的低位是0|1，如果为0则将乘数寄存器右移一位，同时将部分积寄存器也右移一位。
在位移时遵循计算机位移规则，乘数寄存器低位溢出的一位丢弃，部分积寄存器低位溢出的一位填充到乘数寄存器的高位。
同时部分积寄存器高位补0。如果为1则将部分积寄存器加上被乘数寄存器，再进行移位操作。
当所有乘数位处理完成后部分积寄存器做高位，乘数寄存器做低位就是最终乘法结果。</p></blockquote></li><li><p>还有另一种乘法的方式：</p><blockquote><p>只需两个寄存器，A[31:0],B[63:0]，A初始化为被乘数，B初始化为乘数。
每一次取B的最低位，为1则将A[31:0]+B[63:32] -> B[63:32]，为0则不操作。
每次将B &#187; 1，然后高位补0。</p></blockquote></li><li><p>除法实现：</p><blockquote><p>与乘法的操作基本相反，首先CPU会初始化三个寄存器,用来存放被除数，除数，部分商。余数(被除数与除数比较的结果)放到被除数的有效高位上。CPU做除法时和做除法时是相反的，乘法是右移，除法是左移，乘法做的是加法，除法做的是减法。首先CPU会把被除数bit位与除数bit位对齐，然后再让对齐的被除数与除数比较(双符号位判断)。比如01-10=11(前面的1是符号位) 1-2=-1 计算机通过符号位和后一位的bit位来判断大于和小于，那么01-10=11 就说明01小于10，如果得数为01就代表大于，如果得数为00代表等于。如果得数大于或等于则将比较的结果放到被除数的有效高位上然后再商寄存器上商：1 并向后多看一位(上商就是将商的最低位左移1位腾出商寄存器最低位上新的商)如果得数小于则上商：0 并向后多看一位然后循环做以上操作当所有的被除数都处理完后，商做结果被除数里面的值就是余数。</p></blockquote></li></ul><p>3、请结合自己的实现分析，你是如何处理 Busy 信号带来的周期阻塞的？</p><ul><li>除cnt和busy置位以外全是组合逻辑的操作（不然可能会多出来一个空周期）</li><li>对于乘除指令：<ul><li>将busy_E，start_E，MDUOp_D传入HCU</li><li>然后md暂停信号为<code>(busy_E | start_E) & (MDUOp_D != 4'b0000)</code></li></ul></li></ul><p>4、请问采用字节使能信号的方式处理写指令有什么好处？（提示：从清晰性、统一性等角度考虑）</p><ul><li>对于需要写入的位置更加的直观，相当于将DMWE、DMOP写入的A[1:0]用四位字节使能信号表示，十分的统一。</li></ul><p>5、请思考，我们在按字节读和按字节写时，实际从 DM 获得的数据和向 DM 写入的数据是否是一字节？在什么情况下我们按字节读和按字节写的效率会高于按字读和按字写呢？</p><ul><li>按字节读写的时候，我们获得的是一字节，但是我们如果要lw或lh的话我们就需要拼接。如果是sw或sh的话我们需要多次存入。</li><li>若用lb，sb，lh，sh这种非取字的读写时，按字节读可以省去，取位，拼接的步骤，效率要优于按字读写。</li></ul><p>6、为了对抗复杂性你采取了哪些抽象和规范手段？这些手段在译码和处理数据冲突的时候有什么样的特点与帮助？</p><ul><li>NPC统一，NPC统一为一个模块</li><li>指令分类，cal_R,cal_I,shift,shiftv,branch,load,store等</li><li>每一级设置outMUX，只需在MCU中控制outSel即可决定转发值及写入寄存器的值</li></ul><p>7、在本实验中你遇到了哪些不同指令类型组合产生的冲突？你又是如何解决的？相应的测试样例是什么样的？</p><ul><li>在常规测试通过后，我们可以将T_rsUse和T_rtUse相同的指令归类为同一需求指令，把T_new相同的指令归类为同一供给指令。<ul><li>所以可以在new方面有下列指令：add，lw，jal，mfhi</li><li>在rsUse方面有下面情况：add，sll，lw，beq，jr，mult，mthi</li></ul></li><li>然后对着转发的时间表，设计测试数据：</li></ul><pre tabindex=0><code>复制# rs0_E1
add   $t0, $t1, $t2
beq   $t0, $t3, label1
nop

# rs0_E2
lw    $t0, 0($t1)
beq   $t0, $t3, label1
nop

#rs0_E0
jal   label1
nop
ori   $t0, $0, 0x1234
label1: jr $ra
nop
....
</code></pre><p>8、如果你是手动构造的样例，请说明构造策略，说明你的测试程序如何保证覆盖了所有需要测试的情况；如果你是完全随机生成的测试样例，请思考完全随机的测试程序有何不足之处；如果你在生成测试样例时采用了特殊的策略，比如构造连续数据冒险序列，请你描述一下你使用的策略如何结合了随机性达到强测的效果。</p><ul><li>手动构造策略见上</li><li>完全随机生成有几大不足之处，如无法保证内存对齐，无法保证延迟槽中没有跳转分支，无法避免一定几率的死循环等等</li><li>但可以加入策略：<ul><li>比如只用t0-t6寄存器以保证产生足够多的冲突</li><li>在检测到生成跳转后禁用跳转指令</li><li>检测到内存不对齐可以不生成等等</li></ul></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://coder0xe.github.io/tags/nov/>Nov</a></li></ul><nav class=paginav><a class=prev href=https://coder0xe.github.io/posts/p6%E8%AF%BE%E4%B8%8A%E6%B5%8B%E8%AF%95/><span class=title>« Prev</span><br><span>P6课上测试</span>
</a><a class=next href=https://coder0xe.github.io/posts/p5%E8%AF%BE%E4%B8%8A%E6%B5%8B%E8%AF%95/><span class=title>Next »</span><br><span>P5课上测试</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share P6-design-document on x" href="https://x.com/intent/tweet/?text=P6-design-document&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp6-design-document%2f&amp;hashtags=Nov"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P6-design-document on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp6-design-document%2f&amp;title=P6-design-document&amp;summary=P6-design-document&amp;source=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp6-design-document%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P6-design-document on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp6-design-document%2f&title=P6-design-document"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P6-design-document on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp6-design-document%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P6-design-document on whatsapp" href="https://api.whatsapp.com/send?text=P6-design-document%20-%20https%3a%2f%2fcoder0xe.github.io%2fposts%2fp6-design-document%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P6-design-document on telegram" href="https://telegram.me/share/url?text=P6-design-document&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp6-design-document%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share P6-design-document on ycombinator" href="https://news.ycombinator.com/submitlink?t=P6-design-document&u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fp6-design-document%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://coder0xe.github.io/>coder0xe's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>