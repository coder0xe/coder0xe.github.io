<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OS:lab4课下基础 | coder0xe's blog</title><meta name=keywords content="lab4"><meta name=description content="lab4课下基础"><meta name=author content="sudo"><link rel=canonical href=https://coder0xe.github.io/posts/os-lab4%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/><link crossorigin=anonymous href=/assets/css/stylesheet.e4a36188e2c44563c1cc5ed1a2d0b8451a4f68c685114d738b97609f82dae050.css integrity="sha256-5KNhiOLERWPBzF7RotC4RRpPaMaFEU1zi5dgn4La4FA=" rel="preload stylesheet" as=style><link rel=icon href=https://coder0xe.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://coder0xe.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://coder0xe.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://coder0xe.github.io/apple-touch-icon.png><link rel=mask-icon href=https://coder0xe.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://coder0xe.github.io/posts/os-lab4%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://coder0xe.github.io/posts/os-lab4%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/"><meta property="og:site_name" content="coder0xe's blog"><meta property="og:title" content="OS:lab4课下基础"><meta property="og:description" content="lab4课下基础"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-06T14:17:29+08:00"><meta property="article:modified_time" content="2024-05-06T14:17:29+08:00"><meta property="article:tag" content="May"><meta name=twitter:card content="summary"><meta name=twitter:title content="OS:lab4课下基础"><meta name=twitter:description content="lab4课下基础"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://coder0xe.github.io/posts/"},{"@type":"ListItem","position":2,"name":"OS:lab4课下基础","item":"https://coder0xe.github.io/posts/os-lab4%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OS:lab4课下基础","name":"OS:lab4课下基础","description":"lab4课下基础","keywords":["lab4"],"articleBody":"OS:lab4课下基础 1.系统调用 1.1 系统调用相关概念 ​\t在MIPS中，syscall是用于执行系统调用的自陷指令，它使得进程陷入到内核的异常处理程序中，由内核根据系统调用时的上下文执行相应的内核函数，完成相应的功能，并最终返回到syscall的后一条指令。\n存在只能由内核来完成的操作(读写设备、创建进程、IO等) C标准库中的一些函数的实现依赖于操作系统 通过执行syscall指令，用户进程可以陷入到内核态，请求内核提供的服务 通过系统调用陷入到内核态时，需要在用户态与内核态之间进行数据传递与保护 ​\t系统调用保证了系统的安全性：内核将自己能够提供的服务以系统调用的方式提供给用户空间，用户程序只能将服务相关的参数交予操作系统执行\nAPI : Application Programming Interface，程序之间的接口\n​\t直接使用系统调用较为麻烦，于是产生了一系列用户空间的API定义，他们在系统的调用的基础上，实现了更多更高级的常用功能。用户在编写程序时可以直接调用高层次的API来实现各种功能。\n​\t通过层级划分使得程序具有更好的可移植性，只要程序以来的API不变，无论底层的系统调用如何变化，都不会影响\n1.2 系统调用机制的实现 ​\t异常分发向量组(exception_handlers)中的8号异常，即为操作系统处理系统调用时的异常。\nMOS实验代码中，kern目录下即为内核态代码，user目录下即为用户态代码\n​\t以user/lib/debugf.c中的debugf函数来学习处理系统调用的流程(debugf函数是一个debug信息输出函数，进行了IO方面的系统调用)\n​\tdebugf函数的调用链为(系统调用请求从用户态向内核态传递)\ndebugf调用字符串输出函数debug_output\ndebug_output调用了用户空间的syscall_*函数(这里的*为通配符，代表着用户空间进行系统调用的一组操作，都定义在用户态代码syscall_lab.c中，这里调用的是syscall_print_cons)\nsyscall_*函数调用msyscall函数，系统陷入内核态(msyscall是汇编代码，直接调用syscall)。\n内核态中将异常分发到handle_sys函数，将系统所需信息传递进内核(输出字符串s)\n内核取得信息，执行对应的内核空间的系统调用函数sys_*(kern/syscall_all.c)\n系统调用完成，返回值传递回用户态\n从系统调用函数返回，回到debugf调用处\n通过上述描述，对于系统调用的处理实际上是从用户空间向系统空间进行传递的，用户空间中的syscall_*函数与内核中的sys_*是一一对应的，syscall_*函数是用户空间中最接近内核的函数，他调用msyscall中的汇编代码syscall直接陷入内核态，sys_*函数是内核中系统调用的具体实现。\n​\t直接调用syscall陷入内核的msyscall函数具有六个参数，其中第一个参数是与调用名相似的宏，例如SYS_print_cons，被称为系统调用号(include/syscall.h)，用来区分不同的系统调用，其余还有五个参数，即为系统调用时需要传递给内核的参数。\n回忆MIPS函数调用规范中的参数传递，前四个参数保存在寄存器中\nExercise 4.1 msyscall\n进行系统调用(syscall)，并返回到msyscall的调用者处(jr)，syscall_*\n#include LEAF(msyscall) // Just use 'syscall' instruction and return. /* Exercise 4.1: Your code here. */ syscall #陷入内核 jr ra #返回调用者 syscall_* END(msyscall) ​\t通过汇编指令syscall陷入内核态后，处理器将PC寄存器指向一个内核中固定的异常处理入口(见lab3中不同异常处理跳转到的地址)\n​\t在异常向量表中，系统调用这一异常类型的处理入口为handle_sys函数(kern/genex.S)，实际调用do_syscall(kern/syscall_all.c)函数进行系统调用。\n​\t陷入内核态的操作并不是从一个函数跳转到了另一个函数，代码使用的栈指针$sp是内核空间中的栈指针。系统从用户态切换到内核态后，首先需要将原用户进程的运行现场保存到内核空间(SAVE_ALL)，随后的栈指针则指向保存的Trapframe。我们正是借助这个保存的结构体来获取用户态中传递过来的值，例如$a0($4)寄存器保存在内核栈的TF_REG4(sp)处。当内核在handle_开头的函数(处理对应异常的函数)中调用实际进行异常处理的C函数时，将这个栈指针作为参数传递给这个C函数，用来获取用户态中的参数\nExercise 4.2 do_syscall\nHint：用户态的运行现场保存在一个Trapframe中，这个trapframe的指针传递给内核态中处理异常的函数用来获取用户态进行系统调用所传递的参数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 void do_syscall(struct Trapframe *tf) { int (*func)(u_int, u_int, u_int, u_int, u_int); int sysno = tf-\u003eregs[4]; // 系统调用号 if (sysno \u003c 0 || sysno \u003e= MAX_SYSNO) { tf-\u003eregs[2] = -E_NO_SYS; return; } /* Step 1: Add the EPC in 'tf' by a word (size of an instruction). */ /* Exercise 4.2: Your code here. (1/4) */ tf-\u003ecp0_epc += 4; /* Step 2: Use 'sysno' to get 'func' from 'syscall_table'. */ /* Exercise 4.2: Your code here. (2/4) */ func = syscall_table[sysno]; /* Step 3: First 3 args are stored in $a1, $a2, $a3. */ u_int arg1 = tf-\u003eregs[5]; u_int arg2 = tf-\u003eregs[6]; u_int arg3 = tf-\u003eregs[7]; /* Step 4: Last 2 args are stored in stack at [$sp + 16 bytes], [$sp + 20 bytes]. */ u_int arg4, arg5; /* Exercise 4.2: Your code here. (3/4) */ arg4 = *(u_long*)(tf-\u003eregs[29] + 16); arg5 = *(u_long*)(tf-\u003eregs[29] + 20); /* Step 5: Invoke 'func' with retrieved arguments and store its return value to $v0 in 'tf'. */ /* Exercise 4.2: Your code here. (4/4) */ tf-\u003eregs[2] = func(arg1,arg2,arg3,arg4,arg5); } TIPS\ntf结构体的结构\n1 2 3 4 5 6 7 8 9 10 11 12 struct Trapframe { /* Saved main processor registers. */ unsigned long regs[32]; /* Saved special registers. */ unsigned long cp0_status; unsigned long hi; unsigned long lo; unsigned long cp0_badvaddr; unsigned long cp0_cause; unsigned long cp0_epc; }; 前四个参数保存在a0(4)-a3(7)寄存器中，后两个参数保存在栈帧中\nsp指针保存在29号通用寄存器中\n返回值保存在v0(2)寄存器\n指针转换：\n1 2 arg4 = *(u_long*)(tf-\u003eregs[29] + 16); arg5 = *(u_long*)(tf-\u003eregs[29] + 20); tf-\u003eregs + 16得到一个地址，转换为(u_long*)类型的指针再解引用，取出对应地址的数据 依据系统调用号(保存在a0寄存器中)在系统调用表中找到相应的系统调用处理函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 void *syscall_table[MAX_SYSNO] = { [SYS_putchar] = sys_putchar, [SYS_print_cons] = sys_print_cons, [SYS_getenvid] = sys_getenvid, [SYS_yield] = sys_yield, [SYS_env_destroy] = sys_env_destroy, [SYS_set_tlb_mod_entry] = sys_set_tlb_mod_entry, [SYS_mem_alloc] = sys_mem_alloc, [SYS_mem_map] = sys_mem_map, [SYS_mem_unmap] = sys_mem_unmap, [SYS_exofork] = sys_exofork, [SYS_set_env_status] = sys_set_env_status, [SYS_set_trapframe] = sys_set_trapframe, [SYS_panic] = sys_panic, [SYS_ipc_try_send] = sys_ipc_try_send, [SYS_ipc_recv] = sys_ipc_recv, [SYS_cgetc] = sys_cgetc, [SYS_write_dev] = sys_write_dev, [SYS_read_dev] = sys_read_dev, }; 1.3 基础系统调用函数 ​\t在kern/syscall_all.c中定义了一系列基础系统调用，后续的IPC与fork机制以这些系统调用作为支撑\n1.3.1 sys_mem_alloc ​\tsys_mem_alloc的主要功能是分配内存，用户程序可以通过这个系统调用给该程序所允许的虚拟内存空间显式地分配实际的物理内存，或者说我们编写的程序在内存中申请了一片空间。对操作系统来说，是一个进程请求将其运行空间中的某段地址与实际物理内存进行映射，从而可以通过该虚拟页面来对物理内存进行存取访问。\n内核通过传入的进程标识符envid来确定发出请求的进程 Exercise 4.3 envid2env\n通过一个进程的envid获取该进程控制块\nHint：使用宏ENVX()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 int envid2env(u_int envid, struct Env **penv, int checkperm) { struct Env *e; /* Step 1: Assign value to 'e' using 'envid'. */ /* Hint: * If envid is zero, set 'penv' to 'curenv' and return 0. * You may want to use 'ENVX'. */ /* Exercise 4.3: Your code here. (1/2) */ if (envid == 0) { *penv = curenv; return 0; } e = \u0026envs[ENVX(envid)]; if (e-\u003eenv_status == ENV_FREE || e-\u003eenv_id != envid) { return -E_BAD_ENV; } /* Step 2: Check when 'checkperm' is non-zero. */ /* Hints: * Check whether the calling env has sufficient permissions to manipulate the * specified env, * i.e. 'e' is either 'curenv' or its immediate child. i.e.means in other words * If violated, return '-E_BAD_ENV'. */ /* Exercise 4.3: Your code here. (2/2) */ if (checkperm \u0026\u0026 (e-\u003eenv_id != curenv-\u003eenv_id) \u0026\u0026 (e-\u003eenv_parent_id != curenv-\u003eenv_id)) { return -E_BAD_ENV; } /* Step 3: Assign 'e' to '*penv'. */ *penv = e; return 0; } 当envid==0，说明是在fork的情景下调用envid2env，父进程fork的返回值为0，则进程即为当前进程或者说父进程 ENVX是根据进程id获取其在进程数组envs中偏移量的宏 关于checkperm检查权限位 当有效时，检查获取的进程控制块是否为当前进程或是当前进程的子进程(fork)，限制两个进程之间的关系为父子进程时需要检查 Exercise 4.4 sys_mem_alloc\n进程请求将其运行空间中的某段地址与实际物理内存进行映射\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 int sys_mem_alloc(u_int envid, u_int va, u_int perm) { struct Env *env; struct Page *pp; /* Step 1: Check if 'va' is a legal user virtual address using 'is_illegal_va'. */ /* Exercise 4.4: Your code here. (1/3) */ if (is_illegal_va(va)) { return -E_INVAL; } /* Step 2: Convert the envid to its corresponding 'struct Env *' using 'envid2env'. */ /* Hint: **Always** validate the permission in syscalls! */ /* Exercise 4.4: Your code here. (2/3) */ try(envid2env(envid,\u0026env,1)); /* Step 3: Allocate a physical page using 'page_alloc'. */ /* Exercise 4.4: Your code here. (3/3) */ try(page_alloc(\u0026pp)); /* Step 4: Map the allocated page at 'va' with permission 'perm' using 'page_insert'. */ return page_insert(env-\u003eenv_pgdir, env-\u003eenv_asid, pp, va, perm); } 检查进程提供的虚拟地址是否合法is_illegal_va 将进程id转换为进程控制块envid2env，这里需要设置checkperm为1，检查取到的进程控制块是否为当前进程的进程控制块 分配物理内存page_alloc 建立虚拟地址与物理地址之间的映射page_insert 1.3.2 sys_mem_map ​\t将源进程地址空间中的相应内存映射到目标进程的相应虚拟内存中去，或者说此时两个进程共享同一页物理内存\nExercise 4.5 sys_mem_map\nHint：srcenv-\u003edstenv\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 int sys_mem_map(u_int srcid, u_int srcva, u_int dstid, u_int dstva, u_int perm) { struct Env *srcenv; struct Env *dstenv; struct Page *pp; /* Step 1: Check if 'srcva' and 'dstva' are legal user virtual addresses using * 'is_illegal_va'. */ /* Exercise 4.5: Your code here. (1/4) */ if (is_illegal_va(srcva) || is_illegal_va(dstva)) { return -E_INVAL; } /* Step 2: Convert the 'srcid' to its corresponding 'struct Env *' using 'envid2env'. */ /* Exercise 4.5: Your code here. (2/4) */ try(envid2env(srcid,\u0026srcenv,1)); /* Step 3: Convert the 'dstid' to its corresponding 'struct Env *' using 'envid2env'. */ /* Exercise 4.5: Your code here. (3/4) */ try(envid2env(dstid,\u0026dstenv,1)); /* Step 4: Find the physical page mapped at 'srcva' in the address space of 'srcid'. */ /* Return -E_INVAL if 'srcva' is not mapped. */ /* Exercise 4.5: Your code here. (4/4) */ pp = page_lookup(srcenv-\u003eenv_pgdir,srcva,NULL); if (!pp) { return -E_INVAL; } /* Step 5: Map the physical page at 'dstva' in the address space of 'dstid'. */ return page_insert(dstenv-\u003eenv_pgdir, dstenv-\u003eenv_asid, pp, dstva, perm); } 检查源进程或目标进程的虚拟地址是否合法is_illegal_va 找到源进程和目标进程的进程控制块envid 关于checkperm：需要设置，检查是否为当前进程或当前进程的子进程 找到源进程中虚拟地址对应的物理页面的页控制块page_lookup 将该物理页面建立起与目标进程虚拟地址的映射page_insert 1.3.3 sys_mem_unmap ​\t解除某个进程地址空间虚拟内存和物理内存之间的映射关系\nExercise 4.6 sys_mem_unmap\nHint：page_remove\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 int sys_mem_unmap(u_int envid, u_int va) { struct Env *e; /* Step 1: Check if 'va' is a legal user virtual address using 'is_illegal_va'. */ /* Exercise 4.6: Your code here. (1/2) */ if (is_illegal_va(va)) { return -E_INVAL; } /* Step 2: Convert the envid to its corresponding 'struct Env *' using 'envid2env'. */ /* Exercise 4.6: Your code here. (2/2) */ try(envid2env(envid,\u0026e,1)); /* Step 3: Unmap the physical page at 'va' in the address space of 'envid'. */ page_remove(e-\u003eenv_pgdir, e-\u003eenv_asid, va); return 0; } 1.3.4 sys_yield ​\t用户进程放弃CPU，调度其他进程\nExercise 4.7 sys_yield\nHint：schedule\n1 2 3 4 5 void __attribute__((noreturn)) sys_yield(void) { // Hint: Just use 'schedule' with 'yield' set. /* Exercise 4.7: Your code here. */ schedule(1); } 1.3.5 总结 ​\t处理系统调用时，并没有切换地址空间，也不需要将进程上下文保存到进程控制块中，只是切换到内核态下执行一些代码，处理系统调用时内核仍然处于当前进程\nsys_mem_alloc：为当前进程中的虚拟地址va分配一块物理内存 sys_mem_map：将源进程地址空间中的地址映射到目标进程地址空间中的地址，或者说两个进程共享同一个物理页 sys_mem_unmap：解除进程中虚拟地址va与物理内存之间的映射关系 sys_yield：当前进程放弃CPU，进行进程调度 2.进程间通信IPC IPC : Inter-Process Communication\n​\tIPC机制的实现使得系统中的进程之间有了相互传递消息的能力。\n​\t所谓通信，最直观的理解就是交换数据，假如我们能够让一个进程有能力将数据传递给另一个进程，那么进程之间自然具有了相互通信的能力。\n​\t由于进程的地址空间之间是相互独立的，要想传递数据，就要想办法把一个地址空间中的东西传给另一个地址空间\n​\t所有的进程都共享同一个内核空间(kseg0)，故要想在不同进程的地址空间之间交换数据，就可以通过内核空间来实现！\n​\t发送方进程可以将数据以系统调用的形式存放在进程控制块中，接收方进程同样以系统调用的方式在进程控制块中找到对应的数据，读取并返回\n1 2 3 4 5 6 7 8 struct Env { // Lab 4 IPC u_int env_ipc_value; // the value sent to us u_int env_ipc_from; // envid of the sender u_int env_ipc_recving; // whether this env is blocked receiving u_int env_ipc_dstva; // va at which the received page should be mapped u_int env_ipc_perm; // perm in which the received page should be mapped }; env_ipc_dstva接受到的页面需要与自身的哪个虚拟页面完成映射 env_ipc_perm传递的页面的权限位设置 Exercise 4.8 sys_ipc_recv\n用于接收消息dst\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 int sys_ipc_recv(u_int dstva) { /* Step 1: Check if 'dstva' is either zero or a legal address. */ if (dstva != 0 \u0026\u0026 is_illegal_va(dstva)) { return -E_INVAL; } /* Step 2: Set 'curenv-\u003eenv_ipc_recving' to 1. */ /* Exercise 4.8: Your code here. (1/8) */ curenv-\u003eenv_ipc_recving = 1; /* Step 3: Set the value of 'curenv-\u003eenv_ipc_dstva'. */ /* Exercise 4.8: Your code here. (2/8) */ curenv-\u003eenv_ipc_dstva = dstva; /* Step 4: Set the status of 'curenv' to 'ENV_NOT_RUNNABLE' and remove it from * 'env_sched_list'. */ /* Exercise 4.8: Your code here. (3/8) */ curenv-\u003eenv_status = ENV_NOT_RUNNABLE; TAILQ_REMOVE(\u0026env_sched_list,curenv,env_sched_link); /* Step 5: Give up the CPU and block until a message is received. */ ((struct Trapframe *)KSTACKTOP - 1)-\u003eregs[2] = 0; schedule(1); } env_ipc_recving = 1允许接收消息 env_ipc_dstva = dstva：自己要将接受到的页面与dstva进行映射（映射过程在sys_ipc_send中实现，从srcva映射到dstva，故需要先设置好sys_ipc_recving然后再sys_ipc_send） 当前进程挂起，从调度队列中移除，放弃CPU进行进程调度，等待消息到来 Exercise 4.7 sys_ipc_try_send\n用于发送消息src\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 int sys_ipc_try_send(u_int envid, u_int value, u_int srcva, u_int perm) { struct Env *e; struct Page *p; /* Step 1: Check if 'srcva' is either zero or a legal address. */ /* Exercise 4.8: Your code here. (4/8) */ if (srcva != 0 \u0026\u0026 is_illegal_va(srcva)) { return -E_INVAL; } /* Step 2: Convert 'envid' to 'struct Env *e'. */ /* This is the only syscall where the 'envid2env' should be used with 'checkperm' UNSET, * because the target env is not restricted to 'curenv''s children. */ /* Exercise 4.8: Your code here. (5/8) */ try(envid2env(envid,\u0026e,0)); /* Step 3: Check if the target is waiting for a message. */ /* Exercise 4.8: Your code here. (6/8) */ if (e-\u003eenv_ipc_recving != 1) { return -E_IPC_NOT_RECV; } /* Step 4: Set the target's ipc fields. */ e-\u003eenv_ipc_value = value; e-\u003eenv_ipc_from = curenv-\u003eenv_id; e-\u003eenv_ipc_perm = PTE_V | perm; e-\u003eenv_ipc_recving = 0; /* Step 5: Set the target's status to 'ENV_RUNNABLE' again and insert it to the tail of * 'env_sched_list'. */ /* Exercise 4.8: Your code here. (7/8) */ e-\u003eenv_status = ENV_RUNNABLE; TAILQ_INSERT_TAIL(\u0026env_sched_list,e,env_sched_link); /* Step 6: If 'srcva' is not zero, map the page at 'srcva' in 'curenv' to 'e-\u003eenv_ipc_dstva' * in 'e'. */ /* Return -E_INVAL if 'srcva' is not zero and not mapped in 'curenv'. */ if (srcva != 0) { /* Exercise 4.8: Your code here. (8/8) */ p = page_lookup(curenv-\u003eenv_pgdir,srcva,NULL); if (!p) { return -E_INVAL; } try(page_insert(e-\u003eenv_pgdir,e-\u003eenv_asid,p,e-\u003eenv_ipc_dstva,perm)); } return 0; } 当前进程向envid进程发送消息\n由于发送消息并不一定要给自己的子进程，所以这里是唯一使用envid2env时checkperm=0的情况 检查目标进程是否可以接收消息(env_ipc_recving)\n清除接收进程的接收状态，将相应数据填入进程控制块\n传递物理页面的映射关系\n找到srcva在当前进程中对应的物理页面pp(每一个进程一个页表) 如果srcva在当前进程地址空间中存在映射，则将该页面插入到接受进程对应虚拟地址dstva处 修改接收进程的运行状态为RUNNABLE,插入调度队列重新调度\nsrc为0，只传value，不传物理页面，只有当src不为0，才建立两个进程的页面映射关系，将发送进程srvac处的页面映射到接收进程dstva处\n从图中可以看出IPC机制中的信息发送和接收都是通过系统调用实现，从用户态代码向内核态代码进行传递(syscall_*-\u003esys_*) 3.进程创建fork lab3中实现了内核通过env_create创建一个进程，实现fork机制可以使一个进程创建一个进程（父进程和子进程）\n3.1 fork机制 ​\t在操作系统中，一个进程调用fork()函数后，将从此分叉成为两个进程运行，其中新产生的进程称为原进程的子进程，原进程称为父进程。\n​\t在子进程中，fork()调用的返回值为0，父进程中，fork()调用的返回值是子进程的envid\n​\t对于操作系统，子进程开始运行时的大部分上下文状态与原进程相同，包括程序和fork前的现场，相比独立的两个进程，父子进程间的通信要方便得多，子进程能够读取原属于父进程的部分数据，父进程可以通过fork返回的子进程id调用其他系统接口控制子进程行为。\nfork之前只有父进程 fork之后父进程和子进程同时开始执行fork之后的代码段 fork在不同进程中的返回值不同 父进程和子进程很多信息相同但进程控制块不同 3.2 写时复制机制COW ​\t在调用了fork后，子进程会继承父进程地址空间中的代码段和数据段等内容，但是子进程和父进程为相互独立的两个进程，两个进程对于其内存的修改应该是互不影响的。\n​\t如果在fork时将父进程地址空间中的内容全部复制到新的物理页，将会消耗大量的物理内存。在这些物理内存中，如代码段部分，父子进程通常不会其进行写入，对于这样的只读页面我们希望避免对其进行复制，节省物理内存。\n​\t引入写时复制机制(Copy-On-Write)，在fork时，将地址空间中所有可写页标记为写时复制页，使得在父进程或子进程对写时复制页面进行写入时，能够产生一种异常，操作系统在处理异常时，为当前试图写入的虚拟地址分配新的物理页面，并复制原页面的内容，最后返回用户程序。\n​\t借助硬件异常来实现写时复制机制，在MIPS中，当程序尝试写入的虚拟页对应的TLB表项没有PTE_D标记时，会触发TLB_Mod异常，陷入内核态。我们可以将写时复制页面的PTE_D位设为0，当进程尝试写这个页面时，会触发TLB Mod异常，此时，就可在异常处理函数中，将虚拟页映射到一个新的物理页，然后将旧的物理页的内容复制到新的物理页，然后再对这个虚拟页进行修改。\n​\t引入TLB中新的的软件标记位PTE_COW(即写时复制页面标记为PTE_D=0 \u0026 PTE_COW =1)，当触发TLB Mod时，若PTE_COW为1，则进行复制处理。在进行fork时，需要将所有可以写入的内存页面设置PTE_D = 0 \u0026 PTE_COW = 1。\n3.3 fork返回值 fork是一个用户态函数\n​\tfork函数需要若干个原子的系统调用来完成所期望的功能，其中由syscall_exofork实现新进程的创建，在fork的实现中，我们通过判断syscall_exofork的返回值来决定fork返回值以及后续动作。\n在返回用户态时，父子进程经历了相同的恢复运行现场的过程 父进程从系统调用中返回时恢复现场 子进程在进程被调度时恢复现场 在现场恢复后，父子进程都会从内核返回到msyscall 函数中，而它们的现场中存储的返回值（即$v0寄存器的值）是不同的，这一返回值随后返回到syscall_exofork和fork函数，使得fork函数也可以区别两者。 Exercise 4.9 sys_exofork\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 int sys_exofork(void) { struct Env *e; /* Step 1: Allocate a new env using 'env_alloc'. */ /* Exercise 4.9: Your code here. (1/4) */ try(env_alloc(\u0026e,curenv-\u003eenv_id)); /* Step 2: Copy the current Trapframe below 'KSTACKTOP' to the new env's 'env_tf'. */ /* Exercise 4.9: Your code here. (2/4) */ e-\u003eenv_tf = *((struct Trapframe*)KSTACKTOP - 1); /* Step 3: Set the new env's 'env_tf.regs[2]' to 0 to indicate the return value in child. */ /* Exercise 4.9: Your code here. (3/4) */ e-\u003eenv_tf.regs[2] = 0; /* Step 4: Set up the new env's 'env_status' and 'env_pri'. */ /* Exercise 4.9: Your code here. (4/4) */ e-\u003eenv_status = ENV_NOT_RUNNABLE; e-\u003eenv_pri = curenv-\u003eenv_pri; return e-\u003eenv_id; } 创建一个新进程(分配一个新的进程控制块) 复制一份当前进程的运行现场trapframe到子进程的进程控制块 系统调用在内核态返回的envid只传递给父进程，对于子进程，则需要将其现场中的v0寄存器(返回值寄存器)修改为0作为子进程的返回值 初始化其他字段 3.4 地址空间的准备 ​\t用户程序在运行时入口会将一个用户空间中的指针变量struct Env* env指向当前进程的控制块。对于fork的子进程，它具有与父进程不同的进程控制块，因此在子进程第一次被调度的时候(此时还是在fork函数中)需要对env指针进行更新，使其仍指向当前进程的控制块。\n通过一个系统调用取得自己的envid 根据获得的envid，计算对应的进程控制块下标，将对应进程控制块赋给env ​\t父进程需要将地址空间中与子进程共享的页面映射给子进程，这需要遍历父进程的大部分用户空间页，使用duppage函数完成。\nExercise 4.10 duppage\n将虚拟页号为vpn的虚拟页映射到子进程(可以快速地用0作为id获取当前进程、父进程)\nHint：对于不同权限位的页使用不同方式进行处理，源进程到目标进程复制:syscall_mem_map\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 static void duppage(u_int envid, u_int vpn) { int r; u_int addr; u_int perm; /* Step 1: Get the permission of the page. */ /* Hint: Use 'vpt' to find the page table entry. */ /* Exercise 4.10: Your code here. (1/2) */ perm = vpt[vpn] \u0026 0xfff; //virtual page table[virtual page number] /* Step 2: If the page is writable, and not shared with children, and not marked as COW yet, * then map it as copy-on-write, both in the parent (0) and the child (envid). */ /* Hint: The page should be first mapped to the child before remapped in the parent. (Why?) */ /* Exercise 4.10: Your code here. (2/2) */ addr = vpn * PAGE_SIZE; if (!(perm \u0026 PTE_D) || (perm \u0026 PTE_LIBRARY)) { //实际上包含了 perm \u0026 PTE_COW的情况 因为若该页面为写时复制权限，说明已经被fork过一次，即PTE_D=0 \u0026 PTE_COW = 1 syscall_mem_map(0,(void*)addr,envid,(void*)addr,perm);//源进程 源地址 新进程 新地址 } else { perm = (perm \u0026 ! PTE_D) | PTE_COW; syscall_mem_map(0,(void*)addr,envid,(void*)addr,perm); // first mapped to the child syscall_mem_map(0,(void*)addr,0,(void*)addr,perm); } } vpn对应的页表项：vpt[vpn]，权限位：低12位 修改权限: \u0026 + | 关于内存映射时先映射子进程再映射父进程的原因 如果先给父进程加PTE_COW，然后修改了该页，该页将进行写时复制，父进程指向新的页，而新页没有被加上PTE_COW。此时再map子进程，子进程该页加上PTE_COW位而父进程没有。在随后程序运行中，若父进程进行修改，由于缺失PTE_COW，导致无法进行写时复制，因此子进程的运行出现错误（子进程该页本来不该被改，但却由于父进程被改而一起改了） 3.5 页写入异常 ​\t当用户程序写入在TLB中标记为**不可写入(无TLB_D标记)**的页面时，会发生TLB Mod异常。发生TLB Mod异常后，会跳转到异常向量组中的handle_mod函数，之后跳转到kern/tlbex.c中的do_tlb_mod函数中，这个函数正是处理页写入异常的内核函数，对于COW页面，我们只需要取消其PTE_D标记即可在他们被写入时触发do_tlb_mod中的处理逻辑。\n​\tMOS中对于页写入异常的处理实现在用户空间中。如果需要在用户态下完成页写入异常的处理，是不能直接使用正常情况下的用户栈的(发生异常的也可能是正常栈的页面(映射USTACKTOP以下))，需要使用异常处理栈来运行处理程序。\n​\t另外，内核还需要知道进程自身的处理函数所在地址，地址存在env_user_tlb_mod_entry中，需要由父进程通过系统调用设置。\nExercise 4.11 do_tlb_mod\ndo_tlb_mod函数负责将当前现场保存到异常处理栈中，并设置a0和EPC寄存器的值，使得从异常恢复后能够以异常处理栈中保存的现场(trapframe)为参数，跳转到env_user_tlb_mod_entry储存的异常处理函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 void do_tlb_mod(struct Trapframe *tf) { struct Trapframe tmp_tf = *tf; if (tf-\u003eregs[29] \u003c USTACKTOP || tf-\u003eregs[29] \u003e= UXSTACKTOP) { // 调整栈指针到异常处理栈 tf-\u003eregs[29] = UXSTACKTOP; } tf-\u003eregs[29] -= sizeof(struct Trapframe); *(struct Trapframe *)tf-\u003eregs[29] = tmp_tf; Pte *pte; page_lookup(cur_pgdir, tf-\u003ecp0_badvaddr, \u0026pte); if (curenv-\u003eenv_user_tlb_mod_entry) { tf-\u003eregs[4] = tf-\u003eregs[29]; tf-\u003eregs[29] -= sizeof(tf-\u003eregs[4]); // Hint: Set 'cp0_epc' in the context 'tf' to 'curenv-\u003eenv_user_tlb_mod_entry'. /* Exercise 4.11: Your code here. */ tf-\u003ecp0_epc = curenv-\u003eenv_user_tlb_mod_entry; } else { panic(\"TLB Mod but no user handler registered\"); } } 首先检查栈指针的位置，如果不在异常处理栈范围内，就调整到异常处理栈的栈顶（异常重入） 保存当前现场 先向下移动栈指针一个trapframe大小 保存当前现场（指针转换） 把当前的trapframe进行复制，进行保存，而后继续使用当前trapframe Exercise 4.12 sys_set_tlb_mod_entry\n注册进程自身的页写入异常处理函数\n1 2 3 4 5 6 7 8 9 10 11 int sys_set_tlb_mod_entry(u_int envid, u_int func) { struct Env *env; /* Step 1: Convert the envid to its corresponding 'struct Env *' using 'envid2env'. */ /* Exercise 4.12: Your code here. (1/2) */ try(envid2env(envid,\u0026env,1)); /* Step 2: Set its 'env_user_tlb_mod_entry' to 'func'. */ /* Exercise 4.12: Your code here. (2/2) */ env-\u003eenv_user_tlb_mod_entry = func; return 0; } ​\t页写入异常处理时会返回到用户空间的cow_entry函数\nExercise 4.13 cow_entry\n处理写时复制异常的异常处理函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 static void __attribute__((noreturn)) cow_entry(struct Trapframe *tf) { u_int va = tf-\u003ecp0_badvaddr; // 发生异常的地址 u_int perm; /* Step 1: Find the 'perm' in which the faulting address 'va' is mapped. */ /* Hint: Use 'vpt' and 'VPN' to find the page table entry. If the 'perm' doesn't have * 'PTE_COW', launch a 'user_panic'. */ /* Exercise 4.13: Your code here. (1/6) */ perm = vpt[VPN(va)] \u0026 0xfff; if (!(perm \u0026 PTE_COW)) { // 检查权限位 ：检查是不是COW页 user_panic(\"The permission of the page of va 0x%x doesn't has PTE_COW!\",va); } /* Step 2: Remove 'PTE_COW' from the 'perm', and add 'PTE_D' to it. */ /* Exercise 4.13: Your code here. (2/6) */ perm = (perm \u0026 !PTE_COW) | PTE_D; /* Step 3: Allocate a new page at 'UCOW'. */ /* Exercise 4.13: Your code here. (3/6) */ syscall_mem_alloc(0,(void*)UCOW,PTE_D); /* Step 4: Copy the content of the faulting page at 'va' to 'UCOW'. */ /* Hint: 'va' may not be aligned to a page! */ /* Exercise 4.13: Your code here. (4/6) */ va = ROUNDDOWN(va,PAGE_SIZE); memcpy((void*)UCOW,(const void*)va,PAGE_SIZE); // Step 5: Map the page at 'UCOW' to 'va' with the new 'perm'. /* Exercise 4.13: Your code here. (5/6) */ syscall_mem_map(0,(void*)UCOW,0,(void*)va,perm); // Step 6: Unmap the page at 'UCOW'. /* Exercise 4.13: Your code here. (6/6) */ syscall_mem_unmap(0,(void*)UCOW); // Step 7: Return to the faulting routine. int r = syscall_set_trapframe(0, tf); user_panic(\"syscall_set_trapframe returned %d\", r); } 从内核态中do_tlb_mod函数返回时，传递的第一个参数（保存在a0(4号)寄存器中）\n1 2 3 4 // do_tlb_mod tf-\u003eregs[29] -= sizeof(struct Trapframe); *(struct Trapframe *)tf-\u003eregs[29] = tmp_tf; tf-\u003eregs[4] = tf-\u003eregs[29]; sp寄存器的位置实际上保存了一个trapframe a0号寄存器中保存了一个trapframe 用户态处理COW异常函数cow_entry接收到第一个参数为这个trapframe 传递的trapframe中badvaddr域即为发生COW异常的虚拟地址，可以通过这个地址得到相应的页面并检查权限位\n在UCOW地址处分配一个新的可写页(PTE_D)，等待复制，注意权限位可写PTE_D ROUNDDOWN(va)实际上是对地址的低12位清0，或者说得到了所在页的首地址\n1 2 va = ROUNDDOWN(va,PAGE_SIZE); memcpy((void*)UCOW,(const void*)va,PAGE_SIZE); 将发生错误的页复制到UCOW新页 将虚拟地址映射到UCOW新页，当前进程解除映射\n1 2 syscall_mem_map(0,(void*)UCOW,0,(void*)va,perm); syscall_mem_unmap(0,(void*)UCOW); 当前进程的trapframe设为tf\n1 int r = syscall_set_trapframe(0, tf); Exercise 4.14 sys_set_env_status\n父进程将子进程的状态设置为status\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 int sys_set_env_status(u_int envid, u_int status) { struct Env *env; /* Step 1: Check if 'status' is valid. */ /* Exercise 4.14: Your code here. (1/3) */ if (status != ENV_RUNNABLE \u0026\u0026 status != ENV_NOT_RUNNABLE) { return -E_INVAL; } /* Step 2: Convert the envid to its corresponding 'struct Env *' using 'envid2env'. */ /* Exercise 4.14: Your code here. (2/3) */ try(envid2env(envid,\u0026env,1)); /* Step 3: Update 'env_sched_list' if the 'env_status' of 'env' is being changed. */ /* Exercise 4.14: Your code here. (3/3) */ if (env-\u003eenv_status != status) { if (status == ENV_RUNNABLE) { //加入调度队列 TAILQ_INSERT_TAIL(\u0026env_sched_list,env,env_sched_link); } else { // 从调度队列取出 TAILQ_REMOVE(\u0026env_sched_list,env,env_sched_link); } } /* Step 4: Set the 'env_status' of 'env'. */ env-\u003eenv_status = status; return 0; } Exercise 4.15 fork : final!\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 int fork(void) { u_int child; u_int i; /* Step 1: Set our TLB Mod user exception entry to 'cow_entry' if not done yet. */ if (env-\u003eenv_user_tlb_mod_entry != (u_int)cow_entry) { try(syscall_set_tlb_mod_entry(0, cow_entry)); } /* Step 2: Create a child env that's not ready to be scheduled. */ // Hint: 'env' should always point to the current env itself, so we should fix it to the // correct value. child = syscall_exofork(); if (child == 0) { env = envs + ENVX(syscall_getenvid()); return 0; // 子进程在此返回 } /* Step 3: Map all mapped pages below 'USTACKTOP' into the child's address space. */ // Hint: You should use 'duppage'. /* Exercise 4.15: Your code here. (1/2) */ for (i = 0;i \u003c PDX(ROUND(USTACKTOP,PDMAP));i++) { if (vpd[i] \u0026 PTE_V) { for (u_int j = 0;j \u003c 1024;j++) { u_int vpn = (i \u003c\u003c 10) | j; if ((vpn \u003c VPN(USTACKTOP) \u0026\u0026 (vpt[vpn] \u0026 PTE_V))) { duppage(child,vpn); } } } } /* Step 4: Set up the child's tlb mod handler and set child's 'env_status' to * 'ENV_RUNNABLE'. */ /* Hint: * You may use 'syscall_set_tlb_mod_entry' and 'syscall_set_env_status' * Child's TLB Mod user exception entry should handle COW, so set it to 'cow_entry' */ /* Exercise 4.15: Your code here. (2/2) */ syscall_set_tlb_mod_entry(child,cow_entry); syscall_set_env_status(child,ENV_RUNNABLE); return child; } 首先设置好处理COW异常的异常处理函数\n1 e-env_user_tlb_mod_entry = cow_entry 创建新进程，这里通过syscall_exofork实现\nchild = syscall_exofork(); 即从这一行往后会有两个进程执行以下代码段\n父进程的返回值在syscall_exofork中显示地指出来，为子进程的envid\n子进程由于处于NOT_RUNNABLE状态，他的返回值被保存到trapframe中的返回值寄存器v0(2号)中，等到被调度时（父进程把他设置为RUNNABLE后），返回0，进入下方判断返回\n1 2 3 4 if (child == 0) { env = envs + ENVX(syscall_getenvid()); return 0; // 子进程在此返回 } 最重要的一步就是遍历USTACKTOP以下的页面并从父进程地址空间映射到子进程地址空间，下面进行仔细分析\n1 2 3 4 5 6 7 8 9 10 for (i = 0;i \u003c PDX(ROUND(USTACKTOP,PDMAP));i++) { if (vpd[i] \u0026 PTE_V) { for (u_int j = 0;j \u003c 1024;j++) { u_int vpn = (i \u003c\u003c 10) | j; if ((vpn \u003c VPN(USTACKTOP) \u0026\u0026 (vpt[vpn] \u0026 PTE_V))) { duppage(child,vpn); } } } } 已知只需要对USTACKTOP以下的地址空间进行映射，已经有页映射工具duppage，duppage函数会区分页权限进行操作\n宏PDMAP一个页目录项映射到的地址空间大小(4MB)\n宏ROUND相当于向上取整，\n1 ROUND(USTACKTOP,PDMAP) 即USTACKTOP以下的地址空间至少需要多少个页目录项才能映射完整 宏PDX找到虚拟地址对应的页目录偏移量\n宏vpd是当前进程页目录数组的指针，即为首地址\n然后在每个页目录项对应的二级页表中进行遍历\n1 2 3 4 5 6 for (u_int j = 0;j \u003c 1024;j++) { u_int vpn = (i \u003c\u003c 10) | j; if ((vpn \u003c VPN(USTACKTOP) \u0026\u0026 (vpt[vpn] \u0026 PTE_V))) { duppage(child,vpn); } } 回顾二级页表地址结构PDX(10bits) + PTX(10bits) + OFFSET(12bits) 这里需要对得到的虚拟页号进行检查，因为我们在取页表项时，为了保证所取到的页表项完整的映射了USTACKTOP以下的地址范围，进行了向上取整，有可能最后一个页目录项(4MB)对应的二级页表中有页表项对应的页面超过了USTACKTOP 对于符合地址范围且有效的页面映射到子进程中 设置子进程的异常处理函数，状态，子进程可以被进行调度\n父进程返回子进程的envid\n","wordCount":"3112","inLanguage":"en","datePublished":"2024-05-06T14:17:29+08:00","dateModified":"2024-05-06T14:17:29+08:00","author":{"@type":"Person","name":"sudo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://coder0xe.github.io/posts/os-lab4%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/"},"publisher":{"@type":"Organization","name":"coder0xe's blog","logo":{"@type":"ImageObject","url":"https://coder0xe.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://coder0xe.github.io/ accesskey=h title="coder0xe's blog (Alt + H)">coder0xe's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://coder0xe.github.io/ title=首页><span>首页</span></a></li><li><a href=https://coder0xe.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://coder0xe.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://coder0xe.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://coder0xe.github.io/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://coder0xe.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://coder0xe.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">OS:lab4课下基础</h1><div class=post-description>lab4课下基础</div><div class=post-meta><span title='2024-05-06 14:17:29 +0800 +0800'>May 6, 2024</span>&nbsp;·&nbsp;<span>15 min</span>&nbsp;·&nbsp;<span>sudo</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#oslab4%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80 aria-label=OS:lab4课下基础>OS:lab4课下基础</a><ul><li><a href=#1%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8 aria-label=1.系统调用>1.系统调用</a><ul><li><a href=#11-%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e7%9b%b8%e5%85%b3%e6%a6%82%e5%bf%b5 aria-label="1.1 系统调用相关概念">1.1 系统调用相关概念</a></li><li><a href=#12-%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e6%9c%ba%e5%88%b6%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label="1.2 系统调用机制的实现">1.2 系统调用机制的实现</a></li><li><a href=#13-%e5%9f%ba%e7%a1%80%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e5%87%bd%e6%95%b0 aria-label="1.3 基础系统调用函数">1.3 基础系统调用函数</a><ul><li><a href=#131-sys_mem_alloc aria-label="1.3.1 sys_mem_alloc">1.3.1 sys_mem_alloc</a></li><li><a href=#132-sys_mem_map aria-label="1.3.2 sys_mem_map">1.3.2 sys_mem_map</a></li><li><a href=#133-sys_mem_unmap aria-label="1.3.3 sys_mem_unmap">1.3.3 sys_mem_unmap</a></li><li><a href=#134-sys_yield aria-label="1.3.4 sys_yield">1.3.4 sys_yield</a></li><li><a href=#135-%e6%80%bb%e7%bb%93 aria-label="1.3.5 总结">1.3.5 总结</a></li></ul></li></ul></li><li><a href=#2%e8%bf%9b%e7%a8%8b%e9%97%b4%e9%80%9a%e4%bf%a1ipc aria-label=2.进程间通信IPC>2.进程间通信IPC</a></li><li><a href=#3%e8%bf%9b%e7%a8%8b%e5%88%9b%e5%bb%bafork aria-label=3.进程创建fork>3.进程创建fork</a><ul><li><a href=#31-fork%e6%9c%ba%e5%88%b6 aria-label="3.1 fork机制">3.1 fork机制</a></li><li><a href=#32-%e5%86%99%e6%97%b6%e5%a4%8d%e5%88%b6%e6%9c%ba%e5%88%b6cow aria-label="3.2 写时复制机制COW">3.2 写时复制机制COW</a></li><li><a href=#33-fork%e8%bf%94%e5%9b%9e%e5%80%bc aria-label="3.3 fork返回值">3.3 fork返回值</a></li><li><a href=#34-%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4%e7%9a%84%e5%87%86%e5%a4%87 aria-label="3.4 地址空间的准备">3.4 地址空间的准备</a></li><li><a href=#35-%e9%a1%b5%e5%86%99%e5%85%a5%e5%bc%82%e5%b8%b8 aria-label="3.5 页写入异常">3.5 页写入异常</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h1 id=oslab4课下基础>OS:lab4课下基础<a hidden class=anchor aria-hidden=true href=#oslab4课下基础>#</a></h1><h2 id=1系统调用>1.系统调用<a hidden class=anchor aria-hidden=true href=#1系统调用>#</a></h2><h3 id=11-系统调用相关概念>1.1 系统调用相关概念<a hidden class=anchor aria-hidden=true href=#11-系统调用相关概念>#</a></h3><p>​ 在MIPS中，syscall是用于执行系统调用的自陷指令，它使得进程陷入到内核的异常处理程序中，由内核根据系统调用时的上下文执行相应的内核函数，完成相应的功能，并<strong>最终返回到syscall的后一条指令</strong>。</p><ul><li>存在只能由内核来完成的操作(<strong>读写设备、创建进程、IO</strong>等)</li><li>C标准库中的一些函数的实现依赖于操作系统</li><li>通过执行syscall指令，用户进程可以陷入到内核态，请求内核提供的服务</li><li>通过系统调用陷入到内核态时，<strong>需要在用户态与内核态之间进行数据传递与保护</strong></li></ul><p>​ <strong>系统调用保证了系统的安全性</strong>：内核将自己能够提供的服务以系统调用的方式提供给用户空间，用户程序只能将服务相关的参数交予操作系统执行</p><blockquote><p>API : Application Programming Interface，程序之间的接口</p><p>​ 直接使用系统调用较为麻烦，于是产生了一系列用户空间的API定义，他们在系统的调用的基础上，实现了更多更高级的常用功能。用户在编写程序时可以直接调用高层次的API来实现各种功能。</p><p>​ 通过层级划分使得程序具有更好的可移植性，只要程序以来的API不变，无论底层的系统调用如何变化，都不会影响</p><p><img alt=image-20240507182619458 loading=lazy src=/img/image-20240507182619458.png></p></blockquote><h3 id=12-系统调用机制的实现>1.2 系统调用机制的实现<a hidden class=anchor aria-hidden=true href=#12-系统调用机制的实现>#</a></h3><p>​ 异常分发向量组(<code>exception_handlers</code>)中的8号异常，即为操作系统处理系统调用时的异常。</p><blockquote><p>MOS实验代码中，kern目录下即为内核态代码，user目录下即为用户态代码</p></blockquote><p>​ 以<code>user/lib/debugf.c</code>中的debugf函数来学习处理系统调用的流程(debugf函数是一个debug信息输出函数，进行了<strong>IO方面的系统调用</strong>)</p><p>​ debugf函数的调用链为(系统调用请求从用户态向内核态传递)</p><ul><li><p>debugf调用字符串输出函数debug_output</p></li><li><p>debug_output调用了用户空间的<code>syscall_*</code>函数(这里的<code>*</code>为通配符，代表着用户空间进行系统调用的一组操作，都定义在用户态代码<code>syscall_lab.c</code>中，这里调用的是<code>syscall_print_cons</code>)</p></li><li><p>syscall_<code>*</code>函数调用msyscall函数，系统陷入内核态(msyscall是汇编代码，直接调用syscall)。</p></li><li><p>内核态中将异常分发到handle_sys函数，将系统所需信息传递进内核(输出字符串s)</p></li><li><p>内核取得信息，执行对应的内核空间的系统调用函数<code>sys_*</code>(<code>kern/syscall_all.c</code>)</p></li><li><p>系统调用完成，返回值传递回用户态</p></li><li><p>从系统调用函数返回，回到debugf调用处</p></li></ul><p><img alt=image-20240507184746774 loading=lazy src=/img/image-20240507184746774.png></p><blockquote><p>通过上述描述，对于系统调用的处理实际上是从用户空间向系统空间进行传递的，用户空间中的<code>syscall_*</code>函数与内核中的<code>sys_*</code>是一一对应的，<code>syscall_*</code>函数是用户空间中最接近内核的函数，他调用msyscall中的汇编代码syscall直接陷入内核态，<code>sys_*</code>函数是内核中系统调用的具体实现。</p></blockquote><p>​ 直接调用syscall陷入内核的msyscall函数具有六个参数，<strong>其中第一个参数是与调用名相似的宏，例如SYS_print_cons，被称为系统调用号(include/syscall.h)，用来区分不同的系统调用</strong>，其余还有五个参数，即为系统调用时需要传递给内核的参数。</p><blockquote><p>回忆MIPS函数调用规范中的参数传递，前四个参数保存在寄存器中</p><p><img alt=image-20240507185903124 loading=lazy src=/img/image-20240507185903124.png></p><p><img alt=image-20240507185816739 loading=lazy src=/img/image-20240507185816739.png></p></blockquote><blockquote><p>Exercise 4.1 msyscall</p><p>进行系统调用(syscall)，并返回到msyscall的调用者处(jr)，syscall_*</p></blockquote><pre tabindex=0><code class=language-assembly data-lang=assembly>#include &lt;asm/asm.h&gt;

LEAF(msyscall)
	// Just use &#39;syscall&#39; instruction and return.

	/* Exercise 4.1: Your code here. */
	syscall #陷入内核
	jr ra #返回调用者 syscall_*
END(msyscall)
</code></pre><p>​ 通过汇编指令syscall陷入内核态后，处理器将PC寄存器指向一个内核中固定的异常处理入口(见lab3中不同异常处理跳转到的地址)</p><p><img alt=image-20240507190358757 loading=lazy src=/img/image-20240507190358757.png></p><p>​ 在异常向量表中，系统调用这一异常类型的处理入口为handle_sys函数(kern/genex.S)，实际调用do_syscall(kern/syscall_all.c)函数进行系统调用。</p><p>​ <strong>陷入内核态的操作并不是从一个函数跳转到了另一个函数</strong>，代码使用的栈指针$sp是内核空间中的栈指针。系统从用户态切换到内核态后，<strong>首先需要将原用户进程的运行现场保存到内核空间(SAVE_ALL)</strong>，随后的栈指针则指向保存的Trapframe。<strong>我们正是借助这个保存的结构体来获取用户态中传递过来的值，例如<code>$a0($4)</code>寄存器保存在内核栈的TF_REG4(sp)处</strong>。当内核在handle_开头的函数(处理对应异常的函数)中<strong>调用实际进行异常处理的C函数时，将这个栈指针作为参数传递给这个C函数，用来获取用户态中的参数</strong></p><blockquote><p>Exercise 4.2 do_syscall</p><p>Hint：用户态的运行现场保存在一个Trapframe中，这个trapframe的指针传递给内核态中处理异常的函数用来获取用户态进行系统调用所传递的参数</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>do_syscall</span>(<span style=color:#ff79c6>struct</span> Trapframe <span style=color:#ff79c6>*</span>tf) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> (<span style=color:#ff79c6>*</span>func)(u_int, u_int, u_int, u_int, u_int);
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> sysno <span style=color:#ff79c6>=</span> tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>4</span>]; <span style=color:#6272a4>// 系统调用号 
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (sysno <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> sysno <span style=color:#ff79c6>&gt;=</span> MAX_SYSNO) {
</span></span><span style=display:flex><span>		tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>2</span>] <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span>E_NO_SYS;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Add the EPC in &#39;tf&#39; by a word (size of an instruction). */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.2: Your code here. (1/4) */</span>
</span></span><span style=display:flex><span>	tf<span style=color:#ff79c6>-&gt;</span>cp0_epc <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>4</span>;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Use &#39;sysno&#39; to get &#39;func&#39; from &#39;syscall_table&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.2: Your code here. (2/4) */</span>
</span></span><span style=display:flex><span>	func <span style=color:#ff79c6>=</span> syscall_table[sysno];
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: First 3 args are stored in $a1, $a2, $a3. */</span>
</span></span><span style=display:flex><span>	u_int arg1 <span style=color:#ff79c6>=</span> tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>5</span>];
</span></span><span style=display:flex><span>	u_int arg2 <span style=color:#ff79c6>=</span> tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>6</span>];
</span></span><span style=display:flex><span>	u_int arg3 <span style=color:#ff79c6>=</span> tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>7</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Last 2 args are stored in stack at [$sp + 16 bytes], [$sp + 20 bytes]. */</span>
</span></span><span style=display:flex><span>	u_int arg4, arg5;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.2: Your code here. (3/4) */</span>
</span></span><span style=display:flex><span>	arg4 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>(u_long<span style=color:#ff79c6>*</span>)(tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>16</span>);
</span></span><span style=display:flex><span>	arg5 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>(u_long<span style=color:#ff79c6>*</span>)(tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>20</span>);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 5: Invoke &#39;func&#39; with retrieved arguments and store its return value to $v0 in &#39;tf&#39;.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.2: Your code here. (4/4) */</span>
</span></span><span style=display:flex><span>	tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>2</span>] <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>func</span>(arg1,arg2,arg3,arg4,arg5);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p><code>TIPS</code></p><ul><li><p>tf结构体的结构</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Trapframe {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Saved main processor registers. */</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> regs[<span style=color:#bd93f9>32</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Saved special registers. */</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> cp0_status;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> hi;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> lo;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> cp0_badvaddr;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> cp0_cause;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> cp0_epc;
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>前四个参数保存在a0(4)-a3(7)寄存器中，后两个参数保存在栈帧中</strong></p></li><li><p><strong>sp指针保存在29号通用寄存器中</strong></p></li><li><p>返回值保存在v0(2)寄存器</p></li><li><p>指针转换：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	arg4 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>(u_long<span style=color:#ff79c6>*</span>)(tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>16</span>);
</span></span><span style=display:flex><span>	arg5 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>(u_long<span style=color:#ff79c6>*</span>)(tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>20</span>);
</span></span></code></pre></td></tr></table></div></div><ul><li><code>tf->regs + 16</code>得到一个地址，转换为(u_long*)类型的指针再解引用，取出对应地址的数据</li></ul></li><li><p><strong>依据系统调用号(保存在a0寄存器中)在系统调用表中找到相应的系统调用处理函数</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>syscall_table[MAX_SYSNO] <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    [SYS_putchar] <span style=color:#ff79c6>=</span> sys_putchar,
</span></span><span style=display:flex><span>    [SYS_print_cons] <span style=color:#ff79c6>=</span> sys_print_cons,
</span></span><span style=display:flex><span>    [SYS_getenvid] <span style=color:#ff79c6>=</span> sys_getenvid,
</span></span><span style=display:flex><span>    [SYS_yield] <span style=color:#ff79c6>=</span> sys_yield,
</span></span><span style=display:flex><span>    [SYS_env_destroy] <span style=color:#ff79c6>=</span> sys_env_destroy,
</span></span><span style=display:flex><span>    [SYS_set_tlb_mod_entry] <span style=color:#ff79c6>=</span> sys_set_tlb_mod_entry,
</span></span><span style=display:flex><span>    [SYS_mem_alloc] <span style=color:#ff79c6>=</span> sys_mem_alloc,
</span></span><span style=display:flex><span>    [SYS_mem_map] <span style=color:#ff79c6>=</span> sys_mem_map,
</span></span><span style=display:flex><span>    [SYS_mem_unmap] <span style=color:#ff79c6>=</span> sys_mem_unmap,
</span></span><span style=display:flex><span>    [SYS_exofork] <span style=color:#ff79c6>=</span> sys_exofork,
</span></span><span style=display:flex><span>    [SYS_set_env_status] <span style=color:#ff79c6>=</span> sys_set_env_status,
</span></span><span style=display:flex><span>    [SYS_set_trapframe] <span style=color:#ff79c6>=</span> sys_set_trapframe,
</span></span><span style=display:flex><span>    [SYS_panic] <span style=color:#ff79c6>=</span> sys_panic,
</span></span><span style=display:flex><span>    [SYS_ipc_try_send] <span style=color:#ff79c6>=</span> sys_ipc_try_send,
</span></span><span style=display:flex><span>    [SYS_ipc_recv] <span style=color:#ff79c6>=</span> sys_ipc_recv,
</span></span><span style=display:flex><span>    [SYS_cgetc] <span style=color:#ff79c6>=</span> sys_cgetc,
</span></span><span style=display:flex><span>    [SYS_write_dev] <span style=color:#ff79c6>=</span> sys_write_dev,
</span></span><span style=display:flex><span>    [SYS_read_dev] <span style=color:#ff79c6>=</span> sys_read_dev,
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h3 id=13-基础系统调用函数>1.3 基础系统调用函数<a hidden class=anchor aria-hidden=true href=#13-基础系统调用函数>#</a></h3><p>​ 在<code>kern/syscall_all.c</code>中定义了一系列基础系统调用，<strong>后续的IPC与fork机制以这些系统调用作为支撑</strong></p><h4 id=131-sys_mem_alloc>1.3.1 sys_mem_alloc<a hidden class=anchor aria-hidden=true href=#131-sys_mem_alloc>#</a></h4><p>​ <code>sys_mem_alloc</code>的主要功能是分配内存，用户程序可以通过这个系统调用给该程序所允许的虚拟内存空间<strong>显式地</strong>分配实际的物理内存，或者说我们编写的程序在内存中申请了一片空间。<strong>对操作系统来说，是一个进程请求将其运行空间中的某段地址与实际物理内存进行映射，从而可以通过该虚拟页面来对物理内存进行存取访问</strong>。</p><ul><li><strong>内核通过传入的进程标识符envid来确定发出请求的进程</strong></li></ul><blockquote><p>Exercise 4.3 envid2env</p><p>通过一个进程的envid获取该进程控制块</p><p>Hint：使用宏ENVX()</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>envid2env</span>(u_int envid, <span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>**</span>penv, <span style=color:#8be9fd>int</span> checkperm) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>e;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Assign value to &#39;e&#39; using &#39;envid&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hint:
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *   If envid is zero, set &#39;penv&#39; to &#39;curenv&#39; and return 0.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *   You may want to use &#39;ENVX&#39;.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.3: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (envid <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>penv <span style=color:#ff79c6>=</span> curenv;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	e <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>envs[<span style=color:#50fa7b>ENVX</span>(envid)];
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (e<span style=color:#ff79c6>-&gt;</span>env_status <span style=color:#ff79c6>==</span> ENV_FREE <span style=color:#ff79c6>||</span> e<span style=color:#ff79c6>-&gt;</span>env_id <span style=color:#ff79c6>!=</span> envid) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_BAD_ENV;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Check when &#39;checkperm&#39; is non-zero. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hints:
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *   Check whether the calling env has sufficient permissions to manipulate the
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *   specified env, 
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *   i.e. &#39;e&#39; is either &#39;curenv&#39; or its immediate child. i.e.means in other words
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *   If violated, return &#39;-E_BAD_ENV&#39;.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.3: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (checkperm <span style=color:#ff79c6>&amp;&amp;</span> (e<span style=color:#ff79c6>-&gt;</span>env_id <span style=color:#ff79c6>!=</span> curenv<span style=color:#ff79c6>-&gt;</span>env_id) <span style=color:#ff79c6>&amp;&amp;</span> (e<span style=color:#ff79c6>-&gt;</span>env_parent_id <span style=color:#ff79c6>!=</span> curenv<span style=color:#ff79c6>-&gt;</span>env_id)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_BAD_ENV;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Assign &#39;e&#39; to &#39;*penv&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>*</span>penv <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>当envid==0，说明是在fork的情景下调用envid2env，父进程fork的返回值为0，则进程即为当前进程或者说父进程</li><li><code>ENVX</code>是根据进程id获取其在进程数组envs中偏移量的宏</li><li>关于checkperm检查权限位<ul><li>当有效时，检查获取的进程控制块是否为当前进程或是当前进程的子进程(fork)，<strong>限制两个进程之间的关系为父子进程时需要检查</strong></li></ul></li></ul><blockquote><p>Exercise 4.4 sys_mem_alloc</p><p>进程请求将其运行空间中的某段地址与实际物理内存进行映射</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_mem_alloc</span>(u_int envid, u_int va, u_int perm) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>env;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Page <span style=color:#ff79c6>*</span>pp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Check if &#39;va&#39; is a legal user virtual address using &#39;is_illegal_va&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.4: Your code here. (1/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>is_illegal_va</span>(va)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Convert the envid to its corresponding &#39;struct Env *&#39; using &#39;envid2env&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hint: **Always** validate the permission in syscalls! */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.4: Your code here. (2/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>envid2env</span>(envid,<span style=color:#ff79c6>&amp;</span>env,<span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Allocate a physical page using &#39;page_alloc&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.4: Your code here. (3/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>page_alloc</span>(<span style=color:#ff79c6>&amp;</span>pp));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Map the allocated page at &#39;va&#39; with permission &#39;perm&#39; using &#39;page_insert&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>page_insert</span>(env<span style=color:#ff79c6>-&gt;</span>env_pgdir, env<span style=color:#ff79c6>-&gt;</span>env_asid, pp, va, perm);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>检查进程提供的虚拟地址是否合法<code>is_illegal_va</code></li><li>将进程id转换为进程控制块<code>envid2env</code>，这里需要设置checkperm为1，检查取到的进程控制块是否为当前进程的进程控制块</li><li>分配物理内存<code>page_alloc</code></li><li>建立虚拟地址与物理地址之间的映射<code>page_insert</code></li></ul><h4 id=132-sys_mem_map>1.3.2 sys_mem_map<a hidden class=anchor aria-hidden=true href=#132-sys_mem_map>#</a></h4><p>​ <strong>将源进程地址空间中的相应内存映射到目标进程的相应虚拟内存中去，或者说此时两个进程共享同一页物理内存</strong></p><blockquote><p>Exercise 4.5 sys_mem_map</p><p>Hint：srcenv->dstenv</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_mem_map</span>(u_int srcid, u_int srcva, u_int dstid, u_int dstva, u_int perm) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>srcenv;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>dstenv;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Page <span style=color:#ff79c6>*</span>pp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Check if &#39;srcva&#39; and &#39;dstva&#39; are legal user virtual addresses using
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 * &#39;is_illegal_va&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.5: Your code here. (1/4) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>is_illegal_va</span>(srcva) <span style=color:#ff79c6>||</span> <span style=color:#50fa7b>is_illegal_va</span>(dstva)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Convert the &#39;srcid&#39; to its corresponding &#39;struct Env *&#39; using &#39;envid2env&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.5: Your code here. (2/4) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>envid2env</span>(srcid,<span style=color:#ff79c6>&amp;</span>srcenv,<span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Convert the &#39;dstid&#39; to its corresponding &#39;struct Env *&#39; using &#39;envid2env&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.5: Your code here. (3/4) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>envid2env</span>(dstid,<span style=color:#ff79c6>&amp;</span>dstenv,<span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Find the physical page mapped at &#39;srcva&#39; in the address space of &#39;srcid&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Return -E_INVAL if &#39;srcva&#39; is not mapped. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.5: Your code here. (4/4) */</span>
</span></span><span style=display:flex><span>	pp <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>page_lookup</span>(srcenv<span style=color:#ff79c6>-&gt;</span>env_pgdir,srcva,<span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>pp) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 5: Map the physical page at &#39;dstva&#39; in the address space of &#39;dstid&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>page_insert</span>(dstenv<span style=color:#ff79c6>-&gt;</span>env_pgdir, dstenv<span style=color:#ff79c6>-&gt;</span>env_asid, pp, dstva, perm);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>检查源进程或目标进程的虚拟地址是否合法<code>is_illegal_va</code></li><li>找到源进程和目标进程的进程控制块<code>envid</code><ul><li>关于checkperm：需要设置，检查是否为当前进程或当前进程的子进程</li></ul></li><li>找到源进程中虚拟地址对应的物理页面的页控制块<code>page_lookup</code></li><li>将该物理页面建立起与目标进程虚拟地址的映射<code>page_insert</code></li></ul><h4 id=133-sys_mem_unmap>1.3.3 sys_mem_unmap<a hidden class=anchor aria-hidden=true href=#133-sys_mem_unmap>#</a></h4><p>​ <strong>解除某个进程地址空间虚拟内存和物理内存之间的映射关系</strong></p><blockquote><p>Exercise 4.6 sys_mem_unmap</p><p>Hint：page_remove</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_mem_unmap</span>(u_int envid, u_int va) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>e;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Check if &#39;va&#39; is a legal user virtual address using &#39;is_illegal_va&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.6: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>is_illegal_va</span>(va)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Convert the envid to its corresponding &#39;struct Env *&#39; using &#39;envid2env&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.6: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>envid2env</span>(envid,<span style=color:#ff79c6>&amp;</span>e,<span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Unmap the physical page at &#39;va&#39; in the address space of &#39;envid&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>page_remove</span>(e<span style=color:#ff79c6>-&gt;</span>env_pgdir, e<span style=color:#ff79c6>-&gt;</span>env_asid, va);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=134-sys_yield>1.3.4 sys_yield<a hidden class=anchor aria-hidden=true href=#134-sys_yield>#</a></h4><p>​ <strong>用户进程放弃CPU，调度其他进程</strong></p><blockquote><p>Exercise 4.7 sys_yield</p><p>Hint：schedule</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>__attribute__</span>((noreturn)) <span style=color:#50fa7b>sys_yield</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Hint: Just use &#39;schedule&#39; with &#39;yield&#39; set.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.7: Your code here. */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>schedule</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=135-总结>1.3.5 总结<a hidden class=anchor aria-hidden=true href=#135-总结>#</a></h4><p>​ <strong>处理系统调用时，并没有切换地址空间，也不需要将进程上下文保存到进程控制块中，只是切换到内核态下执行一些代码，处理系统调用时内核仍然处于当前进程</strong></p><ul><li>sys_mem_alloc：为当前进程中的虚拟地址va分配一块物理内存</li><li>sys_mem_map：将源进程地址空间中的地址映射到目标进程地址空间中的地址，或者说两个进程共享同一个物理页</li><li>sys_mem_unmap：解除进程中虚拟地址va与物理内存之间的映射关系</li><li>sys_yield：当前进程放弃CPU，进行进程调度</li></ul><h2 id=2进程间通信ipc>2.进程间通信IPC<a hidden class=anchor aria-hidden=true href=#2进程间通信ipc>#</a></h2><blockquote><p>IPC : Inter-Process Communication</p></blockquote><p>​ IPC机制的实现使得系统中的进程之间有了相互传递消息的能力。</p><p>​ <strong>所谓通信，最直观的理解就是交换数据</strong>，假如我们能够让一个进程有能力将数据传递给另一个进程，那么进程之间自然具有了相互通信的能力。</p><p>​ <strong>由于进程的地址空间之间是相互独立的，要想传递数据，就要想办法把一个地址空间中的东西传给另一个地址空间</strong></p><p>​ <strong>所有的进程都共享同一个内核空间(kseg0)，故要想在不同进程的地址空间之间交换数据，就可以通过内核空间来实现！</strong></p><p>​ 发送方进程可以将<strong>数据</strong>以系统调用的形式<strong>存放在进程控制块中</strong>，接收方进程同样以系统调用的方式在进程控制块中找到对应的数据，读取并返回</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Env {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Lab 4 IPC
</span></span></span><span style=display:flex><span>	u_int env_ipc_value;   <span style=color:#6272a4>// the value sent to us
</span></span></span><span style=display:flex><span>	u_int env_ipc_from;    <span style=color:#6272a4>// envid of the sender
</span></span></span><span style=display:flex><span>	u_int env_ipc_recving; <span style=color:#6272a4>// whether this env is blocked receiving
</span></span></span><span style=display:flex><span>	u_int env_ipc_dstva;   <span style=color:#6272a4>// va at which the received page should be mapped 
</span></span></span><span style=display:flex><span>	u_int env_ipc_perm;    <span style=color:#6272a4>// perm in which the received page should be mapped
</span></span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><ul><li><code>env_ipc_dstva</code>接受到的页面需要与自身的哪个虚拟页面完成映射</li><li><code>env_ipc_perm</code>传递的页面的权限位设置</li></ul><blockquote><p>Exercise 4.8 sys_ipc_recv</p><p>用于接收消息dst</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_ipc_recv</span>(u_int dstva) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Check if &#39;dstva&#39; is either zero or a legal address. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (dstva <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>is_illegal_va</span>(dstva)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Set &#39;curenv-&gt;env_ipc_recving&#39; to 1. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.8: Your code here. (1/8) */</span>
</span></span><span style=display:flex><span>	curenv<span style=color:#ff79c6>-&gt;</span>env_ipc_recving <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Set the value of &#39;curenv-&gt;env_ipc_dstva&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.8: Your code here. (2/8) */</span>
</span></span><span style=display:flex><span>	curenv<span style=color:#ff79c6>-&gt;</span>env_ipc_dstva <span style=color:#ff79c6>=</span> dstva;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Set the status of &#39;curenv&#39; to &#39;ENV_NOT_RUNNABLE&#39; and remove it from
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 * &#39;env_sched_list&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.8: Your code here. (3/8) */</span>
</span></span><span style=display:flex><span>	curenv<span style=color:#ff79c6>-&gt;</span>env_status <span style=color:#ff79c6>=</span> ENV_NOT_RUNNABLE;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>TAILQ_REMOVE</span>(<span style=color:#ff79c6>&amp;</span>env_sched_list,curenv,env_sched_link);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 5: Give up the CPU and block until a message is received. */</span>
</span></span><span style=display:flex><span>	((<span style=color:#ff79c6>struct</span> Trapframe <span style=color:#ff79c6>*</span>)KSTACKTOP <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>)<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>2</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>schedule</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><code>env_ipc_recving = 1</code>允许接收消息</li><li><code>env_ipc_dstva = dstva</code>：自己要将接受到的页面与dstva进行映射（映射过程在sys_ipc_send中实现，从srcva映射到dstva，故需要先设置好sys_ipc_recving然后再sys_ipc_send）</li><li>当前进程挂起，从调度队列中移除，放弃CPU进行进程调度，等待消息到来</li></ul><blockquote><p>Exercise 4.7 sys_ipc_try_send</p><p>用于发送消息src</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_ipc_try_send</span>(u_int envid, u_int value, u_int srcva, u_int perm) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>e;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Page <span style=color:#ff79c6>*</span>p;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Check if &#39;srcva&#39; is either zero or a legal address. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.8: Your code here. (4/8) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (srcva <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>is_illegal_va</span>(srcva)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Convert &#39;envid&#39; to &#39;struct Env *e&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* This is the only syscall where the &#39;envid2env&#39; should be used with &#39;checkperm&#39; UNSET,
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 * because the target env is not restricted to &#39;curenv&#39;&#39;s children. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.8: Your code here. (5/8) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>envid2env</span>(envid,<span style=color:#ff79c6>&amp;</span>e,<span style=color:#bd93f9>0</span>));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Check if the target is waiting for a message. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.8: Your code here. (6/8) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (e<span style=color:#ff79c6>-&gt;</span>env_ipc_recving <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_IPC_NOT_RECV;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Set the target&#39;s ipc fields. */</span>
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_ipc_value <span style=color:#ff79c6>=</span> value;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_ipc_from <span style=color:#ff79c6>=</span> curenv<span style=color:#ff79c6>-&gt;</span>env_id;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_ipc_perm <span style=color:#ff79c6>=</span> PTE_V <span style=color:#ff79c6>|</span> perm;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_ipc_recving <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 5: Set the target&#39;s status to &#39;ENV_RUNNABLE&#39; again and insert it to the tail of
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 * &#39;env_sched_list&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.8: Your code here. (7/8) */</span>
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_status <span style=color:#ff79c6>=</span> ENV_RUNNABLE;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>TAILQ_INSERT_TAIL</span>(<span style=color:#ff79c6>&amp;</span>env_sched_list,e,env_sched_link);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 6: If &#39;srcva&#39; is not zero, map the page at &#39;srcva&#39; in &#39;curenv&#39; to &#39;e-&gt;env_ipc_dstva&#39;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 * in &#39;e&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Return -E_INVAL if &#39;srcva&#39; is not zero and not mapped in &#39;curenv&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (srcva <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 4.8: Your code here. (8/8) */</span>
</span></span><span style=display:flex><span>		p <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>page_lookup</span>(curenv<span style=color:#ff79c6>-&gt;</span>env_pgdir,srcva,<span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>p) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>page_insert</span>(e<span style=color:#ff79c6>-&gt;</span>env_pgdir,e<span style=color:#ff79c6>-&gt;</span>env_asid,p,e<span style=color:#ff79c6>-&gt;</span>env_ipc_dstva,perm));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>当前进程向envid进程发送消息</p><ul><li>由于发送消息并不一定要给自己的子进程，所以<strong>这里是唯一使用envid2env时checkperm=0的情况</strong></li></ul></li><li><p>检查目标进程是否可以接收消息(env_ipc_recving)</p></li><li><p>清除接收进程的接收状态，将相应数据填入进程控制块</p></li><li><p>传递物理页面的映射关系</p><ul><li>找到srcva在当前进程中对应的物理页面pp(每一个进程一个页表)</li><li>如果srcva在当前进程地址空间中存在映射，则将该页面插入到接受进程对应虚拟地址dstva处</li></ul></li><li><p>修改接收进程的运行状态为RUNNABLE,插入调度队列重新调度</p></li></ul><blockquote><p>src为0，只传value，不传物理页面，只有当src不为0，才建立两个进程的页面映射关系，将发送进程srvac处的页面映射到接收进程dstva处</p></blockquote><p><img alt=image-20240507205239970 loading=lazy src=/img/image-20240507205239970.png></p><ul><li>从图中可以看出<strong>IPC机制中的信息发送和接收都是通过系统调用实现</strong>，从用户态代码向内核态代码进行传递(<code>syscall_*->sys_*</code>)</li></ul><h2 id=3进程创建fork>3.进程创建fork<a hidden class=anchor aria-hidden=true href=#3进程创建fork>#</a></h2><blockquote><p>lab3中实现了内核通过env_create创建一个进程，实现fork机制可以使一个进程创建一个进程（父进程和子进程）</p></blockquote><h3 id=31-fork机制>3.1 fork机制<a hidden class=anchor aria-hidden=true href=#31-fork机制>#</a></h3><p>​ 在操作系统中，一个进程调用<code>fork()</code>函数后，将从此分叉成为两个进程运行，其中新产生的进程称为原进程的<strong>子进程</strong>，原进程称为<strong>父进程</strong>。</p><p>​ <strong>在子进程中，fork()调用的返回值为0，父进程中，fork()调用的返回值是子进程的envid</strong></p><p>​ 对于操作系统，子进程开始运行时的大部分上下文状态与原进程相同，包括程序和fork前的现场，相比独立的两个进程，父子进程间的通信要方便得多，子进程能够读取原属于父进程的部分数据，父进程可以通过fork返回的子进程id调用其他系统接口控制子进程行为。</p><ul><li>fork之前只有父进程</li><li>fork之后父进程和子进程同时开始执行fork之后的代码段</li><li>fork在不同进程中的返回值不同</li><li>父进程和子进程很多信息相同但进程控制块不同</li></ul><h3 id=32-写时复制机制cow>3.2 写时复制机制COW<a hidden class=anchor aria-hidden=true href=#32-写时复制机制cow>#</a></h3><p>​ 在调用了fork后，子进程会继承父进程地址空间中的代码段和数据段等内容，但是子进程和父进程为相互独立的两个进程，两个进程对于其内存的修改应该是互不影响的。</p><p>​ 如果在fork时将父进程地址空间中的内容全部复制到新的物理页，将会消耗大量的物理内存。<strong>在这些物理内存中，如代码段部分，父子进程通常不会其进行写入，对于这样的只读页面我们希望避免对其进行复制，节省物理内存。</strong></p><p>​ 引入写时复制机制(<code>Copy-On-Write</code>)，<strong>在fork时，将地址空间中所有可写页标记为写时复制页，使得在父进程或子进程对写时复制页面进行写入时，能够产生一种异常，操作系统在处理异常时，为当前试图写入的虚拟地址分配新的物理页面，并复制原页面的内容，最后返回用户程序。</strong></p><p>​ 借助硬件异常来实现写时复制机制，在MIPS中，当程序尝试写入的虚拟页对应的TLB表项没有PTE_D标记时，会触发TLB_Mod异常，陷入内核态。<strong>我们可以将写时复制页面的PTE_D位设为0，当进程尝试写这个页面时，会触发TLB Mod异常</strong>，此时，就可在异常处理函数中，<strong>将虚拟页映射到一个新的物理页，然后将旧的物理页的内容复制到新的物理页，然后再对这个虚拟页进行修改。</strong></p><p>​ 引入TLB中新的的软件标记位<code>PTE_COW</code>(<strong>即写时复制页面标记为<code>PTE_D=0 & PTE_COW =1</code></strong>)，当触发TLB Mod时，若PTE_COW为1，则进行复制处理。<strong>在进行fork时，需要将所有可以写入的内存页面设置PTE_D = 0 & PTE_COW = 1</strong>。</p><h3 id=33-fork返回值>3.3 fork返回值<a hidden class=anchor aria-hidden=true href=#33-fork返回值>#</a></h3><blockquote><p>fork是一个用户态函数</p></blockquote><p>​ fork函数需要若干个原子的系统调用来完成所期望的功能，其中由syscall_exofork实现新进程的创建，在fork的实现中，我们通过判断syscall_exofork的返回值来决定fork返回值以及后续动作。</p><ul><li>在返回用户态时，父子进程经历了相同的恢复运行现场的过程<ul><li>父进程从系统调用中返回时恢复现场</li><li>子进程在进程被调度时恢复现场</li></ul></li><li>在现场恢复后，父子进程都会从内核返回到msyscall 函数中，而它们的现场中存储的返回值（即$v0寄存器的值）是不同的，这一返回值随后返回到syscall_exofork和fork函数，使得fork函数也可以区别两者。</li></ul><blockquote><p>Exercise 4.9 sys_exofork</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_exofork</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>e;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Allocate a new env using &#39;env_alloc&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.9: Your code here. (1/4) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>env_alloc</span>(<span style=color:#ff79c6>&amp;</span>e,curenv<span style=color:#ff79c6>-&gt;</span>env_id));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Copy the current Trapframe below &#39;KSTACKTOP&#39; to the new env&#39;s &#39;env_tf&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.9: Your code here. (2/4) */</span>
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_tf <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>((<span style=color:#ff79c6>struct</span> Trapframe<span style=color:#ff79c6>*</span>)KSTACKTOP <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Set the new env&#39;s &#39;env_tf.regs[2]&#39; to 0 to indicate the return value in child. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.9: Your code here. (3/4) */</span>
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_tf.regs[<span style=color:#bd93f9>2</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Set up the new env&#39;s &#39;env_status&#39; and &#39;env_pri&#39;.  */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.9: Your code here. (4/4) */</span>
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_status <span style=color:#ff79c6>=</span> ENV_NOT_RUNNABLE;
</span></span><span style=display:flex><span>	e<span style=color:#ff79c6>-&gt;</span>env_pri <span style=color:#ff79c6>=</span> curenv<span style=color:#ff79c6>-&gt;</span>env_pri;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> e<span style=color:#ff79c6>-&gt;</span>env_id;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>创建一个新进程(分配一个新的进程控制块)</li><li>复制一份当前进程的运行现场trapframe到子进程的进程控制块</li><li><strong>系统调用在内核态返回的envid只传递给父进程，对于子进程，则需要将其现场中的v0寄存器(返回值寄存器)修改为0作为子进程的返回值</strong></li><li>初始化其他字段</li></ul><h3 id=34-地址空间的准备>3.4 地址空间的准备<a hidden class=anchor aria-hidden=true href=#34-地址空间的准备>#</a></h3><p>​ 用户程序在运行时入口会将一个用户空间中的指针变量<code>struct Env* env</code>指向当前进程的控制块。<strong>对于fork的子进程，它具有与父进程不同的进程控制块，因此在子进程第一次被调度的时候(此时还是在fork函数中)需要对env指针进行更新，使其仍指向当前进程的控制块。</strong></p><ul><li>通过一个系统调用取得自己的envid</li><li>根据获得的envid，计算对应的进程控制块下标，将对应进程控制块赋给env</li></ul><p>​ <strong>父进程需要将地址空间中与子进程共享的页面映射给子进程</strong>，这需要遍历父进程的大部分用户空间页，使用duppage函数完成。</p><blockquote><p>Exercise 4.10 duppage</p><p>将虚拟页号为vpn的虚拟页映射到子进程(可以快速地用0作为id获取当前进程、父进程)</p><p>Hint：对于不同权限位的页使用不同方式进行处理，源进程到目标进程复制:syscall_mem_map</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>duppage</span>(u_int envid, u_int vpn) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> r;
</span></span><span style=display:flex><span>	u_int addr;
</span></span><span style=display:flex><span>	u_int perm;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Get the permission of the page. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hint: Use &#39;vpt&#39; to find the page table entry. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.10: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	perm <span style=color:#ff79c6>=</span> vpt[vpn] <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xfff</span>; <span style=color:#6272a4>//virtual page table[virtual page number]
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: If the page is writable, and not shared with children, and not marked as COW yet,
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 * then map it as copy-on-write, both in the parent (0) and the child (envid). */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hint: The page should be first mapped to the child before remapped in the parent. (Why?)
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.10: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>	addr <span style=color:#ff79c6>=</span> vpn <span style=color:#ff79c6>*</span> PAGE_SIZE;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(perm <span style=color:#ff79c6>&amp;</span> PTE_D) <span style=color:#ff79c6>||</span> (perm <span style=color:#ff79c6>&amp;</span> PTE_LIBRARY)) { <span style=color:#6272a4>//实际上包含了 perm &amp; PTE_COW的情况 因为若该页面为写时复制权限，说明已经被fork过一次，即PTE_D=0 &amp; PTE_COW = 1
</span></span></span><span style=display:flex><span>		<span style=color:#50fa7b>syscall_mem_map</span>(<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)addr,envid,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)addr,perm);<span style=color:#6272a4>//源进程 源地址 新进程 新地址 
</span></span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		perm <span style=color:#ff79c6>=</span> (perm <span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>!</span> PTE_D) <span style=color:#ff79c6>|</span> PTE_COW;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>syscall_mem_map</span>(<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)addr,envid,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)addr,perm); <span style=color:#6272a4>// first mapped to the child
</span></span></span><span style=display:flex><span>		<span style=color:#50fa7b>syscall_mem_map</span>(<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)addr,<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)addr,perm);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>vpn对应的页表项：vpt[vpn]，权限位：低12位</li><li>修改权限: & + |</li><li>关于内存映射时先映射子进程再映射父进程的原因<ul><li>如果先给父进程加PTE_COW，然后修改了该页，该页将进行写时复制，父进程指向新的页，而新页没有被加上PTE_COW。此时再map子进程，子进程该页加上PTE_COW位而父进程没有。在随后程序运行中，若父进程进行修改，由于缺失PTE_COW，导致无法进行写时复制，因此子进程的运行出现错误（子进程该页本来不该被改，但却由于父进程被改而一起改了）</li></ul></li></ul><h3 id=35-页写入异常>3.5 页写入异常<a hidden class=anchor aria-hidden=true href=#35-页写入异常>#</a></h3><p>​ 当用户程序写入在TLB中标记为**不可写入(无TLB_D标记)**的页面时，会发生TLB Mod异常。发生TLB Mod异常后，会跳转到异常向量组中的<code>handle_mod</code>函数，之后跳转到<code>kern/tlbex.c</code>中的<code>do_tlb_mod</code>函数中，这个函数正是处理页写入异常的内核函数，<strong>对于COW页面，我们只需要取消其PTE_D标记即可在他们被写入时触发do_tlb_mod中的处理逻辑。</strong></p><p>​ MOS中对于页写入异常的处理实现在用户空间中。如果需要在用户态下完成页写入异常的处理，<strong>是不能直接使用正常情况下的用户栈的</strong>(发生异常的也可能是正常栈的页面(映射USTACKTOP以下))，需要使用<strong>异常处理栈</strong>来运行处理程序。</p><p><img alt=image-20240508152633198 loading=lazy src=/img/image-20240508152633198.png></p><p>​ 另外，内核还需要知道进程自身的处理函数所在地址，地址存在env_user_tlb_mod_entry中，需要由父进程通过系统调用设置。</p><blockquote><p>Exercise 4.11 do_tlb_mod</p><p>do_tlb_mod函数负责将当前现场保存到异常处理栈中，并设置a0和EPC寄存器的值，使得从异常恢复后能够以异常处理栈中保存的现场(trapframe)为参数，跳转到env_user_tlb_mod_entry储存的异常处理函数</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>do_tlb_mod</span>(<span style=color:#ff79c6>struct</span> Trapframe <span style=color:#ff79c6>*</span>tf) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Trapframe tmp_tf <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>tf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>&lt;</span> USTACKTOP <span style=color:#ff79c6>||</span> tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>&gt;=</span> UXSTACKTOP) { <span style=color:#6272a4>// 调整栈指针到异常处理栈
</span></span></span><span style=display:flex><span>		tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>=</span> UXSTACKTOP;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>-=</span> <span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>struct</span> Trapframe);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>*</span>(<span style=color:#ff79c6>struct</span> Trapframe <span style=color:#ff79c6>*</span>)tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>=</span> tmp_tf;
</span></span><span style=display:flex><span>	Pte <span style=color:#ff79c6>*</span>pte;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>page_lookup</span>(cur_pgdir, tf<span style=color:#ff79c6>-&gt;</span>cp0_badvaddr, <span style=color:#ff79c6>&amp;</span>pte);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (curenv<span style=color:#ff79c6>-&gt;</span>env_user_tlb_mod_entry) {
</span></span><span style=display:flex><span>		tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>4</span>] <span style=color:#ff79c6>=</span> tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>];
</span></span><span style=display:flex><span>		tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>-=</span> <span style=color:#ff79c6>sizeof</span>(tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>4</span>]);
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Hint: Set &#39;cp0_epc&#39; in the context &#39;tf&#39; to &#39;curenv-&gt;env_user_tlb_mod_entry&#39;.
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 4.11: Your code here. */</span>
</span></span><span style=display:flex><span>		tf<span style=color:#ff79c6>-&gt;</span>cp0_epc <span style=color:#ff79c6>=</span> curenv<span style=color:#ff79c6>-&gt;</span>env_user_tlb_mod_entry;
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic</span>(<span style=color:#f1fa8c>&#34;TLB Mod but no user handler registered&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>首先检查栈指针的位置，<strong>如果不在异常处理栈范围内</strong>，就调整到异常处理栈的栈顶（异常重入）</li><li>保存当前现场<ul><li>先向下移动栈指针一个trapframe大小</li><li>保存当前现场（指针转换）</li></ul></li><li>把当前的trapframe进行复制，进行保存，而后继续使用当前trapframe</li></ul><blockquote><p>Exercise 4.12 sys_set_tlb_mod_entry</p><p>注册进程自身的页写入异常处理函数</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_set_tlb_mod_entry</span>(u_int envid, u_int func) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>env;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Convert the envid to its corresponding &#39;struct Env *&#39; using &#39;envid2env&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.12: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>envid2env</span>(envid,<span style=color:#ff79c6>&amp;</span>env,<span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Set its &#39;env_user_tlb_mod_entry&#39; to &#39;func&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.12: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>	env<span style=color:#ff79c6>-&gt;</span>env_user_tlb_mod_entry <span style=color:#ff79c6>=</span> func;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 页写入异常处理时会返回到用户空间的cow_entry函数</p><blockquote><p>Exercise 4.13 cow_entry</p><p>处理写时复制异常的异常处理函数</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>__attribute__</span>((noreturn)) <span style=color:#50fa7b>cow_entry</span>(<span style=color:#ff79c6>struct</span> Trapframe <span style=color:#ff79c6>*</span>tf) {
</span></span><span style=display:flex><span>	u_int va <span style=color:#ff79c6>=</span> tf<span style=color:#ff79c6>-&gt;</span>cp0_badvaddr; <span style=color:#6272a4>// 发生异常的地址
</span></span></span><span style=display:flex><span>	u_int perm;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Find the &#39;perm&#39; in which the faulting address &#39;va&#39; is mapped. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hint: Use &#39;vpt&#39; and &#39;VPN&#39; to find the page table entry. If the &#39;perm&#39; doesn&#39;t have
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 * &#39;PTE_COW&#39;, launch a &#39;user_panic&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.13: Your code here. (1/6) */</span>
</span></span><span style=display:flex><span>	perm <span style=color:#ff79c6>=</span> vpt[<span style=color:#50fa7b>VPN</span>(va)] <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xfff</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>(perm <span style=color:#ff79c6>&amp;</span> PTE_COW)) { <span style=color:#6272a4>// 检查权限位 ：检查是不是COW页
</span></span></span><span style=display:flex><span>		<span style=color:#50fa7b>user_panic</span>(<span style=color:#f1fa8c>&#34;The permission of the page of va 0x%x doesn&#39;t has PTE_COW!&#34;</span>,va);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Remove &#39;PTE_COW&#39; from the &#39;perm&#39;, and add &#39;PTE_D&#39; to it. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.13: Your code here. (2/6) */</span>
</span></span><span style=display:flex><span>	perm <span style=color:#ff79c6>=</span> (perm <span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>!</span>PTE_COW) <span style=color:#ff79c6>|</span> PTE_D;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Allocate a new page at &#39;UCOW&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.13: Your code here. (3/6) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_mem_alloc</span>(<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)UCOW,PTE_D);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Copy the content of the faulting page at &#39;va&#39; to &#39;UCOW&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hint: &#39;va&#39; may not be aligned to a page! */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.13: Your code here. (4/6) */</span>
</span></span><span style=display:flex><span>	va <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ROUNDDOWN</span>(va,PAGE_SIZE);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>memcpy</span>((<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)UCOW,(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)va,PAGE_SIZE);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 5: Map the page at &#39;UCOW&#39; to &#39;va&#39; with the new &#39;perm&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.13: Your code here. (5/6) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_mem_map</span>(<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)UCOW,<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)va,perm);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 6: Unmap the page at &#39;UCOW&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.13: Your code here. (6/6) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_mem_unmap</span>(<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)UCOW);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 7: Return to the faulting routine.
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>syscall_set_trapframe</span>(<span style=color:#bd93f9>0</span>, tf);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>user_panic</span>(<span style=color:#f1fa8c>&#34;syscall_set_trapframe returned %d&#34;</span>, r);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>从内核态中<code>do_tlb_mod</code>函数返回时，传递的第一个参数（保存在a0(4号)寄存器中）</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>// do_tlb_mod
</span></span></span><span style=display:flex><span>tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>-=</span> <span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>struct</span> Trapframe);
</span></span><span style=display:flex><span><span style=color:#ff79c6>*</span>(<span style=color:#ff79c6>struct</span> Trapframe <span style=color:#ff79c6>*</span>)tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>] <span style=color:#ff79c6>=</span> tmp_tf;
</span></span><span style=display:flex><span>tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>4</span>] <span style=color:#ff79c6>=</span> tf<span style=color:#ff79c6>-&gt;</span>regs[<span style=color:#bd93f9>29</span>];
</span></span></code></pre></td></tr></table></div></div><ul><li>sp寄存器的位置实际上保存了一个trapframe</li><li>a0号寄存器中保存了一个trapframe</li><li>用户态处理COW异常函数cow_entry接收到第一个参数为这个trapframe</li></ul></li><li><p>传递的trapframe中badvaddr域即为发生COW异常的虚拟地址，可以通过这个地址得到相应的页面并检查权限位</p><ul><li>在UCOW地址处分配一个新的可写页(PTE_D)，等待复制，注意权限位可写PTE_D</li></ul><p><img alt=image-20240514190636054 loading=lazy src=/img/image-20240514190636054.png></p></li><li><p><code>ROUNDDOWN(va)</code>实际上是对地址的低12位清0，或者说得到了所在页的首地址</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	va <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ROUNDDOWN</span>(va,PAGE_SIZE);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>memcpy</span>((<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)UCOW,(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)va,PAGE_SIZE);
</span></span></code></pre></td></tr></table></div></div><ul><li>将发生错误的页复制到UCOW新页</li></ul></li><li><p>将虚拟地址映射到UCOW新页，当前进程解除映射</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#50fa7b>syscall_mem_map</span>(<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)UCOW,<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)va,perm);
</span></span><span style=display:flex><span><span style=color:#50fa7b>syscall_mem_unmap</span>(<span style=color:#bd93f9>0</span>,(<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)UCOW);
</span></span></code></pre></td></tr></table></div></div></li><li><p>当前进程的trapframe设为tf</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>syscall_set_trapframe</span>(<span style=color:#bd93f9>0</span>, tf);
</span></span></code></pre></td></tr></table></div></div></li></ul><blockquote><p>Exercise 4.14 sys_set_env_status</p><p>父进程将子进程的状态设置为status</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_set_env_status</span>(u_int envid, u_int status) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Env <span style=color:#ff79c6>*</span>env;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Check if &#39;status&#39; is valid. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.14: Your code here. (1/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (status <span style=color:#ff79c6>!=</span> ENV_RUNNABLE <span style=color:#ff79c6>&amp;&amp;</span> status <span style=color:#ff79c6>!=</span> ENV_NOT_RUNNABLE) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Convert the envid to its corresponding &#39;struct Env *&#39; using &#39;envid2env&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.14: Your code here. (2/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>envid2env</span>(envid,<span style=color:#ff79c6>&amp;</span>env,<span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Update &#39;env_sched_list&#39; if the &#39;env_status&#39; of &#39;env&#39; is being changed. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.14: Your code here. (3/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (env<span style=color:#ff79c6>-&gt;</span>env_status <span style=color:#ff79c6>!=</span> status) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (status <span style=color:#ff79c6>==</span> ENV_RUNNABLE) { <span style=color:#6272a4>//加入调度队列
</span></span></span><span style=display:flex><span>			<span style=color:#50fa7b>TAILQ_INSERT_TAIL</span>(<span style=color:#ff79c6>&amp;</span>env_sched_list,env,env_sched_link);
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// 从调度队列取出
</span></span></span><span style=display:flex><span>			<span style=color:#50fa7b>TAILQ_REMOVE</span>(<span style=color:#ff79c6>&amp;</span>env_sched_list,env,env_sched_link);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Set the &#39;env_status&#39; of &#39;env&#39;. */</span>
</span></span><span style=display:flex><span>	env<span style=color:#ff79c6>-&gt;</span>env_status <span style=color:#ff79c6>=</span> status;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Exercise 4.15 fork : final!</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>fork</span>(<span style=color:#8be9fd>void</span>) {
</span></span><span style=display:flex><span>	u_int child;
</span></span><span style=display:flex><span>	u_int i;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 1: Set our TLB Mod user exception entry to &#39;cow_entry&#39; if not done yet. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (env<span style=color:#ff79c6>-&gt;</span>env_user_tlb_mod_entry <span style=color:#ff79c6>!=</span> (u_int)cow_entry) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>syscall_set_tlb_mod_entry</span>(<span style=color:#bd93f9>0</span>, cow_entry));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 2: Create a child env that&#39;s not ready to be scheduled. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Hint: &#39;env&#39; should always point to the current env itself, so we should fix it to the
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// correct value.
</span></span></span><span style=display:flex><span>	child <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>syscall_exofork</span>();
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (child <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		env <span style=color:#ff79c6>=</span> envs <span style=color:#ff79c6>+</span> <span style=color:#50fa7b>ENVX</span>(<span style=color:#50fa7b>syscall_getenvid</span>());
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>// 子进程在此返回 
</span></span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 3: Map all mapped pages below &#39;USTACKTOP&#39; into the child&#39;s address space. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Hint: You should use &#39;duppage&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.15: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;i <span style=color:#ff79c6>&lt;</span> <span style=color:#50fa7b>PDX</span>(<span style=color:#50fa7b>ROUND</span>(USTACKTOP,PDMAP));i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (vpd[i] <span style=color:#ff79c6>&amp;</span> PTE_V) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>for</span> (u_int j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;j <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>1024</span>;j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>				u_int vpn <span style=color:#ff79c6>=</span> (i <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>10</span>) <span style=color:#ff79c6>|</span> j;
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> ((vpn <span style=color:#ff79c6>&lt;</span> <span style=color:#50fa7b>VPN</span>(USTACKTOP) <span style=color:#ff79c6>&amp;&amp;</span> (vpt[vpn] <span style=color:#ff79c6>&amp;</span> PTE_V))) {
</span></span><span style=display:flex><span>					<span style=color:#50fa7b>duppage</span>(child,vpn);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Step 4: Set up the child&#39;s tlb mod handler and set child&#39;s &#39;env_status&#39; to
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 * &#39;ENV_RUNNABLE&#39;. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hint:
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *   You may use &#39;syscall_set_tlb_mod_entry&#39; and &#39;syscall_set_env_status&#39;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *   Child&#39;s TLB Mod user exception entry should handle COW, so set it to &#39;cow_entry&#39;
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 4.15: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_set_tlb_mod_entry</span>(child,cow_entry);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_set_env_status</span>(child,ENV_RUNNABLE);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> child;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>首先设置好处理COW异常的异常处理函数</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>e<span style=color:#ff79c6>-</span>env_user_tlb_mod_entry <span style=color:#ff79c6>=</span> cow_entry
</span></span></code></pre></td></tr></table></div></div></li><li><p>创建新进程，这里通过syscall_exofork实现</p><pre tabindex=0><code>child = syscall_exofork();
</code></pre><ul><li><p>即从这一行往后会有两个进程执行以下代码段</p></li><li><p>父进程的返回值在<code>syscall_exofork</code>中显示地指出来，为子进程的envid</p></li><li><p>子进程由于处于NOT_RUNNABLE状态，他的返回值被保存到trapframe中的返回值寄存器v0(2号)中，等到被调度时（父进程把他设置为RUNNABLE后），返回0，进入下方判断返回</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (child <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		env <span style=color:#ff79c6>=</span> envs <span style=color:#ff79c6>+</span> <span style=color:#50fa7b>ENVX</span>(<span style=color:#50fa7b>syscall_getenvid</span>());
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>// 子进程在此返回 
</span></span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>最重要的一步就是遍历USTACKTOP以下的页面并从父进程地址空间映射到子进程地址空间，下面进行仔细分析</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;i <span style=color:#ff79c6>&lt;</span> <span style=color:#50fa7b>PDX</span>(<span style=color:#50fa7b>ROUND</span>(USTACKTOP,PDMAP));i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (vpd[i] <span style=color:#ff79c6>&amp;</span> PTE_V) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>for</span> (u_int j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;j <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>1024</span>;j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>				u_int vpn <span style=color:#ff79c6>=</span> (i <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>10</span>) <span style=color:#ff79c6>|</span> j;
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>if</span> ((vpn <span style=color:#ff79c6>&lt;</span> <span style=color:#50fa7b>VPN</span>(USTACKTOP) <span style=color:#ff79c6>&amp;&amp;</span> (vpt[vpn] <span style=color:#ff79c6>&amp;</span> PTE_V))) {
</span></span><span style=display:flex><span>					<span style=color:#50fa7b>duppage</span>(child,vpn);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>已知只需要对USTACKTOP以下的地址空间进行映射，已经有页映射工具duppage，duppage函数会区分页权限进行操作</p></li><li><p>宏<code>PDMAP</code>一个页目录项映射到的地址空间大小(4MB)</p></li><li><p>宏<code>ROUND</code>相当于向上取整，</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#50fa7b>ROUND</span>(USTACKTOP,PDMAP)
</span></span></code></pre></td></tr></table></div></div><ul><li>即USTACKTOP以下的地址空间至少需要多少个页目录项才能映射完整</li></ul></li><li><p>宏<code>PDX</code>找到虚拟地址对应的页目录偏移量</p></li><li><p>宏vpd是当前进程页目录数组的指针，即为首地址</p></li><li><p>然后在每个页目录项对应的二级页表中进行遍历</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>for</span> (u_int j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;j <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>1024</span>;j<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>	u_int vpn <span style=color:#ff79c6>=</span> (i <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>10</span>) <span style=color:#ff79c6>|</span> j;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((vpn <span style=color:#ff79c6>&lt;</span> <span style=color:#50fa7b>VPN</span>(USTACKTOP) <span style=color:#ff79c6>&amp;&amp;</span> (vpt[vpn] <span style=color:#ff79c6>&amp;</span> PTE_V))) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>duppage</span>(child,vpn);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>回顾二级页表地址结构<code>PDX(10bits) + PTX(10bits) + OFFSET(12bits)</code></li><li>这里需要对得到的虚拟页号<strong>进行检查，因为我们在取页表项时，为了保证所取到的页表项完整的映射了USTACKTOP以下的地址范围，进行了向上取整，有可能最后一个页目录项(4MB)对应的二级页表中有页表项对应的页面超过了USTACKTOP</strong></li><li>对于符合地址范围且有效的页面映射到子进程中</li></ul></li></ul></li><li><p>设置子进程的异常处理函数，状态，子进程可以被进行调度</p></li><li><p>父进程返回子进程的envid</p></li></ul><p><img alt=image-20240507212156008 loading=lazy src=/img/image-20240507212156008.png></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://coder0xe.github.io/tags/may/>May</a></li></ul><nav class=paginav><a class=prev href=https://coder0xe.github.io/posts/os-lab4%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/><span class=title>« Prev</span><br><span>OS:lab4实验报告</span>
</a><a class=next href=https://coder0xe.github.io/posts/os-lab3%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/><span class=title>Next »</span><br><span>OS:lab3实验报告</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab4课下基础 on x" href="https://x.com/intent/tweet/?text=OS%3alab4%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab4%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f&amp;hashtags=May"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab4课下基础 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab4%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f&amp;title=OS%3alab4%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&amp;summary=OS%3alab4%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&amp;source=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab4%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab4课下基础 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab4%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f&title=OS%3alab4%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab4课下基础 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab4%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab4课下基础 on whatsapp" href="https://api.whatsapp.com/send?text=OS%3alab4%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80%20-%20https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab4%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab4课下基础 on telegram" href="https://telegram.me/share/url?text=OS%3alab4%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab4%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab4课下基础 on ycombinator" href="https://news.ycombinator.com/submitlink?t=OS%3alab4%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab4%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://coder0xe.github.io/>coder0xe's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>