<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OS:lab5课下基础 | coder0xe's blog</title><meta name=keywords content="OS:lab5"><meta name=description content="OS:lab5课下基础"><meta name=author content="sudo"><link rel=canonical href=https://coder0xe.github.io/posts/os-lab5%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/><link crossorigin=anonymous href=/assets/css/stylesheet.e4a36188e2c44563c1cc5ed1a2d0b8451a4f68c685114d738b97609f82dae050.css integrity="sha256-5KNhiOLERWPBzF7RotC4RRpPaMaFEU1zi5dgn4La4FA=" rel="preload stylesheet" as=style><link rel=icon href=https://coder0xe.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://coder0xe.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://coder0xe.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://coder0xe.github.io/apple-touch-icon.png><link rel=mask-icon href=https://coder0xe.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://coder0xe.github.io/posts/os-lab5%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://coder0xe.github.io/posts/os-lab5%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/"><meta property="og:site_name" content="coder0xe's blog"><meta property="og:title" content="OS:lab5课下基础"><meta property="og:description" content="OS:lab5课下基础"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-19T12:24:50+08:00"><meta property="article:modified_time" content="2024-05-19T12:24:50+08:00"><meta property="article:tag" content="May"><meta name=twitter:card content="summary"><meta name=twitter:title content="OS:lab5课下基础"><meta name=twitter:description content="OS:lab5课下基础"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://coder0xe.github.io/posts/"},{"@type":"ListItem","position":2,"name":"OS:lab5课下基础","item":"https://coder0xe.github.io/posts/os-lab5%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OS:lab5课下基础","name":"OS:lab5课下基础","description":"OS:lab5课下基础","keywords":["OS:lab5"],"articleBody":"OS:lab5课下基础 1. 文件系统概述 ​\t计算机文件系统是一种存储和组织数据的方法，便于访问和查找数据。文件系统使用文件和树形目录的逻辑抽象屏蔽了底层硬盘和光盘等物理设备基于数据块进行存储和访问的复杂性。\n即用户不必关心数据实际保存在硬盘/光盘的哪个数据块上，而只需要记住这个文件所属的目录和文件名。\n在写入新数据之前，用户不必关心硬盘上哪个块是空闲的，硬盘上的存储空间管理(分配/释放)由文件系统自动完成，用户只需记住数据写入到了哪个文件\n​\t常见的文件系统通常基于硬盘和光盘等块存储设备，并维护文件在设备中的物理位置。\n​\t广义上，一切带标识的、在逻辑上有完整意义的字节序列都可以称为文件，文件系统将外部设备中的资源抽象为文件，从而可以统一管理外部设备，实现对数据的存储、组织、访问和修改。\n2. 文件系统的设计与实现 MOS是一种微内核设计\n将传统操作系统的文件系统移出内核 将一些内核数据暴露到用户空间 将传统操作系统的设备驱动移出内核 3. IDE磁盘驱动 ​\t为了在磁盘等外部设备上实现文件系统，我们必须为这些外部设备编写驱动程序。(MOS已经在kern/mechine.c中实现了一个简单的控制台驱动程序)\n​\t本次要实现的硬盘驱动程序与已经实现的串口驱动都采用MMIO内存映射技术，并且本次编写的硬盘驱动程序完全运行在用户空间(微内核)。\n3.1 内存映射I/O(MMIO) ​\t几乎每一种外设都是通过读写设备上的寄存器来进行数据通信，外设寄存器也称为I/O接口，主要用来访问I/O设备。\n外设寄存器主要包括控制寄存器、状态寄存器、数据寄存器，这些寄存器被映射到指定的物理地址空间 ​\t在MIPS的内核地址空间中(kseg0/kseg1)实现了硬件级别(高位清0)的物理地址和内核虚拟地址的转换机制，其中，对于kseg1段地址的读写不经过MMU映射，且不使用高速缓存，这正是外部设备驱动所需要的。我们可以通过简单地读写某些固定的内核虚拟地址来实现驱动程序的功能。\n在之前的实验中，我们曾经使用KADDR宏将一个物理地址转换为kseg0段的虚拟地址，即加上kseg0段的偏移量(0x8000_0000)\n​\t在编写设备驱动时，我们需要将物理地址转换为kseg1段的内核虚拟地址，即给物理地址加上kseg1的偏移值0xA000_0000\n​\t以已经编写完成的串口设备驱动为例，MALTA提供的console设备基地址为0x1800_03F8，设备寄存器映射如表所示\n​\t例如写操作：通过向kseg1段的地址写入字符，就能在shell中看到对应的输出。\nkseg0_offset + device_op_addr_base = KSEG1 + MALTA_SERIAL_DATA\n1 2 3 4 5 //写 void printcharc(char ch) { //... *((volatile uint8_t *)(KSEG1 + MALTA_SERIAL_DATA)) = ch; } ​\t在本次实验中，我们需要编写的IDE磁盘驱动位于用户空间，用户态进程若是直接读写内核虚拟地址会引发一个地址错误ADEL/S，故对于设备的读写必须通过系统调用实现\nsys_write_dev：写设备系统调用 sys_read_dev：读设备系统调用 Exercise 5.1 kern/syscall.c中的sys_write_dev以及sys_read_dev\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 int sys_write_dev(u_int va, u_int pa, u_int len) { /* Exercise 5.1: Your code here. (1/2) */ if (is_illegal_va_range(va, len)) { return -E_INVAL; } if (!((pa \u003e= MALTA_IDE_BASE \u0026\u0026 pa + len \u003c MALTA_IDE_BASE + 0x8) || (pa \u003e= MALTA_SERIAL_BASE \u0026\u0026 pa + len \u003c MALTA_SERIAL_BASE + 0x20))) { return -E_INVAL; } if (len == 1) { iowrite8(*(uint8_t *)va,(u_long)pa); } else if (len == 2) { iowrite16(*(uint16_t *)va,(u_long)pa); } else if (len == 4) { iowrite32(*(uint32_t *)va,(u_long)pa); } else { return -E_INVAL; } return 0; } int sys_read_dev(u_int va, u_int pa, u_int len) { /* Exercise 5.1: Your code here. (2/2) */ if (is_illegal_va_range(va, len)) { return -E_INVAL; } if (!((pa \u003e= MALTA_IDE_BASE \u0026\u0026 pa + len \u003c MALTA_IDE_BASE + 0x8) || (pa \u003e= MALTA_SERIAL_BASE \u0026\u0026 pa + len \u003c MALTA_SERIAL_BASE + 0x20))) { return -E_INVAL; } if (len == 1) { *(uint8_t *) va = ioread8((u_long)pa); } else if (len == 2) { *(uint16_t *) va = ioread16((u_long)pa); } else if (len == 4) { *(uint32_t *) va = ioread32((u_long)pa); } else { return -E_INVAL; } return 0; } 这里在读写虚拟地址对应的数据时涉及到对虚拟地址对应数据的读写（先转换为指针类型再解引用） Exercise 5.2 user/lib/syscall_lib.c中完成用户态的相应系统调用的接口\n（msyscall中直接调用syscall陷入内核）\n1 2 3 4 5 6 7 8 9 int syscall_write_dev(void *va, u_int dev, u_int size) { /* Exercise 5.2: Your code here. (1/2) */ return msyscall(SYS_write,va,dev,size); } int syscall_read_dev(void *va, u_int dev, u_int size) { /* Exercise 5.2: Your code here. (2/2) */ return msyscall(SYS_read,va,dev,size); } 3.2 IDE磁盘 3.2.1 磁盘物理结构 磁盘的物理结构\n扇区(sector)：磁盘盘片被划分为很多扇形的区域，这些区域叫做扇区。扇区是磁盘执行读写操作的单位，一般是512字节 磁道(track)：盘片上以盘片中心为圆心，不同大小的同心圆 柱面(cylinder)：硬盘中，不同盘面相同半径的磁道组成的圆柱面 磁头(head)：每个磁盘有两个面，每个面都有一个磁头，当对磁盘进行读写操作时，磁头在盘面上快速移动 3.2.2 IDE 磁盘操作 ​\t扇区(sector)是磁盘读写的基本单位，通过读写MALTA上PIIX4的特定寄存器，我们可以实现以扇区为最小单元的读写。MALTA平台上PIIX4磁盘控制器的基地址为0x1800_01f0，其I/O相关寄存器相对于该地址的偏移和对应的功能如下表\n在include/malta.h中定义了关于这些偏移量的宏定义\n1 2 3 4 5 6 7 8 9 10 11 12 13 #define MALTA_IDE_BASE (MALTA_PCIIO_BASE + 0x01f0) #define MALTA_IDE_DATA (MALTA_IDE_BASE + 0x00) #define MALTA_IDE_ERR (MALTA_IDE_BASE + 0x01) #define MALTA_IDE_NSECT (MALTA_IDE_BASE + 0x02) #define MALTA_IDE_LBAL (MALTA_IDE_BASE + 0x03) #define MALTA_IDE_LBAM (MALTA_IDE_BASE + 0x04) #define MALTA_IDE_LBAH (MALTA_IDE_BASE + 0x05) #define MALTA_IDE_DEVICE (MALTA_IDE_BASE + 0x06) #define MALTA_IDE_STATUS (MALTA_IDE_BASE + 0x07) #define MALTA_IDE_LBA 0xE0 #define MALTA_IDE_BUSY 0x80 #define MALTA_IDE_CMD_PIO_READ 0x20 /* Read sectors with retry */ #define MALTA_IDE_CMD_PIO_WRITE 0x30 /* write sectors with retry */ ​\t在MOS中我们可以挂载编号为0/1的两块IDE磁盘，但实际上我们只使用到编号为0的一块磁盘。\n​\t对于磁盘寻址，我们可以按照柱面-磁头-扇区(Cylinder-Head-Sector, CHS)的方式来定位一个扇区。这种寻址方式符合磁盘的物理结构。\n​\t由于CHS模式下不方便进行寻址，**因此在实验中我们使用逻辑块寻址（Logical Block Addressing, LBA）的方式来进行扇区寻址。**在LBA模式下，IDE设备将磁盘看做一个线性的字节序列，每个扇区都有一个唯一的编号，只需要设置目标扇区编号，就可以完成磁盘的寻址。\n​\t在我们的实验中，扇区编号有28位，因此最多可以寻址$2^{28}$个扇区，即128GB磁盘空间。\n3.2.3 驱动程序编写 ​\t当我们在磁盘的指定位置读取或写入一个扇区时，需要调用read_sector函数将磁盘中对应的扇区的数据读到设备缓冲区中，或write_sector函数将缓冲区中的数据写入磁盘。\n​\t磁盘操作中，所有的地址操作都需要将物理地址转换为虚拟地址，磁盘设备的基地址对应在kseg1的内核虚拟地址为0xb80_01f0。读取流程如下图\n​\t由上图，在磁盘读写的过程中，我们需要反复检查IDE设备是否已经就绪。因此我们构建了一个检查IDE状态的帮手函数wait_ide_ready（用户态函数），用于等待IDE上的操作就绪。\n1 2 3 4 5 6 7 8 9 10 11 static uint8_t wait_ide_ready() { uint8_t flag; while (1) { panic_on(syscall_read_dev(\u0026flag, MALTA_IDE_STATUS, 1)); if ((flag \u0026 MALTA_IDE_BUSY) == 0) { break; } syscall_yield(); } return flag; } ​\t当IDE就绪后，就可以对他进行读写操作了。\n首先设置操作扇区的数目，我们只操作一个扇区，因此设置为1\n接下来一次设置操作扇区号，本实验中的IDE设备无法一次性写入28位扇区号，因此需要单独设置扇区号的各位，在设置[27:24]位时，还需要同时设置扇区寻址模式和磁盘编号。\n再次等待IDE设备就绪\n通过系统调用读取或写入扇区：本实验中IDE设备每次仅能读取或写入4字节，因此需要通过一个循环完成整个扇区的读取或写入，即连续相相同的地址读取或写入4字节\n​\t读取扇区：read_sector，读取diskno号磁盘上的secno号扇区到dst指向的地址。\n​\t写入扇区：write_sector，将src指向的一个扇区的数据写入到diskno号磁盘的secno号扇区。\nExercise 5.3 fs/ide.c ide_read ide_write 实现用户态下对磁盘的读写操作\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 void ide_read(u_int diskno, u_int secno, void *dst, u_int nsecs) { uint8_t temp; u_int offset = 0, max = nsecs + secno; panic_on(diskno \u003e= 2); // Read the sector in turn while (secno \u003c max) { temp = wait_ide_ready(); // Step 1: Write the number of operating sectors to NSECT register temp = 1; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_NSECT, 1)); // Step 2: Write the 7:0 bits of sector number to LBAL register temp = secno \u0026 0xff; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_LBAL, 1)); // Step 3: Write the 15:8 bits of sector number to LBAM register /* Exercise 5.3: Your code here. (1/9) */ temp = (secno \u003e\u003e 8) \u0026 0xff; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_LBAM, 1)); // Step 4: Write the 23:16 bits of sector number to LBAH register /* Exercise 5.3: Your code here. (2/9) */ temp = (secno \u003e\u003e 16) \u0026 0xff; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_LBAH, 1)); // Step 5: Write the 27:24 bits of sector number, addressing mode // and diskno to DEVICE register temp = ((secno \u003e\u003e 24) \u0026 0x0f) | MALTA_IDE_LBA | (diskno \u003c\u003c 4); panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_DEVICE, 1)); // Step 6: Write the working mode to STATUS register temp = MALTA_IDE_CMD_PIO_READ; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_STATUS, 1)); // Step 7: Wait until the IDE is ready temp = wait_ide_ready(); // Step 8: Read the data from device for (int i = 0; i \u003c SECT_SIZE / 4; i++) { panic_on(syscall_read_dev(dst + offset + i * 4, MALTA_IDE_DATA, 4)); } // Step 9: Check IDE status panic_on(syscall_read_dev(\u0026temp, MALTA_IDE_STATUS, 1)); offset += SECT_SIZE; secno += 1; } } void ide_write(u_int diskno, u_int secno, void *src, u_int nsecs) { uint8_t temp; u_int offset = 0, max = nsecs + secno; panic_on(diskno \u003e= 2); // Write the sector in turn while (secno \u003c max) { temp = wait_ide_ready(); // Step 1: Write the number of operating sectors to NSECT register /* Exercise 5.3: Your code here. (3/9) */ temp = 1; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_NSECT, 1)); // Step 2: Write the 7:0 bits of sector number to LBAL register /* Exercise 5.3: Your code here. (4/9) */ temp = secno \u0026 0xff; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_LBAL, 1)); // Step 3: Write the 15:8 bits of sector number to LBAM register /* Exercise 5.3: Your code here. (5/9) */ temp = (secno \u003e\u003e 8) \u0026 0xff; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_LBAM, 1)); // Step 4: Write the 23:16 bits of sector number to LBAH register /* Exercise 5.3: Your code here. (6/9) */ temp = (secno \u003e\u003e 16) \u0026 0xff; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_LBAH, 1)); // Step 5: Write the 27:24 bits of sector number, addressing mode // and diskno to DEVICE register /* Exercise 5.3: Your code here. (7/9) */ temp = ((secno \u003e\u003e 24) \u0026 0x0f) | MALTA_IDE_LBA | (diskno \u003c\u003c 4); panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_DEVICE, 1)); // Step 6: Write the working mode to STATUS register /* Exercise 5.3: Your code here. (8/9) */ temp = MALTA_IDE_CMD_PIO_WRITE; panic_on(syscall_write_dev(\u0026temp, MALTA_IDE_STATUS, 1)); // Step 7: Wait until the IDE is ready temp = wait_ide_ready(); // Step 8: Write the data to device for (int i = 0; i \u003c SECT_SIZE / 4; i++) { /* Exercise 5.3: Your code here. (9/9) */ panic_on(syscall_write_dev(src + offset + i * 4, MALTA_IDE_DATA, 4)); } // Step 9: Check IDE status panic_on(syscall_read_dev(\u0026temp, MALTA_IDE_STATUS, 1)); offset += SECT_SIZE; secno += 1; } } 4. 文件系统结构 4.1 磁盘文件系统布局 ​\t如下图\n​\t图中出现的Block是磁盘块。不同于扇区，磁盘块是一个虚拟概念，是操作系统与磁盘交互的最小单位，操作系统将相邻的扇区组合在一起，形成磁盘块进行整体操作，减小了扇区过多带来的寻址困难，磁盘块的大小由操作系统决定，一般由2的幂次个扇区构成；而扇区是真实存在的，是磁盘读写的基本单位，与操作系统无关。\n​\tMOS操作系统把磁盘最开始的一个磁盘块(4096字节)当做引导扇区和分区表使用，接下来的一个磁盘块为超级块(Super Block)，用来表述文件系统的基本信息，如Magic Number、磁盘大小以及根目录的位置。\n​\tMOS中超级块以结构体的方式进行定义\n1 2 3 4 5 struct Super { u_int s_magic; // magic number : FS_MAGIC u_int s_nblocks; // total number of blocks on disk (1024) struct File s_root; // root dictionary node } 不同于lab2/lab3中使用空闲链表法管理空闲内存资源和进程控制块，在文件系统中我们使用位图来管理空闲的磁盘资源\n​\t在文件系统中，我们使用位图法来管理空闲的磁盘资源，用一个二进制位bit标识磁盘中的一个磁盘块的使用情况(1表示空闲，0表示占用)。\n​\ttools/fsformat.c中定义了创建文件系统镜像的工具，其中init_disk函数将所有的磁盘块都标记为空闲块（tools文件夹下的程序都是运行在linux环境中，而不是MOS）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 void init_disk() { int i, diff; // Step 1: Mark boot sector block. disk[0].type = BLOCK_BOOT; // Step 2: Initialize boundary. nbitblock = (NBLOCK + BLOCK_SIZE_BIT - 1) / BLOCK_SIZE_BIT; nextbno = 2 + nbitblock; // Step 2: Initialize bitmap blocks. for (i = 0; i \u003c nbitblock; ++i) { disk[2 + i].type = BLOCK_BMAP; } for (i = 0; i \u003c nbitblock; ++i) { memset(disk[2 + i].data, 0xff, BLOCK_SIZE); } if (NBLOCK != nbitblock * BLOCK_SIZE_BIT) { diff = NBLOCK % BLOCK_SIZE_BIT / 8; memset(disk[2 + (nbitblock - 1)].data + diff, 0x00, BLOCK_SIZE - diff); } // Step 3: Initialize super block. disk[1].type = BLOCK_SUPER; super.s_magic = FS_MAGIC; super.s_nblocks = NBLOCK; super.s_root.f_type = FTYPE_DIR; strcpy(super.s_root.f_name, \"/\"); } nbitblock表示为了用位图标识整个磁盘上所有块的使用情况所需要的磁盘块的(bitblock)的数量\n1 nbitblock = (NBLOCK + BLOCK_SIZE_BIT - 1) / BLOCK_SIZE_BIT; 这个表达式实际上具有一个整数除法向上取整的效果 NBLOCK：磁盘块的数量：1024 BLOCK_SIZE_BIT：每个磁盘块的bit大小：4096 * 8 disk[0]与disk[1]我们有特殊作用，不进行Bitmap初始化故遍历从disk[i+2]开始\n将所有位图块的每一位都设为1，表示处于空闲状态\n1 2 3 for (i = 0; i \u003c nbitblock; ++i) { memset(disk[2 + i].data, 0xff, BLOCK_SIZE); } 如果位图还有剩余，不能将最后一个位图块中的靠后一部分内容标记为空闲，因为这些磁盘块实际上并不存在，是不可使用的。因此还要将这些剩下的部分设为0\n1 2 3 4 if (NBLOCK != nbitblock * BLOCK_SIZE_BIT) { diff = NBLOCK % BLOCK_SIZE_BIT / 8; memset(disk[2 + (nbitblock - 1)].data + diff, 0x00, BLOCK_SIZE - diff); } ​\t相应的，在MOS操作系统中，文件系统也需要根据位图来判断和标记磁盘的使用情况。fs/fs.c中的block_is_free函数就用来通过位图中的特定位来判断指定的磁盘块是否被占用。\n1 2 3 4 5 6 7 8 9 10 11 int block_is_free(u_int blockno) { if (super == 0 || blockno \u003e= super-\u003es_nblocks) { return 0; } if (bitmap[blockno / 32] \u0026 (1 \u003c\u003c (blockno % 32))) { return 1; } return 0; } 这里的super是指向磁盘中Super Block的指针，指针值为0，即为零指针，没有存储任何内存地址的指针\n这里简单对bitmap涉及到的数据结构进行解释\nbitmap定义为\n1 uint32_t *bitmap; 我们可以把他看做一个32位int类型的数组看待\n这样我们的位图实际上是一个二维的结构，每一个数组元素相当于一行，一行中有32个元素\n行号：blockno / 32 | 列号 : blockno % 32\n检查二维结构中对应的位置是否为1\nExercise 5.4 free_block\n回收一个磁盘块，更改bitmap图中的标志位为1\n1 2 3 4 5 6 7 8 9 10 11 12 void free_block(u_int blockno) { // You can refer to the function 'block_is_free' above. // Step 1: If 'blockno' is invalid (0 or \u003e= the number of blocks in 'super'), return. /* Exercise 5.4: Your code here. (1/2) */ if (blockno == 0 || blockno \u003e= super-\u003es_nblocks) { return; } // Step 2: Set the flag bit of 'blockno' in 'bitmap'. // Hint: Use bit operations to update the bitmap, such as b[n / W] |= 1 \u003c\u003c (n % W). /* Exercise 5.4: Your code here. (2/2) */ bitmap[blockno / 32] |= 1 \u003c\u003c (blockno % 32); } 4.2 文件系统详细结构 ​\tMOS操作系统中使用文件控制块(File结构体)管理文件。\n1 2 3 4 5 6 7 8 9 10 struct File { char f_name[MAXNAMELEN]; // filename; max length is 128 uint32_t f_size;\t// file size in bytes uint32_t f_type;\t// file type uint32_t f_direct[NDIRECT]; uint32_t f_indirect; struct File *f_dir; // the pointer to the dir where this file is in, valid only in memory. char f_pad[FILE_STRUCT_SIZE - MAXNAMELEN - (3 + NDIRECT) * 4 - sizeof(void *)]; } __attribute__((aligned(4), packed)); f_type：普通文件/目录\nf_direct[NDIRECT]：文件的直接指针，每个文件控制块设有10个直接指针，用来记录文件的数据块在磁盘上的位置，每个磁盘块的大小为4KB，也就是说这10个直接指针能表示最大为40KB的文件\nf_indirect：文件的间接指针，当文件的大小超过40KB时，f_indirect指向一个间接磁盘块，用来存储指向文件内容的磁盘块的指针(为了简化计算，我们不使用间接磁盘块的前10个指针)\nMOS 中只有一级间接指针域，实际的操作系统中往往是多级的，这是一种简化\nf_dir指向文件所属的文件目录\nf_pad为了让整数个文件结构体占用一个磁盘块，填充结构体(256字节)中剩下的字节\n​\t对普通的文件来说，其指向的磁盘块存储着文件内容，而对于目录文件来说，其指向的磁盘块存储着各个文件对应的文件控制块。\n当我们要查找某个文件时 首先从超级块中读取根目录的文件控制块 然后沿着目标路径，挨个查看当前目录所包含的文件是否与下一级目标文件同名 找到最终文件 ps : 有关镜像文件\n所谓镜像文件其实就是将特定的一系列文件按照一定的格式制作成单一的文件(类似于压缩包) 例如操作系统、游戏等，最大的特点是可以被特定的软件识别并直接刻录到光盘上 ​\t我们通过fsformat(tools/fsformat.c编译而来)程序来创建一个磁盘镜像文件target/fs.img。通过观察头文件和tools/Makefile，我们发现fsformat.c的编译过程与其他文件有所不同，其使用的是Linux下的gcc编译器，而非交叉编译器，编译生成的fsformat运行于Linux宿主机上，专门用于创建磁盘镜像文件。生成的镜像文件fs.img可以模拟与真实的磁盘文件设备的交互。\nExercise 5.5 file_create\n为目录中增加一个文件(文件控制块)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 struct File *create_file(struct File *dirf) { int nblk = dirf-\u003ef_size / BLOCK_SIZE; // Step 1: Iterate through all existing blocks in the directory. for (int i = 0; i \u003c nblk; ++i) { int bno; // the block number // If the block number is in the range of direct pointers (NDIRECT), get the 'bno' // directly from 'f_direct'. Otherwise, access the indirect block on 'disk' and get // the 'bno' at the index. /* Exercise 5.5: Your code here. (1/3) */ if (i \u003c NDIRECT) { bno = dirf-\u003ef_direct[i]; } else { bno = ((uint32_t *)disk[dirf-\u003ef_indirect].data)[i]; } // Get the directory block using the block number. struct File *blk = (struct File *)(disk[bno].data); // Iterate through all 'File's in the directory block. for (struct File *f = blk; f \u003c blk + FILE2BLK; ++f) { // If the first byte of the file name is null, the 'File' is unused. // Return a pointer to the unused 'File'. /* Exercise 5.5: Your code here. (2/3) */ if (f-\u003ef_name[0] == '\\0') { return f; } } } // Step 2: If no unused file is found, allocate a new block using 'make_link_block' function // and return a pointer to the new block on 'disk'. /* Exercise 5.5: Your code here. (3/3) */ return (struct File *)(disk[make_link_block(dirf, nblk)].data); } 如果当前目录下有空闲的文件控制块就使用空闲的，没有就新分配一个 首先计算当前目录下有多少个磁盘块，对应的块号通过区分NDIRECT查找 *在查询块号时需要注意一个小点：在块号大于10时，我们需要到间接磁盘中查询，我们的块号是32位的，而磁盘中数据的存储格式(disk[].data是一个4096B大小的每个元素为1字节大小的数组)，因此我们不能直接用i做索引，这样只能取出一个一字节大小的数据，我们需要把数组类型转换为32位，((uint32_t )disk[].data)[i] 然后通过块号拿到对应的磁盘块，遍历磁盘块中存储的所有文件控制块，如果文件名为空，即为空闲，返回该文件控制块 如果没有就新分配一个磁盘块并返回(make_link_block) 请阅读tools/fsformat.c 和fs/Makefile，掌握如何将文件和目录按照文件系统的格式写入磁盘，了解文件系统结构的 具体细节，学会添加自定义文件进入磁盘镜像。\n​\tfsformat.c中将文件系统写入磁盘的主函数如下，该函数对文件类型做了区分，是目录或是普通文件。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 int main(int argc, char **argv) { static_assert(sizeof(struct File) == FILE_STRUCT_SIZE); init_disk(); if (argc \u003c 3) { fprintf(stderr, \"Usage: fsformat [files or directories]...\\n\"); exit(1); } for (int i = 2; i \u003c argc; i++) { char *name = argv[i]; struct stat stat_buf; int r = stat(name, \u0026stat_buf); assert(r == 0); if (S_ISDIR(stat_buf.st_mode)) { printf(\"writing directory '%s' recursively into disk\\n\", name); write_directory(\u0026super.s_root, name); } else if (S_ISREG(stat_buf.st_mode)) { printf(\"writing regular file '%s' into disk\\n\", name); write_file(\u0026super.s_root, name); } else { fprintf(stderr, \"'%s' has illegal file mode %o\\n\", name, stat_buf.st_mode); exit(2); } } flush_bitmap(); finish_fs(argv[1]); return 0; } 需要注意的是，在以下两个功能函数中，我们使用到了用户编程的POSIX接口\n​\t在以上代码中，将目录写入磁盘镜像的功能函数为write_directory\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 void write_directory(struct File *dirf, char *path) { DIR *dir = opendir(path); if (dir == NULL) { perror(\"opendir\"); return; } struct File *pdir = create_file(dirf); strncpy(pdir-\u003ef_name, basename(path), MAXNAMELEN - 1); if (pdir-\u003ef_name[MAXNAMELEN - 1] != 0) { fprintf(stderr, \"file name is too long: %s\\n\", path); // File already created, no way back from here. exit(1); } pdir-\u003ef_type = FTYPE_DIR; for (struct dirent *e; (e = readdir(dir)) != NULL;) { if (strcmp(e-\u003ed_name, \".\") != 0 \u0026\u0026 strcmp(e-\u003ed_name, \"..\") != 0) { char *buf = malloc(strlen(path) + strlen(e-\u003ed_name) + 2); sprintf(buf, \"%s/%s\", path, e-\u003ed_name); if (e-\u003ed_type == DT_DIR) { write_directory(pdir, buf); } else { write_file(pdir, buf); } free(buf); } } closedir(dir); } ​\t在以上代码中，将普通文件写入磁盘镜像的功能函数为write_file\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // Write file to disk under specified dir. void write_file(struct File *dirf, const char *path) { int iblk = 0, r = 0, n = sizeof(disk[0].data); struct File *target = create_file(dirf); /* in case `create_file` is't filled */ if (target == NULL) { return; } int fd = open(path, O_RDONLY); // Get file name with no path prefix. const char *fname = strrchr(path, '/'); if (fname) { fname++; } else { fname = path; } strcpy(target-\u003ef_name, fname); target-\u003ef_size = lseek(fd, 0, SEEK_END); target-\u003ef_type = FTYPE_REG; // Start reading file. lseek(fd, 0, SEEK_SET); while ((r = read(fd, disk[nextbno].data, n)) \u003e 0) { save_block_link(target, iblk++, next_block(BLOCK_DATA)); } close(fd); // Close file descriptor. } ​\t下面分析fs中Makefile制作磁盘镜像的命令\n1 2 3 4 5 6 image: $(tools_dir)/fsformat dd if=/dev/zero of=../target/fs.img bs=4096 count=1024 2\u003e/dev/null dd if=/dev/zero of=../target/empty.img bs=4096 count=1024 2\u003e/dev/null # using awk to remove paths with identical basename from FSIMGFILES $(tools_dir)/fsformat ../target/fs.img \\ $$(printf '%s\\n' $(FSIMGFILES) | awk -F/ '{ ns[$$NF]=$$0 } END { for (n in ns) { print ns[n] } }') 可以看出制作磁盘镜像fs.img是在Makefile中通过image这个target完成的，使用已经编译好的fsformat程序，传入参数还不清楚… 4.3 块缓存 ​\t块缓存是指借助虚拟内存来实现磁盘块缓存的设计，MOS操作系统中，文件系统服务是一个用户进程，一个进程可以拥有4GB的虚拟内存空间，将DISKMAP到DISKMAP+DISKMAX这一段虚拟地址空间作为缓冲区，当磁盘读入内存时，用来映射相关的页。\n​\t为了建立起磁盘地址空间和进程虚拟地址空间之间的缓存映射，我们采用的设计如图所示\nExercise 5.6 disk_addr函数计算指定磁盘块对应的虚存地址\n即根据一个块的序号，计算这一磁盘块对应的虚存的起始地址\nHint:我们已经知道，第一块磁盘被映射到DISKMAP，即起始虚拟地址为DISKMAP\n1 2 3 4 void *disk_addr(u_int blockno) { /* Exercise 5.6: Your code here. */ return (void*)(DISKMAP + blockno * BLOCK_SIZE); } Exercise 5.7 map_block | unmap_block\nmap_block：当一个磁盘块的内容载入到内存时，需要为之分配对应的物理内存，map_block完成了这一功能：检查指定的磁盘块是否已经映射到内存，如果没有， 分配一页内存来保存磁盘上的数据；相应地，完成unmap_block函数，用于解除磁盘块和 物理内存之间的映射关系，回收内存。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // Overview: // Allocate a page to cache the disk block. int map_block(u_int blockno) { // Step 1: If the block is already mapped in cache, return 0. // Hint: Use 'block_is_mapped'. /* Exercise 5.7: Your code here. (1/5) */ if (block_is_mapped(blockno)) { return 0; } // Step 2: Alloc a page in permission 'PTE_D' via syscall. // Hint: Use 'disk_addr' for the virtual address. /* Exercise 5.7: Your code here. (2/5) */ return syscall_mem_alloc(0,disk_addr(blockno),PTE_D); } // Overview: // Unmap a disk block in cache. void unmap_block(u_int blockno) { // Step 1: Get the mapped address of the cache page of this block using 'block_is_mapped'. void *va; /* Exercise 5.7: Your code here. (3/5) */ va = block_is_mapped(blockno); // Step 2: If this block is used (not free) and dirty in cache, write it back to the disk // first. // Hint: Use 'block_is_free', 'block_is_dirty' to check, and 'write_block' to sync. /* Exercise 5.7: Your code here. (4/5) */ if (!block_is_free(blockno) \u0026\u0026 block_is_dirty(blockno)) { write_block(blockno); } // Step 3: Unmap the virtual address via syscall. /* Exercise 5.7: Your code here. (5/5) */ syscall_mem_unmap(0,va); user_assert(!block_is_mapped(blockno)); } 需要使用用户态的系统调用函数syscall_*进行内存的映射和解除映射 ​\tread_block和write_block函数用于读写磁盘块，read_block函数将制定编号的磁盘块读入到内存中，首先检查这块磁盘块是否已经在内存中，如果不在，先分配一页物理内存，然后调用ide_read函数来读取磁盘上的数据到对应的虚拟地址。\n​\tfile_get_block函数用于将某个指定的文件指向的磁盘块读入内存\n首先为即将读入内存的磁盘块分配物理内存 然后使用read_block函数将磁盘内容以块为单位读入内存中的相应位置 Exercise 5.8 dir_lookup 查找某个目录下是否存在指定的文件\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 int dir_lookup(struct File *dir, char *name, struct File **file) { // Step 1: Calculate the number of blocks in 'dir' via its size. u_int nblock; /* Exercise 5.8: Your code here. (1/3) */ nblock = dir-\u003ef_size / BLOCK_SIZE; // Step 2: Iterate through all blocks in the directory. for (int i = 0; i \u003c nblock; i++) { // Read the i'th block of 'dir' and get its address in 'blk' using 'file_get_block'. void *blk; /* Exercise 5.8: Your code here. (2/3) */ try(file_get_block(dir, i, \u0026blk)); struct File *files = (struct File *)blk; // Find the target among all 'File's in this block. for (struct File *f = files; f \u003c files + FILE2BLK; ++f) { // Compare the file name against 'name' using 'strcmp'. // If we find the target file, set '*file' to it and set up its 'f_dir' // field. /* Exercise 5.8: Your code here. (3/3) */ if (strcmp(name, f-\u003ef_name) == 0) { *file = f; f-\u003ef_dir = dir; return 0; } } } return -E_NOT_FOUND; } 通过strcmp比对文件名 文件系统结构部分的函数调用参考\n5.文件系统的用户接口 在文件系统建立之后，还需要向用户提供相关的使用接口，MOS操作系统内核是微内核设计，文件系统属于用户态进程，在其他进程与文件系统交互的过程中，涉及到进程通信问题\n5.1 文件描述符 fd : File Descripter\n文件描述符是系统给用户提供的整数，用于其在描述符表(Descripter Table)中进行索引，我们在作为操作系统的使用者进行文件IO编程时\n使用open在描述符表(FDTABLE)的指定位置存放被打开的文件的信息 使用close将描述符表中制定位置的文件信息释放 在write和read时修改描述符表指定位置的文件信息 指定位置即为文件描述符fd ​\t当用户进程试图打开一个文件时，文件系统服务进程需要一个文件描述符来存储文件的基本信息和用户进程中关于文件的状态，同时，文件描述符也起到描述用户对于文件操作的作用。\n​\t当用户进程向文件系统发送打开文件的请求时，文件系统进程会将这些基本信息记录在内存中，然后由操作系统将用户进程请求的地址映射到同一个存储了文件描述符的物理页上。因此一个文件描述符至少需要独占一页的空间。当用户进程获取了文件大小等基本信息后，再次向文件系统发送请求将文件内容映射到指定空间中。\n关于两个结构体之间的指针类型转换\n在file.c中，我们发现很多函数中都会将一个struct Fd*类型的指针转换为struct Filefd *类型的指针，这是C语言中的强制类型转换。\n强制类型转换不改变指针的值，只是改变程序对地址处数据的解释方式(指向的数据类型)\n两个结构体的定义如下\n1 2 3 4 5 6 7 8 9 10 struct Fd { u_int fd_dev_id; u_int fd_offset; u_int fd_omode; }; struct Filefd { struct Fd f_fd; u_int f_fileid; struct File f_file; }; Filefd结构体中第一个成员就是fd，因此指向Filefd的指针同样指向这个Fd的起始位置，可以进行转换\nExercise 5.9 open 打开文件或目录\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 int open(const char *path, int mode) { int r; // Step 1: Alloc a new 'Fd' using 'fd_alloc' in fd.c. // Hint: return the error code if failed. struct Fd *fd; /* Exercise 5.9: Your code here. (1/5) */ try(fd_alloc(\u0026fd)); // Step 2: Prepare the 'fd' using 'fsipc_open' in fsipc.c. /* Exercise 5.9: Your code here. (2/5) */ try(fsipc_open(path, mode, fd)); // Step 3: Set 'va' to the address of the page where the 'fd''s data is cached, using // 'fd2data'. Set 'size' and 'fileid' correctly with the value in 'fd' as a 'Filefd'. char *va; struct Filefd *ffd; u_int size, fileid; /* Exercise 5.9: Your code here. (3/5) */ va = fd2data(fd); ffd = (struct Filefd *)fd; size = ffd-\u003ef_file.f_size; fileid = ffd-\u003ef_fileid; // Step 4: Map the file content using 'fsipc_map'. for (int i = 0; i \u003c size; i += PTMAP) { /* Exercise 5.9: Your code here. (4/5) */ try(fsipc_map(fileid, i, va + i)); } // Step 5: Return the number of file descriptor using 'fd2num'. /* Exercise 5.9: Your code here. (5/5) */ return fd2num(fd); } 对关键函数进行解读：该函数的作用是打开一个文件或目录\n首先为要打开的文件或目录(本质上都是文件)分配一个文件描述符，观察fd_alloc的逻辑\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 int fd_alloc(struct Fd **fd) { u_int va; u_int fdno; for (fdno = 0; fdno \u003c MAXFD - 1; fdno++) { va = INDEX2FD(fdno); if ((vpd[va / PDMAP] \u0026 PTE_V) == 0) { *fd = (struct Fd *)va; return 0; } if ((vpt[va / PTMAP] \u0026 PTE_V) == 0) { // the fd is not used *fd = (struct Fd *)va; return 0; } } return -E_MAX_OPEN; } 本质上是找到最小的没有被分配的文件描述符所对应的页，而一页对应一个文件描述符\nfsipc_open\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 int fsipc_open(const char *path, u_int omode, struct Fd *fd) { u_int perm; struct Fsreq_open *req; req = (struct Fsreq_open *)fsipcbuf; // The path is too long. if (strlen(path) \u003e= MAXPATHLEN) { return -E_BAD_PATH; } strcpy((char *)req-\u003ereq_path, path); req-\u003ereq_omode = omode; return fsipc(FSREQ_OPEN, req, fd, \u0026perm); } 本质上是向文件系统发送打开文件的请求\nfsipc_map\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 int fsipc_map(u_int fileid, u_int offset, void *dstva) { int r; u_int perm; struct Fsreq_map *req; req = (struct Fsreq_map *)fsipcbuf; req-\u003ereq_fileid = fileid; req-\u003ereq_offset = offset; if ((r = fsipc(FSREQ_MAP, req, dstva, \u0026perm)) \u003c 0) { return r; } if ((perm \u0026 ~(PTE_D | PTE_LIBRARY)) != (PTE_V)) { user_panic(\"fsipc_map: unexpected permissions %08x for dstva %08x\", perm, dstva); } return 0; } 向文件系统进程发出映射内存块的请求。\n​\t当要读取一个大文件中间的一小部分内容时，一个简单的做法是从头开始查找，但是开销较大；此外，在多次读写同一文件描述符期间，我们也希望能够从文件中前一次读写完毕的位置开始继续读写数据。因此，文件描述符中需要维护一个指针，帮助我们在文件中定位，在read/write/seek操作时，也需要更新该指针的值\nExercise 5.10 read函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 int read(int fdnum, void *buf, u_int n) { int r; // Similar to the 'write' function below. // Step 1: Get 'fd' and 'dev' using 'fd_lookup' and 'dev_lookup'. struct Dev *dev; struct Fd *fd; /* Exercise 5.10: Your code here. (1/4) */ if ((r = fd_lookup(fdnum, \u0026fd)) \u003c 0 || (r = dev_lookup(fd-\u003efd_dev_id, \u0026dev)) \u003c 0 ) { return r; } // Step 2: Check the open mode in 'fd'. // Return -E_INVAL if the file is opened for writing only (O_WRONLY). /* Exercise 5.10: Your code here. (2/4) */ if ((fd-\u003efd_omode \u0026 O_ACCMODE) == O_WRONLY) { return -E_INVAL; } // Step 3: Read from 'dev' into 'buf' at the seek position (offset in 'fd'). /* Exercise 5.10: Your code here. (3/4) */ r = dev-\u003edev_read(fd, buf, n, fd-\u003efd_offset); // Step 4: Update the offset in 'fd' if the read is successful. /* Hint: DO NOT add a null terminator to the end of the buffer! * A character buffer is not a C string. Only the memory within [buf, buf+n) is safe to * use. */ /* Exercise 5.10: Your code here. (4/4) */ if (r \u003e 0) { fd-\u003efd_offset += r; } return r; } 主要逻辑为调用设备的读取函数dev_read函数从文件当前的偏移位置读取数据到缓冲区中\n注意**(fd-\u003efd_omode \u0026 O_ACCMODE) == O_WRONLY**一定要加括号，否则运算优先级会有问题\n观察dev_read等设备函数\n1 2 3 4 5 6 7 8 9 struct Dev { int dev_id; char *dev_name; int (*dev_read)(struct Fd *, void *, u_int, u_int); int (*dev_write)(struct Fd *, const void *, u_int, u_int); int (*dev_close)(struct Fd *); int (*dev_stat)(struct Fd *, struct Stat *); int (*dev_seek)(struct Fd *, u_int); }; 在设备结构体中定义了一系列关于设备操作的函数，关于他们的具体实现可以在file.c中找到例子(不同设备的定义可能不同)\n1 2 3 4 5 6 7 8 struct Dev devfile = { .dev_id = 'f', .dev_name = \"file\", .dev_read = file_read, .dev_write = file_write, .dev_close = file_close, .dev_stat = file_stat, }; 下面以file_read为例，即设备最终调用了这个函数，函数主体功能为memcpy，返回值为读取的长度。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 static int file_read(struct Fd *fd, void *buf, u_int n, u_int offset) { u_int size; struct Filefd *f; f = (struct Filefd *)fd; // Avoid reading past the end of file. size = f-\u003ef_file.f_size; if (offset \u003e size) { return 0; } if (offset + n \u003e size) { n = size - offset; } memcpy(buf, (char *)fd2data(fd) + offset, n); return n; } 5.2 文件系统服务 ​\tMOS操作系统中的文件服务通过IPC的方式供其他进程调用，进行文件读写操作。\n在内核启动时，启动了文件系统服务进程ENV_CREATE(fs_serv) 用户进程需要进行文件操作时，使用ipc_send,ipc_recv与fs_serv进行交互 ​\t在流程上，fs/serv.c中服务进程的主函数首先调用了serve_init函数准备好全局的文件打开记录表opentab，然后调用fs_init函数来初始化文件系统：\n首先通过读取超级块的内容获知磁盘的基本信息 然后检查磁盘是否能正常读写 最后调用read_bitmap函数检查磁盘块上的位图是否正确 ​\t执行完文件系统的初始化后，调用serve函数，文件系统服务开始运行，等待其他进程交互。\n1 2 3 4 5 6 7 8 9 10 11 int main() { user_assert(sizeof(struct File) == FILE_STRUCT_SIZE); debugf(\"FS is running\\n\"); serve_init(); fs_init(); serve(); return 0; } UML时序图如下(分析见实验报告)\n​\t用户进程向文件进程发送的请求如下\n1 2 3 4 5 6 7 8 9 10 enum { FSREQ_OPEN, FSREQ_MAP, FSREQ_SET_SIZE, FSREQ_CLOSE, FSREQ_DIRTY, FSREQ_REMOVE, FSREQ_SYNC, MAX_FSREQNO, }; 当用户程序发送文件系统操作请求时，将请求的内容放在对应的结构体中进行消息的传递。\nfs_serv进程收到其他进程的IPC操作后，IPC传递的消息包含了请求的类型和其他必要的参数，根据请求的类型(增/删/查/改)执行相应的文件操作\n结果重新通过IPC反馈给用户程序\nuser/lib/fsipc.c中定义了请求文件系统时用到的IPC操作\nuser/lib/file.c文件中定义了用户程序读写、创建、删除、修改文件的接口\n​\t下面三个练习实现删除指定路径文件的功能。\nExercise 5.11 fs/serv.c serve_remove\n1 2 3 4 5 6 7 8 9 void serve_remove(u_int envid, struct Fsreq_remove *rq) { // Step 1: Remove the file specified in 'rq' using 'file_remove' and store its return value. int r; /* Exercise 5.11: Your code here. (1/2) */ r = file_remove(rq-\u003ereq_path); // Step 2: Respond the return value to the caller 'envid' using 'ipc_send'. /* Exercise 5.11: Your code here. (2/2) */ ipc_send(envid, r, 0, 0); } Exercise 5.12 user/lib/fsipc.c fsipc_remove\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 int fsipc_remove(const char *path) { // Step 1: Check the length of 'path' using 'strlen'. // If the length of path is 0 or larger than 'MAXPATHLEN', return -E_BAD_PATH. /* Exercise 5.12: Your code here. (1/3) */ if (strlen(path) == 0 || strlen(path) \u003e MAXPATHLEN) { return -E_BAD_PATH; } // Step 2: Use 'fsipcbuf' as a 'struct Fsreq_remove'. struct Fsreq_remove *req = (struct Fsreq_remove *)fsipcbuf; // Step 3: Copy 'path' into the path in 'req' using 'strcpy'. /* Exercise 5.12: Your code here. (2/3) */ strcpy(req-\u003ereq_path, path); // Step 4: Send request to the server using 'fsipc'. /* Exercise 5.12: Your code here. (3/3) */ return fsipc(FSREQ_REMOVE, req, 0, 0); } Exercise 5.13 user/lib/file.c remove\n1 2 3 4 5 6 int remove(const char *path) { // Call fsipc_remove. /* Exercise 5.13: Your code here. */ return fsipc_remove(path); } ","wordCount":"4121","inLanguage":"en","datePublished":"2024-05-19T12:24:50+08:00","dateModified":"2024-05-19T12:24:50+08:00","author":{"@type":"Person","name":"sudo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://coder0xe.github.io/posts/os-lab5%E8%AF%BE%E4%B8%8B%E5%9F%BA%E7%A1%80/"},"publisher":{"@type":"Organization","name":"coder0xe's blog","logo":{"@type":"ImageObject","url":"https://coder0xe.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://coder0xe.github.io/ accesskey=h title="coder0xe's blog (Alt + H)">coder0xe's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://coder0xe.github.io/ title=首页><span>首页</span></a></li><li><a href=https://coder0xe.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://coder0xe.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://coder0xe.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://coder0xe.github.io/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://coder0xe.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://coder0xe.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">OS:lab5课下基础</h1><div class=post-description>OS:lab5课下基础</div><div class=post-meta><span title='2024-05-19 12:24:50 +0800 +0800'>May 19, 2024</span>&nbsp;·&nbsp;<span>20 min</span>&nbsp;·&nbsp;<span>sudo</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#oslab5%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80 aria-label=OS:lab5课下基础>OS:lab5课下基础</a><ul><li><a href=#1-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e6%a6%82%e8%bf%b0 aria-label="1. 文件系统概述">1. 文件系统概述</a></li><li><a href=#2-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e7%9a%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0 aria-label="2. 文件系统的设计与实现">2. 文件系统的设计与实现</a></li><li><a href=#3-ide%e7%a3%81%e7%9b%98%e9%a9%b1%e5%8a%a8 aria-label="3. IDE磁盘驱动">3. IDE磁盘驱动</a><ul><li><a href=#31-%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84iommio aria-label="3.1 内存映射I/O(MMIO)">3.1 内存映射I/O(MMIO)</a></li><li><a href=#32-ide%e7%a3%81%e7%9b%98 aria-label="3.2 IDE磁盘">3.2 IDE磁盘</a><ul><li><a href=#321-%e7%a3%81%e7%9b%98%e7%89%a9%e7%90%86%e7%bb%93%e6%9e%84 aria-label="3.2.1 磁盘物理结构">3.2.1 磁盘物理结构</a></li><li><a href=#322-ide-%e7%a3%81%e7%9b%98%e6%93%8d%e4%bd%9c aria-label="3.2.2 IDE 磁盘操作">3.2.2 IDE 磁盘操作</a></li><li><a href=#323-%e9%a9%b1%e5%8a%a8%e7%a8%8b%e5%ba%8f%e7%bc%96%e5%86%99 aria-label="3.2.3 驱动程序编写">3.2.3 驱动程序编写</a></li></ul></li></ul></li><li><a href=#4-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e7%bb%93%e6%9e%84 aria-label="4. 文件系统结构">4. 文件系统结构</a><ul><li><a href=#41-%e7%a3%81%e7%9b%98%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e5%b8%83%e5%b1%80 aria-label="4.1 磁盘文件系统布局">4.1 磁盘文件系统布局</a></li><li><a href=#42-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e8%af%a6%e7%bb%86%e7%bb%93%e6%9e%84 aria-label="4.2 文件系统详细结构">4.2 文件系统详细结构</a></li><li><a href=#43-%e5%9d%97%e7%bc%93%e5%ad%98 aria-label="4.3 块缓存">4.3 块缓存</a></li></ul></li><li><a href=#5%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e7%9a%84%e7%94%a8%e6%88%b7%e6%8e%a5%e5%8f%a3 aria-label=5.文件系统的用户接口>5.文件系统的用户接口</a><ul><li><a href=#51-%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6 aria-label="5.1 文件描述符">5.1 文件描述符</a></li><li><a href=#52-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e6%9c%8d%e5%8a%a1 aria-label="5.2 文件系统服务">5.2 文件系统服务</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h1 id=oslab5课下基础>OS:lab5课下基础<a hidden class=anchor aria-hidden=true href=#oslab5课下基础>#</a></h1><h2 id=1-文件系统概述>1. 文件系统概述<a hidden class=anchor aria-hidden=true href=#1-文件系统概述>#</a></h2><p>​ <strong>计算机文件系统是一种存储和组织数据的方法，便于访问和查找数据。<strong>文件系统使用</strong>文件</strong>和<strong>树形目录</strong>的逻辑抽象屏蔽了底层硬盘和光盘等<strong>物理设备基于数据块</strong>进行存储和访问的复杂性。</p><ul><li><p><strong>即用户不必关心数据实际保存在硬盘/光盘的哪个数据块上，而只需要记住这个文件所属的目录和文件名。</strong></p></li><li><p><strong>在写入新数据之前，用户不必关心硬盘上哪个块是空闲的，硬盘上的存储空间管理(分配/释放)由文件系统自动完成，用户只需记住数据写入到了哪个文件</strong></p></li></ul><p>​ 常见的文件系统通常基于硬盘和光盘等块存储设备，并维护文件在设备中的物理位置。</p><p>​ 广义上，<strong>一切带标识的、在逻辑上有完整意义的字节序列都可以称为文件</strong>，文件系统将外部设备中的资源抽象为文件，从而可以统一管理外部设备，实现对数据的存储、组织、访问和修改。</p><h2 id=2-文件系统的设计与实现>2. 文件系统的设计与实现<a hidden class=anchor aria-hidden=true href=#2-文件系统的设计与实现>#</a></h2><blockquote><p>MOS是一种微内核设计</p><ul><li>将传统操作系统的文件系统移出内核</li><li>将一些内核数据暴露到用户空间</li><li>将传统操作系统的设备驱动移出内核</li></ul></blockquote><p><img alt=image-20240519144942685 loading=lazy src=/img/image-20240519144942685.png></p><h2 id=3-ide磁盘驱动>3. IDE磁盘驱动<a hidden class=anchor aria-hidden=true href=#3-ide磁盘驱动>#</a></h2><p>​ 为了在磁盘等外部设备上实现文件系统，我们必须为这些外部设备编写驱动程序。(MOS已经在<code>kern/mechine.c</code>中实现了一个简单的控制台驱动程序)</p><p>​ 本次要实现的硬盘驱动程序与已经实现的串口驱动都采用MMIO内存映射技术，并且本次编写的<strong>硬盘驱动程序完全运行在用户空间(微内核)</strong>。</p><h3 id=31-内存映射iommio>3.1 内存映射I/O(MMIO)<a hidden class=anchor aria-hidden=true href=#31-内存映射iommio>#</a></h3><p>​ 几乎每一种外设都是通过读写设备上的寄存器来进行数据通信，外设寄存器也称为<strong>I/O接口</strong>，主要用来访问I/O设备。</p><ul><li>外设寄存器主要包括控制寄存器、状态寄存器、数据寄存器，这些寄存器被<strong>映射到指定的物理地址空间</strong></li></ul><p>​ 在MIPS的内核地址空间中(kseg0/kseg1)实现了<strong>硬件级别(高位清0)的物理地址和内核虚拟地址的转换机制</strong>，其中，对于kseg1段地址的读写不经过MMU映射，且不使用高速缓存，这正是外部设备驱动所需要的。<strong>我们可以通过简单地读写某些固定的内核虚拟地址来实现驱动程序的功能。</strong></p><blockquote><p>在之前的实验中，我们曾经使用KADDR宏将一个物理地址转换为kseg0段的虚拟地址，即加上kseg0段的偏移量(0x8000_0000)</p></blockquote><p>​ <strong>在编写设备驱动时，我们需要将物理地址转换为kseg1段的内核虚拟地址，即给物理地址加上kseg1的偏移值0xA000_0000</strong></p><p>​ 以已经编写完成的串口设备驱动为例，MALTA提供的console设备基地址为0x1800_03F8，设备寄存器映射如表所示</p><p><img alt=image-20240519151254993 loading=lazy src=/img/image-20240519151254993.png></p><p>​ 例如写操作：通过向kseg1段的地址写入字符，就能在shell中看到对应的输出。</p><blockquote><p>kseg0_offset + device_op_addr_base = KSEG1 + MALTA_SERIAL_DATA</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>//写
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>printcharc</span>(<span style=color:#8be9fd>char</span> ch) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//...
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>*</span>((<span style=color:#ff79c6>volatile</span> <span style=color:#8be9fd>uint8_t</span> <span style=color:#ff79c6>*</span>)(KSEG1 <span style=color:#ff79c6>+</span> MALTA_SERIAL_DATA)) <span style=color:#ff79c6>=</span> ch;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在本次实验中，我们需要编写的IDE磁盘驱动位于用户空间，<strong>用户态进程若是直接读写内核虚拟地址会引发一个地址错误ADEL/S，故对于设备的读写必须通过系统调用实现</strong></p><ul><li><code>sys_write_dev</code>：写设备系统调用</li><li><code>sys_read_dev</code>：读设备系统调用</li></ul><blockquote><p>Exercise 5.1 kern/syscall.c中的sys_write_dev以及sys_read_dev</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_write_dev</span>(u_int va, u_int pa, u_int len) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.1: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>is_illegal_va_range</span>(va, len)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	} 
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>((pa <span style=color:#ff79c6>&gt;=</span> MALTA_IDE_BASE <span style=color:#ff79c6>&amp;&amp;</span> pa <span style=color:#ff79c6>+</span> len <span style=color:#ff79c6>&lt;</span> MALTA_IDE_BASE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>0x8</span>) <span style=color:#ff79c6>||</span> (pa <span style=color:#ff79c6>&gt;=</span> MALTA_SERIAL_BASE <span style=color:#ff79c6>&amp;&amp;</span> pa <span style=color:#ff79c6>+</span> len <span style=color:#ff79c6>&lt;</span> MALTA_SERIAL_BASE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>0x20</span>))) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (len <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>iowrite8</span>(<span style=color:#ff79c6>*</span>(<span style=color:#8be9fd>uint8_t</span> <span style=color:#ff79c6>*</span>)va,(u_long)pa);
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (len <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>iowrite16</span>(<span style=color:#ff79c6>*</span>(<span style=color:#8be9fd>uint16_t</span> <span style=color:#ff79c6>*</span>)va,(u_long)pa);
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (len <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>4</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>iowrite32</span>(<span style=color:#ff79c6>*</span>(<span style=color:#8be9fd>uint32_t</span> <span style=color:#ff79c6>*</span>)va,(u_long)pa);
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>sys_read_dev</span>(u_int va, u_int pa, u_int len) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.1: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>is_illegal_va_range</span>(va, len)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	} 
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>((pa <span style=color:#ff79c6>&gt;=</span> MALTA_IDE_BASE <span style=color:#ff79c6>&amp;&amp;</span> pa <span style=color:#ff79c6>+</span> len <span style=color:#ff79c6>&lt;</span> MALTA_IDE_BASE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>0x8</span>) <span style=color:#ff79c6>||</span> (pa <span style=color:#ff79c6>&gt;=</span> MALTA_SERIAL_BASE <span style=color:#ff79c6>&amp;&amp;</span> pa <span style=color:#ff79c6>+</span> len <span style=color:#ff79c6>&lt;</span> MALTA_SERIAL_BASE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>0x20</span>))) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (len <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>(<span style=color:#8be9fd>uint8_t</span> <span style=color:#ff79c6>*</span>) va <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ioread8</span>((u_long)pa);
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (len <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>(<span style=color:#8be9fd>uint16_t</span> <span style=color:#ff79c6>*</span>) va <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ioread16</span>((u_long)pa);
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (len <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>4</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>(<span style=color:#8be9fd>uint32_t</span> <span style=color:#ff79c6>*</span>) va <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ioread32</span>((u_long)pa);
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>这里在读写虚拟地址对应的数据时涉及到对虚拟地址对应数据的读写（先转换为指针类型再解引用）</li></ul><blockquote><p>Exercise 5.2 user/lib/syscall_lib.c中完成用户态的相应系统调用的接口</p><p>（msyscall中直接调用syscall陷入内核）</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>va, u_int dev, u_int size) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.2: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>msyscall</span>(SYS_write,va,dev,size);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>syscall_read_dev</span>(<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>va, u_int dev, u_int size) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.2: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>msyscall</span>(SYS_read,va,dev,size);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=32-ide磁盘>3.2 IDE磁盘<a hidden class=anchor aria-hidden=true href=#32-ide磁盘>#</a></h3><h4 id=321-磁盘物理结构>3.2.1 磁盘物理结构<a hidden class=anchor aria-hidden=true href=#321-磁盘物理结构>#</a></h4><ul><li><p>磁盘的物理结构</p><ul><li>扇区(sector)：磁盘盘片被划分为很多扇形的区域，这些区域叫做扇区。<strong>扇区是磁盘执行读写操作的单位，一般是512字节</strong></li><li>磁道(track)：盘片上以盘片中心为圆心，<strong>不同大小的同心圆</strong></li><li>柱面(cylinder)：硬盘中，<strong>不同盘面相同半径的磁道组成的圆柱面</strong></li><li>磁头(head)：每个磁盘有两个面，<strong>每个面都有一个磁头</strong>，当对磁盘进行读写操作时，磁头在盘面上快速移动</li></ul><p><img alt=image-20240519162659492 loading=lazy src=/img/image-20240519162659492.png></p></li></ul><h4 id=322-ide-磁盘操作>3.2.2 IDE 磁盘操作<a hidden class=anchor aria-hidden=true href=#322-ide-磁盘操作>#</a></h4><p>​ <strong>扇区(sector)是磁盘读写的基本单位</strong>，通过读写MALTA上PIIX4的特定寄存器，我们可以实现以扇区为最小单元的读写。MALTA平台上PIIX4磁盘控制器的基地址为0x1800_01f0，<strong>其I/O相关寄存器相对于该地址的偏移和对应的功能如下表</strong></p><p><img alt=image-20240519163024229 loading=lazy src=/img/image-20240519163024229.png></p><blockquote><p>在include/malta.h中定义了关于这些偏移量的宏定义</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_BASE (MALTA_PCIIO_BASE + 0x01f0)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_DATA (MALTA_IDE_BASE + 0x00)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_ERR (MALTA_IDE_BASE + 0x01)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_NSECT (MALTA_IDE_BASE + 0x02)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_LBAL (MALTA_IDE_BASE + 0x03)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_LBAM (MALTA_IDE_BASE + 0x04)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_LBAH (MALTA_IDE_BASE + 0x05)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_DEVICE (MALTA_IDE_BASE + 0x06)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_STATUS (MALTA_IDE_BASE + 0x07)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_LBA 0xE0
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_BUSY 0x80
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_CMD_PIO_READ 0x20  </span><span style=color:#6272a4>/* Read sectors with retry */</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define MALTA_IDE_CMD_PIO_WRITE 0x30 </span><span style=color:#6272a4>/* write sectors with retry */</span><span style=color:#ff79c6>
</span></span></span></code></pre></td></tr></table></div></div></blockquote><p>​ 在MOS中我们可以挂载编号为0/1的两块IDE磁盘，但实际上我们只使用到编号为0的一块磁盘。</p><p>​ 对于磁盘寻址，我们可以按照柱面-磁头-扇区(<code>Cylinder-Head-Sector, CHS</code>)的方式来定位一个扇区。这种寻址方式符合磁盘的物理结构。</p><p>​ 由于CHS模式下不方便进行寻址，**因此在实验中我们使用逻辑块寻址（Logical Block Addressing, LBA）的方式来进行扇区寻址。**在LBA模式下，IDE设备将磁盘看做一个线性的字节序列，每个扇区都有一个唯一的编号，只需要设置目标扇区编号，就可以完成磁盘的寻址。</p><p>​ <strong>在我们的实验中，扇区编号有28位，因此最多可以寻址$2^{28}$个扇区，即128GB磁盘空间。</strong></p><p><img alt=image-20240519163850732 loading=lazy src=/img/image-20240519163850732.png></p><h4 id=323-驱动程序编写>3.2.3 驱动程序编写<a hidden class=anchor aria-hidden=true href=#323-驱动程序编写>#</a></h4><p>​ 当我们在磁盘的指定位置读取或写入一个扇区时，需要调用read_sector函数<strong>将磁盘中对应的扇区的数据读到设备缓冲区</strong>中，或write_sector函数<strong>将缓冲区中的数据写入磁盘</strong>。</p><p>​ <strong>磁盘操作中，所有的地址操作都需要将物理地址转换为虚拟地址</strong>，磁盘设备的基地址对应在kseg1的内核虚拟地址为0xb80_01f0。读取流程如下图</p><p><img alt=image-20240519164649355 loading=lazy src=/img/image-20240519164649355.png></p><p>​ 由上图，在磁盘读写的过程中，我们需要反复检查IDE设备是否已经就绪。因此我们构建了一个检查IDE状态的帮手函数<code>wait_ide_ready</code>（用户态函数），用于等待IDE上的操作就绪。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>uint8_t</span> <span style=color:#50fa7b>wait_ide_ready</span>() {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>uint8_t</span> flag;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_read_dev</span>(<span style=color:#ff79c6>&amp;</span>flag, MALTA_IDE_STATUS, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> ((flag <span style=color:#ff79c6>&amp;</span> MALTA_IDE_BUSY) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>syscall_yield</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> flag;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 当IDE就绪后，就可以对他进行读写操作了。</p><ul><li><p>首先设置操作扇区的数目，我们只操作一个扇区，因此设置为1</p></li><li><p>接下来一次设置操作扇区号，<strong>本实验中的IDE设备无法一次性写入28位扇区号，因此需要单独设置扇区号的各位</strong>，在设置[27:24]位时，还需要同时设置扇区寻址模式和磁盘编号。</p></li><li><p>再次等待IDE设备就绪</p></li><li><p><strong>通过系统调用读取或写入扇区</strong>：本实验中IDE设备每次仅能读取或写入4字节，因此需要通过一个循环完成整个扇区的读取或写入，即连续相相同的地址读取或写入4字节</p></li></ul><p>​ 读取扇区：<code>read_sector</code>，读取diskno号磁盘上的secno号扇区到dst指向的地址。</p><p>​ 写入扇区：<code>write_sector</code>，将src指向的一个扇区的数据写入到diskno号磁盘的secno号扇区。</p><blockquote><p>Exercise 5.3 fs/ide.c ide_read ide_write 实现用户态下对磁盘的读写操作</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>ide_read</span>(u_int diskno, u_int secno, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>dst, u_int nsecs) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>uint8_t</span> temp;
</span></span><span style=display:flex><span>	u_int offset <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, max <span style=color:#ff79c6>=</span> nsecs <span style=color:#ff79c6>+</span> secno;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>panic_on</span>(diskno <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Read the sector in turn
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (secno <span style=color:#ff79c6>&lt;</span> max) {
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>wait_ide_ready</span>();
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 1: Write the number of operating sectors to NSECT register
</span></span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_NSECT, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 2: Write the 7:0 bits of sector number to LBAL register
</span></span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> secno <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xff</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_LBAL, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 3: Write the 15:8 bits of sector number to LBAM register
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.3: Your code here. (1/9) */</span>
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> (secno <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>8</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xff</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_LBAM, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 4: Write the 23:16 bits of sector number to LBAH register
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.3: Your code here. (2/9) */</span>
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> (secno <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>16</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xff</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_LBAH, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 5: Write the 27:24 bits of sector number, addressing mode
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>// and diskno to DEVICE register
</span></span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> ((secno <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>24</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0x0f</span>) <span style=color:#ff79c6>|</span> MALTA_IDE_LBA <span style=color:#ff79c6>|</span> (diskno <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>4</span>);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_DEVICE, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 6: Write the working mode to STATUS register
</span></span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> MALTA_IDE_CMD_PIO_READ;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_STATUS, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 7: Wait until the IDE is ready
</span></span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>wait_ide_ready</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 8: Read the data from device
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> SECT_SIZE <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>4</span>; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_read_dev</span>(dst <span style=color:#ff79c6>+</span> offset <span style=color:#ff79c6>+</span> i <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>4</span>, MALTA_IDE_DATA, <span style=color:#bd93f9>4</span>));
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 9: Check IDE status
</span></span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_read_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_STATUS, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		offset <span style=color:#ff79c6>+=</span> SECT_SIZE;
</span></span><span style=display:flex><span>		secno <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>ide_write</span>(u_int diskno, u_int secno, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>src, u_int nsecs) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>uint8_t</span> temp;
</span></span><span style=display:flex><span>	u_int offset <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, max <span style=color:#ff79c6>=</span> nsecs <span style=color:#ff79c6>+</span> secno;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>panic_on</span>(diskno <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Write the sector in turn
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (secno <span style=color:#ff79c6>&lt;</span> max) {
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>wait_ide_ready</span>();
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 1: Write the number of operating sectors to NSECT register
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.3: Your code here. (3/9) */</span>
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_NSECT, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 2: Write the 7:0 bits of sector number to LBAL register
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.3: Your code here. (4/9) */</span>
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> secno <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xff</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_LBAL, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 3: Write the 15:8 bits of sector number to LBAM register
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.3: Your code here. (5/9) */</span>
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> (secno <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>8</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xff</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_LBAM, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 4: Write the 23:16 bits of sector number to LBAH register
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.3: Your code here. (6/9) */</span>
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> (secno <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>16</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0xff</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_LBAH, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 5: Write the 27:24 bits of sector number, addressing mode
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>// and diskno to DEVICE register
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.3: Your code here. (7/9) */</span>
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> ((secno <span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#bd93f9>24</span>) <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0x0f</span>) <span style=color:#ff79c6>|</span> MALTA_IDE_LBA <span style=color:#ff79c6>|</span> (diskno <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>4</span>);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_DEVICE, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 6: Write the working mode to STATUS register
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.3: Your code here. (8/9) */</span>
</span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> MALTA_IDE_CMD_PIO_WRITE;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_STATUS, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 7: Wait until the IDE is ready
</span></span></span><span style=display:flex><span>		temp <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>wait_ide_ready</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 8: Write the data to device
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> SECT_SIZE <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>4</span>; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>			<span style=color:#6272a4>/* Exercise 5.3: Your code here. (9/9) */</span>
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_write_dev</span>(src <span style=color:#ff79c6>+</span> offset <span style=color:#ff79c6>+</span> i <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>4</span>, MALTA_IDE_DATA, <span style=color:#bd93f9>4</span>));
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Step 9: Check IDE status
</span></span></span><span style=display:flex><span>		<span style=color:#50fa7b>panic_on</span>(<span style=color:#50fa7b>syscall_read_dev</span>(<span style=color:#ff79c6>&amp;</span>temp, MALTA_IDE_STATUS, <span style=color:#bd93f9>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		offset <span style=color:#ff79c6>+=</span> SECT_SIZE;
</span></span><span style=display:flex><span>		secno <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=4-文件系统结构>4. 文件系统结构<a hidden class=anchor aria-hidden=true href=#4-文件系统结构>#</a></h2><h3 id=41-磁盘文件系统布局>4.1 磁盘文件系统布局<a hidden class=anchor aria-hidden=true href=#41-磁盘文件系统布局>#</a></h3><p>​ 如下图</p><p><img alt=image-20240520155728319 loading=lazy src=/img/image-20240520155728319.png></p><p>​ 图中出现的Block是磁盘块。<strong>不同于扇区，磁盘块是一个虚拟概念，是操作系统与磁盘交互的最小单位，操作系统将相邻的扇区组合在一起，形成磁盘块进行整体操作</strong>，减小了扇区过多带来的寻址困难，<strong>磁盘块的大小由操作系统决定</strong>，一般由2的幂次个扇区构成；而扇区是真实存在的，是磁盘读写的基本单位，<strong>与操作系统无关</strong>。</p><p>​ MOS操作系统把磁盘<strong>最开始的一个磁盘块(4096字节)当做引导扇区和分区表</strong>使用，接下来的一个磁盘块为超级块(<code>Super Block</code>)，用来表述<strong>文件系统的基本信息</strong>，如Magic Number、磁盘大小以及根目录的位置。</p><p>​ MOS中超级块以结构体的方式进行定义</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Super {
</span></span><span style=display:flex><span>    u_int s_magic; <span style=color:#6272a4>// magic number : FS_MAGIC
</span></span></span><span style=display:flex><span>    u_int s_nblocks; <span style=color:#6272a4>// total number of blocks on disk (1024)
</span></span></span><span style=display:flex><span>    <span style=color:#ff79c6>struct</span> File s_root; <span style=color:#6272a4>// root dictionary node
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>不同于lab2/lab3中使用<strong>空闲链表法</strong>管理空闲内存资源和进程控制块，在文件系统中我们使用<strong>位图</strong>来管理空闲的磁盘资源</p></blockquote><p>​ 在文件系统中，我们使用位图法来管理空闲的磁盘资源，用一个二进制位bit标识磁盘中的一个磁盘块的使用情况(<strong>1表示空闲，0表示占用</strong>)。</p><p>​ <code>tools/fsformat.c</code>中定义了创建文件系统镜像的工具，其中init_disk函数将所有的磁盘块都标记为空闲块（<strong>tools文件夹下的程序都是运行在linux环境中，而不是MOS</strong>）</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init_disk</span>() {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> i, diff;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Mark boot sector block.
</span></span></span><span style=display:flex><span>	disk[<span style=color:#bd93f9>0</span>].type <span style=color:#ff79c6>=</span> BLOCK_BOOT;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Initialize boundary.
</span></span></span><span style=display:flex><span>	nbitblock <span style=color:#ff79c6>=</span> (NBLOCK <span style=color:#ff79c6>+</span> BLOCK_SIZE_BIT <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>/</span> BLOCK_SIZE_BIT;
</span></span><span style=display:flex><span>	nextbno <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span> <span style=color:#ff79c6>+</span> nbitblock;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Initialize bitmap blocks.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> nbitblock; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>		disk[<span style=color:#bd93f9>2</span> <span style=color:#ff79c6>+</span> i].type <span style=color:#ff79c6>=</span> BLOCK_BMAP;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> nbitblock; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>memset</span>(disk[<span style=color:#bd93f9>2</span> <span style=color:#ff79c6>+</span> i].data, <span style=color:#bd93f9>0xff</span>, BLOCK_SIZE);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (NBLOCK <span style=color:#ff79c6>!=</span> nbitblock <span style=color:#ff79c6>*</span> BLOCK_SIZE_BIT) {
</span></span><span style=display:flex><span>		diff <span style=color:#ff79c6>=</span> NBLOCK <span style=color:#ff79c6>%</span> BLOCK_SIZE_BIT <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>8</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>memset</span>(disk[<span style=color:#bd93f9>2</span> <span style=color:#ff79c6>+</span> (nbitblock <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>)].data <span style=color:#ff79c6>+</span> diff, <span style=color:#bd93f9>0x00</span>, BLOCK_SIZE <span style=color:#ff79c6>-</span> diff);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 3: Initialize super block.
</span></span></span><span style=display:flex><span>	disk[<span style=color:#bd93f9>1</span>].type <span style=color:#ff79c6>=</span> BLOCK_SUPER;
</span></span><span style=display:flex><span>	super.s_magic <span style=color:#ff79c6>=</span> FS_MAGIC;
</span></span><span style=display:flex><span>	super.s_nblocks <span style=color:#ff79c6>=</span> NBLOCK;
</span></span><span style=display:flex><span>	super.s_root.f_type <span style=color:#ff79c6>=</span> FTYPE_DIR;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>strcpy</span>(super.s_root.f_name, <span style=color:#f1fa8c>&#34;/&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>nbitblock表示为了用位图标识整个磁盘上所有块的使用情况所需要的<strong>磁盘块的(bitblock)的数量</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>nbitblock <span style=color:#ff79c6>=</span> (NBLOCK <span style=color:#ff79c6>+</span> BLOCK_SIZE_BIT <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>/</span> BLOCK_SIZE_BIT;
</span></span></code></pre></td></tr></table></div></div><ul><li>这个表达式实际上具有一个整数除法向上取整的效果</li><li>NBLOCK：磁盘块的数量：1024</li><li>BLOCK_SIZE_BIT：每个磁盘块的bit大小：4096 * 8</li></ul></li><li><p>disk[0]与disk[1]我们有特殊作用，不进行Bitmap初始化故遍历从disk[i+2]开始</p></li><li><p>将所有位图块的每一位都设为1，表示处于空闲状态</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> nbitblock; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>memset</span>(disk[<span style=color:#bd93f9>2</span> <span style=color:#ff79c6>+</span> i].data, <span style=color:#bd93f9>0xff</span>, BLOCK_SIZE);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div></li><li><p>如果位图还有剩余，<strong>不能将最后一个位图块中的靠后一部分内容标记为空闲，因为这些磁盘块实际上并不存在</strong>，是不可使用的。因此还要将这些剩下的部分设为0</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (NBLOCK <span style=color:#ff79c6>!=</span> nbitblock <span style=color:#ff79c6>*</span> BLOCK_SIZE_BIT) {
</span></span><span style=display:flex><span>		diff <span style=color:#ff79c6>=</span> NBLOCK <span style=color:#ff79c6>%</span> BLOCK_SIZE_BIT <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>8</span>;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>memset</span>(disk[<span style=color:#bd93f9>2</span> <span style=color:#ff79c6>+</span> (nbitblock <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>)].data <span style=color:#ff79c6>+</span> diff, <span style=color:#bd93f9>0x00</span>, BLOCK_SIZE <span style=color:#ff79c6>-</span> diff);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div></li></ul><p>​ 相应的，在MOS操作系统中，文件系统也需要根据位图来判断和标记磁盘的使用情况。fs/fs.c中的block_is_free函数就用来通过位图中的特定位来判断指定的磁盘块是否被占用。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>block_is_free</span>(u_int blockno) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (super <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> blockno <span style=color:#ff79c6>&gt;=</span> super<span style=color:#ff79c6>-&gt;</span>s_nblocks) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (bitmap[blockno <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>32</span>] <span style=color:#ff79c6>&amp;</span> (<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>&lt;&lt;</span> (blockno <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>32</span>))) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>这里的super是指向磁盘中<code>Super Block</code>的指针，指针值为0，<strong>即为零指针，没有存储任何内存地址的指针</strong></p></li><li><p><strong>这里简单对bitmap涉及到的数据结构进行解释</strong></p><ul><li><p>bitmap定义为</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>uint32_t</span> <span style=color:#ff79c6>*</span>bitmap;
</span></span></code></pre></td></tr></table></div></div><p>我们可以把他看做一个32位int类型的数组看待</p></li><li><p>这样我们的<strong>位图实际上是一个二维的结构</strong>，每一个数组元素相当于一行，一行中有32个元素</p></li><li><p>行号：<code>blockno / 32</code> | 列号 : <code>blockno % 32</code></p></li><li><p>检查二维结构中对应的位置是否为1</p></li></ul></li></ul><blockquote><p>Exercise 5.4 free_block</p><p>回收一个磁盘块，更改bitmap图中的标志位为1</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>free_block</span>(u_int blockno) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// You can refer to the function &#39;block_is_free&#39; above.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: If &#39;blockno&#39; is invalid (0 or &gt;= the number of blocks in &#39;super&#39;), return.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.4: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (blockno <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> blockno <span style=color:#ff79c6>&gt;=</span> super<span style=color:#ff79c6>-&gt;</span>s_nblocks) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Set the flag bit of &#39;blockno&#39; in &#39;bitmap&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Hint: Use bit operations to update the bitmap, such as b[n / W] |= 1 &lt;&lt; (n % W).
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.4: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>	bitmap[blockno <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>32</span>] <span style=color:#ff79c6>|=</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>&lt;&lt;</span> (blockno <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>32</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=42-文件系统详细结构>4.2 文件系统详细结构<a hidden class=anchor aria-hidden=true href=#42-文件系统详细结构>#</a></h3><p>​ MOS操作系统中使用文件控制块(File结构体)管理文件。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> File {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>char</span> f_name[MAXNAMELEN]; <span style=color:#6272a4>// filename; max length is 128
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>uint32_t</span> f_size;	 <span style=color:#6272a4>// file size in bytes
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>uint32_t</span> f_type;	 <span style=color:#6272a4>// file type
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>uint32_t</span> f_direct[NDIRECT];
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>uint32_t</span> f_indirect;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>f_dir; <span style=color:#6272a4>// the pointer to the dir where this file is in, valid only in memory.
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>char</span> f_pad[FILE_STRUCT_SIZE <span style=color:#ff79c6>-</span> MAXNAMELEN <span style=color:#ff79c6>-</span> (<span style=color:#bd93f9>3</span> <span style=color:#ff79c6>+</span> NDIRECT) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>4</span> <span style=color:#ff79c6>-</span> <span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>)];
</span></span><span style=display:flex><span>} <span style=color:#50fa7b>__attribute__</span>((<span style=color:#50fa7b>aligned</span>(<span style=color:#bd93f9>4</span>), packed));
</span></span></code></pre></td></tr></table></div></div><ul><li><p><code>f_type</code>：普通文件/目录</p></li><li><p><code>f_direct[NDIRECT]</code>：文件的直接指针，每个文件控制块设有10个直接指针，<strong>用来记录文件的数据块在磁盘上的位置</strong>，每个磁盘块的大小为4KB，<strong>也就是说这10个直接指针能表示最大为40KB的文件</strong></p></li><li><p><code>f_indirect</code>：文件的间接指针，当文件的大小超过40KB时，<strong>f_indirect指向一个间接磁盘块，用来存储指向文件内容的磁盘块的指针</strong>(为了简化计算，我们不使用间接磁盘块的前10个指针)</p><blockquote><p>MOS 中只有一级间接指针域，实际的操作系统中往往是多级的，这是一种简化</p></blockquote></li><li><p><code>f_dir</code>指向文件所属的文件目录</p></li><li><p><code>f_pad</code>为了让整数个文件结构体占用一个磁盘块，填充结构体(256字节)中剩下的字节</p></li></ul><p>​ <strong>对普通的文件来说，其指向的磁盘块存储着文件内容，而对于目录文件来说，其指向的磁盘块存储着各个文件对应的文件控制块。</strong></p><p><img alt=image-20240520170856467 loading=lazy src=/img/image-20240520170856467.png></p><ul><li>当我们要查找某个文件时<ul><li>首先从超级块中读取根目录的文件控制块</li><li>然后沿着目标路径，挨个查看当前目录所包含的文件是否与下一级目标文件同名</li><li>找到最终文件</li></ul></li></ul><blockquote><p>ps : 有关镜像文件</p><ul><li>所谓镜像文件其实就是将特定的一系列文件按照一定的格式制作成单一的文件(类似于压缩包)</li><li>例如操作系统、游戏等，最大的特点是可以被特定的软件识别并直接刻录到光盘上</li></ul></blockquote><p>​ 我们通过fsformat(tools/fsformat.c编译而来)程序来创建一个磁盘镜像文件<code>target/fs.img</code>。通过观察头文件和tools/Makefile，我们发现fsformat.c的编译过程与其他文件有所不同，<strong>其使用的是Linux下的gcc编译器，而非交叉编译器</strong>，编译生成的fsformat运行于Linux宿主机上，专门用于创建磁盘镜像文件。<strong>生成的镜像文件fs.img可以模拟与真实的磁盘文件设备的交互。</strong></p><blockquote><p>Exercise 5.5 file_create</p><p>为目录中增加一个文件(文件控制块)</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span><span style=color:#50fa7b>create_file</span>(<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>dirf) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> nblk <span style=color:#ff79c6>=</span> dirf<span style=color:#ff79c6>-&gt;</span>f_size <span style=color:#ff79c6>/</span> BLOCK_SIZE;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Iterate through all existing blocks in the directory.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> nblk; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>int</span> bno; <span style=color:#6272a4>// the block number
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>// If the block number is in the range of direct pointers (NDIRECT), get the &#39;bno&#39;
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>// directly from &#39;f_direct&#39;. Otherwise, access the indirect block on &#39;disk&#39; and get
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>// the &#39;bno&#39; at the index.
</span></span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.5: Your code here. (1/3) */</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>&lt;</span> NDIRECT) {
</span></span><span style=display:flex><span>			bno <span style=color:#ff79c6>=</span> dirf<span style=color:#ff79c6>-&gt;</span>f_direct[i];
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>			bno <span style=color:#ff79c6>=</span> ((<span style=color:#8be9fd>uint32_t</span> <span style=color:#ff79c6>*</span>)disk[dirf<span style=color:#ff79c6>-&gt;</span>f_indirect].data)[i];
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Get the directory block using the block number.
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>blk <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>)(disk[bno].data);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Iterate through all &#39;File&#39;s in the directory block.
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>f <span style=color:#ff79c6>=</span> blk; f <span style=color:#ff79c6>&lt;</span> blk <span style=color:#ff79c6>+</span> FILE2BLK; <span style=color:#ff79c6>++</span>f) {
</span></span><span style=display:flex><span>			<span style=color:#6272a4>// If the first byte of the file name is null, the &#39;File&#39; is unused.
</span></span></span><span style=display:flex><span>			<span style=color:#6272a4>// Return a pointer to the unused &#39;File&#39;.
</span></span></span><span style=display:flex><span>			<span style=color:#6272a4>/* Exercise 5.5: Your code here. (2/3) */</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (f<span style=color:#ff79c6>-&gt;</span>f_name[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;\0&#39;</span>) {
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> f;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: If no unused file is found, allocate a new block using &#39;make_link_block&#39; function
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// and return a pointer to the new block on &#39;disk&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.5: Your code here. (3/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> (<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>)(disk[<span style=color:#50fa7b>make_link_block</span>(dirf, nblk)].data);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>如果当前目录下有空闲的文件控制块就使用空闲的，没有就新分配一个</li><li>首先计算当前目录下有多少个磁盘块，对应的块号通过区分NDIRECT查找<ul><li>*<em>在查询块号时需要注意一个小点：在块号大于10时，我们需要到间接磁盘中查询，我们的块号是32位的，而磁盘中数据的存储格式(disk[].data是一个4096B大小的每个元素为1字节大小的数组)，因此我们不能直接用i做索引，这样只能取出一个一字节大小的数据，我们需要把数组类型转换为32位，((uint32_t <em>)disk[].data)[i]</em></em></li></ul></li><li>然后通过块号拿到对应的磁盘块，遍历磁盘块中存储的所有文件控制块，如果文件名为空，即为空闲，返回该文件控制块</li><li>如果没有就新分配一个磁盘块并返回(<code>make_link_block</code>)</li></ul><blockquote><p>请阅读tools/fsformat.c 和fs/Makefile，掌握如何将文件和目录按照文件系统的格式写入磁盘，了解文件系统结构的 具体细节，学会添加自定义文件进入磁盘镜像。</p></blockquote><p>​ fsformat.c中将文件系统写入磁盘的主函数如下，该函数对文件类型做了区分，是目录或是普通文件。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>(<span style=color:#8be9fd>int</span> argc, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>**</span>argv) {
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>static_assert</span>(<span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>struct</span> File) <span style=color:#ff79c6>==</span> FILE_STRUCT_SIZE);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>init_disk</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (argc <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>3</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>fprintf</span>(stderr, <span style=color:#f1fa8c>&#34;Usage: fsformat &lt;img-file&gt; [files or directories]...</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>; i <span style=color:#ff79c6>&lt;</span> argc; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>name <span style=color:#ff79c6>=</span> argv[i];
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>struct</span> stat stat_buf;
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>int</span> r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>stat</span>(name, <span style=color:#ff79c6>&amp;</span>stat_buf);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>assert</span>(r <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>S_ISDIR</span>(stat_buf.st_mode)) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;writing directory &#39;%s&#39; recursively into disk</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, name);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>write_directory</span>(<span style=color:#ff79c6>&amp;</span>super.s_root, name);
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>S_ISREG</span>(stat_buf.st_mode)) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>printf</span>(<span style=color:#f1fa8c>&#34;writing regular file &#39;%s&#39; into disk</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, name);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>write_file</span>(<span style=color:#ff79c6>&amp;</span>super.s_root, name);
</span></span><span style=display:flex><span>		} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>fprintf</span>(stderr, <span style=color:#f1fa8c>&#34;&#39;%s&#39; has illegal file mode %o</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, name, stat_buf.st_mode);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>flush_bitmap</span>();
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>finish_fs</span>(argv[<span style=color:#bd93f9>1</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>需要注意的是，在以下两个功能函数中，我们使用到了用户编程的POSIX接口</p></blockquote><p>​ 在以上代码中，将目录写入磁盘镜像的功能函数为<code>write_directory</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>write_directory</span>(<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>dirf, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path) {
</span></span><span style=display:flex><span>	DIR <span style=color:#ff79c6>*</span>dir <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>opendir</span>(path);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (dir <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>perror</span>(<span style=color:#f1fa8c>&#34;opendir&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>pdir <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>create_file</span>(dirf);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>strncpy</span>(pdir<span style=color:#ff79c6>-&gt;</span>f_name, <span style=color:#50fa7b>basename</span>(path), MAXNAMELEN <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (pdir<span style=color:#ff79c6>-&gt;</span>f_name[MAXNAMELEN <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>fprintf</span>(stderr, <span style=color:#f1fa8c>&#34;file name is too long: %s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, path);
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// File already created, no way back from here.
</span></span></span><span style=display:flex><span>		<span style=color:#50fa7b>exit</span>(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	pdir<span style=color:#ff79c6>-&gt;</span>f_type <span style=color:#ff79c6>=</span> FTYPE_DIR;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>struct</span> dirent <span style=color:#ff79c6>*</span>e; (e <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>readdir</span>(dir)) <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>NULL</span>;) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strcmp</span>(e<span style=color:#ff79c6>-&gt;</span>d_name, <span style=color:#f1fa8c>&#34;.&#34;</span>) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>strcmp</span>(e<span style=color:#ff79c6>-&gt;</span>d_name, <span style=color:#f1fa8c>&#34;..&#34;</span>) <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>			<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>buf <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>malloc</span>(<span style=color:#50fa7b>strlen</span>(path) <span style=color:#ff79c6>+</span> <span style=color:#50fa7b>strlen</span>(e<span style=color:#ff79c6>-&gt;</span>d_name) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>sprintf</span>(buf, <span style=color:#f1fa8c>&#34;%s/%s&#34;</span>, path, e<span style=color:#ff79c6>-&gt;</span>d_name);
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (e<span style=color:#ff79c6>-&gt;</span>d_type <span style=color:#ff79c6>==</span> DT_DIR) {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>write_directory</span>(pdir, buf);
</span></span><span style=display:flex><span>			} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#50fa7b>write_file</span>(pdir, buf);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>free</span>(buf);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>closedir</span>(dir);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在以上代码中，将普通文件写入磁盘镜像的功能函数为<code>write_file</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>// Write file to disk under specified dir.
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>write_file</span>(<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>dirf, <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> iblk <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, r <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, n <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>sizeof</span>(disk[<span style=color:#bd93f9>0</span>].data);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>target <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>create_file</span>(dirf);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* in case `create_file` is&#39;t filled */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (target <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> fd <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>open</span>(path, O_RDONLY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Get file name with no path prefix.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>fname <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>strrchr</span>(path, <span style=color:#f1fa8c>&#39;/&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (fname) {
</span></span><span style=display:flex><span>		fname<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		fname <span style=color:#ff79c6>=</span> path;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>strcpy</span>(target<span style=color:#ff79c6>-&gt;</span>f_name, fname);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	target<span style=color:#ff79c6>-&gt;</span>f_size <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>lseek</span>(fd, <span style=color:#bd93f9>0</span>, SEEK_END);
</span></span><span style=display:flex><span>	target<span style=color:#ff79c6>-&gt;</span>f_type <span style=color:#ff79c6>=</span> FTYPE_REG;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Start reading file.
</span></span></span><span style=display:flex><span>	<span style=color:#50fa7b>lseek</span>(fd, <span style=color:#bd93f9>0</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> ((r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>read</span>(fd, disk[nextbno].data, n)) <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>save_block_link</span>(target, iblk<span style=color:#ff79c6>++</span>, <span style=color:#50fa7b>next_block</span>(BLOCK_DATA));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>close</span>(fd); <span style=color:#6272a4>// Close file descriptor.
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 下面分析fs中Makefile制作磁盘镜像的命令</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#50fa7b>image</span><span style=color:#ff79c6>:</span> <span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>tools_dir</span><span style=color:#ff79c6>)</span>/fsformat
</span></span><span style=display:flex><span>	dd <span style=color:#ff79c6>if</span><span style=color:#ff79c6>=</span>/dev/zero <span style=color:#8be9fd;font-style:italic>of</span><span style=color:#ff79c6>=</span>../target/fs.img <span style=color:#8be9fd;font-style:italic>bs</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>count</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1024</span> 2&gt;/dev/null
</span></span><span style=display:flex><span>	dd <span style=color:#ff79c6>if</span><span style=color:#ff79c6>=</span>/dev/zero <span style=color:#8be9fd;font-style:italic>of</span><span style=color:#ff79c6>=</span>../target/empty.img <span style=color:#8be9fd;font-style:italic>bs</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>count</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1024</span> 2&gt;/dev/null
</span></span><span style=display:flex><span>	<span style=color:#6272a4># using awk to remove paths with identical basename from FSIMGFILES</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>$(</span>tools_dir<span style=color:#ff79c6>)</span>/fsformat ../target/fs.img <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span>		<span style=color:#8be9fd;font-style:italic>$$</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>printf</span> <span style=color:#f1fa8c>&#39;%s\n&#39;</span> <span style=color:#ff79c6>$(</span>FSIMGFILES<span style=color:#ff79c6>)</span> | awk -F/ <span style=color:#f1fa8c>&#39;{ ns[$$NF]=$$0 } END { for (n in ns) { print ns[n] } }&#39;</span><span style=color:#ff79c6>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>可以看出制作磁盘镜像fs.img是在Makefile中通过image这个target完成的，使用已经编译好的fsformat程序，传入参数还不清楚&mldr;</li></ul><h3 id=43-块缓存>4.3 块缓存<a hidden class=anchor aria-hidden=true href=#43-块缓存>#</a></h3><p>​ <strong>块缓存是指借助虚拟内存来实现磁盘块缓存的设计</strong>，MOS操作系统中，文件系统服务是一个<strong>用户进程</strong>，一个进程可以拥有4GB的虚拟内存空间，将<code>DISKMAP</code>到<code>DISKMAP+DISKMAX</code>这一段虚拟地址空间作为缓冲区，当磁盘读入内存时，用来映射相关的页。</p><p>​ 为了建立起磁盘地址空间和进程虚拟地址空间之间的缓存映射，我们采用的设计如图所示</p><p><img alt=image-20240520191428089 loading=lazy src=/img/image-20240520191428089.png></p><blockquote><p>Exercise 5.6 disk_addr函数计算指定磁盘块对应的虚存地址</p><p>即根据一个块的序号，计算这一磁盘块对应的虚存的起始地址</p><p>Hint:我们已经知道，第一块磁盘被映射到DISKMAP，即起始虚拟地址为DISKMAP</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>disk_addr</span>(u_int blockno) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.6: Your code here. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> (<span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span>)(DISKMAP <span style=color:#ff79c6>+</span> blockno <span style=color:#ff79c6>*</span> BLOCK_SIZE);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Exercise 5.7 map_block | unmap_block</p><p>map_block：当一个磁盘块的内容载入到内存时，需要为之分配对应的物理内存，map_block完成了这一功能：检查指定的磁盘块是否已经映射到内存，如果没有， 分配一页内存来保存磁盘上的数据；相应地，完成unmap_block函数，用于解除磁盘块和 物理内存之间的映射关系，回收内存。</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>// Overview:
</span></span></span><span style=display:flex><span><span style=color:#6272a4>//  Allocate a page to cache the disk block.
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>map_block</span>(u_int blockno) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: If the block is already mapped in cache, return 0.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Hint: Use &#39;block_is_mapped&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.7: Your code here. (1/5) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>block_is_mapped</span>(blockno)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Alloc a page in permission &#39;PTE_D&#39; via syscall.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Hint: Use &#39;disk_addr&#39; for the virtual address.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.7: Your code here. (2/5) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>syscall_mem_alloc</span>(<span style=color:#bd93f9>0</span>,<span style=color:#50fa7b>disk_addr</span>(blockno),PTE_D);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Overview:
</span></span></span><span style=display:flex><span><span style=color:#6272a4>//  Unmap a disk block in cache.
</span></span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>unmap_block</span>(u_int blockno) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Get the mapped address of the cache page of this block using &#39;block_is_mapped&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>va;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.7: Your code here. (3/5) */</span>
</span></span><span style=display:flex><span>	va <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>block_is_mapped</span>(blockno);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: If this block is used (not free) and dirty in cache, write it back to the disk
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// first.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Hint: Use &#39;block_is_free&#39;, &#39;block_is_dirty&#39; to check, and &#39;write_block&#39; to sync.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.7: Your code here. (4/5) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#50fa7b>block_is_free</span>(blockno) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>block_is_dirty</span>(blockno)) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>write_block</span>(blockno);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 3: Unmap the virtual address via syscall.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.7: Your code here. (5/5) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>syscall_mem_unmap</span>(<span style=color:#bd93f9>0</span>,va);
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>user_assert</span>(<span style=color:#ff79c6>!</span><span style=color:#50fa7b>block_is_mapped</span>(blockno));
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>需要使用用户态的系统调用函数syscall_*进行内存的映射和解除映射</li></ul><p>​ <code>read_block</code>和<code>write_block</code>函数用于读写磁盘块，<code>read_block</code>函数将制定编号的磁盘块读入到内存中，首先检查这块磁盘块是否已经在内存中，如果不在，先分配一页物理内存，然后调用ide_read函数来读取磁盘上的数据到对应的虚拟地址。</p><p>​ <code>file_get_block</code>函数用于将某个指定的文件指向的磁盘块读入内存</p><ul><li>首先为即将读入内存的磁盘块分配物理内存</li><li>然后使用<code>read_block</code>函数将磁盘内容以块为单位读入内存中的相应位置</li></ul><blockquote><p>Exercise 5.8 dir_lookup 查找某个目录下是否存在指定的文件</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>dir_lookup</span>(<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>dir, <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>name, <span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>**</span>file) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Calculate the number of blocks in &#39;dir&#39; via its size.
</span></span></span><span style=display:flex><span>	u_int nblock;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.8: Your code here. (1/3) */</span>
</span></span><span style=display:flex><span>	nblock <span style=color:#ff79c6>=</span> dir<span style=color:#ff79c6>-&gt;</span>f_size <span style=color:#ff79c6>/</span> BLOCK_SIZE;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Iterate through all blocks in the directory.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> nblock; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Read the i&#39;th block of &#39;dir&#39; and get its address in &#39;blk&#39; using &#39;file_get_block&#39;.
</span></span></span><span style=display:flex><span>		<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>blk;
</span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.8: Your code here. (2/3) */</span>
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>file_get_block</span>(dir, i, <span style=color:#ff79c6>&amp;</span>blk));
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>files <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>)blk;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// Find the target among all &#39;File&#39;s in this block.
</span></span></span><span style=display:flex><span>		<span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>struct</span> File <span style=color:#ff79c6>*</span>f <span style=color:#ff79c6>=</span> files; f <span style=color:#ff79c6>&lt;</span> files <span style=color:#ff79c6>+</span> FILE2BLK; <span style=color:#ff79c6>++</span>f) {
</span></span><span style=display:flex><span>			<span style=color:#6272a4>// Compare the file name against &#39;name&#39; using &#39;strcmp&#39;.
</span></span></span><span style=display:flex><span>			<span style=color:#6272a4>// If we find the target file, set &#39;*file&#39; to it and set up its &#39;f_dir&#39;
</span></span></span><span style=display:flex><span>			<span style=color:#6272a4>// field.
</span></span></span><span style=display:flex><span>			<span style=color:#6272a4>/* Exercise 5.8: Your code here. (3/3) */</span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strcmp</span>(name, f<span style=color:#ff79c6>-&gt;</span>f_name) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>*</span>file <span style=color:#ff79c6>=</span> f;
</span></span><span style=display:flex><span>				f<span style=color:#ff79c6>-&gt;</span>f_dir <span style=color:#ff79c6>=</span> dir;
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_NOT_FOUND;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>通过strcmp比对文件名</li></ul><blockquote><p>文件系统结构部分的函数调用参考</p><p><img alt=image-20240520195606539 loading=lazy src=/img/image-20240520195606539.png></p></blockquote><h2 id=5文件系统的用户接口>5.文件系统的用户接口<a hidden class=anchor aria-hidden=true href=#5文件系统的用户接口>#</a></h2><blockquote><p>在文件系统建立之后，还需要向用户提供相关的使用接口，MOS操作系统内核是微内核设计，文件系统属于用户态进程，在其他进程与文件系统交互的过程中，涉及到进程通信问题</p></blockquote><h3 id=51-文件描述符>5.1 文件描述符<a hidden class=anchor aria-hidden=true href=#51-文件描述符>#</a></h3><blockquote><p>fd : File Descripter</p><p>文件描述符是系统给用户提供的整数，用于其在描述符表(Descripter Table)中进行索引，我们在作为操作系统的使用者进行文件IO编程时</p><ul><li>使用open在描述符表(FDTABLE)的指定位置存放被打开的文件的信息</li><li>使用close将描述符表中制定位置的文件信息释放</li><li>在write和read时修改描述符表指定位置的文件信息</li><li><strong>指定位置即为文件描述符fd</strong></li></ul></blockquote><p>​ 当用户进程试图打开一个文件时，文件系统服务进程需要一个文件描述符来存储文件的基本信息和用户进程中关于文件的状态，同时，文件描述符也起到描述用户对于文件操作的作用。</p><p>​ 当用户进程向文件系统发送打开文件的请求时，文件系统进程会将这些基本信息记录在内存中，然后由操作系统将用户进程请求的地址映射到同一个存储了文件描述符的物理页上。<strong>因此一个文件描述符至少需要独占一页的空间</strong>。当用户进程获取了文件大小等基本信息后，再次向文件系统发送请求将文件内容映射到指定空间中。</p><blockquote><p>关于两个结构体之间的指针类型转换</p><p>在file.c中，我们发现很多函数中都会将一个struct Fd*类型的指针转换为struct Filefd *类型的指针，这是C语言中的强制类型转换。</p><p><strong>强制类型转换不改变指针的值，只是改变程序对地址处数据的解释方式(指向的数据类型)</strong></p><p>两个结构体的定义如下</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Fd {
</span></span><span style=display:flex><span>	u_int fd_dev_id;
</span></span><span style=display:flex><span>	u_int fd_offset;
</span></span><span style=display:flex><span>	u_int fd_omode;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#ff79c6>struct</span> Filefd {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Fd f_fd;
</span></span><span style=display:flex><span>	u_int f_fileid;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> File f_file;
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>Filefd结构体中第一个成员就是fd，因此指向Filefd的指针同样指向这个Fd的起始位置，可以进行转换</p></blockquote><blockquote><p>Exercise 5.9 open 打开文件或目录</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>open</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path, <span style=color:#8be9fd>int</span> mode) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> r;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Alloc a new &#39;Fd&#39; using &#39;fd_alloc&#39; in fd.c.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Hint: return the error code if failed.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>fd;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.9: Your code here. (1/5) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>fd_alloc</span>(<span style=color:#ff79c6>&amp;</span>fd));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Prepare the &#39;fd&#39; using &#39;fsipc_open&#39; in fsipc.c.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.9: Your code here. (2/5) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>fsipc_open</span>(path, mode, fd));
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 3: Set &#39;va&#39; to the address of the page where the &#39;fd&#39;&#39;s data is cached, using
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// &#39;fd2data&#39;. Set &#39;size&#39; and &#39;fileid&#39; correctly with the value in &#39;fd&#39; as a &#39;Filefd&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>va;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Filefd <span style=color:#ff79c6>*</span>ffd;
</span></span><span style=display:flex><span>	u_int size, fileid;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.9: Your code here. (3/5) */</span>
</span></span><span style=display:flex><span>	va <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>fd2data</span>(fd);
</span></span><span style=display:flex><span>	ffd <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> Filefd <span style=color:#ff79c6>*</span>)fd;
</span></span><span style=display:flex><span>	size <span style=color:#ff79c6>=</span> ffd<span style=color:#ff79c6>-&gt;</span>f_file.f_size;
</span></span><span style=display:flex><span>	fileid <span style=color:#ff79c6>=</span> ffd<span style=color:#ff79c6>-&gt;</span>f_fileid;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 4: Map the file content using &#39;fsipc_map&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> size; i <span style=color:#ff79c6>+=</span> PTMAP) {
</span></span><span style=display:flex><span>		<span style=color:#6272a4>/* Exercise 5.9: Your code here. (4/5) */</span>
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>try</span>(<span style=color:#50fa7b>fsipc_map</span>(fileid, i, va <span style=color:#ff79c6>+</span> i));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 5: Return the number of file descriptor using &#39;fd2num&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.9: Your code here. (5/5) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>fd2num</span>(fd);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>对关键函数进行解读：该函数的作用是打开一个文件或目录</p><ul><li><p>首先为要打开的文件或目录(本质上都是文件)分配一个文件描述符，观察<code>fd_alloc</code>的逻辑</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>fd_alloc</span>(<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>**</span>fd) {
</span></span><span style=display:flex><span>	u_int va;
</span></span><span style=display:flex><span>	u_int fdno;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>for</span> (fdno <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; fdno <span style=color:#ff79c6>&lt;</span> MAXFD <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>; fdno<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>		va <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>INDEX2FD</span>(fdno);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> ((vpd[va <span style=color:#ff79c6>/</span> PDMAP] <span style=color:#ff79c6>&amp;</span> PTE_V) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>*</span>fd <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>)va;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> ((vpt[va <span style=color:#ff79c6>/</span> PTMAP] <span style=color:#ff79c6>&amp;</span> PTE_V) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) { <span style=color:#6272a4>// the fd is not used
</span></span></span><span style=display:flex><span>			<span style=color:#ff79c6>*</span>fd <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>)va;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_MAX_OPEN;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>本质上是找到最小的没有被分配的文件描述符所对应的页，而一页对应一个文件描述符</p></li><li><p>fsipc_open</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>fsipc_open</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path, u_int omode, <span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>fd) {
</span></span><span style=display:flex><span>	u_int perm;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Fsreq_open <span style=color:#ff79c6>*</span>req;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	req <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> Fsreq_open <span style=color:#ff79c6>*</span>)fsipcbuf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// The path is too long.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strlen</span>(path) <span style=color:#ff79c6>&gt;=</span> MAXPATHLEN) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_BAD_PATH;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>strcpy</span>((<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>)req<span style=color:#ff79c6>-&gt;</span>req_path, path);
</span></span><span style=display:flex><span>	req<span style=color:#ff79c6>-&gt;</span>req_omode <span style=color:#ff79c6>=</span> omode;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>fsipc</span>(FSREQ_OPEN, req, fd, <span style=color:#ff79c6>&amp;</span>perm);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>本质上是向文件系统发送打开文件的请求</p></li><li><p>fsipc_map</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>fsipc_map</span>(u_int fileid, u_int offset, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>dstva) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> r;
</span></span><span style=display:flex><span>	u_int perm;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Fsreq_map <span style=color:#ff79c6>*</span>req;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	req <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> Fsreq_map <span style=color:#ff79c6>*</span>)fsipcbuf;
</span></span><span style=display:flex><span>	req<span style=color:#ff79c6>-&gt;</span>req_fileid <span style=color:#ff79c6>=</span> fileid;
</span></span><span style=display:flex><span>	req<span style=color:#ff79c6>-&gt;</span>req_offset <span style=color:#ff79c6>=</span> offset;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>fsipc</span>(FSREQ_MAP, req, dstva, <span style=color:#ff79c6>&amp;</span>perm)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> r;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((perm <span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>~</span>(PTE_D <span style=color:#ff79c6>|</span> PTE_LIBRARY)) <span style=color:#ff79c6>!=</span> (PTE_V)) {
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>user_panic</span>(<span style=color:#f1fa8c>&#34;fsipc_map: unexpected permissions %08x for dstva %08x&#34;</span>, perm, dstva);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>向文件系统进程发出映射内存块的请求。</p></li></ul><p>​ 当要读取一个大文件中间的一小部分内容时，一个简单的做法是从头开始查找，但是开销较大；此外，在多次读写同一文件描述符期间，我们也希望能够从文件中前一次读写完毕的位置开始继续读写数据。<strong>因此，文件描述符中需要维护一个指针，帮助我们在文件中定位，在read/write/seek操作时，也需要更新该指针的值</strong></p><blockquote><p>Exercise 5.10 read函数</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>read</span>(<span style=color:#8be9fd>int</span> fdnum, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>buf, u_int n) {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> r;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Similar to the &#39;write&#39; function below.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Get &#39;fd&#39; and &#39;dev&#39; using &#39;fd_lookup&#39; and &#39;dev_lookup&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Dev <span style=color:#ff79c6>*</span>dev;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>fd;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.10: Your code here. (1/4) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>fd_lookup</span>(fdnum, <span style=color:#ff79c6>&amp;</span>fd)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> (r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>dev_lookup</span>(fd<span style=color:#ff79c6>-&gt;</span>fd_dev_id, <span style=color:#ff79c6>&amp;</span>dev)) <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span> ) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> r;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Check the open mode in &#39;fd&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// Return -E_INVAL if the file is opened for writing only (O_WRONLY).
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.10: Your code here. (2/4) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ((fd<span style=color:#ff79c6>-&gt;</span>fd_omode <span style=color:#ff79c6>&amp;</span> O_ACCMODE) <span style=color:#ff79c6>==</span> O_WRONLY) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_INVAL;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 3: Read from &#39;dev&#39; into &#39;buf&#39; at the seek position (offset in &#39;fd&#39;).
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.10: Your code here. (3/4) */</span>
</span></span><span style=display:flex><span>	r <span style=color:#ff79c6>=</span> dev<span style=color:#ff79c6>-&gt;</span><span style=color:#50fa7b>dev_read</span>(fd, buf, n, fd<span style=color:#ff79c6>-&gt;</span>fd_offset);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 4: Update the offset in &#39;fd&#39; if the read is successful.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Hint: DO NOT add a null terminator to the end of the buffer!
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *  A character buffer is not a C string. Only the memory within [buf, buf+n) is safe to
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	 *  use. */</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.10: Your code here. (4/4) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (r <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>		fd<span style=color:#ff79c6>-&gt;</span>fd_offset <span style=color:#ff79c6>+=</span> r;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> r;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>主要逻辑为<strong>调用设备的读取函数<code>dev_read</code>函数从文件当前的偏移位置读取数据到缓冲区中</strong></p></li><li><p>注意**(fd->fd_omode & O_ACCMODE) == O_WRONLY**一定要加括号，否则运算优先级会有问题</p></li><li><p>观察dev_read等设备函数</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Dev {
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> dev_id;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>dev_name;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> (<span style=color:#ff79c6>*</span>dev_read)(<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>, u_int, u_int);
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> (<span style=color:#ff79c6>*</span>dev_write)(<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>, <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>, u_int, u_int);
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> (<span style=color:#ff79c6>*</span>dev_close)(<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>);
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> (<span style=color:#ff79c6>*</span>dev_stat)(<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>, <span style=color:#ff79c6>struct</span> Stat <span style=color:#ff79c6>*</span>);
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> (<span style=color:#ff79c6>*</span>dev_seek)(<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>, u_int);
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>在设备结构体中定义了一系列关于设备操作的函数，关于他们的具体实现可以在<code>file.c</code>中找到例子(不同设备的定义可能不同)</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>struct</span> Dev devfile <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    .dev_id <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;f&#39;</span>,
</span></span><span style=display:flex><span>    .dev_name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;file&#34;</span>,
</span></span><span style=display:flex><span>    .dev_read <span style=color:#ff79c6>=</span> file_read,
</span></span><span style=display:flex><span>    .dev_write <span style=color:#ff79c6>=</span> file_write,
</span></span><span style=display:flex><span>    .dev_close <span style=color:#ff79c6>=</span> file_close,
</span></span><span style=display:flex><span>    .dev_stat <span style=color:#ff79c6>=</span> file_stat,
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>下面以<code>file_read</code>为例，即设备最终调用了这个函数，函数主体功能为<code>memcpy</code>，返回值为读取的长度。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>file_read</span>(<span style=color:#ff79c6>struct</span> Fd <span style=color:#ff79c6>*</span>fd, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>buf, u_int n, u_int offset) {
</span></span><span style=display:flex><span>	u_int size;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Filefd <span style=color:#ff79c6>*</span>f;
</span></span><span style=display:flex><span>	f <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> Filefd <span style=color:#ff79c6>*</span>)fd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Avoid reading past the end of file.
</span></span></span><span style=display:flex><span>	size <span style=color:#ff79c6>=</span> f<span style=color:#ff79c6>-&gt;</span>f_file.f_size;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (offset <span style=color:#ff79c6>&gt;</span> size) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (offset <span style=color:#ff79c6>+</span> n <span style=color:#ff79c6>&gt;</span> size) {
</span></span><span style=display:flex><span>		n <span style=color:#ff79c6>=</span> size <span style=color:#ff79c6>-</span> offset;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>memcpy</span>(buf, (<span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>)<span style=color:#50fa7b>fd2data</span>(fd) <span style=color:#ff79c6>+</span> offset, n);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> n;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=52-文件系统服务>5.2 文件系统服务<a hidden class=anchor aria-hidden=true href=#52-文件系统服务>#</a></h3><p>​ MOS操作系统中的文件服务<strong>通过IPC的方式</strong>供其他进程调用，进行文件读写操作。</p><ul><li>在内核启动时，启动了文件系统服务进程<code>ENV_CREATE(fs_serv)</code></li><li>用户进程需要进行文件操作时，使用<code>ipc_send,ipc_recv</code>与<code>fs_serv</code>进行交互</li></ul><p>​ 在流程上，fs/serv.c中服务进程的主函数首先调用了serve_init函数准备好<strong>全局的文件打开记录表opentab</strong>，然后调用<code>fs_init</code>函数来初始化文件系统：</p><ul><li>首先通过<strong>读取超级块的内容</strong>获知磁盘的基本信息</li><li>然后检查磁盘是否能正常读写</li><li>最后调用<code>read_bitmap</code>函数检查磁盘块上的位图是否正确</li></ul><p>​ 执行完文件系统的初始化后，调用serve函数，文件系统服务开始运行，等待其他进程交互。</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>user_assert</span>(<span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>struct</span> File) <span style=color:#ff79c6>==</span> FILE_STRUCT_SIZE);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>debugf</span>(<span style=color:#f1fa8c>&#34;FS is running</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>serve_init</span>();
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>fs_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>serve</span>();
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>UML时序图如下(分析见实验报告)</p><p><img alt=image-20240521200627636 loading=lazy src=/img/image-20240521200627636.png></p><p>​ 用户进程向文件进程发送的请求如下</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>enum</span> {
</span></span><span style=display:flex><span>	FSREQ_OPEN,
</span></span><span style=display:flex><span>	FSREQ_MAP,
</span></span><span style=display:flex><span>	FSREQ_SET_SIZE,
</span></span><span style=display:flex><span>	FSREQ_CLOSE,
</span></span><span style=display:flex><span>	FSREQ_DIRTY,
</span></span><span style=display:flex><span>	FSREQ_REMOVE,
</span></span><span style=display:flex><span>	FSREQ_SYNC,
</span></span><span style=display:flex><span>	MAX_FSREQNO,
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><ul><li><p>当用户程序发送文件系统操作请求时，将请求的内容放在对应的结构体中进行消息的传递。</p></li><li><p><code>fs_serv</code>进程收到其他进程的IPC操作后，IPC传递的消息包含了请求的类型和其他必要的参数，根据请求的类型(增/删/查/改)执行相应的文件操作</p></li><li><p>结果重新通过IPC反馈给用户程序</p></li></ul><blockquote><p>user/lib/fsipc.c中定义了请求文件系统时用到的IPC操作</p><p>user/lib/file.c文件中定义了用户程序读写、创建、删除、修改文件的接口</p></blockquote><p>​ 下面三个练习实现删除指定路径文件的功能。</p><blockquote><p>Exercise 5.11 fs/serv.c serve_remove</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>serve_remove</span>(u_int envid, <span style=color:#ff79c6>struct</span> Fsreq_remove <span style=color:#ff79c6>*</span>rq) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Remove the file specified in &#39;rq&#39; using &#39;file_remove&#39; and store its return value.
</span></span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> r;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.11: Your code here. (1/2) */</span>
</span></span><span style=display:flex><span>	r <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>file_remove</span>(rq<span style=color:#ff79c6>-&gt;</span>req_path);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Respond the return value to the caller &#39;envid&#39; using &#39;ipc_send&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.11: Your code here. (2/2) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>ipc_send</span>(envid, r, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Exercise 5.12 user/lib/fsipc.c fsipc_remove</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>fsipc_remove</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 1: Check the length of &#39;path&#39; using &#39;strlen&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>// If the length of path is 0 or larger than &#39;MAXPATHLEN&#39;, return -E_BAD_PATH.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.12: Your code here. (1/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>strlen</span>(path) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> <span style=color:#50fa7b>strlen</span>(path) <span style=color:#ff79c6>&gt;</span> MAXPATHLEN) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span>E_BAD_PATH;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 2: Use &#39;fsipcbuf&#39; as a &#39;struct Fsreq_remove&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#ff79c6>struct</span> Fsreq_remove <span style=color:#ff79c6>*</span>req <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>struct</span> Fsreq_remove <span style=color:#ff79c6>*</span>)fsipcbuf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 3: Copy &#39;path&#39; into the path in &#39;req&#39; using &#39;strcpy&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.12: Your code here. (2/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>strcpy</span>(req<span style=color:#ff79c6>-&gt;</span>req_path, path);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Step 4: Send request to the server using &#39;fsipc&#39;.
</span></span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.12: Your code here. (3/3) */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>fsipc</span>(FSREQ_REMOVE, req, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Exercise 5.13 user/lib/file.c remove</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>remove</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>path) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// Call fsipc_remove.
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/* Exercise 5.13: Your code here. */</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#50fa7b>fsipc_remove</span>(path);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://coder0xe.github.io/tags/may/>May</a></li></ul><nav class=paginav><a class=prev href=https://coder0xe.github.io/posts/os-lab5%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/><span class=title>« Prev</span><br><span>OS:lab5实验报告</span>
</a><a class=next href=https://coder0xe.github.io/posts/oo-unit3/><span class=title>Next »</span><br><span>OO-Unit3</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab5课下基础 on x" href="https://x.com/intent/tweet/?text=OS%3alab5%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab5%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f&amp;hashtags=May"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab5课下基础 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab5%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f&amp;title=OS%3alab5%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&amp;summary=OS%3alab5%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&amp;source=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab5%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab5课下基础 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab5%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f&title=OS%3alab5%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab5课下基础 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab5%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab5课下基础 on whatsapp" href="https://api.whatsapp.com/send?text=OS%3alab5%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80%20-%20https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab5%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab5课下基础 on telegram" href="https://telegram.me/share/url?text=OS%3alab5%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&amp;url=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab5%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share OS:lab5课下基础 on ycombinator" href="https://news.ycombinator.com/submitlink?t=OS%3alab5%e8%af%be%e4%b8%8b%e5%9f%ba%e7%a1%80&u=https%3a%2f%2fcoder0xe.github.io%2fposts%2fos-lab5%25E8%25AF%25BE%25E4%25B8%258B%25E5%259F%25BA%25E7%25A1%2580%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://coder0xe.github.io/>coder0xe's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>